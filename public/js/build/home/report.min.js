$(function(){var o="1",i="",n="",d="",e="",t="";[{id:"1",name:"时长视图"},{id:"2",name:"时间视图"},{id:"4",name:"能效视图"}].forEach(function(e){t+=s("view_type",e)}),e+='<div class="ui dropdown fc-filter-d">视图类型<i class="dropdown icon"></i><div class="menu">'+t+"</div></div>";var a,r,l;function c(e){var t="";return t+='<a href="javascript:;" class="clear" onclick="Strack.calendar_click_filter(event,this);" data-type="'+e+'" data-value="all">'+StrackLang.Clear_Selected+"</a>"}function s(e,t){var a="";return a+='<a href="javascript:;" class="item" onclick="Strack.calendar_click_filter(event,this);" data-type="'+e+'" data-value="'+t.id+'"><i class="icon-left icon-unchecked"></i>'+t.name+"</a>"}e+=function(e,t,a,r){var o="",i=[];r&&i.push("display: none");return o+='<div id="fc_filter_wrap_'+e+'" class="ui multiple dropdown fc-filter-d" style="'+i.join(";")+'">'+t+'<i class="dropdown icon"></i><div class="menu"><div class="ui icon userSearch input"><i class="search icon"></i><input type="text" placeholder="Search..."></div><div class="divider"></div><div class="header">'+c(e)+'</div><div class="scrolling menu">'+a+"</div></div></div>"}("user","团队成员",'<div style="padding: 10px;"><div class="item"><ul id="usergroup"></ul></div></div>'),e+=(a="",r=[{id:"today",name:StrackLang.Today},{id:"yesterday",name:StrackLang.Yesterday},{id:"tomorrow",name:StrackLang.Tomorrow}],l="",r.forEach(function(e){l+=s("end_time",e)}),a+='<div class="ui dropdown fc-filter-d">日期<i class="dropdown icon"></i><div class="menu"><div class="header">'+c("end_time")+'</div><div class="divider"></div>'+l+'<div class="fc-endtime-bw"><div class="from aign-left"><input id="fc_endtime_from" data-options="editable:false" /></div><span class="endtime" style="display: none;"><div class="symbol aign-left"> - </div><div class="to aign-left"><input id="fc_endtime_to" data-options="editable:false" /></div></span></div></div></div>'),$("#fc_filter_wrap").append(e),$.ajax({type:"POST",url:ReportPHP.getUserPlannedData,data:{type:3},dataType:"json",beforeSend:function(){$("#fc_filter_wrap").append(Strack.loading_dom("white","","c_filter"))},success:function(e){$("#st-load_c_filter").remove(),200==e.status&&(e=e.data,$("#usergroup").tree({checkbox:!0,data:e,filter:function(e,t){var a=$("#usergroup").tree("find",t.parent_id);return!(!a||0!=a.hidden)||-1!=t.text.indexOf(e)},onCheck:function(e,t){var a=$(this).tree("getChecked");d=[],a.forEach(function(e){-1!=(e.id+"").indexOf("u_")&&d.push(e.id.replace("u_",""))}),d&&("1"==o?I:"2"==o?B:O)()}}))}}),Strack.init_dropdown(".fc-toolbar .ui.menu , .ui.dropdown"),$("#fc_endtime_from").datebox({width:100,height:25,end_limit:"fc_endtime_to",onSelect:function(e){Strack.handle_calendar_check_icon(this,"date_all","end_time"),"1"==o?(i=n=Strack.date_format(e,"yyyy-MM-dd"),I()):"2"==o?(i=n=Strack.date_format(e,"yyyy-MM-dd"),B()):(i=Strack.date_format(e,"yyyy-MM-dd"),n&&O())}}),$("#fc_endtime_to").datebox({width:100,height:25,start_limit:"fc_endtime_from",onSelect:function(e){Strack.handle_calendar_check_icon(this,"date_all","end_time"),n=Strack.date_format(e,"yyyy-MM-dd"),i&&O()}}),Strack.calendar_click_filter=function(e,t){e.stopPropagation(),e.preventDefault();var a,r=$(t).data("type"),e=$(t).data("value");Strack.handle_calendar_check_icon(t,e,r),"view_type"==r&&(o=e),"end_time"==r?i=n="today"==e?(a=new Date).getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate():"yesterday"==e?(a=new Date((new Date).getTime()-864e5)).getFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate():"tomorrow"==e?(e=new Date((new Date).getTime()+864e5)).getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate():"":"user"==r&&($(".tree-checkbox").removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"),d=[]),"1"==o?($(".endtime").hide(),$("#teamViewer").show(),$("#overTime").hide(),$("#loadRate").hide(),I()):"2"==o?($(".endtime").hide(),$("#teamViewer").show(),$("#overTime").hide(),$("#loadRate").hide(),B()):($(".endtime").show(),$("#teamViewer").hide(),$("#overTime").show(),$("#loadRate").show(),O())},$("#fc_filter_wrap").on("input",".userSearch input",function(){$("#usergroup").tree("doFilter",$(this).val())});var h=document.getElementById("teamViewer"),u=document.getElementById("overTime"),e=document.getElementById("loadRate"),m=echarts.init(h),p=echarts.init(u),f=echarts.init(e),_=[],v=[],y=[],w=["#DF6262","#C36464","#B83D3D","#E77676","#E78383"],b=["#3B8686","#3C7575","#246E6E","#54A4A4","#5DA4A4"],g=["#DF9B62","#C38F64","#B8753D","#E7A976","#E7B083"],S=["#4FB34F","#509C50","#319331","#65C665","#70C670"],x=[],k=[],M=[],j=[],C=[],D=[],L=[],F=[];function A(e,t){var a=t.value(0),r=t.coord([a,t.value(2)]),o=t.coord([a,t.value(1)]),a=.2*t.size([0,1])[0],e=echarts.graphic.clipRectByRect({x:r[0]-(1-e.seriesIndex)*a,y:r[1],width:a,height:o[1]-r[1]},{x:e.coordSys.x,y:e.coordSys.y,width:e.coordSys.width,height:e.coordSys.height});return e&&{type:"rect",shape:e,style:t.style()}}function T(e,t){var a=t.value(0),r=t.coord([a,t.value(2)]),o=t.coord([a,t.value(1)]),a=.2*t.size([0,1])[0],e=echarts.graphic.clipRectByRect({x:r[0]-(2-e.seriesIndex)*a,y:r[1],width:a,height:o[1]-r[1]},{x:e.coordSys.x,y:e.coordSys.y,width:e.coordSys.width,height:e.coordSys.height});return e&&{type:"rect",shape:e,style:t.style()}}function z(e){var t="";return 0<Math.floor(e/60)&&(t=Math.floor(e/60)+"小时"),0<Math.floor(e%60)&&(t+=Math.floor(e%60)+"分钟"),t}function H(e){e=new Date(e);return("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)}function B(){$.ajax({type:"POST",url:ReportPHP.getUserPlannedData,data:{type:2,start_date:i,end_date:n,user_ids:d},dataType:"json",beforeSend:function(){$("#container").append(Strack.loading_dom("white","","report_toolbar"))},success:function(e){200==e.status&&(e=e.data,_=[],x=[],k=[],echarts.util.each(e,function(e,i){_.push(e.user_name),echarts.util.each(e.plan_data,function(e,t){var a=1e3*e.start_time,r=1e3*e.end_time,o=parseInt((e.end_time-e.start_time)/60);x.push({val_id:e.id,project_id:e.project_id,module_id:e.module_id,name:e.name,project_name:e.project_name,value:[i,a,r,o],itemStyle:{normal:{color:w[t],borderColor:"#ffffff",borderWidth:2,borderType:"dotted"}}})}),echarts.util.each(e.actual_data,function(e,t){var a=1e3*e.start_time,r=1e3*e.end_time,o=parseInt((e.end_time-e.start_time)/60);k.push({val_id:e.id,project_id:e.project_id,module_id:e.module_id,name:e.name,project_name:e.project_name,value:[i,a,r,o],itemStyle:{normal:{color:b[t],borderColor:"#ffffff",borderWidth:2,borderType:"dotted"}}})})}),"object"==typeof(e={tooltip:{formatter:function(e){return e.marker+e.data.project_name+"<br>"+e.name+"<br>工时："+z(e.value[3])+"<br>开始时间："+H(e.value[1])+"<br>结束时间："+H(e.value[2])}},title:{text:"时间视图",left:"center"},dataZoom:[{startValue:0,endValue:4,type:"slider",filterMode:"weakFilter",showDataShadow:!1,top:415,height:10,borderColor:"transparent",backgroundColor:"#e2e2e2",handleIcon:"M10.7,11.9H9.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4h1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7v-1.2h6.6z M13.3,22H6.7v-1.2h6.6z M13.3,19.6H6.7v-1.2h6.6z",handleSize:20,handleStyle:{shadowBlur:6,shadowOffsetX:1,shadowOffsetY:2,shadowColor:"#aaa"},labelFormatter:""},{type:"inside",filterMode:"weakFilter"}],grid:{height:300},xAxis:{data:_,axisLabel:{interval:0,formatter:function(e){if(e)return e.split("").join("\n")}}},yAxis:{min:function(e){return e.min},max:function(e){return e.max},interval:72e5,type:"time",axisLabel:{formatter:H}},color:["#DF6262","#3B8686"],legend:{top:10,left:80,itemWidth:14,data:[{name:"计划工时",icon:"path://M1,7.76a7,7,0,1,0,7-7A7,7,0,0,0,1,7.76Zm5.6,1.9,5.2-5.25a.5.5,0,0,1,.71,0h0l.46.45A.15.15,0,0,1,13,5L7,11.11a.5.5,0,0,1-.71,0h0l-.42-.43h0L3,7.87a.15.15,0,0,1,0-.18l.46-.45a.5.5,0,0,1,.71,0h0L6.6,9.66Z"},{name:"实际工时",icon:"path://M1,7.76a7,7,0,1,0,7-7A7,7,0,0,0,1,7.76Zm5.6,1.9,5.2-5.25a.5.5,0,0,1,.71,0h0l.46.45A.15.15,0,0,1,13,5L7,11.11a.5.5,0,0,1-.71,0h0l-.42-.43h0L3,7.87a.15.15,0,0,1,0-.18l.46-.45a.5.5,0,0,1,.71,0h0L6.6,9.66Z"}]},series:[{name:"计划工时",type:"custom",renderItem:A,encode:{x:0,y:[1,2]},data:x},{name:"实际工时",type:"custom",renderItem:A,encode:{x:0,y:[1,2]},data:k}]})&&(m.setOption(e,!0),m.on("dblclick",function(e){e.data&&(e=Strack.details_url(e.data,e.data.val_id),window.open(e))}))),$("#st-load_report_toolbar").remove()}})}function I(){$.ajax({type:"POST",url:ReportPHP.getUserPlannedData,data:{start_date:i,end_date:n,user_ids:d},dataType:"json",beforeSend:function(){$("#container").append(Strack.loading_dom("white","","report_toolbar"))},success:function(e){200==e.status&&(e=e.data,_=[],M=[],j=[],C=[],D=[],echarts.util.each(e,function(e,a){_.push(e.user_name);var r=0,o=0,i=0,n=0;echarts.util.each(e.plan_data,function(e,t){M.push({val_id:e.id,project_id:e.project_id,module_id:e.module_id,name:e.name,project_name:e.project_name,value:[a,r,r+=Strack.translate_timespinner_val(e.plan),Strack.translate_timespinner_val(e.plan)],itemStyle:{normal:{color:w[t],borderColor:"#ffffff",borderWidth:2,borderType:"dotted"}}})}),echarts.util.each(e.actual_data,function(e,t){j.push({val_id:e.id,project_id:e.project_id,module_id:e.module_id,name:e.name,project_name:e.project_name,value:[a,o,o+=Strack.translate_timespinner_val(e.actual),Strack.translate_timespinner_val(e.actual)],itemStyle:{normal:{color:b[t],borderColor:"#ffffff",borderWidth:2,borderType:"dotted"}}})}),echarts.util.each(e.estimate_data,function(e,t){C.push({val_id:e.id,project_id:e.project_id,module_id:e.module_id,name:e.name,project_name:e.project_name,value:[a,i,i+=Strack.translate_timespinner_val(e.estimate),Strack.translate_timespinner_val(e.estimate)],itemStyle:{normal:{color:g[t],borderColor:"#ffffff",borderWidth:2,borderType:"dotted"}}})}),echarts.util.each(e.settlement_data,function(e,t){D.push({val_id:e.id,project_id:e.project_id,module_id:e.module_id,name:e.name,project_name:e.project_name,value:[a,n,n+=Strack.translate_timespinner_val(e.settlement),Strack.translate_timespinner_val(e.settlement)],itemStyle:{normal:{color:S[t],borderColor:"#ffffff",borderWidth:2,borderType:"dotted"}}})})}),"object"==typeof(e={tooltip:{formatter:function(e){return e.marker+e.data.project_name+"<br>"+e.name+"<br>工时："+z(e.value[3])}},title:{text:"时长视图",left:"center"},dataZoom:[{startValue:0,endValue:4,type:"slider",filterMode:"weakFilter",showDataShadow:!1,top:415,height:10,borderColor:"transparent",backgroundColor:"#e2e2e2",handleIcon:"M10.7,11.9H9.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4h1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7v-1.2h6.6z M13.3,22H6.7v-1.2h6.6z M13.3,19.6H6.7v-1.2h6.6z",handleSize:20,handleStyle:{shadowBlur:6,shadowOffsetX:1,shadowOffsetY:2,shadowColor:"#aaa"},labelFormatter:""},{type:"inside",filterMode:"weakFilter"}],grid:{height:300},xAxis:{data:_,axisLabel:{interval:0,formatter:function(e){if(e)return e.split("").join("\n")}}},yAxis:{min:0,max:function(e){return e.max+120},minInterval:120,axisLabel:{formatter:function(e){return e%60!=0?(e/60).toFixed(1)+"小时":e/60+"小时"}}},color:["#DF6262","#3B8686","#DF9B62","#4FB34F"],legend:{top:10,left:80,itemWidth:14,data:[{name:"计划工时",icon:"path://M1,7.76a7,7,0,1,0,7-7A7,7,0,0,0,1,7.76Zm5.6,1.9,5.2-5.25a.5.5,0,0,1,.71,0h0l.46.45A.15.15,0,0,1,13,5L7,11.11a.5.5,0,0,1-.71,0h0l-.42-.43h0L3,7.87a.15.15,0,0,1,0-.18l.46-.45a.5.5,0,0,1,.71,0h0L6.6,9.66Z"},{name:"实际工时",icon:"path://M1,7.76a7,7,0,1,0,7-7A7,7,0,0,0,1,7.76Zm5.6,1.9,5.2-5.25a.5.5,0,0,1,.71,0h0l.46.45A.15.15,0,0,1,13,5L7,11.11a.5.5,0,0,1-.71,0h0l-.42-.43h0L3,7.87a.15.15,0,0,1,0-.18l.46-.45a.5.5,0,0,1,.71,0h0L6.6,9.66Z"},{name:"预估工时",icon:"path://M1,7.76a7,7,0,1,0,7-7A7,7,0,0,0,1,7.76Zm5.6,1.9,5.2-5.25a.5.5,0,0,1,.71,0h0l.46.45A.15.15,0,0,1,13,5L7,11.11a.5.5,0,0,1-.71,0h0l-.42-.43h0L3,7.87a.15.15,0,0,1,0-.18l.46-.45a.5.5,0,0,1,.71,0h0L6.6,9.66Z"},{name:"结算工时",icon:"path://M1,7.76a7,7,0,1,0,7-7A7,7,0,0,0,1,7.76Zm5.6,1.9,5.2-5.25a.5.5,0,0,1,.71,0h0l.46.45A.15.15,0,0,1,13,5L7,11.11a.5.5,0,0,1-.71,0h0l-.42-.43h0L3,7.87a.15.15,0,0,1,0-.18l.46-.45a.5.5,0,0,1,.71,0h0L6.6,9.66Z"}]},series:[{name:"计划工时",type:"custom",renderItem:T,encode:{x:0,y:[1,2]},data:M},{name:"实际工时",type:"custom",renderItem:T,encode:{x:0,y:[1,2]},data:j},{name:"预估工时",type:"custom",renderItem:T,encode:{x:0,y:[1,2]},data:C},{name:"结算工时",type:"custom",renderItem:T,encode:{x:0,y:[1,2]},data:D}]})&&(m.setOption(e,!0),m.on("dblclick",function(e){e.data&&(e=Strack.details_url(e.data,e.data.val_id),window.open(e))}))),$("#st-load_report_toolbar").remove()}})}function O(){$.ajax({type:"POST",url:ReportPHP.getUserPlannedData,data:{type:4,start_date:i,end_date:n,user_ids:d},dataType:"json",beforeSend:function(){$("#container").append(Strack.loading_dom("white","","report_toolbar"))},success:function(e){var t;200==e.status&&(e=e.data,v=[],y=[],L=[],F=[],echarts.util.each(e.overtimeData,function(e,t){v.push(e.user_name),L.push((e.overtime_working_hours/60).toFixed(2))}),echarts.util.each(e.loadRateData,function(e,t){y.push(e.user_name),F.push(e.loadRate)}),e={title:{text:"负荷情况",left:"center"},dataZoom:[{startValue:0,endValue:9,type:"slider",filterMode:"weakFilter",showDataShadow:!(t={title:{text:"超时情况",left:"center"},dataZoom:[{startValue:0,endValue:9,type:"slider",filterMode:"weakFilter",showDataShadow:!1,top:415,height:10,borderColor:"transparent",backgroundColor:"#e2e2e2",handleIcon:"M10.7,11.9H9.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4h1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7v-1.2h6.6z M13.3,22H6.7v-1.2h6.6z M13.3,19.6H6.7v-1.2h6.6z",handleSize:20,handleStyle:{shadowBlur:6,shadowOffsetX:1,shadowOffsetY:2,shadowColor:"#aaa"},labelFormatter:""},{type:"inside",filterMode:"weakFilter"}],grid:{height:300},xAxis:{data:v,axisLabel:{interval:0,formatter:function(e){if(e)return e.split("").join("\n")}},triggerEvent:!0},yAxis:{type:"value",splitNumber:10,axisLabel:{formatter:function(e){return e+"小时"}}},series:[{data:L,name:"超时时间",type:"bar",label:{normal:{show:!0,position:"top"}}}]}),top:415,height:10,borderColor:"transparent",backgroundColor:"#e2e2e2",handleIcon:"M10.7,11.9H9.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4h1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7v-1.2h6.6z M13.3,22H6.7v-1.2h6.6z M13.3,19.6H6.7v-1.2h6.6z",handleSize:20,handleStyle:{shadowBlur:6,shadowOffsetX:1,shadowOffsetY:2,shadowColor:"#aaa"},labelFormatter:""},{type:"inside",filterMode:"weakFilter"}],grid:{height:300},xAxis:{data:y,axisLabel:{interval:0,formatter:function(e){if(e)return e.split("").join("\n")}},triggerEvent:!0},yAxis:{type:"value"},series:[{data:F,name:"负荷率",type:"line",label:{normal:{show:!0,position:"top"}}}]},"object"==typeof t&&e&&"object"==typeof e&&(p.setOption(t,!0),p.on("click",function(e){"xAxis"==e.componentType&&alert("单击了"+e.event.target.anid+"x轴标签")}),f.setOption(e,!0),f.on("click",function(e){"xAxis"==e.componentType&&alert("单击了"+e.event.target.anid+"x轴标签")}))),$("#st-load_report_toolbar").remove()}})}I()});