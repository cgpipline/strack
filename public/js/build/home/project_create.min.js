$(function(){obj={step_prev:function(){_.preStep()},step_next:function(){_.nextStep()},select_template:function(e){$(".step-template").removeClass("step-template-ac"),$(e).addClass("step-template-ac"),s.template_id=$(e).attr("data-tempid")},delete_disk_item:function(e){e=$(e).attr("data-moduleid");$("#entity_disk_"+e).remove()},step_submit:function(){0<$("#project_thumb_queue .uploadifive-queue-item").length?(s.has_media=!0,$("#choice_project_thumb").uploadifive("upload")):(s.has_media=!1,p())},nav_add_disk:function(e){Strack.open_dialog("dialog",{title:StrackLang.Add_Entity_Disk_Title,width:480,height:370,content:Strack.dialog_dom({type:"normal",hidden:[],items:[{case:1,id:"Ndisk_name",type:"text",lang:StrackLang.Name,name:"name",valid:"",value:""},{case:1,id:"Ndisk_code",type:"text",lang:StrackLang.Code,name:"code",valid:"",value:""},{case:1,id:"Nwin_path",type:"text",lang:StrackLang.Win_Path,name:"win_path",valid:"",value:""},{case:1,id:"Nmac_path",type:"text",lang:StrackLang.Mac_Path,name:"mac_path",valid:"",value:""},{case:1,id:"Nlinux_path",type:"text",lang:StrackLang.Linux_Path,name:"linux_path",valid:"",value:""}],footer:[{obj:"submit_add_disk",type:1,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){}})},submit_add_disk:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",StrackPHP.addProjectDisk,{back:function(e){var t;200===parseInt(e.status)?($("#add_project_disk").find(".combobox-f").each(function(){t=$(this).attr("id"),$("#"+t).combobox("reload")}),Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},add_more_disk:function(e){Strack.open_dialog("dialog",{title:StrackLang.Add_More_Disk_Title,width:480,height:280,content:Strack.dialog_dom({type:"normal",hidden:[],items:[{case:1,id:"Mdisk_name",type:"text",lang:StrackLang.Name,name:"name",valid:"1",value:""},{case:1,id:"Mdisk_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1",value:""},{case:2,id:"Mdisk_list",lang:StrackLang.Disks,name:"id",valid:"1"}],footer:[{obj:"add_more_project_disk",type:1,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#Mdisk_list",{url:StrackPHP.getDiskCombobox,valueField:"id",textField:"name"})}})},add_more_project_disk:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","","","",{extra:function(e){var t;Strack.dialog_cancel(),-1===$.inArray(e.code,i)?(i.push(e.code),t=e,$("#entity_disk_list").prepend(function(e){var t="",a="disk_"+e.code;return t+='<div id="item_disk_'+e.code+'" class="ui grid disk-setting-item" data-code="'+e.code+'" data-name="'+e.name+'"><div class="two column row"><div class="five wide column"><a href="javascript:;" class="delete-bnt" onclick="obj.delete_more_project_disk(this)" data-code="'+e.code+'"><i class="icon-uniE6DB"></i></a><span class="title">'+e.name+'</span></div><div class="eleven wide column combobox"><input id="'+a+'" name="'+e.code+'" autocomplete="off"/></div></div></div>'}(t)),Strack.combobox_widget("#disk_"+t.code,{url:StrackPHP.getDiskCombobox,prompt:StrackLang.Please_Select_Disk,valueField:"id",textField:"name",value:t.id,width:300,height:30,onSelect:function(e){t.disk_id=a.disk_id,update_project_disk(t,e)}}),obj.check_more_project_disk_notice()):layer.msg(StrackLang.Project_Disks_Code_Exist,{icon:2,time:1200,anim:6})}})},delete_more_project_disk:function(e){e=$(e).attr("data-code");$("#item_disk_"+e).remove(),obj.check_more_project_disk_notice()},check_more_project_disk_notice:function(){0<$("#entity_disk_list .disk-setting-item").length?$("#entity_disk_list .datagrid-empty-no").remove():$("#entity_disk_list").html('<div class="datagrid-empty-no">'+StrackLang.No_More_Disks_Configured+"</div>")}};var a=Strack.generate_hidden_param(),i=[],s={template_id:0,info:{},disk:{},has_media:!1,media:{mode:"single",module_id:a.module_id}},r=[],l=!1,_=$("#project_step").step({mustStep:[1,2],stepCallBack:function(e){!function(i){var e={template:StrackLang.Please_Select_Template,info:StrackLang.Please_Fill_Project_Info,disk:StrackLang.Please_Set_Disk,group:""},o=!0,n=0,d="";if(["template","info","disk","group"].forEach(function(e,t){if(!(t+1<i&&o))return!1;switch(d=e){case"template":o=0<s.template_id;break;case"info":a=Strack.validate_form("add_project_info"),o=200===parseInt(a.status)?(s.info=a.data,!0):!(l=!0);break;case"disk":o=m()}return n=t+1,!!o&&void 0;var a}),o){switch(n+1){case 2:$.inArray(n,r)<0&&r.push(n),function(){var e=s.hasOwnProperty("info")?s.info.status_id:"",t=s.hasOwnProperty("info")?s.info.public:"yes",a=s.hasOwnProperty("info")?s.info.start_time:"",i=s.hasOwnProperty("info")?s.info.end_time:"",o=s.hasOwnProperty("info")?s.info.group_open:"",n=$("#add_project_info");n.hasClass("load-active")?$("#info_project_status").combobox("setValue",e):(n.addClass("load-active"),Strack.combobox_widget("#info_project_status",{url:StrackPHP.getProjectStatusCombobox,valueField:"id",textField:"name",width:626,height:39,value:e,queryParams:{template_id:s.template_id}}),t=t||"yes",Strack.combobox_widget("#info_project_public",{url:StrackPHP.getPublicType,valueField:"id",textField:"name",width:626,height:39,value:t}),$("#info_project_start").datebox({width:626,height:39,value:a,end_limit:"info_project_end"}),$("#info_project_end").datebox({width:626,height:39,value:i,start_limit:"info_project_start"}),$("#info_project_name").inputmask("*{0,128}"),$("#info_project_code").inputmask("alphaDash"),$("#info_project_rate").inputmask("decimal"),Strack.init_open_switch({dom:"#project_group_open",value:o,onText:StrackLang.Switch_ON,offText:StrackLang.Switch_OFF,width:100}),Strack.get_media_server(function(a){$("#choice_project_thumb").uploadifive({auto:!1,formData:{timestamp:Strack.current_time(),token:a.token,size:"250x140"},multi:!1,queueSizeLimit:1,queueID:"project_thumb_queue",uploadScript:a.upload_url,onUpload:function(e){0==e?layer.msg(StrackLang.Please_Select_File,{icon:2,time:1200,anim:6}):$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},onUploadComplete:function(e,t){t=JSON.parse(t);200===parseInt(t.status)?(s.media.media_server=a,s.media.media_data=t.data,p()):layer.msg(t.message,{icon:7,time:1200,anim:6})}})},function(e){$("#project_upload_thumbnail").hide()}))}();break;case 3:$.inArray(n,r)<0&&(r.push(n),Strack.combobox_widget("#disk_global_combobox",{url:StrackPHP.getDiskCombobox,prompt:StrackLang.Please_Select_Disk,valueField:"id",textField:"name",width:300,height:30,onSelect:function(e){}}))}var t=$("#bottom_bnt_prev"),a=$("#bottom_bnt_next"),c=$("#bottom_bnt_submit");switch(_.goStep(i),i){case 1:t.hide(),a.show(),c.hide();break;case 3:t.show(),a.hide(),c.show();break;default:t.show(),a.show(),c.hide()}}else l||layer.msg(e[d],{icon:2,time:1200,anim:6})}(e)}});function m(){var e,t,a,i={};return $("#add_project_disk").find(".combobox-f").each(function(){a=$(this).closest(".disk-setting-item"),t=$(this).attr("id"),(e=Strack.get_combos_val("#"+t,"combobox","getValue"))&&(t=a.attr("data-code"),a=a.attr("data-name"),i[t]={id:e,code:t,name:a})}),s.disk=i,!0}function p(){m(),$.ajax({type:"POST",url:ProjectPHP.addProject,data:JSON.stringify(s),dataType:"json",contentType:"application/json",beforeSend:function(){s.has_media||$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?layer.msg(e.message,{icon:1,shade:.2,time:1e3},function(){location.href=ProjectPHP.project_create}):layer.msg(e.message,{icon:7,time:1200,anim:6})}})}function n(e){var t="",a="",a=0!==parseInt(e.project_id)&&e.hasOwnProperty("thumb")?'<img src="'+e.thumb+'">':'<div class="panel-thumb-null"><i class="icon-uniF1ED"></i></div>';return t+='<a href="javascript:;" class="wide column step-template" onclick="obj.select_template(this)" data-tempid="'+e.project_template_id+'"><div class="template-item"><div class="template-card">'+a+'<p class="template-name">'+e.name+"</p></div></div></a>"}_.goStep(1),$.ajax({type:"POST",url:ProjectPHP.getTemplateList,dataType:"json",beforeSend:function(){$(".project-step-content").append(Strack.loading_dom("white","","template"))},success:function(e){var t=$("#template_builtin_list"),a=!0,i=$("#template_project_list"),o=!0;e.rows.forEach(function(e){0===parseInt(e.project_id)?(a&&(t.empty(),a=!1),t.append(n(e))):(o&&(i.empty(),o=!1),i.append(n(e)))}),$(".st-load").remove()}})});