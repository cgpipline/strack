var Strack={set_cookie:function(e,t,a){Strack.remove_cookie(e);var i=new Date;a<=0&&(a=1),i.setTime(i.getTime()+864e5*a),document.cookie=e+"="+encodeURI(t)+"; expires="+i.toGMTString()+";path=/"},get_cookie:function(e){e=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=e?decodeURIComponent(e[2]):""},get_query_variable:function(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var i=t[a].split("=");if(i[0]==e)return i[1]}return!1},remove_cookie:function(e){var t=new Date;""!==Strack.get_cookie(e)&&(t.setTime(t.getTime()-864e5),document.cookie=e+"=;expires="+t.toGMTString())},is_string:function(e){return"string"==typeof e&&e.constructor==String},deep_copy:function(e){if(!Strack.isObject(e))throw new Error("obj 不是一个对象！");var t,a=Array.isArray(e)?[]:{};for(t in e)a[t]=Strack.isObject(e[t])?Strack.deep_copy(e[t]):e[t];return a},isObject:function(e){return("object"==typeof e||"function"==typeof e)&&null!==e},save_storage:function(e,t){sessionStorage.setItem(e,t)},read_storage:function(e){return sessionStorage.getItem(e)},delete_storage:function(e){sessionStorage.removeItem(e)},save_local_storage:function(e,t){localStorage.setItem(e,t)},read_local_storage:function(e){return localStorage.getItem(e)},delete_local_storage:function(e){localStorage.removeItem(e)},clear_all_storage:function(){sessionStorage.clear()},get_page_uuid:function(){var e=$(document.body),e={identity:e.data("identity"),created:e.data("created")};return e.uid=e.identity+"_"+e.created,e.group="message",e},parse_dom:function(e){try{return(new DOMParser).parseFromString(e,"text/xml")}catch(e){alert(e.message)}return null},indexOfArray:function(e,t,a){if(e)for(var i=0,d=e.length;i<d;i++)if(null==a){if(e[i]==t)return i}else if(e[i][t]==a)return i;return-1},getArrayItem:function(e,t,a){a=Strack.indexOfArray(e,t,a);return-1==a?null:e[a]},css:function(e,t){if(!t||0===t.length)throw new Error('CSS "path" is required !');e=document.getElementById(e);$(e).append("<link type='text/css' rel='stylesheet' href='"+t+"' />")},js:function(e,t){if(!t||0===t.length)throw new Error('JS "path" is required !');e=document.getElementById(e);$(e).append("<script type='text/javascript' language='javascript' src='"+t+"'/><\/script>")},html_encode:function(e){return $("<div/>").text(e).html()},html_decode:function(e){return $("<div/>").html(e).text()},get_obj_by_id:function(e){return document.getElementById(e)},array_distinct:function(e,t){for(var a=[],i=e.concat(t),d={},r=0;r<i.length;r++)i[r]in d?d[i[r]]++:d[i[r]]=1;for(x in d)1==d[x]&&a.push(x);return a},array_group:function(e,i){return e.reduce(function(e,t,a){return e[t[i]]=e[t[i]]||[],e[t[i]].push(t),e},{})},get_base_path:function(e){e=e.split("/");return e.pop(),e.join("/")},trim_spaces:function(e,t){e=e.replace(/(^\s+)|(\s+$)/g,"");return e="g"===t.toLowerCase()?e.replace(/\s/g,""):e},string_ucwords:function(e){if(-1==e.indexOf("_"))return e.substring(0,1).toUpperCase()+e.substring(1);var e=e.split("_"),t=[];return e.forEach(function(e){t.push(e.substring(0,1).toUpperCase()+e.substring(1))}),t.join("_")},prefix_integer:function(e,t){return(Array(t).join(0)+e).slice(-t)},time_to_frame:function(e,t){t=t||Strack.G.FrameRates.film;return Math.round(e*t)},replace_textarea:function(e){var t;return e&&(t=new RegExp("\r\n","g"),e=e.replace(t,"<br>")),e},revert_textarea:function(e){var t=new RegExp("＜br＞","g"),a=new RegExp("＜p＞","g");return e=(e=e.replace(t,"\r\n")).replace(a," ")},replace_html_tag:function(e){return e=e.replace(/<\/?[^>]*>/g,"")},remove_html_ext:function(e){return e.replace(".html","")},hex_to_rgb:function(e,t){var a=("#"+e).toLowerCase();if(a&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(a)){if(4===a.length){for(var i="#",d=1;d<4;d+=1)i+=a.slice(d,d+1).concat(a.slice(d,d+1));a=i}for(var r=[],o=1;o<7;o+=2)r.push(parseInt("0x"+a.slice(o,o+2)));return"RGBA("+r.join(",")+","+t+")"}return a},current_time:function(){return Date.parse(new Date)/1e3},remove_parent:function(e){$(e).parent().remove()},date_format:function(e,t){var a,i={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(a in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),i)new RegExp("("+a+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[a]:("00"+i[a]).substr((""+i[a]).length)));return t},MDFormat:function(e){e=new Date(e);var t=(new Date).getFullYear(),a=e.getFullYear(),i=Strack.date_format(e,"yyyy-M-d"),d="",r=[StrackLang.January,StrackLang.February,StrackLang.March,StrackLang.April,StrackLang.May,StrackLang.June,StrackLang.July,StrackLang.August,StrackLang.September,StrackLang.October,StrackLang.November,StrackLang.December],o=new Date,n=new Date,s=new Date,o=Strack.date_format(o,"yyyy-M-d");return n.setHours(0,0,0,0),n.setDate(n.getDate()-1),n=Strack.date_format(n,"yyyy-M-d"),s.setHours(0,0,0,0),s.setDate(s.getDate()+1),s=Strack.date_format(s,"yyyy-M-d"),o==i?d=StrackLang.Today:n==i?d=StrackLang.Yesterday:s==i?d=StrackLang.Tomorrow:(d=r[e.getMonth()]+" "+e.getDate()+StrackLang.UnitTH,a!=t&&(d="("+a+") "+d)),d},lastMFirst:function(e){var t=new Date,a=t.getFullYear(),i=t.getMonth()+1;return 0==i&&(i=12,a-=1),i<10&&(i="0"+i),"today"==e?a+"-"+i+"-"+t.getDate():a+"-"+i+"-01"},getLastDay:function(e,t){var a=e,e=t++;12<t&&(e-=12,a++);e=new Date(a,e,1);return new Date(e.getTime()-864e5).getDate()},lastMonthDate:function(){var e=new Date,t=e.getFullYear(),a=e.getMonth()+1,i=e.getDate(),d=new Array(0,31,28,31,30,31,30,31,31,30,31,30,31);return 1==a?(t=e.getFullYear()-1,a=12):a-=1,t%4==0&&t%100!=0&&(d[2]=29),d[a]<i&&(i=d[a]),t+"-"+(a=a<10?"0"+a:a)+"-"+(i=i<10?"0"+i:i)},date_to_unix:function(e){return new Date(e).getTime()},unix_to_date:function(e,t){t=t||"Y-m-d H:i:s";function a(e){return e<10?"0"+e:e}var e=e?new Date(e):new Date,i=e.getFullYear(),d=a(e.getMonth()+1),r=a(e.getDate()),o=a(e.getHours()),n=a(e.getMinutes()),s=a(e.getSeconds());return t.replace(/Y|m|d|H|i|s/gi,function(e){return{Y:i,m:d,d:r,H:o,i:n,s:s}[e]})},getTime2Time:function(e,t){var a=t;return(Date.parse(e)/1e3-(a=Date.parse(a)/1e3))/86400},generate_hidden_param:function(e){var t,a={};return $(e||"#page_hidden_param").find("input").each(function(){t=$(this).attr("name"),a[t]=$(this).val()}),Strack.G.pageHiddenParam=a},copy_to_clipboard:function(){layer.msg(StrackLang.Copy_Clipboard_SC)},number_add_zero:function(e,t){return(""+e).length<t?(new Array(t+1).join("0")+e).slice(-t):""+e},add_animate_effect:function(e,t,a,i,d,r){$(e).hasClass(t)||($(e).addClass(t),a&&($(i).hide(),$(e).append(r)),window.setTimeout(function(){$(e).removeClass(t)},1e3))},init_lazy_load:function(e,t){$(e).lazyload({container:$(t),event:"scroll",effect:"fadeIn"})},fall_load_data:function(e,i,d,r){$(e).on("scroll",function(){var e=this.scrollTop||this.scrollTop,t=this.scrollHeight||this.scrollHeight,a=this.clientHeight||this.clientHeight;r&&r(),e===t-a&&(i.page_number++,a=Math.ceil(i.total/i.page_size),i.page_number<=a&&d&&d(i))})},array_to_json:function(e){var t,a="";for(t in e)a+=t+"="+e[t]+"&";return a=a.substring(0,a.length-1)},validate_form:function(e){var o={},n=200;return $("#"+e+" .form-input").each(function(){var e=$(this).attr("id"),t=$(this).attr("wiget-type"),a=$(this).attr("wiget-need"),i=$(this).attr("wiget-field"),d=$(this).attr("wiget-name"),r="";switch(t){case"input":case"textarea":r=$("#"+e).val();break;case"combobox":r=Strack.get_combos_val("#"+e,"combobox","getValue");break;case"combotree":r=Strack.get_combos_val("#"+e,"combotree","getValue");break;case"combobox_s":r=Strack.get_combos_val("#"+e,"combobox","getValues");break;case"switch":r=Strack.get_switch_val("#"+e);break;case"datebox":r=(r=$("#"+e).datebox("getValue"))||"";break;case"json":r=Strack.get_json_editor_val(e)}if("yes"===a&&0===r.length)return n=404,layer.msg(d+" : "+StrackLang.Required_Field,{icon:2,time:1200,anim:6}),!1;o[i]=r}),{status:n,message:"",data:o}},validate_date_format:function(e){var t,a=!1,i=e.split("-"),d=0,r=0,o=0,n=0,s=0;return 3!=i.length||2==(t=i[2].split(" ")).length&&(e=t[1].split(":"),d=i[0],r=i[1],o=t[0],n=e[0],s=e[1],(0<=n&&n<=23&&0<=s&&s<=59||24==n&&0==s)&&((a=(4==r||6==r||9==r||11==r)&&0<=o&&o<=30||2!=r&&0<=o&&o<=31?!0:a)||((d%4==0?!0:!1)?2==r&&0<=o&&o<=29&&(a=!0):2==r&&0<=o&&o<=28&&(a=!0)))),a},check_email:function(e){return!0!=!new RegExp(/^([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\-|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]$/).test(e)},check_auth_format:function(e){return!(e.length<1||e.indexOf("/")<1)},check_long:function(e,t){return e.length==t},valid_form:function(e,t,a){if(isNaN(e)){var i=e.split(","),d=parseInt(i[0]),i=parseInt(i[1]);return d===i?t.length<d?{status:!1,error_num:-1,message:a+""+StrackLang.Error_Valid_Fixed+" "+d}:{status:!0,error_num:0,message:""}:t.length<d||t.length>i?{status:!1,error_num:-1,message:a+""+StrackLang.Error_Valid_Range+" "+d+"-"+i}:{status:!0,error_num:0,message:""}}switch(e){case 0:return{status:!0,error_num:0,message:""};case 1:return""===t||null===t?{status:!1,error_num:-1,message:a+""+StrackLang.Error_Valid_Empty}:{status:!0,error_num:0,message:""};case 2:return Strack.check_email(t)?{status:!0,error_num:0,message:""}:{status:!1,error_num:-1,message:a+""+StrackLang.Error_Format};case 3:return Strack.check_auth_format(t)?{status:!0,error_num:0,message:""}:{status:!1,error_num:-1,message:a+""+StrackLang.Error_Format};default:return{status:!1,error_num:666,message:StrackLang.Illegal_Operation}}},dialog_dom:function(e){var t="",a="",i="",d="",r=e.hidden||[];switch(e.type){case"normal":i+='<div class="st-dialog-main">',d+=Strack.dialog_hide(r),d+=Strack.dialog_form(e.items),a=Strack.dialog_footer(e.footer,"",e.keep_panel),t+=Strack.dialog_build(i,"",d,a);break;case"adv_filter":i+='<div class="st-dialog-datalist pitem-wrap">',d+=Strack.dialog_hide(r),d+='<div id="adv_fdialog" class="adv-filter-main"><div class="dgcb-query-all"><div class="query-all-name aign-left">'+StrackLang.ConditionalLogic+'</div><div class="query-all-input aign-left"><input id="logic_comb"></div><a href="javascript:;" onclick="Strack.add_filter_group(this)" class="query-all-btn aign-left"><i class="icon-uniEA33"></i>'+StrackLang.AddFilterGroup+'</a></div><div id="dg_adv_filter" class="dgcb-query-wrap"></div></div>',a=Strack.dialog_footer(e.footer,"",e.keep_panel),t+=Strack.dialog_build(i,"",d,a);break;case"adv_sort":var o=[{case:106,lang:StrackLang.Sort_First_By,index:"first"},{case:106,lang:StrackLang.Then_By,index:"second"},{case:106,lang:StrackLang.Then_By,index:"third"}];d+=Strack.dialog_hide(r);var a=Strack.dialog_footer(e.footer,"",e.keep_panel),n="";o.forEach(function(e){n+=Strack.dialog_items(e)}),d+="<div>"+n+"</div>",t+=Strack.dialog_build(i+='<div class="st-dialog-main">',"",d,a);break;case"relationship_set":d+=Strack.dialog_hide(r),i+='<div class="st-dialog-main">',d+='<div class="st-dg-relate-r"><div class="dg-relate-r-t">'+StrackLang.Related_Module_Title+'</div><div class="dg-relate-r-list"><table class="ui celled striped table"><tbody id="related_module_list" ></tbody></table></div></div>',d+='<div class="st-dg-relate-l"><div class="st-dialog-toolbar"><a href="javascript:;" class="easyui-linkbutton" iconCls="icon-add" plain="true"onclick="Strack.dialog_relationship_item();">'+StrackLang.Add+'</a></div><div id="st_relationship" class="st-dialog-relate"></div></div>',a=Strack.dialog_footer(e.footer,"",e.keep_panel),t+=Strack.dialog_build(i,"",d,a);break;case"download":break;case"avatar":i+='<div class="st-dialog-main">',d+=Strack.dialog_hide(r),d+=Strack.dialog_avatar(e.header_extra,e.footer),t+=Strack.dialog_build(i,"",d,a);break;case"item_operation":i+='<div class="st-dialog-main">',d+=Strack.dialog_hide(r),d+=Strack.dialog_form(e.items),d+='<div class="st-dialog-up"><ul id="st_dialog_item" class="dg-report-list"></ul></div>',a=Strack.dialog_footer(e.footer,"",e.keep_panel),t+=Strack.dialog_build(i,"",d,a);break;case"datagrid":i+='<div class="st-dialog-datalist pitem-wrap">',d+=Strack.dialog_hide(r),d+=Strack.dialog_grid(e.grid),a=Strack.dialog_footer(e.footer,"",e.keep_panel),t+=Strack.dialog_build(i,"",d,a);break;case"add_custom_field":i+='<div class="st-dialog-datalist pitem-wrap">',d+=Strack.dialog_hide(r),d+=Strack.dialog_custom_field(),a=Strack.dialog_footer(e.footer,"",e.keep_panel),t+=Strack.dialog_build(i,"",d,a);break;case"add_entity_task":i+='<div class="st-dialog-entity-task pitem-wrap">',d+=Strack.dialog_hide(r),d+=Strack.dialog_add_entity_task(e.entity_title),a=Strack.dialog_footer(e.footer,"",e.keep_panel),t+=Strack.dialog_build(i,"",d,a)}return t},dialog_build:function(e,t,a,i){var d="";return d+=e,d+=t,d+='<form id="st_dialog_form" style="height: 100%">'+a+"</form>",d+=i,d+="</div>"},dialog_hide:function(e){var t="";return e.forEach(function(e){t+=Strack.dialog_items(e)}),'<div id="st_dialog_form_hide">'+t+"</div>"},dialog_form:function(e){var t="";return e.forEach(function(e){t+=Strack.dialog_base_item(e.lang,e)}),t},dialog_footer:function(e,t,a){var i="<footer>";return t&&(i+='<div class="st-dialog-lfooter">'+Strack.dialog_button(0,t)+"</div>"),i+='<div class="st-dialog-footer '+(a?"stf-bottom-25":"stf-bottom-10")+'">'+Strack.dialog_button(0,e)+"</div>",i+=Strack.dialog_footer_keep_dom(a),i+="</footer>"},dialog_footer_keep_dom:function(e){var t="";return e&&(t+='<div class="std-keep-wrap"><div class="std-keep-item"><a href="javascript:;" class="std-ck std-continue-next" onclick="Strack.toggle_dialog_keep(this)" data-type="continue_next"><i class="icon-uniF204"></i></a>'+StrackLang.Keep_And_Continue_To_Next+'</div><div class="std-keep-item"><a href="javascript:;" class="std-ck std-keep-data" onclick="Strack.toggle_dialog_keep(this)" data-type="keep_data"><i class="icon-uniF204"></i></a>'+StrackLang.Keep_The_Current_Content+"</div></div>"),t},toggle_dialog_keep:function(e){var t=$(e).data("type");Strack.do_toggle_dialog_keep(e,t)},do_toggle_dialog_keep:function(e,t){e=$(e).find("i");e.hasClass("active")?(e.removeClass("icon-uniF205").addClass("icon-uniF204").removeClass("active"),Strack.G.dialogKeepBntStatus[t]="no"):(e.removeClass("icon-uniF204").addClass("icon-uniF205").addClass("active"),Strack.G.dialogKeepBntStatus[t]="yes")},set_dialog_keep_status_bnt:function(e,t){Strack.G.dialogKeepBntStatus=t;var a=$("#"+e).find(".std-continue-next")[0],e=$("#"+e).find(".std-keep-data")[0];"yes"===t.keep_data&&Strack.do_toggle_dialog_keep(e,"keep_data"),"yes"===t.continue_next&&Strack.do_toggle_dialog_keep(a,"continue_next")},dialog_grid:function(e){var t="";return t+='<div id="'+e.wrap_dom+'" class="entity-datalist" style="height: '+e.height+'px ;width: 100%" >',e.toolbar_show&&(t+='<div id="'+e.toolbar_id+'" class="proj_tb tb-padding-grid-small st-buttons-blue" style="overflow: hidden">'+Strack.dialog_grid_toolbar(e.toolbar_dom)+"</div>"),e.top_notice&&(t+='<div class="dg-data-notice text-ellipsis">'+e.top_notice+"</div>"),t+='<table id="'+e.table_dom+'" ></table></div>'},dialog_grid_toolbar:function(e){var t="";return e.forEach(function(e){t+=Strack.toolbar_dom_build(e)}),t},toolbar_dom_build:function(e){var t="";return"button"===e.type&&(t+='<a href="javascript:;" class="easyui-linkbutton" iconCls="'+e.icon+'" plain="true" onclick="'+e.obj+'(this);">'+e.title+"</a>"),t},dialog_custom_field:function(){var e="";return e+='<div class="stdg-add-field"><div class="stdg-field-left aign-left"><div class="stdg-left-header">'+StrackLang.Field_Type+'</div><div id="stdg_fd_list" class="stdg-left-wrap"></div></div><div class="stdg-field-right aign-left"><div id="stdg_fd_title" class="stdg-right-header">'+StrackLang.Please_One_Field_Type+'</div><div id="stdg_fd_main" class="stdg-right-wrap"></div></div></div>'},dialog_add_entity_task:function(e){var t="",a=Strack.dialog_form([{case:2,id:"Mentity",lang:e,name:"entity_ids",valid:"1"},{case:2,id:"Mstep",lang:StrackLang.Step,name:"step_ids",valid:"1"}]),e=Strack.dialog_form([{case:2,id:"Nup_fields",type:"text",lang:StrackLang.Fields,name:"fields",valid:1,value:""}]);return t+='<div class="stdg-etask-wrap"><div class="stdg-etask-left"><div class="stdg-etask-l-input">'+a+'</div><div id="stdg_etask_list" class="stdg-etask-l-list"><div class="datagrid-empty-no">'+StrackLang.Please_Select_Step+'</div></div></div><div class="stdg-etask-right"><div class="etask-right-null"><div class="datagrid-empty-no">'+StrackLang.Please_Select_Base+'</div></div><div class="etask-right-main"><div class="etask-right-input">'+e+'</div><div class="st-dialog-up"><ul id="st_dialog_item" class="dg-report-list"></ul></div></div></div></div>'},remove_entity_step_task:function(e){var t=$(e).closest(".stdg-etask-l-item"),a=t.attr("id"),i=t.attr("data-stepcode"),d=t.attr("data-stepid"),r=$(e).closest(".etask-l-lists");t.remove(),Strack.reset_entity_step_task_data({type:"remove",param:{id:d,code:i},step_code:i,md5_name:a}),0===r.find(".stdg-etask-l-item").length&&(e=$(e).data("step"),$("#"+e).combobox("unselect",d))},remove_entity_step_task_group:function(e,t){$("#etask_g_"+t.code).remove(),Strack.check_entity_step_task_list(e)},copy_entity_step_task:function(e){var t=$(e).closest(".stdg-etask-l-item"),a=(t.attr("id"),t.attr("data-stepcode")),i=t.attr("data-stepid"),d={step_id:$(e).data("step"),list_id:$(e).data("list"),combox_id:$(e).data("combox"),edit_id:$(e).data("edit")},r=$(e).data("md5name"),e=Strack.check_item_operate_fields("#"+d.combox_id,"#"+d.edit_id);Strack.G.entityStepTaskAddData.data[a][r]=e.up_data,e.allow_up&&t.after(Strack.entity_step_task_item_dom(d,{id:i,code:a,md5_name:r},"new"))},add_entity_step_task_group:function(e,t,a){var i,d=Strack.entity_step_task_item_dom(e,t,a),e=$("#"+e.list_id);0===e.find(".etask-l-list-g").length&&e.empty(),"new"!==a&&0<(i=$("#etask_g_"+t.step_code)).length?i.find(".etask-l-lists").append(d):e.append(Strack.entity_step_task_group_dom(t,d,a))},entity_step_task_item_dom:function(e,t,a){var i="",d="new"===a?t.code+"_"+Math.floor(1e4*Math.random()+1):t.code,r="new"===a?t.code:t.step_code;return i+='<div id="'+d+'" class="stdg-etask-l-item" data-stepcode="'+r+'" data-stepid="'+t.id+'"><a href="javascript:;" class="etask-l-item-bnt etask-l-remove" onclick="Strack.remove_entity_step_task(this)" title="'+StrackLang.Delete+'" data-step="'+e.step_id+'"><i class="icon-uniE6DB"></i></a><a href="javascript:;" class="etask-l-item-bnt etask-l-copy" onclick="Strack.copy_entity_step_task(this)" title="'+StrackLang.Copy+'" data-md5name="'+d+'" data-combox="'+e.combox_id+'" data-step="'+e.step_id+'" data-list="'+e.list_id+'" data-edit="'+e.edit_id+'"><i class="icon-uniE92A"></i></a><a href="javascript:;" class="text-ellipsis etask-l-item-name" onclick="Strack.set_entity_step_task(this)" data-combox="'+e.combox_id+'" data-list="'+e.list_id+'" data-edit="'+e.edit_id+'">'+d+"</a></div>",Strack.reset_entity_step_task_data({type:"add",param:t,step_code:r,md5_name:d,mode:a}),i},reset_entity_step_task_data:function(t){var e,a;if("add"===t.type)Strack.G.entityStepTaskAddData.data.hasOwnProperty(t.step_code)||(Strack.G.entityStepTaskAddData.data[t.step_code]={}),"old"!==t.mode&&(t.param.md5_name&&$("#"+t.param.md5_name).hasClass("etask-l-active")?(e=Strack.G.entityStepTaskAddData.data[t.step_code][t.param.md5_name],a=[],e.base.forEach(function(e){0<=$.inArray(e.field,["base-name","base-code"])&&(e.value=t.md5_name),a.push(e)}),e.base=a,Strack.G.entityStepTaskAddData.data[t.step_code][t.md5_name]=e):Strack.G.entityStepTaskAddData.data[t.step_code][t.md5_name]={base:[{field:"base-name",field_type:"built_in",value:t.md5_name,variable_id:0},{field:"base-code",field_type:"built_in",value:t.md5_name,variable_id:0}]});else if("remove"===t.type){var i,d=Strack.G.entityStepTaskAddData.data[t.step_code],r={};for(i in d)t.md5_name!==i&&(r[i]=d[i]);Strack.G.entityStepTaskAddData.data[t.step_code]=r}},entity_step_task_group_dom:function(e,t,a){var i="",d="new"===a?e.name:e.step_name;return i+='<div id="etask_g_'+("new"===a?e.code:e.step_code)+'" class="etask-l-list-g"><div class="etask-l-list-title text-ellipsis">'+d+'</div><div class="etask-l-lists">'+t+"</div></div>"},set_entity_step_task:function(e){var t=$(e).closest(".stdg-etask-l-item"),a=t.attr("id"),i=t.attr("data-stepcode"),d=$(e).data("list"),r=$(e).data("combox"),o=$(e).data("edit"),n=$("#"+d),s=$("#"+o),l=n.find(".etask-l-active"),c=!0;if(0<l.length?(e=l.attr("id"),d=l.attr("data-stepcode"),c=(r=Strack.check_item_operate_fields("#"+r,"#"+o)).allow_up,Strack.G.entityStepTaskAddData.data[d][e]=r.up_data):("m_review_task_item"===o&&$("#step_task_details").show(),$(".etask-right-null").hide(),$(".etask-right-main").show()),c){n.find(".stdg-etask-l-item").removeClass("etask-l-active"),t.addClass("etask-l-active"),l.addClass("form_ok");var _=Strack.G.entityStepTaskAddData.data[i][a],m={};if($.isEmptyObject(_))m["base-name"]=a,m["base-code"]=a;else for(var u in _)_[u].forEach(function(e){m[e.field]=e.value});$(".form-tip").remove(),s.find(".field_edit_item").each(function(){var e=$(this).attr("data-editor"),t=$(this).attr("data-field"),a=$(this).attr("data-multiple");if(m.hasOwnProperty(t))switch(e){case"combobox":"yes"===a?$(this).combobox("setValues",m[t]):$(this).combobox("setValue",m[t]);break;case"datebox":$(this).datebox("setValue",m[t]);break;case"checkbox":"yes"===m[t]?$(this).attr("checked","checked"):$(this).attr("checked","");break;default:$(this).val(m[t])}else switch(e){case"combobox":$(this).combobox("clear");break;case"datebox":$(this).datebox("clear");break;case"checkbox":$(this).attr("checked","");break;default:$(this).val("")}})}else l.removeClass("form_ok")},check_entity_step_task_list:function(e){e=$("#"+e.list_id);0===e.find(".etask-l-list-g").length&&(e.empty().append('<div class="datagrid-empty-no">'+StrackLang.Please_Select_Step+"</div>"),$(".etask-right-main").hide(),$(".etask-right-null").show())},dialog_avatar:function(e,t){var a="";return a+='<div class="up-avatar"><header id="crop_avatar_js"></header><div class="user-avatar">'+$("#"+e.user_data.dom_id).html()+'</div><div class="user-avatar-wrap"><span class="avatar-w-title"><p>'+e.lang+'</p></span></div></div><div class="crop-avatar-wrap"><div class="crop-avatar-img"></div><div class="crop-avatar-view"><div class="avatar-view-sm1"></div><div class="avatar-view-sm2"></div><div class="avatar-view-sm3"></div></div><div class="crop-avatar-footer"><a href="javascript:;" class="file">'+StrackLang.Select_Image_File+'<input id="img_upload" type="file" name="" id=""></a><div class="user-avatar-button">'+Strack.dialog_button(0,t)+"</div></div></div>"},dialog_button:function(e,t){for(var a="",i=e;i<t.length;i++){switch(t[i].type){case 1:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsub" onclick="obj.'+t[i].obj+'();">';break;case 2:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgcel" onclick="obj.'+t[i].obj+'();">';break;case 3:a+='<a href="javascript:;" id="'+t[i].id+'" class="st-dialog-button button-dgcel">';break;case 4:a+='<a href="javascript:;" class="st-dialog-button file">'+StrackLang.Select_Image_File+'<input id="img_up_bnt" type="file" name="">';break;case 5:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsub" onclick="Strack.'+t[i].obj+'(this);">';break;case 6:a+='<input id="'+t[i].obj+'" class="aign-left" name="'+t[i].obj+'" type="file" multiple="true">';break;case 7:a+='<a href="javascript:;" class="st-dialog-button st-button-base stdown-filter project_filter" onclick="Strack.'+t[i].obj+"(this,"+t[i].value[3]+","+t[i].value[0]+","+t[i].value[1]+","+t[i].value[2]+');" data-dtype="'+t[i].value[3]+'" data-height="'+t[i].value[1]+'">'+t[i].title+'<i class="dropdown icon project_filter"></i></a>';break;case 8:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgcel" onclick="Strack.'+t[i].obj+'(this);">';break;case 9:a+='<div id="dailog_error" class="dailog-error aign-left" style="width:'+t[i].width+'"><div class="error-icon aign-left icon-left"><i class="icon-uniEA30"></i></div><div class="error-notice aign-left text-ellipsis"></div></div>';break;case 10:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgcel" onclick="Strack.'+t[i].obj+'(this);" data-tab="prev">';break;case 11:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsub" onclick="Strack.'+t[i].obj+'(this);" data-tab="next">';break;case 12:a+='<div class="dailog-upexcel aign-left"><input id="'+t[i].obj+'" class="aign-left" name="'+t[i].obj+'" type="file" multiple="true"></div>';break;case 13:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsstop" onclick="obj.'+t[i].obj+'();">';break;case 14:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsstop" onclick="Strack.'+t[i].obj+'();">';break;default:a+='<a href="javascript:;" class="st-dialog-button st-button-base button-dgsub" onclick="obj.'+t[i].obj+'();">'}[7,9].indexOf(t[i].type)<0&&(a+=t[i].title,a+="</a>")}return a},dialog_relationship_item:function(){var e=Math.floor(1e3*Math.random()+1),t=$("#Mmodule_id").val(),a=$("#hide_temp_id").val();return $("#st_relationship").append(Strack.dialog_items({case:108,index:e,module_id:t})),Strack.combobox_widget("#first_"+e,{url:StrackPHP.getRelationshipModuleList,valueField:"id",textField:"name",width:160,value:t,queryParams:{module_id:t,template_id:a,type:"entity",position:"first"}}),Strack.combobox_widget("#second_"+e,{url:StrackPHP.getRelationshipModuleList,valueField:"id",textField:"name",width:160,queryParams:{module_id:t,template_id:a,type:"entity",position:"second"}}),e},dialog_items:function(e){var t=e.case,a="",i="";switch(e.mask&&(i=e.mask),t){case 1:a='<input id="'+e.id+'" class="dialog-widget-val" data-widget="input" type="'+e.type+'" autocomplete="off" data-name="'+e.name+'" data-valid="'+e.valid+'" value="'+e.value+"\" data-inputmask=\"'alias':'"+i+"'\">";break;case 2:a='<input id="'+e.id+'" class="dialog-widget-val" data-widget="widget" data-name="'+e.name+'" data-valid="'+e.valid+'" >';break;case 3:a='<div class="dialog-json-editor"><div id="'+e.id+'" class="dialog-widget-val" data-widget="json" data-name="'+e.name+'" data-valid="'+e.valid+'"></div></div>';break;case 4:a='<div id="'+e.id+'" class="dialog-widget-val" data-widget="datalist" data-name="'+e.name+'" ></div>';break;case 5:a='<div class="template-columns-wrap" ><div class="template-columns-item template-margin" ><div id="template-field" ></div></div><div class="template-columns-item" ><table id="template-columns" ></table></div></div>';break;case 6:a+='<a class="admin-softicon-amd" href="javascript:;" onclick="obj.'+e.name+"("+e.sid+');">',a+='<img class="admin-softicon-md" src="'+StrackPHP.UPLOADS+"/SoftwareIcon/"+e.value+'.jpg">',a+="</a>";break;case 7:a='<textarea id="'+e.id+'" class="dialog-widget-val" data-widget="textarea" data-name="'+e.name+'" data-valid="'+e.valid+'">'+e.value+"</textarea>";break;case 8:a+='<div id="'+e.id+'" data-name="'+e.name+'" data-valid="'+e.valid+'"><div class="'+e.value+'"></div></div>';break;case 9:a+='<div id="queue" class="img_queue"></div>';break;case 10:a+='<div style="" class="st-dialog-tags"><input id="'+e.id+'" class="combo-tags dialog-widget-val" data-widget="tags" data-name="'+e.name+'" placeholder="'+StrackLang.InputTag+'" style="width: calc(100% - 10px); padding: 2px 5px 3px;"></div>';break;case 11:a+='<div id="queue" class="single_queue"></div>';break;case 12:a='<div class="template-columns-wrap" ><div class="template-columns-item" ><input id="h_relationship_search"><table id="h_relationship_src" ></table></div><div class="template-columns-bnt"><a href="javascript:;" class="move-bnt" onclick="Strack.remove_h_relate_set(this)"><i class="icon-uniF100"></i></a><a href="javascript:;" class="move-bnt" onclick="Strack.move_to_h_relation_panel(this)"><i class="icon-uniF101"></i></a></div><div class="template-columns-item" ><table id="h_relationship_dst" ></table></div></div>';break;case 14:a='<div id="dialog_img_list" class="dialog-imgs"></div>';break;case 101:a='<input id="'+e.id+'" class="dialog-widget-val" data-widget="input" type="'+e.type+'" data-name="'+e.name+'"  data-valid="'+e.valid+'" value="'+e.value+'">';break;case 102:a='<div id="'+e.id+'" class="hidden"></div>';break;case 103:a='<div id="dg_comb_list" class="dg-comb-list"></div>';break;case 104:a='<div id="dg_comb_display" class="dg-cb-display"><div class="dgcb-disp-name aign-left">'+StrackLang.Summafield+'</div><div class="dgcb-disp-input aign-left"><input id="Fdgcb_field" ></div><div class="dgcb-cal-name aign-left">'+StrackLang.Calculation+'</div><div class="dgcb-cal-input aign-left"><input id="Fdgcb_cal" ></div></div>';break;case 105:a='<div id="dg_comb_query" class="dg-cb-query"><div class="dgcb-query-all"><div class="query-all-name aign-left">'+StrackLang.ConditionalLogic+'</div><div class="query-all-input aign-left"><input id="logic_comb"></div><a href="javascript:;" onclick="Strack.add_filter_group(this)" class="query-all-btn aign-left"><i class="icon-uniEA33"></i>'+StrackLang.AddFilterGroup+'</a></div><div id="dgcb_qwrap" class="dgcb-query-wrap"></div></div>';break;case 106:a='<div class="st-dialog-items"><div class="st-dialog-name">'+e.lang+'</div><div id="shang_'+e.index+'" class="st-dialog-input" data-name="'+e.index+'" style="overflow: hidden;"><div class="input-left aign-left"><input  id="sort_'+e.index+'" autocomplete="off" type="text"></div><div class="input-right aign-left"><input id="sort_'+e.index+'_func" autocomplete="off" type="text"></div></div></div>';break;case 107:a='<div class="template-columns-wrap" ><div class="template-columns-item template-margin" ><div id="template_field" ></div></div><div class="template-columns-item" ><input id="m_view_id" value="0" type="hidden"/><div class="st-dialog-items"><div class="st-dialog-name">'+StrackLang.Name+'</div><div class="st-dialog-input"><input id="m_view_name" /></div></div><div class="st-dialog-items"><div class="st-dialog-name">'+StrackLang.Public+'</div><div class="st-dialog-input"><input id="m_view_share" /></div></div></div></div>';break;case 108:a='<div class="st-dialog-items"><div class="st-dialog-input" data-name="'+e.index+'" style="overflow: hidden;"><div class="input-left aign-left"><input  id="first_'+e.index+'" autocomplete="off" type="text"></div><div class="input-right aign-left"><input id="second_'+e.index+'" autocomplete="off" type="text"></div><a href="javascript:;" class="a-close-bnt aign-left" onclick="Strack.remove_parent(this)"><i class=" icon-uniE6DB"></i></a></div></div>';break;case 109:a='<div id="dg_status_comb_list" class="dg-comb-list"></div>';break;case 110:a='<div id="dg_express_setting" class="dg-express-setting"><div class="dg-express-list"><div class="exp-list-wrap"></div><a href="javascript:;" class="exp-bnt exp-bnt-orange aign-left" onclick="Strack.add_new_custom_operator_express(this)" data-moduleid="'+e.module_id+'" data-projectid="'+e.project_id+'"><i class="icon-uniEA85"></i></a><a href="javascript:;" class="exp-bnt exp-bnt-blue aign-left" onclick="Strack.add_new_custom_field_express(this)" data-moduleid="'+e.module_id+'" data-projectid="'+e.project_id+'"><i class="icon-uniE680"></i></a></div><div class="dg-express-show"></div></div>';break;default:a="404"}return a},dialog_base_item:function(e,t){var a='<div class="st-dialog-items">',i=0<t.valid.length?"required":"";switch(parseInt(t.case)){case 103:a+='<div class="st-dialog-name '+i+'"><div class="g-comb-name aign-left">'+e+'</div><a href="javascript:;" onclick="Strack.add_cf_comb_item(this)" class="dg-comb-add aign-left"><i class="icon-uniEA33 icon-right"></i></a></div>';break;case 109:a+='<div class="st-dialog-name '+i+'"><div class="g-comb-name aign-left">'+e+'</div><a href="javascript:;" onclick="Strack.add_cf_status_comb_item(this)" class="dg-comb-add aign-left"><i class="icon-uniEA33 icon-right"></i></a></div>';break;default:a+='<div class="st-dialog-name '+i+'">'+e+"</div>"}return a+='<div class="st-dialog-input">'+Strack.dialog_items(t)+"</div></div>"},fill_slider_page_param:function(e){$("#datagrid_slider_action,#grid_slider_af_settlement_bnt,#grid_slider_jj_settlement_bnt,#grid_slider_cf_settlement_bnt").attr("data-moduleid",e.module_id).attr("data-projectid",e.project_id).attr("data-linkid",e.item_id),$("#grid_slider_af_settlement_bnt,#grid_slider_jj_settlement_bnt,#grid_slider_cf_settlement_bnt").removeClass(function(e,t){return(t.match(/(^|\s)settlement_bnt_\S+/g)||[]).join(" ")}),$("#grid_slider_af_settlement_bnt").addClass("settlement_bnt_af_"+e.item_id),$("#grid_slider_jj_settlement_bnt").addClass("settlement_bnt_jj_"+e.item_id),$("#grid_slider_cf_settlement_bnt").addClass("settlement_bnt_cf_"+e.item_id),$("#datagrid_top_fields_config,#datagrid_main_fields_config").attr("data-id",e.item_id).attr("data-page",e.page).attr("data-moduleid",e.module_id).attr("data-modulecode",e.module_code).attr("data-projectid",e.project_id).attr("data-templateid",e.template_id)},open_datagrid_slider:function(e){var t=$("#datagrid_slider");t.show().addClass("grid-slider-in"),$("#datagrid_slider_mask").show(),Strack.fill_slider_page_param(e),Strack.G.gridSliderParam=e,Strack.init_breadcrumb("datagrid_slider_breadcrumb",e),Strack.get_datagrid_slider_thumb(e),Strack.get_datagrid_slider_topinfo(e),e.position="grid_slider",Strack.init_tab_list("grid_slider_tab",e,function(e){var t=null;$.isEmptyObject(Strack.G.gridSliderActiveTab)?e.forEach(function(e){t=t||e}):t=Strack.G.gridSliderActiveTab,Strack.show_datagrid_slider_tab(t)}),t.hasClass("init-active")||(t.addClass("init-active"),Strack.init_grid_resize_envent(t)),setTimeout(function(){t.removeClass("grid-slider-in")},300)},close_datagrid_slider:function(e){var t=$("#datagrid_slider");t.addClass("grid-slider-out"),Strack.G.gridSliderParam={},Strack.remove_task_repeat_editor(),$("body").hasClass("schedule")&&Strack.reload_fullCalendar_data("scheduler_my_index"),setTimeout(function(){t.hide().removeClass("grid-slider-out"),$("#datagrid_slider_mask").hide()},500)},get_datagrid_slider_thumb:function(t){$.ajax({type:"POST",url:StrackPHP.getDetailTopThumb,data:t,dataType:"json",beforeSend:function(){$("#grid_slider_thumb").prepend(Strack.loading_dom("white","","slider_thumb"))},success:function(e){e=e.data;e.link_id=t.item_id,e.module_id=t.module_id,e.param.icon="icon-uniE61A",Strack.thumb_media_widget("#grid_slider_thumb",e,{modify_thumb:t.rule_side_thumb_modify,clear_thumb:t.rule_side_thumb_clear}),$("#st-load_slider_thumb").remove()}})},get_datagrid_slider_topinfo:function(t){t.category="top_field";var a=$("#grid_slider_tg_bnt"),i=$("#grid_slider_af_settlement_bnt"),d=$("#grid_slider_jj_settlement_bnt"),r=$("#grid_slider_cf_settlement_bnt");a.hide(),i.hide(),d.hide(),r.hide(),Strack.G.sliderTopfieldsRequestParam={id:"#grid_slider_top_info",mask:"top_info",pos:"min",url:StrackPHP.getModuleItemInfo,data:t,loading_type:"white"},Strack.load_info_panel(Strack.G.sliderTopfieldsRequestParam,function(e){a.removeClass(function(e,t){return(t.match(/(^|\s)time_log_bnt_\S+/g)||[]).join(" ")}),a.attr("data-linkid",t.item_id).attr("data-moduleid",t.module_id).addClass("time_log_bnt_"+t.item_id),"base"===t.module_code&&("yes"===e.is_my_task&&(a.show(),Strack.init_timelog_bnt("#grid_slider_tg_bnt",e.timelog)),"yes"===e.af_settlement_bnt&&(i.html(Strack.show_application_for_settlement_lang(e.assignee_id,e.reviewed_id)),i.attr("data-eq",e.assignee_eq_reviewed),i.show()),"yes"===e.jj_settlement_bnt&&(d.attr("data-eq",e.assignee_eq_reviewed),d.show()),"yes"===e.cf_settlement_bnt&&(r.attr("data-eq",e.assignee_eq_reviewed),r.show()))})},reset_my_schedule:function(e){e=$(e).closest(".my-scheduler-index").attr("id");Strack.reload_fullCalendar_data(e)},show_application_for_settlement_lang:function(e,t){return e===t?StrackLang.Confirmation_For_Settlement:StrackLang.Application_For_Settlement},application_for_settlement:function(t,e){e.stopPropagation(),e.preventDefault();e={link_id:$(t).attr("data-linkid"),module_id:$(t).attr("data-moduleid"),assignee_eq_reviewed:$(t).attr("data-eq"),type:"apply"};Strack.submit_base_confirmation_data(e,function(e){200===parseInt(e.status)?Strack.Websocket.List.hasOwnProperty("update")||(Strack.refrash_confirmation_bnt_show(t,"apply"),Strack.reset_my_schedule(t)):layer.msg(e.message,{icon:7,time:1200,anim:6})})},reject_for_settlement:function(a,e){e.stopPropagation(),e.preventDefault();var i=$(a).attr("data-linkid"),d=$(a).attr("data-moduleid"),r=$(a).attr("data-eq");Strack.get_media_server(function(t){Strack.open_dialog("dialog",{title:StrackLang.Reasons_For_Refusal,width:440,height:340,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mlink_id",type:"hidden",name:"link_id",valid:1,value:i},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:d},{case:101,id:"Massignee_eq_reviewed",type:"hidden",name:"assignee_eq_reviewed",valid:1,value:r},{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:"reject"}],items:[{case:7,id:"Mreject_txt",type:"text",lang:StrackLang.Content,name:"reject_txt",valid:0,value:""},{case:11,id:"Mmedia_queue",type:"text",lang:StrackLang.Media_Attachment,name:"media_queue",valid:0,value:""}],footer:[{obj:"choice_media",type:6,title:""},{obj:"submit_reject_for_settlement",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$("#choice_media").uploadifive({auto:!1,token:t.token,formData:{timestamp:Strack.current_time(),belong_system:StrackPHP.Belong_System,size:"250x140"},multi:!0,queueSizeLimit:0,queueID:"queue",uploadScript:t.upload_url,onUpload:function(e){0==e?layer.msg(StrackLang.Please_Select_File,{icon:2,time:1200,anim:6}):$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},onUploadComplete:function(e,t){t=JSON.parse(t);200===parseInt(t.status)&&Strack.G.Note_Uploadifive_Imgs.push(t.data)},onQueueComplete:function(){var e={link_id:i,module_id:d,text:$("#Mreject_txt").val(),type:"reject",media_data:{media_server:t,images:Strack.G.Note_Uploadifive_Imgs}};Strack.submit_base_confirmation_data(e,function(e){200===parseInt(e.status)?Strack.dialog_cancel():layer.msg(e.message,{icon:7,time:1200,anim:6})})}})},close:function(){Strack.Websocket.List.hasOwnProperty("update")||(Strack.refrash_confirmation_bnt_show(a,"reject"),Strack.reset_my_schedule(a)),Strack.G.Note_Uploadifive_Imgs=[]}})},function(e){Strack.open_dialog("dialog",{title:StrackLang.Reasons_For_Refusal,width:440,height:340,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mlink_id",type:"hidden",name:"link_id",valid:1,value:i},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:d},{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:"reject"}],items:[{case:7,id:"Mreject_txt",type:"text",lang:StrackLang.Content,name:"reject_txt",valid:0,value:""}],footer:[{obj:"submit_reject_for_settlement",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){},close:function(){Strack.Websocket.List.hasOwnProperty("update")||(Strack.refrash_confirmation_bnt_show(a,"reject"),Strack.reset_my_schedule(a)),Strack.G.Note_Uploadifive_Imgs=[]}})})},submit_reject_for_settlement:function(){var e;0<$(".uploadifive-queue-item").length?$("#choice_media").uploadifive("upload"):(e={link_id:$("#Mlink_id").val(),module_id:$("#Mmodule_id").val(),text:$("#Mreject_txt").val(),type:"reject"},Strack.submit_base_confirmation_data(e,function(e){200===parseInt(e.status)?Strack.dialog_cancel():layer.msg(e.message,{icon:7,time:1200,anim:6})}))},confirmation_for_settlement:function(t,e){e.stopPropagation(),e.preventDefault();e={link_id:$(t).attr("data-linkid"),module_id:$(t).attr("data-moduleid"),assignee_eq_reviewed:$(t).attr("data-eq"),type:"confirm",media_data:{}};Strack.submit_base_confirmation_data(e,function(e){200===parseInt(e.status)?Strack.Websocket.List.hasOwnProperty("update")||(Strack.refrash_confirmation_bnt_show(t,"confirm"),Strack.reset_my_schedule(t)):layer.msg(e.message,{icon:7,time:1200,anim:6})})},refrash_confirmation_bnt_show:function(e,t){var a=$(e).attr("data-from"),i=a?$("#"+a+"_slider_af_settlement_bnt"):$("#slider_af_settlement_bnt"),d=a?$("#"+a+"_slider_jj_settlement_bnt"):$("#slider_jj_settlement_bnt"),a=a?$("#"+a+"_slider_cf_settlement_bnt"):$("#slider_cf_settlement_bnt");i.hide(),d.hide(),a.hide(),console.log(a);a=$(e).closest("#tools_slider_inbox");0<a.length&&(e="",a.find("#slider_msg_tab_all").hasClass("active")&&(e="all"),a.find("#slider_msg_tab_at_me").hasClass("active")&&(e="at_me"),Strack.load_side_inbox(e)),"reject"===t&&i.show()},submit_base_confirmation_data:function(e,t){$.ajax({type:"POST",url:StrackPHP.updateBaseConfirmationData,data:JSON.stringify(e),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),t(e)}})},show_datagrid_slider_tab:function(e){if(e){Strack.G.gridSliderActiveTab=e,Strack.active_select_tab("grid_slider_tab",e.tab_id),$(".grid-slider-main .pitem-wrap").hide();var t=[],a=Strack.deep_copy(Strack.G.gridSliderParam),i=$("#grid_slider_datagrid_add_bnt"),d=$("#grid_slider_datagrid_related_bnt");switch(i.show(),d.hide(),e.type){case"fixed":if(0<=$.inArray(e.tab_id,["correlation_base","file_commit","file","base"])){switch($("#grid_slider_tab_table").show(),e.tab_id){case"base":t=[{field:"id",field_type:"built_in",editor:"combobox",value:a.item_id,condition:"NEQ",module_code:e.module_code,table:"Base"}];break;case"file":case"file_commit":t=[{field:"module_id",field_type:"built_in",editor:"combobox",value:a.module_id,condition:"EQ",module_code:e.tab_id,table:"File"},{field:"link_id",value:a.item_id,condition:"EQ",module_code:e.tab_id,table:"File"}];break;case"correlation_base":t=[{field:"id",field_type:"built_in",editor:"combobox",value:a.item_id,condition:"NEQ",module_code:a.module_code,table:"Base"},{field:"entity_id",field_type:"built_in",editor:"combobox",value:a.entity_id,condition:"EQ",module_code:a.module_code,table:"Base"}]}Strack.load_grid_slider_grid_data(a,e,t)}else switch($("#grid_slider_tab_"+e.tab_id).show(),e.tab_id){case"note":Strack.grid_slider_note_panel();break;case"info":Strack.grid_slider_info_panel();break;case"history":Strack.grid_slider_history_panel();break;case"onset":Strack.grid_slider_onset_panel();break;case"onset_att":Strack.grid_slider_onset_att_panel()}break;case"entity_child":case"horizontal_relationship":case"be_horizontal_relationship":$("#grid_slider_tab_table").show(),"be_horizontal_relationship"===e.type?i.hide():d.show(),Strack.load_grid_slider_grid_data(a,e,t);break;case"other_page":$("#grid_slider_tab_iframe_page").show(),"cloud_disk"===e.tab_id&&Strack.grid_slider_cloud_disk_panel()}}},add_grid_slider_item:function(e){var t=Strack.G.gridSliderActiveTab,a=Strack.deep_copy(Strack.G.gridSliderParam);"fixed"===t.type?Strack.item_operate_dialog(t.name,{mode:"create",field_list_type:["edit"],from_item_id:a.item_id,from_module_id:a.module_id,module_id:t.module_id,project_id:a.project_id,page:a.page,schema_page:"project_"+t.module_code,type:"add_panel",keep_panel:!0},function(){$("#grid_slider_datagrid_box").datagrid("reload")}):Strack.item_operate_dialog(t.name,{mode:"create_related",field_list_type:["edit"],from_item_id:a.item_id,from_module_id:t.module_id,module_id:t.dst_module_id,project_id:a.project_id,horizontal_type:t.horizontal_type,variable_id:t.variable_id,page:a.page,schema_page:"project_"+t.module_code,type:"add_panel",keep_panel:!0},function(){$("#grid_slider_datagrid_box").datagrid("reload")})},related_grid_slider_item:function(e){var t=Strack.G.gridSliderActiveTab,a=Strack.deep_copy(Strack.G.gridSliderParam),t={project_id:a.project_id,grid_id:"grid_slider_datagrid_box",variable_id:t.variable_id,src_module_id:t.module_id,dst_module_id:t.dst_module_id,src_link_id:a.item_id,horizontal_type:t.horizontal_type,link_data:[],from:"toolbar"};Strack.open_h_relationship_dialog(t)},delete_grid_slider_item:function(e){var t,a,i=Strack.G.gridSliderActiveTab,d=Strack.deep_copy(Strack.G.gridSliderParam),r="Delete_"+Strack.string_ucwords(i.module_code)+"_Notice",o=0,n=0;"fixed"===i.type?(t=i.module_id,a=i.module_code):(t=i.dst_module_id,a=i.dst_module_code,o=d.item_id,n=d.module_id),Strack.ajax_grid_delete("grid_slider_datagrid_box","id",StrackLang[r],StrackPHP.deleteGridData,{from_item_id:o,from_module_id:n,lang:i.name,module_code:a,module_id:t,module_type:i.type,page:d.page,project_id:d.project_id,rule_side_thumb_clear:d.rule_side_thumb_clear,rule_side_thumb_modify:d.rule_side_thumb_modify,rule_tab_base:d.rule_tab_base,rule_tab_cloud_disk:d.rule_tab_cloud_disk,rule_tab_correlation_task:d.rule_tab_correlation_task,rule_tab_file:d.rule_tab_file,rule_tab_file_commit:d.rule_tab_file_commit,rule_tab_history:d.rule_tab_history,rule_tab_horizontal_relationship:d.rule_tab_horizontal_relationship,rule_tab_info:d.rule_tab_info,rule_tab_notes:d.rule_tab_notes,rule_tab_onset:d.rule_tab_onset,rule_template_fixed_tab:d.rule_template_fixed_tab,schema_page:"project_"+i.module_code,template_id:d.template_id})},grid_slider_note_panel:function(){var e=Strack.deep_copy(Strack.G.gridSliderParam);e.status="new",e.page_number=1,e.page_size=20,Strack.load_notes({page_id:"#slider_note_list",content_id:".grid-slider-main",avatar_id:"",editor_id:"grid_slider_comments_editor",list_id:"grid_slider_comments_list",tab_id:".grid_slider_tab",details_top_bar:!1,tab_bar_id:""},e)},grid_slider_info_panel:function(){var e=Strack.deep_copy(Strack.G.gridSliderParam);e.category="main_field",Strack.G.sliderMainfieldsRequestParam={id:"#grid_slider_info_main",mask:"main_info",pos:"max",url:StrackPHP.getModuleItemInfo,data:e,loading_type:"white"},Strack.load_info_panel(Strack.G.sliderMainfieldsRequestParam)},get_endpoints_heatly:function(a,i,t){$.ajax({url:i.check_url+"/login/check_status",type:"HEAD",timeout:3e3,success:function(e){console.log("成功：",i.check_url),$.isEmptyObject(i)||Strack.generate_check_cloud_token(i,t,function(e,t){0===parseInt(e.status)?$.ajax({type:"POST",url:StrackPHP.frontendCheckCouldDiskServer,data:JSON.stringify({type:"back",data:e.data,param:a,fast_endpoints:i}),dataType:"json",contentType:"application/json",success:function(e){200===parseInt(e.status)&&$(a.dom_id).empty().append(' <iframe src="'+e.data.url+'" name="cloud_disk_iframe" class="page-iframe-base page-iframe-wh-100"></iframe>'),$("#st-load_slider_iframe_page_load").remove()}}):(console.log(e.message),$("#st-load_slider_iframe_page_load").remove())})},error:function(){console.log("失败：",data.check_url)}})},generate_check_cloud_token:function(e,t,a){$.ajax({type:"POST",url:e.check_url+"/login/generate_check_cloud_token",data:JSON.stringify({login:{login_name:e.login_name,password:e.password},user_data:t}),dataType:"json",contentType:"application/json",success:function(e){a(e,t)}})},check_cloud_disk_endpoints:function(e,a){$.ajax({type:"POST",url:StrackPHP.frontendCheckCouldDiskServer,data:{type:"check"},beforeSend:function(){$(e).prepend(Strack.loading_dom("white","","slider_iframe_page_load"))},success:function(e){for(var t in e.endpoints)Strack.get_endpoints_heatly(a,e.endpoints[t],e.user_data)}})},grid_slider_cloud_disk_panel:function(){var e=Strack.deep_copy(Strack.G.gridSliderParam);Strack.check_cloud_disk_endpoints("#grid_slider_tab_iframe_page",{dom_id:"#grid_slider_tab_iframe_page",type:"task",link_id:e.item_id})},grid_slider_onset_panel:function(){$("#grid_slider_onset_entity_not_exit,#grid_slider_onset_link_not_exit,#grid_slider_onset_info_main").hide(),Strack.get_item_onset_data(Strack.G.gridSliderParam,function(e){200===parseInt(e.status)?"yes"===e.data.has_link_onset?($("#grid_slider_onset_info_main").show(),Strack.grid_slider_load_onset_info(e.data)):($("#grid_slider_onset_link_not_exit").show(),$("#grid_slider_onset_select_module_id").val(e.data.module_id),$("#grid_slider_onset_select_entity_id").val(e.data.entity_id),$("#grid_slider_onset_select_entity_module_id").val(e.data.entity_module_id),Strack.combobox_widget("#grid_slider_onset_select_list",{url:StrackPHP.getProjectOnsetList,valueField:"id",textField:"name",width:300,height:30,queryParams:{project_id:Strack.G.gridSliderParam.project_id}})):$("#grid_slider_onset_entity_not_exit").show()})},grid_slider_onset_att_panel:function(){$("#grid_slider_onset_att_entity_not_exit,#grid_slider_onset_att_link_not_exit,#grid_slider_onset_att_link_main").hide(),Strack.get_item_onset_data(Strack.G.gridSliderParam,function(e){200===parseInt(e.status)?"yes"===e.data.has_link_onset?($("#grid_slider_onset_att_link_main").show(),Strack.grid_slider_load_onset_attachment({module_id:e.data.module_id,onset_id:e.data.onset_id})):($("#grid_slider_onset_att_link_not_exit").show(),$("#grid_slider_onset_att_select_module_id").val(e.data.module_id),$("#grid_slider_onset_att_select_entity_id").val(e.data.entity_id),$("#grid_slider_onset_att_select_entity_module_id").val(e.data.entity_module_id),Strack.combobox_widget("#grid_slider_onset_att_select_list",{url:StrackPHP.getProjectOnsetList,valueField:"id",textField:"name",width:300,height:30,queryParams:{project_id:Strack.G.gridSliderParam.project_id}})):$("#grid_slider_onset_att_entity_not_exit").show()})},add_link_onset:function(e){var t=$(e).attr("data-tab"),a=Strack.validate_form("info"===t?"grid_slider_onset_add_link_onset":"grid_slider_onset_att_add_link_onset");200===parseInt(a.status)&&$.ajax({type:"POST",url:StrackPHP.addEntityLinkOnset,data:a.data,dataType:"json",beforeSend:function(){$("#grid_slider_tab_onset_att").prepend(Strack.loading_dom("white","","onset_add"))},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),"info"===t?($("#grid_slider_onset_select_list").combobox("clear"),$("#grid_slider_onset_entity_not_exit,#grid_slider_onset_link_not_exit").hide(),$("#grid_slider_onset_info_main").show(),Strack.grid_slider_load_onset_info(e.data)):($("#grid_slider_onset_att_select_list").combobox("clear"),$("#grid_slider_onset_att_entity_not_exit,#grid_slider_onset_att_link_not_exit").hide(),$("#grid_slider_onset_att_link_main").show(),Strack.grid_slider_load_onset_attachment({module_id:a.data.onset_module_id,onset_id:a.data.onset_id}))):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_onset_add").remove()}})},grid_slider_load_onset_info:function(e){var t=Strack.deep_copy(Strack.G.gridSliderParam);t.category="detail_onset_field",t.module_id=e.entity_module_id,t.onset_id=e.onset_id,Strack.load_info_panel({id:"#grid_slider_onset_info",mask:"grid_slider_onset_info",pos:"onset",url:StrackPHP.getOnsetInfoData,data:t,loading_type:"white"},function(e){})},grid_slider_load_onset_attachment:function(e){$("#grid_slider_onset_att_bnt").attr("data-linkid",e.onset_id).attr("data-moduleid",e.module_id),Strack.load_onset_attachment("#grid_slider_onset_att_wrap",{module_id:e.module_id,link_id:e.onset_id})},grid_slider_history_panel:function(){var e=Strack.deep_copy(Strack.G.gridSliderParam);e.status="new",e.page_number=1,e.page_size=30,Strack.grid_slider_history_data(e)},grid_slider_history_data:function(a){$.ajax({type:"POST",url:StrackPHP.getDataGridSliderHistoryData,data:a,beforeSend:function(){$("#grid_slider_tab_history").prepend(Strack.loading_dom("white","","slider_history"))},success:function(e){var t=$("#grid_slider_history");"new"===a.status&&(a.total=e.total,Strack.fall_load_data("#grid_slider_history",a,function(e){a.status="more",Strack.grid_slider_history_data(ids,a)}),t.empty(),$("#st-load_slider_history").remove()),t.append(Strack.grid_slider_history_list_dom(e.rows))}})},load_grid_slider_grid_data:function(t,a,i){$.ajax({type:"POST",url:StrackPHP.getDataGridSliderTableConfig,data:JSON.stringify({tab_param:a,grid_param:t}),dataType:"json",contentType:"application/json",beforeSend:function(){$("#grid_slider_tab_table").prepend(Strack.loading_dom("white","","slider_table"))},success:function(e){200===parseInt(e.status)&&Strack.init_grid_slider_grid_data(t,a,e,i),$("#st-load_slider_table").remove()}})},init_grid_slider_grid_data:function(e,t,a,i){var d,r=i||[],o=0,i="",i="horizontal_relationship"===t.type?(o=t.dst_module_id,Strack.generate_schema_page(t.dst_module_code)):(o=t.module_id,Strack.generate_schema_page(t.module_code)),o={page:"details_"+t.tab_id,schema_page:i,module_id:o,project_id:e.project_id,item_id:e.item_id,grid_id:"grid_slider_datagrid_box",view_type:"grid"},a=Strack.generate_grid_columns_data(o,a),r={filter:{temp_fields:{add:{},cut:{}},group:a.grid.group_name,sort:a.grid.sort_config.sort_query,request:r,filter_input:a.grid.filter_config.filter_input,filter_panel:a.grid.filter_config.filter_panel,filter_advance:a.grid.filter_config.filter_advance},page:o.page,schema_page:o.schema_page,module_id:o.module_id,project_id:e.project_id,item_id:e.item_id,module_code:t.module_code,module_type:t.type,horizontal_type:t.horizontal_type,parent_module_id:e.module_id},e=$("#grid_slider_tab_table");e.hasClass("load_active")?(d={moduleId:t.module_id,projectId:o.project_id,queryParams:{filter_data:JSON.stringify(r)},panelConfig:{active_filter_id:a.grid.filter_config.filter_id},sortConfig:a.grid.sort_config,sortData:a.grid.sort_config.sort_data,renderNewPage:!0,columnsFieldConfig:a.grid.columnsFieldConfig,frozenColumns:a.grid.frozenColumns,columns:a.grid.columns},$.isEmptyObject(a.grid.group_name)||(d.groupActive=!0,d.groupField=Strack.get_grid_group_field(a.grid.group_name).field,d.groupFormatter=function(e,t){return'<span class="">'+e+"( "+t.length+" )</span>"}),$("#grid_slider_datagrid_box").datagrid("setOptions",d).datagrid("reload")):(e.addClass("load_active"),d={url:StrackPHP.getDetailGridData,height:Strack.panel_height(".grid-slider-tab-table",215),view:scrollview,rowheight:50,differhigh:!1,singleSelect:!1,adaptive:{dom:"#datagrid_slider",min_width:680,exth:215,domresize:1},ctrlSelect:!0,multiSort:!0,DragSelect:!0,moduleId:o.module_id,projectId:o.project_id,queryParams:{filter_data:JSON.stringify(r)},panelConfig:{active_filter_id:a.grid.filter_config.filter_id},sortConfig:a.grid.sort_config,sortData:a.grid.sort_config.sort_data,columnsFieldConfig:a.grid.columnsFieldConfig,frozenColumns:a.grid.frozenColumns,columns:a.grid.columns,toolbar:"#grid_slider_tb",pagination:!0,pageNumber:1,pageSize:200,pageList:[100,200,300,400,500],pagePosition:"bottom",remoteSort:!1},$.isEmptyObject(a.grid.group_name)||(d.groupActive=!0,d.groupField=Strack.get_grid_group_field(a.grid.group_name).field,d.groupFormatter=function(e,t){return'<span class="">'+e+"( "+t.length+" )</span>"}),$("#grid_slider_datagrid_box").datagrid(d).datagrid("enableCellEditing").datagrid("disableCellSelecting").datagrid("gotoCell",{index:0,field:"id"}).datagrid("columnMoving"))},grid_slider_history_list_dom:function(e){var t="";return e.forEach(function(e){t+=Strack.grid_slider_history_item_dom(e)}),t},grid_slider_history_item_dom:function(e){var t="",a="";switch(e.operate){case"update":a+=e.created_by+" "+StrackLang.Modify+" "+e.module_name+" "+e.link_name+" ( "+e.id+" )";break;case"create":a+=e.created_by+" "+StrackLang.Create+" "+e.module_name+" "+e.link_name+" ( "+e.id+" )";break;case"delete":a+=e.created_by+" "+StrackLang.Delete+" "+e.module_name+" "+e.link_name+" ( "+e.id+" )"}return t+='<div class="history-items"><div class="history-items-thumb">'+Strack.build_avatar(e.avatar.id,e.avatar.avatar,Strack.upper_first_str(e.avatar.pinyin))+'</div><div class="history-items-info"><div class="history-content text-ellipsis">'+a+'</div><div class="history-date">'+e.created+"</div></div></div>"},init_grid_resize_envent:function(t){var a,i,d,r=t.find(".grid-slider-dotted"),o=t.find(".grid-slider-wrap");t.find(".x-resizable-handle").on("mousedown",function(e){e.preventDefault(),Strack.G.onSideHandleResize=!0,$(document).on("mousemove",function(e){a=e.pageX,d=document.documentElement.clientWidth-660,a=a<=400?400:d<a?d:a,i=document.documentElement.clientWidth-a,r.show().addClass("st_wrap_dotted").css({width:i+"px"}),t.css({left:a+"px"})}).on("mouseup",function(e){$(this).off("mousemove"),r.hide().removeClass("st_wrap_dotted"),o.css({width:i+"px"}),Strack.G.onSideHandleResize=!1})})},switch_top_nav:function(e){e=$(e).attr("data-tools");switch(e){case"timelog":Strack.load_side_timelog("active");break;case"inbox":Strack.load_side_inbox("all")}$("#tools_slider_"+e).sidebar("toggle")},toggle_slider_tab:function(e){var t=$(e).attr("data-panel"),a=$(e).attr("data-tab");switch(t){case"timelog":Strack.load_side_timelog(a);break;case"inbox":Strack.load_side_inbox(a)}},load_side_inbox:function(e){$("#slider_inbox_wrap").find(".sd-msg-tab").removeClass("active"),$("#slider_msg_tab_"+e).addClass("active"),$(".slider-inbox-list").removeClass("active"),$("#slider_msg_main_"+e).addClass("active"),$("#slider_msg_refresh").attr("data-tab",e),Strack.load_side_inbox_data(e,{page_number:1,page_size:30,tab:e,status:"new"})},load_side_inbox_data:function(t,a){var e="#slider_msg_list_"+t,i=$(e).closest(".slider-inbox-main")[0],d=$(e);Strack.marked_read_message(),$.ajax({type:"POST",url:StrackPHP.getSideInboxData,dataType:"json",contentType:"application/json",data:JSON.stringify(a),beforeSend:function(){$("#slider_inbox_wrap").prepend(Strack.loading_dom("white","","inbox"))},success:function(e){"new"===a.status&&(0<e.total?(d.empty(),a.status="more",a.total=e.total,Strack.fall_load_data(i,a,function(e){Strack.load_side_inbox_data(t,a)})):d.html('<div class="datagrid-empty-no text-center">'+StrackLang.Datagird_No_Data+"</div>")),Strack.fill_inbox_list(d,e.rows),Strack.init_note_att_event("#slider_inbox_wrap"),$("#st-load_inbox").remove()}})},marked_read_message:function(){Strack.G.UnReadMessageData&&0<Strack.G.UnReadMessageData.created&&$.ajax({type:"POST",url:StrackPHP.readMessage,dataType:"json",data:{created:Strack.G.UnReadMessageData.created},success:function(e){200===parseInt(e.status)&&(Strack.G.UnReadMessageData.created=0,Strack.G.UnReadMessageData.massage_number=0,Strack.top_tool_number("#top_msg_number",0))}})},refresh_inbox_slider:function(e){e=$(e).attr("data-tab");Strack.load_side_inbox_data(e,{page_number:1,page_size:30,tab:e,status:"new"})},fill_inbox_list:function(t,e){e.forEach(function(e){t.append(Strack.inbox_list_dom(e))})},inbox_list_dom:function(e){var t="";return t+='<div class="event"><div class="label avatar avatar-show">'+Strack.build_avatar(e.sender.id,e.sender.user_avatar,Strack.upper_first_str(e.sender.pinyin))+'</div><div class="content">',t+=Strack.inbox_list_title_item_dom(e),t+=Strack.inbox_list_content_dom(e.content),t+=Strack.inbox_list_bnt_dom(e.content),t+=Strack.inbox_list_img_item_dom(e.media_data),t+="</div>"},generate_inbox_position:function(e){var t="";return e.name&&(t+='<span style="margin-right: 5px">'+StrackLang.At_Position+"</span>",e.url?t+='<a href="'+e.url+'" target="_blank" style="margin-right: 5px">'+e.name+"</a>":t+='<a href="javascript:;" style="margin-right: 5px">'+e.name+"</a>",t+="<span>"+e.module_name+"</span>"),t},generate_inbox_item_name:function(e){var t="";return e.url?t+='<a href="'+e.url+'" target="_blank" style="margin-right: 5px">'+e.item_name+"</a>":t+='<a href="javascript:;" style="margin-right: 5px">'+e.item_name+"</a>",t},inbox_list_title_item_dom:function(e){var t="",a=e.content.title;return t+='<div class="summary"><div class="title"><span class="user" style="margin-right: 5px">'+a.created_by+'</span><span style="margin-right: 5px"><strong>'+Strack.inbox_list_title_lang(e.content.operate)+"</strong></span>"+Strack.generate_inbox_item_name(a)+"<span>"+a.module_name+'</span></div><div class="date"><span style="margin-right: 5px">'+e.created+"</span>"+Strack.generate_inbox_position(e.content.position)+"</div></div>"},inbox_list_content_dom:function(e){var t="";return e.update_data&&e.update_data.content&&e.update_data.content&&(t+='<div class="b-content">'+Strack.html_decode(e.update_data.content)+"</div>"),t},check_user_inbox_list_bnt_show:function(e){return Strack.G.userId!=e.created&&(Strack.G.userId==e.reviewed_by||Strack.G.userId==e.assignee)},inbox_list_bnt_dom:function(e){var t="",a=Math.floor(1e6*Math.random()+1);e.bnt&&"apply"===e.operate&&e.bnt.forEach(function(e){switch(e.lang){case"Reject_For_Settlement":Strack.check_user_inbox_list_bnt_show(e)&&(t+='<a href="javascript:;" id="'+a+'_slider_jj_settlement_bnt" class="ui button red" onclick="Strack.reject_for_settlement(this, event)" data-linkid="'+e.link_id+'" data-moduleid="'+e.module_id+'" data-projectid="'+e.project_id+'" data-from="'+a+'" title="">'+StrackLang.Reject_For_Settlement+"</a>");break;case"Confirmation_For_Settlement":Strack.check_user_inbox_list_bnt_show(e)&&(t+='<a href="javascript:;" id="'+a+'_slider_cf_settlement_bnt" class="ui button green" onclick="Strack.confirmation_for_settlement(this, event)" data-linkid="'+e.link_id+'" data-moduleid="'+e.module_id+'" data-projectid="'+e.project_id+'" data-from="'+a+'" title="">'+StrackLang.Confirmation_For_Settlement+"</a>")}});e="";return t&&(e+='<div class="msg-bnt">'+t+"</div>"),e},inbox_list_title_lang:function(e){var t="";switch(e){case"add":t=StrackLang.Create;break;case"update":t=StrackLang.Modify;break;case"delete":t=StrackLang.Delete;break;case"apply":t=StrackLang.Application_For_Settlement;break;case"reject":t=StrackLang.Reject_For_Settlement;break;case"confirm":t=StrackLang.Confirmation_For_Settlement}return t},inbox_list_text_item_dom:function(t,e){var a,i="";return 0<e.length&&(a="",e.forEach(function(e){a+=Strack.inbox_list_item_dom(t,e)}),i+='<div class="extra text">'+a+"</div>"),i},inbox_list_item_dom:function(e,t){var a="",i="",d="";switch(e){case"add":i="info",d="blue";break;case"update":i="checkmark",d="green";break;case"delete":i="minus",d="red"}return a+='<div class="item"><i class="'+i+" box icon "+d+'"></i><a style="margin: 0 5px">'+t.field+"</a>"+t.value+"</div>"},inbox_list_img_item_dom:function(e){var t,a="";return"yes"===e.has_media&&(a+='<div class="extra images"><div class="note-att" data-id="'+(t="main_"+Math.floor(1e4*Math.random()+1))+'">'+Strack.show_note_img_att(t,e)+"</div></div>"),a},load_side_timelog:function(e){switch($("#slider_timelog_wrap").find(".sd-tg-tab").removeClass("active"),$("#slider_tg_tab_"+e).addClass("active"),$(".slider-menu-main").removeClass("active"),$("#slider_tg_main_"+e).addClass("active"),$("#slider_tg_refresh").attr("data-tab",e),Strack.G.sideTimelogParam=Strack.generate_hidden_param("#side_timelog_hidden_param"),e){case"active":$.ajax({type:"POST",url:StrackPHP.getSideTimelogMyTimer,dataType:"json",contentType:"application/json",beforeSend:function(){$("#slider_timelog_wrap").prepend(Strack.loading_dom("white","","timelog")),$("#slider_timer_list").empty()},success:function(e){e.forEach(function(e){Strack.init_active_timer(e)}),Strack.check_timer_exit(),$("#st-load_timelog").remove()}});break;case"history":Strack.load_timelog_slider_history("#slider_tg_history_list",{page_number:1,page_size:100,status:"new"})}},load_timelog_slider_history:function(a,i){$.ajax({type:"POST",url:StrackPHP.getSideTimelogMyData,dataType:"json",data:{page_number:i.page_number,page_size:i.page_size},beforeSend:function(){$("#slider_timelog_wrap").prepend(Strack.loading_dom("white","","timelog"))},success:function(e){var t=e.timelog_list;"new"===i.status&&($(a).empty(),i.status="more",i.total=t.total,Strack.fall_load_data(a,i,function(e){Strack.load_timelog_slider_history(a,i)})),Strack.fill_timelog_history_list(a,t.rows,e.timelog_group_total),$("#st-load_timelog").remove()}})},fill_timelog_history_list:function(t,e,a){var i;e.forEach(function(e){0<(i=$("#timelog_g_"+e.group)).length?i.prepend(Strack.timelog_history_item_dom(e)):$(t).append(Strack.timelog_history_group_dom(e,a[e.group]))})},timelog_history_group_dom:function(e,t){var a="";return a+='<div class="time-item-title"><div class="time-title-show"><div class="name aign-left">'+e.group_name+'</div><div class="total aign-right">'+StrackLang.Work_Hour_Total+"："+Strack.format_timer_time(t)+'</div></div></div><div id="timelog_g_'+e.group+'" class="timelog-group">'+Strack.timelog_history_item_dom(e)+"</div>"},timelog_history_item_dom:function(e){var t="";return t+='<li id="timelog_i_'+e.id+'" class="time-base-item"><div class="acrive-task-show"><div class="time-task-info aign-left"><div href="javascript:;" class="task-step text-ellipsis">'+e.title+'</div><div href="javascript:;" class="task-belog-to text-ellipsis">'+e.belong+'</div></div><div class="time-date-show aign-left"><div class="itime-total">'+Strack.format_timer_time(e.duration)+'</div><div class="itime-range">'+e.start_time+" - "+e.end_time+'</div></div><div class="time-task-close aign-left">',"yes"===Strack.G.sideTimelogParam.rule_delete&&(t+='<a href="javascript:;" onclick="Strack.delete_timelog_history_item(this);" data-timeid="'+e.id+'"><i class="icon-uniEA36"></i></a>'),t+="</div></div></li>"},refresh_timelog_slider:function(e){e=$(e).attr("data-tab");Strack.load_side_timelog(e)},generate_kanban_timelog_bnt:function(e,t){var a="";return a=t&&0<t.rows.length&&e.user_id==t.rows[0].id?Strack.init_timelog_bnt_dom(e,e.random_id,"kanban",!0):a},init_timelog_bnt:function(e,t){var a=$(e);switch(a.attr("data-from","slider"),t.color){case"red":a.attr("data-timelogid",t.id),a.removeClass("green").addClass("red"),a.html('<i class="icon-uniE974 icon-left"></i>'+StrackLang.Pause);break;case"green":a.attr("data-timelogid",0),a.removeClass("red").addClass("green"),a.html('<i class="icon-uniE974 icon-left"></i>'+StrackLang.Start)}},init_timelog_bnt_dom:function(e,t,a,i){var d="",r=i?"":"fc-h-event-";switch(e.timelog.color){case"red":d+='<div class="fc-h-event-all-day-tg aign-left"><a id="'+t+'" href="javascript:;" class="ui button basic '+r+"red time_log_bnt_"+e.item_id+'" onclick="Strack.item_start_timelog(this, event)" data-linkid="'+e.item_id+'" data-timelogid="'+e.timelog.id+'" data-moduleid="'+e.module_id+'" title="" data-id="'+t+'" data-from="'+a+'"><i class="icon-uniE974 icon-left"></i>'+StrackLang.Pause+"</a></div>";break;case"green":d+='<div class="fc-h-event-all-day-tg aign-left"><a id="'+t+'" href="javascript:;" class="ui button basic '+r+"green time_log_bnt_"+e.item_id+'" onclick="Strack.item_start_timelog(this, event)" data-linkid="'+e.item_id+'" data-timelogid="0" data-moduleid="'+e.module_id+'" title="" data-id="'+t+'" data-from="'+a+'"><i class="icon-uniE974 icon-left"></i>'+StrackLang.Start+"</a></div>"}return d},init_active_timer:function(e){var t="timer_"+Math.floor(1e4*Math.random()+1);Strack.add_side_timer_item(t,{status:"stop",time:"00:00",value:e.link_id,disabled:!0}),Strack.run_timer(t,e.timer_start);t=$("#item_"+t);t.addClass("active"),t.attr("data-timerid",e.id)},add_side_timer:function(e){var t="timer_"+Math.floor(1e4*Math.random()+1);Strack.add_side_timer_item(t,{status:"start",time:"00:00",value:"",disabled:!1})},add_side_timer_item:function(e,t){$("#slider_timer_list .datagrid-empty-no").remove(),$("#slider_timer_list").prepend(Strack.side_timer_dom(e,t));var a=(a=$("input[name=project_id]").val())||0;Strack.combobox_widget("#"+e,{url:StrackPHP.getTimeLogIssuesCombobox,prompt:StrackLang.Please_Select_Timer_Issue,valueField:"id",textField:"name",groupField:"group_lang",value:t.value,disabled:t.disabled,width:220,queryParams:{project_id:a},onSelect:function(e){}})},start_timer:function(a){var i=$(a).data("id"),e=$("#"+i).combobox("getRowValue","id");$.isEmptyObject(e)?layer.msg(StrackLang.Please_Select_Timelog_Issue,{icon:2,time:1200,anim:6}):$.ajax({type:"POST",url:StrackPHP.addTimelogTimer,dataType:"json",data:e,beforeSend:function(){$("#slider_timer_list").prepend(Strack.loading_dom("white","","timer"))},success:function(e){var t;200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),$("#"+i).combobox("disable"),Strack.run_timer(i,0),(t=$(a).closest(".tg-ac-item")).addClass("active"),t.attr("data-timerid",e.data.id),t.find(".control-bnt").empty().append(Strack.timer_control_bnt("stop",i)),Strack.check_timer_exit()):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_timer").remove()}})},stop_timer:function(e){var t=$(e).data("id"),e=$(e).closest(".tg-ac-item").attr("data-timerid");$.ajax({type:"POST",url:StrackPHP.stopTimelogTimer,dataType:"json",data:{timer_id:e},beforeSend:function(){$("#slider_timer_list").prepend(Strack.loading_dom("white","","timer"))},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),$("#"+t).combobox("destroy"),$("#item_"+t).remove(),clearInterval(Strack.G.TllogTerval[t]),Strack.check_timer_exit()):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_timer").remove()}})},delete_timer:function(e){var t=$(e).data("id"),e=$(e).closest(".tg-ac-item");e.hasClass("active")?(e=e.attr("data-timerid"),$.ajax({type:"POST",url:StrackPHP.deleteTimelog,dataType:"json",data:{primary_ids:e},beforeSend:function(){$("#slider_timer_list").prepend(Strack.loading_dom("white","","timer"))},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),$("#"+t).combobox("destroy"),$("#item_"+t).remove(),clearInterval(Strack.G.TllogTerval[t]),Strack.check_timer_exit()):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_timer").remove()}})):($("#"+t).combobox("destroy"),$("#item_"+t).remove(),Strack.check_timer_exit())},delete_timelog_history_item:function(e){var t=$(e).data("timeid");0<t&&$.ajax({type:"POST",url:StrackPHP.deleteTimelog,dataType:"json",data:{primary_ids:t},beforeSend:function(){$("#slider_timelog_wrap").prepend(Strack.loading_dom("white","","timelog"))},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),$("#timelog_i_"+t).remove()):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_timelog").remove()}})},run_timer:function(e,t){var a=$("#item_"+e).find(".time"),i=0<t?t:0;Strack.G.TllogTerval[e]=setInterval(function(){a.html(Strack.format_timer_time(i)),i++},1e3)},format_timer_time:function(e){var t=e,a=parseInt(t/86400),i=parseInt(t%86400/3600),d=parseInt(t%86400%3600/60),e=t%86400%360%60,t="";return 0!==a&&(t+=a+StrackLang.Days+" "),0===i&&0===a||(t+=Strack.fix_timer_number(i,2)+":"),0===d&&0===i&&0===a||(t+=Strack.fix_timer_number(d,2)+":"),t+=Strack.fix_timer_number(e,2),0===a&&0===i&&0===d&&(t+=" "+StrackLang.Unit_Sec),0===a&&0===i&&0!==d&&(t+=" "+StrackLang.Unit_Min),t},fix_timer_number:function(e,t){return(""+e).length<t?(new Array(t+1).join("0")+e).slice(-t):""+e},check_timer_exit:function(){var e=$("#slider_timer_list"),t=e.find(".tg-ac-item").length;0===t&&e.empty().append('<div class="datagrid-empty-no text-center">'+StrackLang.Datagird_No_Data+"</div>"),Strack.top_tool_number("#top_timer_number",t)},side_timer_dom:function(e,t){var a="";return a+='<div id="item_'+e+'" class="ui grid tg-ac-item"><div class="center aligned four column row"><div class="seven wide column"><div style="padding-left: 20px"><input id="'+e+'" autocomplete="off"></div></div><div class="five wide column button-wrap time">'+t.time+'</div><div class="two wide column button-wrap control-bnt">'+Strack.timer_control_bnt(t.status,e)+'</div><div class="two wide column button-wrap">',"yes"===Strack.G.sideTimelogParam.rule_delete&&(a+='<a href="javascript:;" class="button" onclick="Strack.delete_timer(this)" data-id="'+e+'"><button class="ui basic gray button">'+StrackLang.Delete+"</button></a>"),a+="</div></div></div>"},timer_control_bnt:function(e,t){var a="";return"yes"===Strack.G.sideTimelogParam.rule_start_stop&&(a+="start"===e?'<a href="javascript:;" class="button" onclick="Strack.start_timer(this)" data-id="'+t+'"><button class="ui basic green button">'+StrackLang.Start+"</button></a>":'<a href="javascript:;" class="button" onclick="Strack.stop_timer(this)" data-id="'+t+'"><button class="ui basic red button">'+StrackLang.Pause+"</button></a>"),a},item_start_timelog:function(t,e){e.stopPropagation(),e.preventDefault();var a=$(t).attr("data-id"),i=$(t).attr("data-linkid"),d=$(t).attr("data-timelogid"),r=$(t).attr("data-moduleid"),o=$(t).attr("data-from");$.ajax({type:"POST",url:StrackPHP.startOrStopTimelog,data:{id:i,timelog_id:d,module_id:r,from:o},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.top_tool_number("#top_timer_number",e.data.timer_number),Strack.Websocket.List.hasOwnProperty("update")||Strack.item_timelog_bnt_refresh(t,"add",{id:a,link_id:i,timelog_id:d,module_id:r,from:o,data:e.data})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},item_timelog_bnt_refresh:function(e,t,a){var i={color:"",id:0};switch(a.from){case"kanban":0<a.timelog_id?(Strack.init_timelog_bnt("#"+a.id,i={color:"green",id:0}),$(".kanban-card-bnt a.button").each(function(){$(this).hasClass("red")&&$(this).removeClass("red").addClass("green")})):(i={color:"red",id:a.data.id},Strack.init_timelog_bnt("#"+a.id,i));break;case"slider":0<a.timelog_id?Strack.init_timelog_bnt("#"+a.id,i={color:"green",id:0}):(i={color:"red",id:a.data.id},Strack.init_timelog_bnt("#"+a.id,i));break;case"schedule":var d=$("#"+a.id);0<a.timelog_id?(i={color:"green",id:0},d.attr("data-timelogid",0),d.removeClass("fc-h-event-red").addClass("fc-h-event-green"),d.html('<i class="icon-uniE974 icon-left"></i>'+StrackLang.Start)):(i={color:"red",id:a.data.id},d.attr("data-timelogid",a.data.id),d.removeClass("fc-h-event-green").addClass("fc-h-event-red"),d.html('<i class="icon-uniE974 icon-left"></i>'+StrackLang.Pause))}$.inArray(a.link_id,Strack.G.tempStartTimelogids.ids)<0&&Strack.G.tempStartTimelogids.ids.push(parseInt(a.link_id)),Strack.G.tempStartTimelogids.status[parseInt(a.link_id)]=i},top_header:function(){var e=$("input[name = project_id]"),e=0<e.length?e.val():0;$.ajax({type:"POST",url:StrackPHP.getTopRightData,dataType:"json",data:{project_id:e},success:function(e){var t=e.user_data;Strack.G.userId=t.user_id,Strack.notice.license(e.license_data),Strack.notice.demo_project(e.project_data),Strack.top_tool_number("#top_timer_number",e.timer_number),Strack.G.UnReadMessageData={massage_number:e.message_data.massage_number,created:e.message_data.last_message_data.created},Strack.top_tool_number("#top_msg_number",e.message_data.massage_number),$("#top_avatar").append(Strack.build_avatar(t.user_id,t.avatar,Strack.upper_first_str(t.pinyin)));e=$("#padmin_avatar");0<e.length&&(e.empty().append(Strack.build_avatar(t.user_id,t.avatar,Strack.upper_first_str(t.pinyin))),$("#padmin_name").html(t.name)),0<$("#acinfo_menu").length&&($("#acinfo_avatar").empty().append(Strack.build_avatar(t.user_id,t.avatar,Strack.upper_first_str(t.pinyin))),$("#acinfo_name").html(t.name))}})},top_tool_number:function(e,t){0<parseInt(t)?$(e).html(t).addClass("st-sup-ac"):$(e).removeClass("st-sup-ac").empty()},load_notes:function(r,o){var n=$(r.content_id).find('[data-tab="note"]');$.ajax({type:"POST",url:StrackPHP.getNoteListData,data:o,dataType:"json",beforeSend:function(){"new"===o.status&&n.addClass("loading")},success:function(e){var t,a,i=$("#"+r.list_id+" .note-no-stick"),d=$("#"+r.list_id+" .note-stick");"new"===o.status&&(a="comments_list_"+o.module_id+"_"+o.item_id,(t=$("#"+r.list_id)).attr("class").split(" ").forEach(function(e){$.inArray(e,["ui","threaded","comments","note-comments"])<0&&t.removeClass(e)}),t.addClass(a),o.total=e.note_list.total,r.avatar_id&&$(r.avatar_id).empty().append(Strack.build_avatar(e.user_data.user_id,e.user_data.avatar,Strack.upper_first_str(e.user_data.pinyin))),a={item_id:o.item_id,project_id:o.project_id,module_id:o.module_id,module_type:o.module_type,structure_id:o.structure_id,list_id:r.list_id,list_class:"comments_list_"+o.module_id,parent_id:0},$(".simditor-body").attr("contenteditable",!1),Strack.init_note_editor(r.editor_id,0,a,"panel","add",!0),Strack.fall_load_data(r.page_id,o,function(e){e.status="more",Strack.load_notes(r,e)},function(){var e;r.details_top_bar&&(e=$("#"+r.tab_bar_id),0<$(".globel-top-notice").length?e.css("top",85):e.css("top",49),$(r.tab_id).offset().top<80?e.show(200):e.hide(200))}),d.empty().append(Strack.show_note_list(e.stick_note_list)),0<e.stick_note_list.total&&d.addClass("note-stick-bottom"),i.empty(),n.removeClass("loading")),i.append(Strack.show_note_list(e.note_list)),e.note_list.rows.forEach(function(e){Strack.init_note_att_event(".comment_note_"+e.id)})}})},init_note_att_event:function(e){(e?$(e).find(".note-att"):$(".note-att")).each(function(){Strack.init_thumb_media($(this).data("id"))})},init_note_editor:function(e,a,t,i,d,r){Strack.G.GeditorParam["e_"+a]=t;Strack.G.Geditor["e_"+a]=new Simditor({textarea:$("#"+e),placeholder:StrackLang.Add_Note_Notice,toolbarHidden:r,toolbartype:a,panel_type:"main",toolbar:["color","bold","emoji","|","strikethrough","ol","ul","blockquote","table","hr"],footer_control:!0,from:i,edit_mode:d,module_type:t.module_type,list_class:t.list_class,emoji:{imagePath:"images/emoji/"},mention:{url:StrackPHP.getAtUserList,nameKey:"name",pinyinKey:"pinyin",abbrKey:"abbr",param:t}}),0===a&&Strack.G.Geditor["e_"+a].on("focus",function(e,t){Strack.hide_note_reply(),$(".toolbar_"+a).show(),Strack.reset_slider_note_hight(this.wrapper,"focus"),Strack.G.mediaScreenshotStatus&&obj.exit_media_painter()})},reset_slider_note_hight:function(e,t){var a=$(e).closest(".note-editor-slider");0<a.length&&(e=parseInt(a.attr("data-baseh")),a=a.find(".pyn-fd-wrap"),"focus"===t?a.css("height","calc(100% - "+(e+58)+"px)"):a.css("height","calc(100% - "+e+"px)"))},show_note_reply:function(e){var t=$(e).attr("data-noteid");Strack.hide_note_reply(),$(e).parent().hide().after(Strack.note_reply_editor(t));e=Strack.G.GeditorParam.e_0;e.parent_id=t,Strack.init_note_editor("editor-reply_"+t,t,e,"panel","add",!1)},hide_note_reply:function(){$(".reply-editor").each(function(){Strack.close_note(this)})},note_reply_editor:function(e){return'<div id="reply-wrap_'+e+'" class="reply-editor" toolbar_type="'+e+'"><textarea id="editor-reply_'+e+'" autocomplete="off"></textarea></div>'},show_note_list:function(e){var t="";return e.rows.forEach(function(e){t+=Strack.notes_single_item_dom(e,"add")}),t},notes_single_item_dom:function(e,t){var a="",i=Strack.notes_item_dom(e);return"add"===t?(a+='<div class="comment comment_note_'+e.id+'" stick="'+e.stick+'">',a+=i,a+="</div>"):i},notes_item_dom:function(e){var t="";t+='<a href="javascript:;" class="avatar avatar-show" title="'+e.user_data.name+'">',t+=Strack.build_avatar(e.user_data.user_id,e.user_data.avatar,Strack.upper_first_str(e.user_data.pinyin));var a="";switch(e.type){case"text":a=e.text;break;case"audio":a+='<p class="weixinAudio"> <audio src="'+e.audio_data.path+'" id="media" width="1" height="1" preload></audio> <span id="audio_area" class="db audio_area"> <span class="audio_wrp db"> <span class="audio_play_area"> <i class="icon_audio_default"></i> <i class="icon_audio_playing"></i> </span> <span id="audio_length" class="audio_length tips_global">'+e.audio_data.duration+'</span> <span class="db audio_info_area"> <span class="audio_source tips_global">'+e.audio_data.description+'</span> </span> <span id="audio_progress" class="progress_bar" style="width: 0%;"></span> </span> </span> </p>',a+=e.text}var i="";i+='<a href="javascript:;" onclick="Strack.edit_note(this)" class="note-editicon" data-noteid="'+e.id+'"><i class="icon-uniF040 icon-left"></i></a>',i+='<a href="javascript:;" onclick="Strack.delete_note(this)" class="note-editicon" data-noteid="'+e.id+'"><i class="icon-uniE765"></i></a>';var d="";0<e.reply_data.length&&(d=StrackLang.Reply+" #"+e.parent_id+" "+e.reply_data.reply_user_name);var r="main_"+Math.floor(1e4*Math.random()+1);return t+='</a><div class="content">'+Strack.init_note_tag(e.tag_data)+'<div class="note-toolbar"><a href="javascript:;" class="author" target="_blank">#'+e.id+" "+e.user_data.name+'</a><span class="reply_auth_name">'+d+'</span><div class="metadata"><span class="date">'+e.last_updated+'</span></div><div class="aign-right note-tedit">'+i+'</div></div><div class="text  editor-style ntext_'+e.id+'"><div class="simditor-body">'+a+'</div></div><div class="note-att" data-id="'+r+'">'+Strack.show_note_img_att(r,e.media_data)+"</div>",t+='<div class="actions"><a class="reply" onclick="Strack.show_note_reply(this)" data-noteid="'+e.id+'">'+StrackLang.Reply+"</a></div>",t+="</div>",t+=Strack.init_link_note(e.link_note_data)},init_link_note:function(e){var t,a="";return e.length&&(t="",e.forEach(function(e){t+='<a href="javascript:;" onclick="Strack.edit_note(this)" data-noteid="'+e.id+'"> # '+e.id+"</a>"}),a+='<div class="link-note"><ul class="link-note-wrap"><li class="link-note-item"><span class="link-icon"><i class="icon-uniE612"></i></span><span class="link-title">'+StrackLang.Link_Note+'</span><div class="link-note-bnt">'+t+"</div></li></ul></div>"),a},init_note_tag:function(e){if(e.length){var t="";return e.forEach(function(e){t+=Strack.note_tag_dom(e)}),'<a href="javascript:;" class="note-tags '+("yes"===Strack.read_storage("note-tag-show")?"note-tags-show":"")+'" onclick="Strack.toggle_note_tag_show(this)">'+t+"</a>"}return""},note_tag_dom:function(e){return e?'<span class="card-label mod-card-front" title="'+e.name+'" style="background-color: #'+e.color+'">'+e.name+"</span>":""},toggle_note_tag_show:function(e){$(e).hasClass("note-tags-show")?($(".note-tags").removeClass("note-tags-show"),Strack.save_storage("note-tag-show","no")):($(".note-tags").addClass("note-tags-show"),Strack.save_storage("note-tag-show","yes"))},delete_note:function(e){var t=$(e).attr("data-noteid");$.messager.confirm(StrackLang.Confirmation_Box,StrackLang.Note_Delete_Confirm,function(e){e&&$.ajax({type:"POST",url:StrackPHP.deleteNote,dataType:"json",data:{primary_ids:t},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){Strack.top_message({bg:"g",msg:e.message}),$.messager.progress("close"),Strack.Websocket.List.hasOwnProperty("update")||Strack.update.note(e.data)}})})},close_note:function(e){var t=$(e).attr("toolbar_type");Strack.reset_slider_note_hight(e,"blur"),Strack.destroy_note_img_uploadifive(t),$(".ed_rethumb_"+t).empty().removeClass("simditor-fields-ac"),$(e).closest(".simditor-footer").find(".toolbar-foot-item").removeClass("ntool-active"),0<t?((e=$("#reply-wrap_"+t)).prev().show(),e.remove()):($(".toolbar_"+t).hide(),Strack.G.Geditor["e_"+t].setValue(""),$(".fieldsbar_"+t).removeClass("simditor-fields-ac").find("li").each(function(){$(this).find("input.ed_fiedlds").combobox("destroy"),$(this).remove()})),Strack.G.closeNoteObj=null},reset_note:function(e){$(".ed_rethumb_"+e).empty().removeClass("simditor-fields-ac"),Strack.G.Geditor["e_"+e].setValue(""),$(".fieldsbar_"+e).removeClass("simditor-fields-ac").find("li").each(function(){$(this).find("input.ed_fiedlds").combobox("destroy"),$(this).remove()})},data_url_to_file:function(e){for(var t=e.split(","),e=t[0].match(/:(.*?);/)[1],a=atob(t[1]),i=a.length,d=new Uint8Array(i);i--;)d[i]=a.charCodeAt(i);return new File([d],"img.png",{type:e})},add_note:function(e){var t=$(e).attr("toolbar_type"),a=$("#nodeimg_"+t+" .uploadifive-queue-item").length,i=Strack.G.Geditor["e_"+t].getValue();Strack.G.closeNoteObj=e;var d=$("#screenshot_list .pyn-st-img img");0<d.length?Strack.add_review_img_to_uploadfive(e,t,d):0<i.length||0<a?0<a?$("#nodeimg_bnt_"+t).uploadifive("upload"):Strack.update_note(t,StrackPHP.addNote,"add"):layer.msg(StrackLang.Note_Text_Empty_Or_Media_Empty,{icon:2,time:1200,anim:6})},add_review_img_to_uploadfive:function(e,t,a){$(".simditor-rethumb").hasClass("simditor-fields-ac")?(a.each(function(){$("#nodeimg_bnt_"+t).uploadifive("addQueueItem",Strack.data_url_to_file($(this).attr("src")))}),$("#nodeimg_bnt_"+t).uploadifive("upload")):Strack.note_add_image(e,t,"add",function(){a.each(function(){$("#nodeimg_bnt_"+t).uploadifive("addQueueItem",Strack.data_url_to_file($(this).attr("src")))}),$("#nodeimg_bnt_"+t).uploadifive("upload")})},update_note:function(e,t,a,i,d){var r=Strack.G.Geditor["e_"+e].body,o=$(".fieldsbar_"+e),n=Strack.G.GeditorParam["e_"+e];n.file_commit_id=Strack.G.mediaViewPlayIndex,d&&(n.media_server=d),n.type="text",n.id=e,n.text=Strack.G.Geditor["e_"+e].getValue();var s=[];r.find("a").each(function(){$(this).hasClass("simditor-mention")&&s.push($(this).data("uid"))}),n.at_user_ids=s.join(","),n.status_id=0,n.stick="no",n.version_id=0,n.tags="",o.find(".ed_fiedlds").each(function(){var e=$("#"+$(this).attr("id"));switch($(this).attr("data-input")){case"status":n.status_id=e.combobox("getValue");break;case"stick":n.stick=e.combobox("getValue");break;case"tag":var t=e.combobox("getValues");n.tags=t.join(",")}}),n.images=i||[],"modify"===a&&(n.delete_media_ids=Strack.G.Note_Delete_Img_Ids),$.ajax({type:"POST",url:t,data:JSON.stringify(n),dataType:"json",contentType:"application/json",beforeSend:function(){d||$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){if($.messager.progress("close"),200===parseInt(e.status)){switch($("#screenshot_list .pyn-st-img").length&&$("#screenshot_list").html('<div class="pyn-st-null">'+StrackLang.Screenshot_Null+"</div>"),Strack.top_message({bg:"g",msg:e.message}),Strack.G.Note_Uploadifive_Imgs=[],a){case"modify":case"batch_add":Strack.dialog_cancel();break;case"add":Strack.close_note(Strack.G.closeNoteObj)}Strack.Websocket.List.hasOwnProperty("update")||Strack.update.note(e.data)}else layer.msg(e.message,{icon:7,time:1200,anim:6})}})},batch_add_note:function(e){var t=$(e).closest(".datagrid-toolbar"),e=t.attr("data-grid"),a=t.attr("data-moduleid"),i=t.attr("data-projectid"),e=$("#"+e).datagrid("getSelections"),d=[];e.forEach(function(e){d.push(parseInt(e.id))}),0<d.length?Strack.open_dialog("dialog",{title:StrackLang.Batch_Add_Note,width:700,height:470,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mlink_ids",type:"hidden",name:"link_ids",valid:1,value:d.join(",")},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:a},{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:i}],items:[{case:7,id:"Mnote_text",type:"text",lang:"",name:"note_text",valid:1,value:""},{case:14,id:"Mnote_meida",type:"text",lang:"",name:"note_meida",valid:1,value:""}],footer:[{obj:"submit_batch_add_note",type:11,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var e={item_id:d.join(","),project_id:i,module_id:a,list_id:d.list_id,list_class:"comments_list_"+a,parent_id:0};Strack.init_note_editor("Mnote_text",a+"_0",e,"dialog","batch_add",!1),$("#st_dialog_form").find(".simditor-body").css({height:"140px"})}}):layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6})},submit_batch_add_note:function(){var e=$("#Mmodule_id").val()+"_0",t=Strack.G.Geditor["e_"+e].getValue(),a=$("#nodeimg_"+e+" .uploadifive-queue-item").length;0<t.length||0<a?0<a?$("#nodeimg_bnt_"+e).uploadifive("upload"):Strack.update_note(e,StrackPHP.batchAddNote,"batch_add"):layer.msg(StrackLang.Note_Text_Empty_Or_Media_Empty,{icon:2,time:1200,anim:6})},edit_note:function(e){var i=$(e).attr("data-noteid");0<i&&(Strack.hide_note_reply(),$.ajax({type:"POST",url:StrackPHP.getOneNoteData,data:{note_id:i},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(a){Strack.G.Note_Uploadifive_Imgs=[],$.messager.progress("close"),Strack.open_dialog("dialog",{title:StrackLang.Modify_Note,width:700,height:470,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mnote_id",type:"hidden",name:"note_id",valid:1,value:i}],items:[{case:7,id:"Mnote_text",type:"text",lang:"",name:"note_text",valid:1,value:a.text},{case:14,id:"Mnote_meida",type:"text",lang:"",name:"note_meida",valid:1,value:""}],footer:[{obj:"modify_note",type:11,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var t,e=Strack.G.GeditorParam.e_0;e.parent_id=i,Strack.init_note_editor("Mnote_text",i,e,"dialog","modify",!1),$("#st_dialog_form").find(".simditor-body").css({height:"140px"}),Strack.editor_footer_item(i,"stick",StrackLang.Stick,a.stick),a.status_id&&Strack.editor_footer_item(i,"status",StrackLang.Status,a.status_id),0<a.tag_data.length&&(t=[],a.tag_data.forEach(function(e){0<e.tag_id&&t.push(e.tag_id)}),0<t.length&&Strack.editor_footer_item(i,"tag",StrackLang.Tag,t)),"yes"===a.media_data.has_media&&Strack.init_modify_note_img_list("#dialog_img_list",a.media_data.param)},close:function(){Strack.G.Note_Delete_Img_Ids=[],Strack.G.Note_Has_Img_Length=0}})}}))},init_modify_note_img_list:function(e,t){var a="";t.forEach(function(e){a+=Strack.modify_note_img_item_dom(e)}),Strack.G.Note_Has_Img_Length=t.length,$(e).empty().append('<div class="note-del-img-title">'+StrackLang.Select_The_Media_To_Delete+'</div><div class="note-del-img-wrap">'+a+"</div>")},modify_note_img_item_dom:function(e){var t="",a="";switch(e.type){case"image":a=e.base_url+e.md5_name+"_origin."+e.ext;break;case"video":a=e.base_url+e.md5_name+".jpg"}return t+='<a href="javascript:;" class="note-del-img aign-left" onclick="Strack.sign_delete_note_images(this)" data-id="'+e.media_id+'"><img src="'+a+'"></a>'},sign_delete_note_images:function(e){var t,a=parseInt($(e).attr("data-id"));$(e).hasClass("active")?(t=[],Strack.G.Note_Delete_Img_Ids.forEach(function(e){e!==a&&t.push(e)}),Strack.G.Note_Delete_Img_Ids=t,Strack.G.Note_Has_Img_Length++):(Strack.G.Note_Delete_Img_Ids.push(a),Strack.G.Note_Has_Img_Length--),$(e).toggleClass("active")},modify_note:function(){var e=$("#Mnote_id").val(),t=Strack.G.Geditor["e_"+e].getValue(),a=$("#nodeimg_"+e+" .uploadifive-queue-item").length;0<t.length||0<a||0<Strack.G.Note_Has_Img_Length?0<a?$("#nodeimg_bnt_"+e).uploadifive("upload"):Strack.update_note(e,StrackPHP.modifyNote,"modify"):layer.msg(StrackLang.Note_Text_Empty_Or_Media_Empty,{icon:2,time:1200,anim:6})},click_editor_footer:function(e){var t,a=$(e).attr("toolbar_type"),i=$(e).attr("toolbar_area");"image"===i?(t=$(e).attr("edit_mode"),Strack.note_add_image(e,a,t)):(e=$(e).attr("lang"),Strack.editor_footer_item(a,i,e,""))},editor_footer_item:function(e,t,a,i){var d=$(".fieldsbar_"+e),r="ed_field_"+t+"_"+e,o=$("#"+r);$(".toolbar_"+e).find(".toolbar-foot-item").each(function(){$(this).attr("toolbar_area")===t&&$(this).toggleClass("ntool-active")}),0===o.length?(d.addClass("simditor-fields-ac"),Strack.init_editor_footer_item(d.find("ul"),e,r,t,a,i)):(o.find("input.ed_fiedlds").combobox("destroy"),o.remove(),0===d.find("li").length&&d.removeClass("simditor-fields-ac"))},init_editor_footer_item:function(e,t,a,i,d,r){var o="",n="ed_input_"+i+"_"+t;e.append(o+='<li id="'+a+'" class="e-fields-item" ><div class="e-fiedlds-name aign-left">'+d+'</div><div class="e-fiedlds-input"><input id="'+n+'" class="ed_fiedlds" data-input="'+i+'"></div></li>');t=Strack.G.GeditorParam["e_"+t],i="tag"===(t.area=i);$("#"+n).combobox({url:StrackPHP.getNoteWidgetData,valueField:"id",textField:"name",queryParams:t,multiple:i,value:r,width:320,onLoadSuccess:function(){var e=$(this).combobox("getData");e.length&&0===r.length&&$(this).combobox("select",e[0].id)}})},note_add_image:function(a,i,d,r){var o=$(".ed_rethumb_"+i);o.hasClass("simditor-fields-ac")?($(a).removeClass("ntool-active"),Strack.destroy_note_img_uploadifive(i),o.removeClass("simditor-fields-ac").empty()):Strack.get_media_server(function(e){$(a).addClass("ntool-active");var t="";t+='<div id="nodeimg_'+i+'" class="rethumb-images aign-left"></div><div class="rethumb-add aign-right"><input id="nodeimg_bnt_'+i+'" class="aign-left" name="nodeimg_bnt_'+i+'" type="file" multiple="true"></div>',o.addClass("simditor-fields-ac").empty().append(t),Strack.init_note_img_uploadifive(i,e,{edit_mode:d},r)})},init_note_img_uploadifive:function(i,d,r,e){$("#nodeimg_bnt_"+i).uploadifive({auto:!1,removeCompleted:!0,token:d.token,formData:{timestamp:Strack.current_time(),belong_system:StrackPHP.Belong_System,size:"250x140"},queueID:"nodeimg_"+i,uploadScript:d.upload_url,onUpload:function(e){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},onInit:function(){e&&e()},onUploadComplete:function(e,t){t=JSON.parse(t);200===parseInt(t.status)&&Strack.G.Note_Uploadifive_Imgs.push(t.data[0])},onQueueComplete:function(e,t){var a="";switch(r.edit_mode){case"batch_add":a=StrackPHP.batchAddNote;break;case"modify":a=StrackPHP.modifyNote;break;default:a=StrackPHP.addNote}Strack.update_note(i,a,r.edit_mode,Strack.G.Note_Uploadifive_Imgs,d)}})},destroy_note_img_uploadifive:function(e){$("#nodeimg_bnt_"+e).uploadifive("destroy")},follow_item:function(e){var t=$(e),a={module_id:t.attr("data-moduleid"),module_type:t.attr("data-moduletype"),follow_status:t.attr("data-followstatus"),link_id:t.attr("data-linkid")};"yes"===a.follow_status?$.messager.confirm(StrackLang.Confirmation_Box,StrackLang.Confirm_UnFollow,function(e){e&&Strack.do_follow_item(t,a)}):Strack.do_follow_item(t,a)},do_follow_item:function(t,e){$.ajax({type:"POST",url:StrackPHP.followItem,data:e,dataType:"json",beforeSend:function(){t.addClass("disabled")},success:function(e){t.removeClass("disabled"),200===parseInt(e.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),t.attr("data-followstatus",e.data.follow_status),t.html(e.data.follow_status_name)):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},open_action_slider:function(e){var t=$(e).data("from"),a=$(e).data("moduleid"),i=$(e).data("projectid"),d=$("#action_search_bnt");switch($("#action_list_slider").sidebar("toggle"),d.attr("data-from",t).attr("data-moduleid",a).attr("data-projectid",i),t){case"grid":var r=$(e).data("grid"),o=$("#"+r).datagrid("getSelections"),n=[];o.forEach(function(e){n.push(e.id)}),d.attr("data-grid",r).attr("data-ids",n.join(",")),Strack.load_sidebar_action_list({from:t,grid:r,module_id:a,project_id:i,filter:""});break;case"details":r=$(e).data("linkid");d.attr("data-ids",r),Strack.load_sidebar_action_list({from:t,grid:"",module_id:a,project_id:i,filter:""})}},search_action:function(e){var t=$(e),a=$("#action_search_box").val(),e="";0<a.length&&(e={name:["-lk","%"+a+"%"]});e={from:t.data("from"),grid:t.data("grid"),module_id:t.data("moduleid"),project_id:t.data("projectid"),filter:e};Strack.load_sidebar_action_list(e)},open_schedule_slider:function(e){var t=$("#schedule_list_slider");t.sidebar("toggle");t.hasClass("slider-active")||Strack.init_schedule_panel("scheduler_my",28)},check_event_end_time:function(e,t){},init_schedule_panel:function(e,t,i){var o="yes"===i.rule_update_widget;$("#"+e).fullCalendar({header:{left:"today prev,next",center:"title",right:"agendaDay,agendaWeek,agendaMonth,listWeek,"},contentHeight:Strack.panel_height("#"+e,t),domParam:{dom:e,min_h:t},defaultView:"agendaDay",slotDuration:"00:10:00",defaultDate:Strack.date_format(new Date,"yyyy-MM-dd"),selectable:!0,handleWindowResize:!0,defaultTimedEventDuration:"00:30:00",eventOrder:"end_time",navLinks:!0,eventLimit:!0,nowIndicator:!0,param:i,loading:function(e,t){var a,i;1==e||0==e&&("refetchEvents"!==Strack.G.calendarLoadMode&&(a=$(".fc-scroller .fc-time-grid").height(),e=(new Date).getHours(),$(".fc-scroller").scrollTop(e/24*a),i=e+":00:00",$(".fc-scroller .fc-time-grid tr").each(function(){$(this).attr("data-time")===i&&$(this).find("td").css("color","red")})),Strack.G.calendarLoadMode="",$.messager.progress("close"))},windowResize:function(e){$(this).fullCalendar("option","contentHeight",Strack.panel_height("#scheduler_my",39))},events:function(e,t,a,i){$.ajax({url:StrackPHP.getMyScheduleData,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({start:e.unix(),end:t.unix(),filter:Strack.G.calendarEventsFilter}),success:function(a){Strack.right_menu_dom({copy_id:"",edit_id:"",id:"my_schedule_rmenu",data:a.right_menu_config});var t=[];a.events_list.forEach(function(e){"yes"===e.lock_status?e.editable=!1:e.editable=o,"yes"===e.is_all_day&&(e.allDay=!0,e.durationEditable=!1),t.push(e)}),Strack.G.calendarLockDateList=a.lock_date_list,Strack.G.calendarTaskRemainderLime={plan_available_time:a.task_remainder_time,task_remainder_end_time:a.task_remainder_end_time},a.page_auth_rules.list.forEach(function(e){var t=Strack.deep_copy(a.page_auth_rules.base);t.event_id=e.event_id,t.item_id=e.item_id,t.entity_id=e.entity_id,t.project_id=e.project_id,t.template_id=e.template_id,Strack.G.myScheduleSideParam[e.event_id]=t}),Strack.toggle_task_plan_lock_bnt(a.lock_bnt_status),i(t)}})},select:function(e,t,a,i,d){},eventClick:function(e,t,a){var i,d;($(t.target).hasClass("fc-h-event-copy")||0<$(t.target).closest(".fc-h-event-copy").length)&&(d=$(a.el[0]).closest(".my-scheduler-index").attr("id"),Strack.copy_calendar_plan(t,e,d)),($(t.target).hasClass("fc-h-event-del")||0<$(t.target).closest(".fc-h-event-del").length)&&(i=$(t.target).closest(".fc-h-event-del").data("id"),d=$(a.el[0]).closest(".my-scheduler-index").attr("id"),Strack.del_calendar_plan(t,e,d,i))},contextmenu:function(e,t,a){"base"===e.type&&"yes"===i.rule_schedule_delete_task&&(Strack.G.myScheduleDeleteTaskData=e,$("#my_schedule_rmenu").menu("show",{left:t.pageX,top:t.pageY}))},eventDBClick:function(e,t,a){0===$(t.target).closest(".item-list-pt").length&&Strack.open_datagrid_slider(Strack.G.myScheduleSideParam[e.id])},eventResize:function(e,t,a,i,d,r){o&&Strack.update_scheduler_event(e)},eventDrop:function(e,t,a,i,d,r){o&&(e.allDay||"yes"!==e.is_all_day?Strack.update_scheduler_event(e):(r=$(r.el[0]).closest(".my-scheduler-index").attr("id"),Strack.add_scheduler_task_plan_event(e,r)))},eventMouseover:function(e,t,a){},eventMouseout:function(e,t,a){}})},toggle_task_plan_lock_bnt:function(e){var t=$(".fc-lock-plan a");"agendaDay"===t.attr("data-view")&&(e?t.show().attr("data-mode","unlock").removeClass("blue").addClass("red").html('<i class="icon-uniE9B9 icon-left"></i>'+StrackLang.UnLock_Task_Plan):t.show().attr("data-mode","lock").removeClass("red").addClass("blue").html('<i class="icon-uniE9B8 icon-left"></i>'+StrackLang.Lock_Task_Plan))},filter_fullCalendar_data:function(e){var t=$(e).closest(".my-scheduler-index").attr("id"),a=$(e).data("filter");$(".fc-filter-bnt-ac").removeClass("active"),a&&$(e).addClass("active"),Strack.reload_fullCalendar_data(t,a)},reload_fullCalendar_data:function(e,t){t&&(Strack.G.calendarEventsFilter=t),Strack.G.calendarLoadMode="refetchEvents",$("#"+e).fullCalendar("refetchEvents")},update_kanban_issue:function(e,t){Strack.submit_update_item("",!0,e,t)},add_scheduler_task_plan_event:function(e,t){var a=0,i=0;e.start&&(a=e.start.format());i=(e.end||e.start).format(),i={lock:"no",link_id:e.item_id,start_time:a,end_time:i,estimate_append:0,operation:"add"};Strack.add_scheduler_task_plan_event_update(i,t,!1)},add_scheduler_task_plan_event_update:function(e,t,a){$.ajax({type:"POST",url:StrackPHP.addTaskPlan,data:JSON.stringify(e),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.reload_fullCalendar_data(t),a&&Strack.dialog_cancel()):($.messager.progress("close"),layer.msg(e.message,{icon:7,time:1200,anim:6}))}})},update_scheduler_event:function(e){var t={};t[e.table_name]=[];var a="",i="",i="event"===e.event_type?(a="start_time","end_time"):(a="plan_start_time","plan_end_time");e.allDay?(t[e.table_name].push({field:e.table_name+"-"+a,field_type:"built_in",value:e.start.format(),variable_id:0}),t[e.table_name].push({field:e.table_name+"-"+i,field_type:"built_in",value:0,variable_id:0})):(e.start&&t[e.table_name].push({field:e.table_name+"-"+a,field_type:"built_in",value:e.start.format(),variable_id:0}),e.end?t[e.table_name].push({field:e.table_name+"-"+i,field_type:"built_in",value:e.end.format(),variable_id:0}):t[e.table_name].push({field:e.table_name+"-"+i,field_type:"built_in",value:e.start.format(),variable_id:0})),Strack.submit_update_item("",!0,{from_item_id:"0",from_module_id:"0",mode:"modify",module_id:e.module_id,page:e.page,primary_id:e.item_id,project_id:e.project_id,type:"update_panel"},t)},show_scheduler_tips:function(e,t){},close_schedule_slider:function(e){$("#schedule_list_slider").sidebar("toggle")},load_sidebar_action_list:function(i){$.ajax({type:"POST",url:StrackPHP.getSidebarActionData,dataType:"json",data:i,beforeSend:function(){$("#action_list_slider").append(Strack.loading_dom("white","","action"))},success:function(e){var t="",a="";e.common.forEach(function(e){t+=Strack.action_list_item_dom(e,i,"common")}),e.other.forEach(function(e){a+=Strack.action_list_item_dom(e,i,"other")}),$("#common_action_list").empty().append(t),$("#other_action_list").empty().append(a),$("#st-load_action").remove()}})},action_list_item_dom:function(e,t,a){var i="",d="other"===a?StrackLang.Set_Action_Common:StrackLang.Cancel_Action_Common;return i+='<div class="column dgat-item"><a href="javascript:;" class="dgat-img" onclick="Strack.click_run_action(this)" data-from="'+t.from+'" data-grid="'+t.grid+'" data-actionid="'+e.id+'" data-moduleid="'+e.module_id+'"><div class="action-icon"><div class="soft-avatar"><img src="'+e.thumb+'"></div></div></a><div class="dgat-dcname"><strong>'+e.name+'</strong></div><div class="dgat-dcname">'+e.version+'</div><div class="dgat-bnt" ><a href="javascript:;" onclick="Strack.toggle_action_common(this)" data-type="'+a+'" data-actionid="'+e.id+'" data-moduleid="'+e.module_id+'">'+d+"</a></div></div>"},toggle_action_common:function(e){var t=$(e).data("type"),a=$(e).data("actionid"),e=$(e).data("moduleid");$.ajax({type:"POST",url:StrackPHP.setActionCommonStatus,data:{mode:"common"===t?"cancel":"set",action_id:a,module_id:e},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.search_action(Strack.get_obj_by_id("action_search_bnt"))):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},close_action_slider:function(e){$("#action_list_slider").sidebar("toggle")},click_run_action:function(r){Strack.Websocket.init("action",{ws_type:"websocket",url:"ws://localhost:9888",afterInit:function(e){if("error"===e.status)layer.msg(e.message,{icon:7,time:1200,anim:6});else{var e=$(r).data("from"),t=$(r).data("actionid"),a=$(r).data("moduleid");switch(e){case"grid_edit":case"grid":var i,d=$(r).data("grid"),d=$("#"+d).datagrid("getSelections");0<d.length?(i=[],d.forEach(function(e){i.push(e.id)}),Strack.run_action({action_id:t,module_id:a,link_ids:i})):layer.msg(StrackLang.Please_Select_Grid_One,{icon:2,time:1200,anim:6});break;default:d=$("#action_search_bnt").data("ids");Strack.run_action({action_id:t,module_id:a,link_ids:d})}}}})},run_action:function(t){$.ajax({type:"POST",url:StrackPHP.getActionModuleData,dataType:"json",contentType:"application/json",data:JSON.stringify(t),beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.Websocket.List.action.send(JSON.stringify({action_id:t.action_id,link_ids:t.link_ids,module_data:e}))}})},word_limit:function(e,t){return t<e.length?e.substr(0,t)+"...":e},format_step_task:function(a){var i,d="",r={};return a.field_data&&a.field_data.forEach(function(e,t){"thumb"===a.config.fields&&"media"===a.config.module_code?(i=a.config.field.replace("thumb","param"),i=a.row_data[i][t].fields.value,e.fields.value&&i?r[a.config.fields]={total:1,rows:[{id:0,param:JSON.parse(i),thumb:e.fields.value}]}:r[a.config.fields]={total:0,rows:[]}):r[a.config.fields]=e.fields.value,d+=Strack.widget_input_dom(a.config,e.primary.value,Strack.widget_input_value(a.config,r,a.project_id,!1,{primary:e.primary.value,module_id:a.module_id,from:"grid"}),"grid",!1,{module_id:e.module_id,url:e.url})}),d},generate_grid_columns_config:function(col_config,param,columns_field_config,step_first_col_status){var cols=[];return col_config.forEach(function(val){if(val.step){if(val.hidden&&step_first_col_status[val.belong])return!1;val.formatter=function(e,t,a){return Strack.format_step_task({project_id:param.project_id,module_id:param.task_module_id,config:columns_field_config[val.field],field_data:e,row_data:t})}}else if(val.outreach_formatter&&(val.formatter=function(value,row,index){return eval(val.outreach_formatter)}),"yes"===val.is_has_many&&(val.formatter=function(e,t,a){if(e&&0<e.total){var i=[];return e.rows.forEach(function(e){i.push(e.name)}),i.join(" , ")}return""}),"custom"===val.field_type)switch(val.custom_type){case"belong_to":switch(val.custom_config.relation_module_code){case"media":val.formatter=function(e,t,a){return e&&0<e.total?Strack.build_grid_preview_thumb_dom({id:t.id,thumb:e.rows[0].thumb,param:e.rows[0].param,module_id:param.module_id,field_type:"horizontal",field_config:columns_field_config[val.field]}):Strack.build_grid_preview_thumb_dom({id:t.id,thumb:null,param:null,module_id:param.module_id,field_type:"horizontal",field_config:columns_field_config[val.field]})};break;case"status":val.formatter=function(e,t,a){return e&&0<e.total?Strack.widget_status_dom(e.rows[0].icon,e.rows[0].name,e.rows[0].color):""}}break;case"checkbox":val.formatter=function(e,t,a){return"on"===e?StrackLang.Checked:StrackLang.UnChecked}}else!val.step&&"media"===val.module_code&&0<=val.field.indexOf("thumb")&&(val.formatter=function(e,t,a){var i=val.field.replace("thumb","param");return e&&t[i]?Strack.build_grid_preview_thumb_dom({id:t.id,thumb:e,param:t[i],module_id:param.module_id,field_type:"direct",field_config:columns_field_config[val.field]}):Strack.build_grid_preview_thumb_dom({id:t.id,thumb:null,param:null,module_id:param.module_id,field_type:"direct",field_config:columns_field_config[val.field]})});if(val.editor)switch(val.editor.type){case"tagbox":var query_params={primary:0,add_default:"no",project_id:param.project_id,module:val.module,field_type:val.field_type,fields:val.field,variable_id:val.variable_id,frozen_module:val.frozen_module,flg_module:val.flg_module,data_source:val.data_source,module_id:param.module_id};val.editor.options={height:"auto",valueField:"id",textField:"name",method:"post",url:StrackPHP.getWidgetData,hasDownArrow:!0,limitToList:!0,queryParams:query_params},"tag"===val.module&&(val.editor.options.limitToList=!1,val.editor.options.allowInput=!0,val.editor.options.appendToDB={allow:!0,param:query_params}),val.group&&(val.editor.options.groupField="group");break;case"combobox":val.editor.options={height:31,valueField:"id",textField:"name",method:"post",url:StrackPHP.getWidgetData,queryParams:{primary:0,project_id:param.project_id,module:val.module,field_type:val.field_type,fields:val.field,variable_id:val.variable_id,frozen_module:val.frozen_module,flg_module:val.flg_module,data_source:val.data_source,module_id:param.module_id}},val.group&&(val.editor.options.groupField="group")}cols.push(val)}),cols},load_grid_columns:function(e,t,a){var i=t.loading_type||"white";$.ajax({type:"POST",url:StrackPHP.getGridColumns,data:t,dataType:"json",beforeSend:function(){$(t.loading_id).append(Strack.loading_dom(i,"","grid_columns"))},success:function(e){200===parseInt(e.status)&&(e=Strack.generate_grid_columns_data(t,e)),a(e),$("#st-load_grid_columns").remove()}})},generate_schema_page:function(e){var t="";switch(e){case"correlation_base":t="project_base";break;case"user":t="admin_account";break;case"action":t="admin_action";break;case"eventlog":t="admin_eventlog";break;default:t="project_"+e}return t},generate_grid_columns_data:function(e,t){var a=0,i=0;Strack.G.dataGridStepColunmsConfig[e.grid_id]={step_list:[],step_columns:{}},t.grid.step_columns_config.step_list&&t.grid.step_columns_config.step_list.forEach(function(a){Strack.G.dataGridStepColunmsConfig[e.grid_id].step_columns[a.code]={},Strack.G.dataGridStepColunmsConfig[e.grid_id].step_list.push(a.code);var i,d,r,o="",n=[],s=[],l={},c=0;0<(c=t.grid.step_columns_config.step_fields.length)&&(t.grid.step_columns_config.step_fields.forEach(function(e,t){r=e.width||160,d=e.module_code+"_"+e.fields,i=a.code+"_"+d,l={field:i,title:e.lang,align:"center",width:r,findex:t+1,hidden:!0,drag:!1,step:!0,step_index:"",belong:a.code},0===t?(l.bdc=a.color,l.cbd="colboth",l.cellClass="datagrid-cell-c1-"+i,l.deltaWidth=1,l.hidden=!1,l.step_index="first",o=d):n.push(d),t===c-1&&(l.bdc=a.color,l.cbd="colright",l.cellClass="datagrid-cell-c1-"+i,l.deltaWidth=1,l.step_index="last"),s.push(l)}),Strack.G.dataGridStepColunmsConfig[e.grid_id].step_columns[a.code]={first:{bgc:a.color,but:a.code,class:a.code+"_h",colspan:1,fhcol:!0,fname:a.code,step:"yes",title:a.name,first_field:o,field_list:n.join(",")},second:s})});var d,r,o,n=t.grid.columnsFieldConfig;return 1===t.grid.columns.length?d=t.grid.columns[a=0]:(d=t.grid.columns[a=1],r=[],o={},t.grid.columns[0].forEach(function(e){"yes"===e.step?"yes"!==e.hidden_status?(r.push(e),o[e.fname]=!1):o[e.fname]=!0:r.push(e)}),t.grid.columns[0]=r),t.grid.columns[a]=Strack.generate_grid_columns_config(d,e,n,o),d=1===t.grid.frozenColumns.length?t.grid.frozenColumns[i=0]:t.grid.frozenColumns[i=1],t.grid.frozenColumns[i]=Strack.generate_grid_columns_config(d,e,n,o),t},generate_grid_right_menu:function(a){var i,d,r,o=[],n="",s=[],l="";return $(a.contextMenuData.edit_id).children(".item").each(function(){var e,t;i="right_menu_"+Math.floor(1e6*Math.random()+1),"DIV"===$(this).prop("tagName")?(n=$(this).attr("data-lang"),e={id:i,lang:n,iconCls:"",type:"button",click:"",children:[]},t=[],$(this).find(".group-field").each(function(){i="right_menu_item"+Math.floor(1e6*Math.random()+1),n=Strack.trim_spaces($(this).text(),"g"),d=$(this).attr("onclick"),t.push({id:i,lang:n,iconCls:"",type:"function",click:d,attr_data:{grid:a.id,moduleid:a.moduleId}})}),0<t.length&&(e.children=t,o.push(e))):(n=Strack.trim_spaces($(this).text(),"g"),r=$(this).attr("data-lang"),s=$(this).find("i").attr("class"),l=s?s.split(" ")[0]:"",d=$(this).attr("onclick"),o.push({id:i,lang:n,iconCls:l,type:"function",click:d,attr_data:{lang:r,grid:a.id,moduleid:a.moduleId}}))}),o.push({id:"ac_copy_cell",lang:StrackLang.Copy_Grip_Cell,iconCls:"icon-uniE943",type:"function",click:"Strack.copy_to_clipboard(this)",attr_data:{"clipboard-action":"copy","clipboard-target":"#grid_clipboard"}}),o},right_menu_dom:function(e){var t;0===$("#"+e.id).length&&(t="",e.data.forEach(function(e){e.children?t+=Strack.menu_item_dom("multi",e):t+=Strack.menu_item_dom("single",e)}),$("body").append('<div id="'+e.id+'" class="easyui-menu">'+t+"</div>"),$("#"+e.id).menu({itemHeight:28,minWidth:160}),e.copy_id&&new Clipboard("#st_menu_"+e.copy_id))},menu_item_dom:function(e,t){var a="",i="iconCls:'"+t.iconCls+"'";switch(e){case"single":a+='<div id="st_menu_'+t.id+'" data-options="'+i+'" '+Strack.menu_item_atrr(t)+">"+t.lang+"</div>";break;case"multi":var d;a+='<div id="st_menu_'+t.id+'" data-options="'+i+'" '+Strack.menu_item_atrr(t)+">"+t.lang+"<div>",t.children.forEach(function(e){d="iconCls:'"+e.iconCls+"'",a+='<div id="st_menu_'+e.id+'" data-options="'+d+'" '+Strack.menu_item_atrr(e)+">"+e.lang+"</div>"}),a+="</div></div>"}return a},menu_item_atrr:function(e){var t="";if("function"===e.type)for(var a in t+='onclick="'+e.click+'"',e.attr_data)t+=" data-"+a+'="'+e.attr_data[a]+'"';return t},load_view_config:function(e,i,d){$.ajax({type:"POST",url:StrackPHP.getListViewConfig,data:i,dataType:"json",success:function(e){var t=$("#"+i.tool_id),a=t.find(".grid_sort");a.append(Strack.toolbar_down_init("sort",i.module_code,e.sort_list,i.opts,"list")),Strack.init_show_sort_down_icon(a,e.sort_config.sort_data,e.sort_config.sort_type),t.find(".grid_group").append(Strack.toolbar_down_init("group",i.module_code,e.group_list,i.opts,"list")),t.find(".grid_view").append(Strack.toolbar_view_init("view",e.view_list,"list")),d(e)}})},toolbar_down_init:function(d,e,t,r){var a,o="";"show"===d&&(Strack.G.gridFieldCache[t.toolbarConfig.page]={});var i,n={grouping_of_persons:{icon:"icon-uniF007",lang:StrackLang.Persons_View_Mode},grouping_of_stage:{icon:"icon-uniE9C6",lang:StrackLang.Stage_View_Mode},status:{icon:"icon-uniE9D0",lang:StrackLang.Status_View_Mode}};for(i in e)for(var s in e[i])$.isEmptyObject(e[i][s].fields)||(t.isKanban?e[i][s].fields.forEach(function(e){var t,a,i;"yes"===e.can_use_kanban_view&&(i=t="",a="basic blue",i="status"===e.module?(t=n.status.icon,n.status.lang):(t=n[e.kanban_view_mode].icon,n[e.kanban_view_mode].lang),e.is_checked&&(a="green"),o+='<div class="aign-left"><a href="javascript:;" class="ui '+a+' button view-kanban-mode" onclick="Strack.toggle_kanban_view(this);" data-panel="'+r+'" panel="'+r+'" from="'+d+'" field="'+e.fields+'" field_type="'+e.field_type+'" field_width="'+e.width+'" field_sort="'+e.sort+'" field_edit="'+e.edit+'" module="'+e.module+'" table="'+e.table+'" module_code="'+e.module_code+'" module_type="'+e.module_type+'" belong="'+e.belong+'" editor="'+e.editor+'" lang="'+e.lang+'" value_show="'+e.value_show+'" can_use_kanban="'+e.can_use_kanban_view+'"><i class="icon-left '+t+'"></i>'+i+"</a></div>")}):(a="",e[i][s].fields.forEach(function(e){a+=Strack.toolbar_down_item(d,e,r),"show"===d&&(Strack.G.gridFieldCache[t.toolbarConfig.page][e.value_show]=e)}),o+='<div class="divider custom-menu-item"></div>',o+=Strack.toolbar_down_other(e[i][s].title,a)));return o},toolbar_down_other:function(e,t){var a="";return a+='<div class="item custom-menu-item"><i class="dropdown icon"></i>'+e+'<div class="menu st-down-menu">'+t+"</div></div>"},toolbar_down_item:function(e,t,a){var i="",d=e+"_"+t.module+"_"+t.fields,r=t.is_checked?"icon-checked":"icon-unchecked",o="";return"group"===e&&"yes"===t.can_use_kanban_view&&(o='<span class="can-use-kanban icon-uniE6E7"></span>'),i+='<a href="javascript:;" id="'+d+'" class="item '+(e+"-field")+'" onclick="Strack.click_down_item(this);" panel="'+a+'" from="'+e+'" field="'+t.fields+'" field_type="'+t.field_type+'" field_width="'+t.width+'" field_sort="'+t.sort+'" field_edit="'+t.edit+'" module="'+t.module+'" table="'+t.table+'" module_code="'+t.module_code+'" module_type="'+t.module_type+'" belong="'+t.belong+'" editor="'+t.editor+'" lang="'+t.lang+'" value_show="'+t.value_show+'" can_use_kanban="'+t.can_use_kanban_view+'"><i class="icon-left '+r+'"></i>'+t.lang+o+"</a>"},toolbar_step_init:function(e,t,a,i){var d="";return t.forEach(function(e){d+=Strack.toolbar_step_dom(e,a)}),d},toolbar_step_dom:function(e,t){var a="",i="";e.is_checked?a='<i class="icon-uniEA39"></i>':i="hide";var d="";return d+='<a href="javascript:;" id="stid_'+e.code+'" class="item steps_box custom-menu-item '+i+'" onclick="Strack.toggle_steps(this);" data-step="'+e.code+'" data-stepid="'+e.id+'" data-grid="'+t.id+'" data-maindom="'+t.searchConfig.filterBar.main_dom+'"><div class="steps_box_icon">'+a+'</div><div class="steps_box_color" style="background-color:#'+e.color+'"></div><div class="steps_box_name">'+e.name+"</div></a>"},toolbar_common_action:function(t,a,e){var i="";return e.forEach(function(e){e.grid=t,e.module_id=a.moduleId,i+=Strack.common_action_dom("grid_edit",e)}),i},common_action_dom:function(e,t){var a="",i=t.link_id||0;return a+='<a href="javascript:;" class="item group-field" onclick="Strack.click_run_action(this);" data-from="'+e+'" data-grid="'+t.grid+'" data-actionid="'+t.id+'" data-linkid="'+i+'" data-moduleid="'+t.module_id+'">'+t.name+"</a>"},show_all_steps:function(e){e={mode:"show_all",grid:$(e).data("grid"),maindom:$(e).data("maindom")};Strack.show_or_hide_steps(e)},hide_all_steps:function(e){e={mode:"hide_all",grid:$(e).data("grid"),maindom:$(e).data("maindom")};Strack.show_or_hide_steps(e)},toggle_steps:function(e){var t={mode:"",step:$(e).data("step"),step_id:$(e).data("stepid"),grid:$(e).data("grid"),maindom:$(e).data("maindom")};$(e).hasClass("hide")?(t.mode="show",$(e).removeClass("hide")):(t.mode="hide",$(e).addClass("hide")),Strack.show_or_hide_steps(t)},show_or_hide_steps:function(a){var i,d,r=$("#"+a.grid),e=r.datagrid("options"),t=e.columns.length,t=e.columns[t-1],o=[];switch(t.forEach(function(e){e.step&&(0<=$.inArray(a.mode,["show","hide"])&&e.belong===a.step||0<=$.inArray(a.mode,["hide_all","show_all"]))&&o.push({field:e.field,belong:e.belong})}),a.mode){case"show":0<(d=$("."+a.step+"_h")).length?o.forEach(function(e){d.is(":hidden")&&e.belong===a.step&&(d.show(),r.datagrid("showColumn",e.field),1<d.attr("colspan")&&(i=d.find(".colswitch").data("fieldlist"),i.split(",").forEach(function(e){r.datagrid("showColumn",a.step+"_"+e)})))}):(n=Strack.G.dataGridStepColunmsConfig[a.grid].step_columns[a.step],$.isEmptyObject(n)||r.datagrid("appendStepColumn",n).datagrid("reload"));break;case"hide":o.forEach(function(e){e.belong===a.step&&(r.datagrid("hideColumn",e.field),$("."+e.belong+"_h").hide())});break;case"show_all":var n=Strack.G.dataGridStepColunmsConfig[a.grid].step_list,s=!1,l={};o.forEach(function(e){l.hasOwnProperty(e.belong)||(l[e.belong]=e)}),n.forEach(function(t){var e;0<(d=$("."+t+"_h")).length?d.is(":hidden")&&(d.show(),r.datagrid("showColumn",l[t].field),1<d.attr("colspan")&&(i=d.find(".colswitch").data("fieldlist"),i.split(",").forEach(function(e){r.datagrid("showColumn",t+"_"+e)}))):(s=!0,e=Strack.G.dataGridStepColunmsConfig[a.grid].step_columns[t],$.isEmptyObject(e)||r.datagrid("appendStepColumn",e))}),s&&r.datagrid("reload");break;case"hide_all":o.forEach(function(e){r.datagrid("hideColumn",e.field),$("."+e.belong+"_h").hide()})}Strack.show_or_hide_steps_icon(a)},show_or_hide_steps_icon:function(e){var t;$("#"+e.maindom).find(".steps_box").each(function(){switch(t=$(this).data("step"),e.mode){case"show":e.step===t&&$(this).find(".steps_box_icon").html('<i class="icon-uniEA39"></i>');break;case"hide":e.step===t&&$(this).find(".steps_box_icon").empty();break;case"show_all":$(this).find(".steps_box_icon").html('<i class="icon-uniEA39"></i>');break;case"hide_all":$(this).find(".steps_box_icon").empty()}})},show_or_hide_grid_step:function(e){var t=$(e);t.html('<div class="ui active centered mini inline loader"></div>');var a=t.data("grid"),i=$("#"+a),d=t.attr("data-col"),e=(t.attr("data-color"),t.attr("data-firstfield")),a=t.attr("data-fieldlist").split(","),r=[];0<a.length&&(a.forEach(function(e){r.push(d+"_"+e)}),a=0,t.hasClass("showcol")?(a=1,t.removeClass("showcol").parent().parent().attr("colspan",a),$("td[field="+d+"_"+e+"]").removeClass("colleft").addClass("colboth"),setTimeout(function(){t.html('<i class="icon-uniF101"></i>')},200)):(a=r.length+1,t.addClass("showcol").parent().parent().attr("colspan",a),$("td[field="+d+"_"+e+"]").removeClass("colboth").addClass("colleft"),setTimeout(function(){t.html('<i class="icon-uniF100"></i>')},200)),i.datagrid("ResetStepColumnColspan",{step:d,colspan:a,field_list:r}))},toolbar_view_init:function(t,e,a){var i="",d="",r="";return $.isEmptyObject(e)||(e.views.forEach(function(e){e.checked||$(".grid_view_mode").attr("view_mode",e.view_mode).html("切换到"+e.name)}),r+='<div class="divider custom-menu-item"></div>',r+=Strack.toolbar_view_item(t,e.checked,"view-g-active",a),$(".current_view").text("（"+e.checked.name+"）"),e.self.forEach(function(e){i+=Strack.toolbar_view_item(t,e,"",a)}),r+='<div class="divider custom-menu-item"></div>',r+=Strack.toolbar_down_other(StrackLang.Self_View,i),e.public.forEach(function(e){d+=Strack.toolbar_view_item(t,e,"",a)}),r+='<div class="divider custom-menu-item"></div>',r+=Strack.toolbar_down_other(StrackLang.Public_View,d)),r},toolbar_view_mode_item:function(e,t,a,i){var d="",r=t.checked?"icon-checked":"icon-unchecked";return d+='<a href="javascript:;" class="item view-mode-item custom-menu-item '+a+'" onclick="Strack.click_view_mode_item(this);" data-panel="'+i+'" from="view_mode" view_mode="'+t.view_mode+'" ><i class="icon-left '+r+'"></i>'+t.name+"</a>"},toolbar_view_item:function(e,t,a,i){var d="",r=t.checked?"icon-checked":"icon-unchecked",o=t.show_artist?'<span style="color: #777"> ( '+t.user_name+" ) </span>":"";return d+='<a href="javascript:;" class="item view-g-item custom-menu-item '+a+'" onclick="Strack.click_down_item(this);" panel="'+i+'" from="'+e+'" view_id="'+t.id+'" view_name="'+t.name+'" view_public="'+t.public+'" allow_edit="'+t.allow_edit+'"><i class="icon-left '+r+'"></i>'+t.name+o+"</a>"},build_view_toolbar:function(t,a){$.ajax({type:"POST",url:StrackPHP.getViewData,dataType:"json",data:{module_id:t.module_id,structure_id:t.structure_id,tab_name:t.tab_name},success:function(e){Strack.build_toolbar_sort(t,e.sort_fields),Strack.build_toolbar_group(t,e.group_fields),a(e)}})},build_toolbar_sort:function(t,e){var a=$("#"+t.tab_name+"_sort_"+t.structure_id),i="";0<a.length&&("list"===t.tab_name&&e.forEach(function(e){i+=Strack.sort_field_dow(t,e)}),a.empty().append(i))},sort_field_dow:function(e,t){var a="";return a+='<a href="javascript:;" id="sort_field_'+e.tab_name+"_"+e.structure_id+"_"+t.field+'" class="item sort_fields" onclick="Strack.sort_change(this);" data-field="'+t.field+'" data-pid="'+t.p_id+'" data-structureid="'+t.structure_id+'" data-grid="'+t.grid+'"><i class="icon-left sort_list icon-unchecked"></i>'+t.lang+"</a>"},build_toolbar_group:function(t,e){var a=$("#"+t.tab_name+"_group_"+t.structure_id),i="";0<a.length&&("list"===t.tab_name&&e.forEach(function(e){i+=Strack.group_field_dow(t,e)}),a.empty().append(i))},group_field_dow:function(e,t){var a="";return a+='<a href="javascript:;" id="group_field_'+e.tab_name+"_"+e.structure_id+"_"+t.field+'" onclick="Strack.group_sort_change(this);" data-field="'+t.field+'" data-pid="'+t.p_id+'" data-structureid="'+t.structure_id+'" data-grid="'+t.grid+'"><i class="icon-left filter_list icon-unchecked"></i>'+t.lang+"</a>"},project_warn:function(e){return'<div class="page-warning"><i class="icon-uniF071"></i>'+e+"</div>"},init_breadcrumb:function(t,a,i){$.ajax({type:"POST",url:StrackPHP.getModuleBreadcrumb,dataType:"json",data:a,beforeSend:function(){$("#"+t).append(Strack.loading_dom("white","","breadcrumb"))},success:function(e){e=Strack.breadcrumb_dom(e,a);$("#"+t).empty().append(e),i&&i(e)}})},details_url:function(e,t){return Strack.remove_html_ext(StrackPHP.details)+"/"+e.module_id+"-"+e.project_id+"-"+t+".html"},breadcrumb_dom:function(e,t){var a=[],i=Strack.remove_html_ext(StrackPHP.details);return e.forEach(function(e){"no"===e.is_self?"no"===e.is_details?a.push('<a class="section" href="'+e.url+'" title="('+e.module_lang+") "+e.name+'" target="_blank">('+e.module_lang+") "+e.name+"</a>"):a.push('<a class="section" href="'+i+"/"+e.module_id+"-"+t.project_id+"-"+e.item_id+'.html" title="('+e.module_lang+") "+e.name+'" target="_blank">('+e.module_lang+") "+e.name+"</a>"):a.push('<div class="section" title="'+e.name+'">'+e.name+"</div>")}),'<div class="ui small breadcrumb" >'+a.join('<div class="divider"> / </div>')+"</div>"},init_tab_list:function(t,a,i){$.ajax({type:"POST",url:StrackPHP.getTabConfig,dataType:"json",data:a,beforeSend:function(){$("#"+t).append(Strack.loading_dom("white","","tab"))},success:function(e){Strack.generate_tab_list(t,a,e),i(e),$("#st-load_tab").remove()}})},generate_tab_list:function(t,e,a){var i=$("#"+t),d=i.find(".tabs-tab-list"),r="";0<a.length&&a.forEach(function(e){r+=Strack.tab_item_dom(t,e)}),"yes"===e.rule_template_fixed_tab&&(r+=Strack.tab_item_config_dom(e)),d.empty().append(r),Strack.tab_auto_hide(i);e=0,e="details"===i.attr("data-pos")?document.body.clientWidth:i.width();d[0].scrollWidth>e&&i.addClass("tabs-nav-container-scrolling")},tab_auto_hide:function(e){var t=e.find(".tabs-tab-prev"),a=e.find(".tabs-tab-next");e.on("mresize",function(){Strack.init_tab_scrolling(e,t,a)})},tab_item_dom:function(e,t){var a="",i="be_horizontal_relationship"===t.type?'<i class="icon-uniE692 icon-left"></i>'+t.name:t.name;return a+='<a href="javascript:;" id="'+t.tab_id+'" class="item tab_item" onclick="Strack.select_tab_item(this);"  data-parentid="'+e+'" data-horizontaltype="'+t.horizontal_type+'" data-table="'+t.table+'" data-tabid="'+t.tab_id+'" data-group="'+t.group+'" data-type="'+t.type+'" data-moduleid="'+t.module_id+'"  data-dstmoduleid="'+t.dst_module_id+'"  data-dstmodulecode="'+t.dst_module_code+'" data-variableid="'+t.variable_id+'" data-modulecode="'+t.module_code+'" data-moduletype="'+t.module_type+'">'+i+"</a>"},tab_item_config_dom:function(e){var t="";return t+='<a href="javascript:;" class="item tab_item" onclick="Strack.tab_item_config(this);" data-itemid="'+e.item_id+'" data-moduleid="'+e.module_id+'" data-modulecode="'+e.module_code+'" data-templateid="'+e.template_id+'" data-projectid="'+e.project_id+'"><i class="icon-uniF013 icon-left"></i>'+StrackLang.Template_Fixed_Tab+"</a>"},tab_item_config:function(e){var t=StrackLang.Template_Fixed_Tab,a=$(e).attr("data-moduleid"),i=$(e).attr("data-itemid"),d=$(e).attr("data-modulecode"),r=$(e).attr("data-templateid"),o=$(e).attr("data-projectid"),e=$(e).closest(".projitem-footer").attr("data-pos");Strack.template_set_dialog({datalist_url:StrackPHP.getModuleTabList,config_url:StrackPHP.getTemplateConfig,title:t,item_id:i,temp_id:r,module_code:d,module_id:a,project_id:o,category:"tab",id_field:"tab_id",text_field:"name",text_field_lang:StrackLang.Tab,group:"group",limit:0,submit_bnt:"update_details_tab_set",pos:e})},select_tab_item:function(e){var t=$(e).html(),a=$(e).attr("data-parentid"),i=$(e).attr("data-tabid"),d=$(e).attr("data-moduleid"),r=$(e).attr("data-moduletype"),o=$(e).attr("data-dstmoduleid"),n=$(e).attr("data-dstmodulecode"),s=$(e).attr("data-modulecode"),l=$(e).attr("data-variableid"),c=$(e).attr("data-type"),_=$(e).attr("data-group"),m=$(e).attr("data-horizontaltype"),u=$(e).attr("data-table");switch(a){case"details_tab":obj.show_details_tab_page({tab_id:i,name:t,type:c,group:_,module_id:d,module_type:r,dst_module_id:o,dst_module_code:n,variable_id:l,module_code:s,horizontal_type:m,table:u});break;case"grid_slider_tab":Strack.show_datagrid_slider_tab({tab_id:i,name:t,type:c,group:_,module_id:d,dst_module_id:o,dst_module_code:n,module_code:s,variable_id:l,horizontal_type:m,table:u})}},active_select_tab:function(e,t){$("#"+e).find(".tabs-tab-list .tab_item").each(function(){$(this).attr("data-tabid")===t?$(this).addClass("active"):$(this).removeClass("active")})},init_tab_scrolling:function(e,t,a){var i=0,d=e.find(".tabs-tab-list"),r=d[0].scrollWidth;Strack.G.leftScrolling=0,d.scrollLeft(0),t.addClass("tabs-tab-btn-disabled"),a.removeClass("tabs-tab-btn-disabled");("details"===e.attr("data-pos")?document.body.clientWidth:e.width())<r?e.hasClass("scrolling_active")||(e.addClass("scrolling_active"),e.addClass("tabs-nav-container-scrolling"),t.addClass("tabs-tab-arrow-show").addClass("tabs-tab-btn-disabled").on("click",function(){$(this).hasClass("tabs-tab-btn-disabled")||(i=d.width(),0<Strack.G.leftScrolling&&(Strack.G.leftScrolling=d.scrollLeft()-i,d.scrollLeft(Strack.G.leftScrolling),a.removeClass("tabs-tab-btn-disabled"),Strack.G.leftScrolling<=0&&t.addClass("tabs-tab-btn-disabled")))}),a.addClass("tabs-tab-arrow-show").on("click",function(){$(this).hasClass("tabs-tab-btn-disabled")||(i=d.width(),Strack.G.leftScrolling<=r&&(Strack.G.leftScrolling=i+d.scrollLeft(),d.scrollLeft(Strack.G.leftScrolling),t.removeClass("tabs-tab-btn-disabled"),Strack.G.leftScrolling>=r&&a.addClass("tabs-tab-btn-disabled")))})):(e.removeClass("tabs-nav-container-scrolling"),e.removeClass("scrolling_active"),e.find(".tabs-tab-prev").removeClass("tabs-tab-arrow-show").off("click"),e.find(".tabs-tab-next").removeClass("tabs-tab-arrow-show").off("click"))},dialog_cancel:function(e){e?(e=$(e).closest(".window-body").attr("id"),$("#"+e).dialog("close")):$("#dialog").dialog("close")},scheduler_tips:function(a,e){$.ajax({url:StrackPHP.getSchedulerTips,type:"post",data:{resourceId:e},dataType:"json",success:function(e){var t="";e.forEach(function(e){t+="<p>"+e+"</p>"}),layer.tips(t,a,{tips:[3,"#464646"],time:2e4})}})},widget_field_validate:function(t){var a="";return["status_id"].every(function(e){return 0<=t.indexOf(e)?(a=e,!1):(a=t,!0)}),a},widget_input_value:function(e,t,a,i,d){var r,o,n=e.value_show,s={value:t[n],project_id:a};if("custom"===e.field_type&&("belong_to"===e.type&&0<=$.inArray(e.relation_module_code,["status","media"])||e.hasOwnProperty("custom_config")&&0<=$.inArray(e.custom_config.relation_module_code,["status","media"])))switch((e.hasOwnProperty("custom_config")?e.custom_config:e).relation_module_code){case"status":t[n]&&0<t[n].total?(s.value=t[n].rows[0].id,s.show_val=Strack.widget_status_dom(t[n].rows[0].icon,t[n].rows[0].name,t[n].rows[0].color),s.bg_clolor=t[n].rows[0].color,s.font_set=!0):(s.value="",s.show_val="");break;case"media":s.value="",s.show_val=Strack.thumb_media_common_dom(t[n],{param:d,from:d.from,config:e})}else"custom"===e.field_type&&"has_many"===e.editor_type?t[n]&&0<t[n].total?(r=[],o=[],t[n].rows.forEach(function(e){r.push(e.id),o.push(e.name)}),s.value=r.join(","),s.show_val=o.join(",")):(s.value="",s.show_val=""):"thumb"===e.fields&&"media"===e.module_code?(s.value="",s.show_val=Strack.thumb_media_common_dom(t[n],{param:d,from:d.from,config:e})):t[n]&&0<=t[n].total?(r=[],o=[],0<t[n].total?(t[n].rows.forEach(function(e){r.push(e.id),o.push(e.name)}),s.value=r.join(","),s.show_val=o.join(",")):(s.value="",s.show_val="")):s.show_val=t[n],s.bg_clolor="",s.font_set="";return s},generate_widget:function(e,t,a,i,d,r){var o=d||"",n=r||0,s="";if("no"===e.group)e.data.forEach(function(e){"yes"===e.show&&(s+=Strack.widget_input_dom(e,a,Strack.widget_input_value(e,t,i,!1,{primary:a,module_id:n,from:o}),o,!0,{module_id:n}))});else for(var l in e.data)s+='<div class="task-info-names"><i class="icon-uniF05A icon-left"></i>'+StrackLang[l]+"</div>",e.data[l].forEach(function(e){"yes"===e.show&&(s+=Strack.widget_input_dom(e,a,Strack.widget_input_value(e,t,i,!0,{primary:a,module_id:n,from:o}),o,!0,{module_id:n}))});return s},translate_timespinner_val:function(e){var t,a=0;return a=e?-1!==e.indexOf(":")?(t=e.split(":"),60*parseFloat(t[0])+parseFloat(t[1])):parseFloat(e):a},calculation_progress_bar:function(e,t,a){var i=0,d=0,r="",o="",n=0,s=0,l=0,c=0;a<=t?(d=(i=t)-a,c=a,r="shortage",o="剩余工时",s=0<i?(n=a/i*100).toFixed(2)+"%":"0%",l=100-n):(r="over",o="超时工时",n=100-(l=(d=(i=a)-(c=t))/i*100),s=(100+l).toFixed(2)+"%");var _=100,m=100;e<i?0<i&&(_=e/i*100):0<e&&(m=i/e*100);var u="0px",a="0px",t="0px",i="0px";return 3<n&&(a=n.toFixed(2)+"% - 6px",u="6px"),3<l&&(i=l.toFixed(2)+"% - 6px",t="6px"),{est_progress:{per:_.toFixed(3)+"%",show_val:Strack.format_timespinner_val(e)},actual_plan_progress:{per:m.toFixed(3)+"%",left:{per:a,show_val:Strack.format_timespinner_val(c),show_per:s,padding:u},right:{per:i,show_val:Strack.format_timespinner_val(d),css_name:r,over_name:o,padding:t}}}},format_timespinner_val:function(e){var t=e+"";return e&&-1!==t.indexOf(":")?(t=t.split(":"))[0]+"小时"+t[1]+"分钟":parseInt(e/60)+"小时"+parseInt(e%60)+"分钟"},widget_input_dom:function(e,t,a,i,d,r){var o,n,s=a.bg_clolor?Strack.hex_to_rgb(a.bg_clolor,.3):"transparent",l=a.font_set?"font-size-10":"",c=r.hasOwnProperty("module_id")?r.module_id:0,_="",m="",m="yes"===e.is_foreign_key?(_=e.foreign_key,e.frozen_module):(_=e.fields,e.module_code),u=_+"_"+t+"_"+Math.floor(1e4*Math.random()+1),g="",p=0;switch("custom"===e.field_type&&(p=e.variable_id),o=a.value&&!/^[0-9]+.?[0-9]*$/.test(a.value)?a.value.toString().replace(/\"/g,"&quot;"):a.value||"",i){case"grid":case"min":n={wrap:"item-list-pt",lang:"item-list-ptn",content:"item-list-input",hide:"icon-hide-min"};break;case"schedule":n={wrap:"item-list-pt",lang:"item-list-ptn",content:"schedule-list-input",hide:"icon-hide-min"};break;default:n={wrap:"task-info-items",lang:"task-info-title",content:"task-info-content",hide:"icon-hide"}}var f,h,k={},v="";switch(e.editor){case"textarea":k.ellipsis="info-textarea",v=a.show_val?Strack.revert_textarea(a.show_val):"";break;case"timespinner":a.show_val&&-1!==a.show_val.indexOf(":")?v=(h=a.show_val.split(":"))[0]+"小时"+h[1]+"分钟":(v=(f=parseInt(a.show_val/60))+"小时"+(h=parseInt(a.show_val%60))+"分钟",a.value=f.toFixed(2)+":"+h.toFixed(2));break;default:k.ellipsis="text-ellipsis",v=a.show_val||""}g+='<div class="'+n.wrap+' overflow-hide">',d&&(g+='<div class="'+n.lang+' aign-left">'+e.lang+"</div>");d=e.value_show+"_"+t;g+='<div class="widget_input '+n.content+" aign-left item-hover "+d+" "+l+' " style="background-color:'+s+'">';l="";e.data_source&&(l=e.data_source);s=e.mask||"";return"deny"!==e.edit&&(e.from_module_code===e.belong_module&&"none"!==e.editor||e.from_module_code!==e.belong_module&&"none"!==e.outreach_editor)?(g+='<a href="javascript:;" class="aign-right '+n.hide+' widget-edit" onclick="Strack.widget_input_edit(this)"  data-widgetid="'+u+'" data-module="'+e.module+'" data-flgmodule="'+e.flg_module+'" data-table="'+e.table+'" data-ofields='+e.fields+' data-fields="'+_+'" data-fieldtype="'+e.field_type+'" data-value="'+o+'" data-primary="'+t+'"  data-editor="'+e.editor+'" data-mask="'+s+'" data-multiple="'+e.multiple+'" data-projectid="'+a.project_id+'" data-frozenmodule="'+m+'" data-datasource="'+l+'" data-variableid="'+p+'" data-moduleid="'+c+'" data-modulecode="'+e.module_code+'" data-fielduuid="'+d+'">',g+='<i class="icon-uniE684"></i>'):(g+='<a href="javascript:;" class="aign-right '+n.hide+' widget-edit">',g+='<i class="icon-uniE63D2"></i>'),g+="</a>","grid"===i?"thumb"===e.fields||"custom"===e.field_type&&"media"===e.custom_config.relation_module_code?(g+='<div class=item-list-ptc">',g+=v,g+="</div>"):(g+='<a href="'+(r.hasOwnProperty("url")?r.url:"javascript:;")+'" class="info-content-show  info-grid-content '+k.ellipsis+" widget-show-"+u+'" target="_blank">',g+=v,g+="</a>"):(g+='<div class="info-content-show  '+k.ellipsis+" widget-show-"+u+'">',g+=v,g+="</div>"),g+="</div>",g+="</div>"},widget_input_edit:function(e){var t=$(e).parent().width(),a=35<(a=$(e).parent().height())?35:a,i=$(e).attr("data-module"),d=$(e).attr("data-frozenmodule"),r=$(e).attr("data-fields"),o=$(e).attr("data-flgmodule"),n=$(e).attr("data-fieldtype"),s=$(e).attr("data-widgetid"),l=$(e).attr("data-value"),c=$(e).attr("data-primary"),_=$(e).attr("data-editor"),m=$(e).attr("data-validate"),u=$(e).attr("data-mask"),g=$(e).attr("data-multiple"),p=$(e).attr("data-datasource"),f=$(e).attr("data-projectid"),h=$(e).attr("data-moduleid"),k=$(e).attr("data-modulecode"),v=$(e).attr("data-variableid"),b="";m&&(b="length["+(m=m.split(","))[0]+","+m[1]+"]"),"upload"===_?Strack.open_change_item_media({title:StrackLang.Modify_Thumb,link_id:c,module_id:h,mode:"single",from:"common",field_type:n,variable_id:v},function(){}):Strack.widget_edit_active(e,t,a,{module:i,fields:r,flg_module:o,frozen_module:d,field_type:n,widgetid:s,value:l,primary:c,editor:_,validate:b,mask:u,multiple:g,project_id:f,variable_id:v,module_id:h,module_code:k,data_source:p})},widget_edit_active:function(e,t,a,i){Strack.widget_update();var e=$(e),d=e.parent();if(e.hide().next().hide(),d.hasClass("widget-active")){d.addClass("widget-show").find(".info-content-edit").show();var r=d.find(".info-content-edit").find("input").eq(0).attr("id"),o=$("#"+r);switch(i.editor){case"tagbox":i.value&&o.tagbox("setValues",i.value);break;case"combobox":o.combobox("setValue",i.value);break;case"datebox":o.datebox("setValue",i.value);break;case"checkbox":1===parseInt(i.value)?o.prop("checked","checked"):o.removeAttr("checked");break;case"task_repeat":break;default:o.val(i.value)}}else{var n="";switch(r=i.widgetid,i.editor){case"textarea":d.append('<div class="info-content-edit"><textarea id="'+r+'" class="widget-edit" data-module="'+i.module+'" data-field="'+i.fields+'" data-oldval="'+i.value+'" data-fieldtype="'+i.field_type+'" data-widgetid="'+i.widgetid+'"  data-primary="'+i.primary+'"  data-editor="'+i.editor+'" data-variableid="'+i.variable_id+'" data-moduleid="'+i.module_id+'" data-modulecode="'+i.module_code+'" ></textarea></div>').addClass("widget-active widget-show");break;case"task_repeat":var s='<div class="info-content-edit"><a href="javascript:;" id="'+r+'" class="task-repeat ui icon button '+("yes"===i.value?"active":"")+'" onclick="Strack.toggle_task_repeat_editor(this, event)" data-id="'+r+'"><i class="history icon"></i><input id="val_'+r+'" type="hidden" class="widget-edit" data-module="'+i.module+'" data-field="'+i.fields+'" data-oldval="'+i.value+'" data-fieldtype="'+i.field_type+'" data-widgetid="'+i.widgetid+'"  data-primary="'+i.primary+'"  data-editor="'+i.editor+'" data-variableid="'+i.variable_id+'" data-moduleid="'+i.module_id+'" data-modulecode="'+i.module_code+'" /></a></div>';d.append(s).addClass("widget-active widget-show");break;default:0<=$.inArray(i.editor,["input","combobox","datebox"])&&(n="info-content-comb"),d.append('<div class="info-content-edit '+n+'"><input id="'+r+'" class="widget-edit" data-module="'+i.module+'" data-field="'+i.fields+'" data-oldval="'+i.value+'" data-fieldtype="'+i.field_type+'" data-widgetid="'+i.widgetid+'"  data-primary="'+i.primary+'"  data-editor="'+i.editor+'" data-variableid="'+i.variable_id+'" data-moduleid="'+i.module_id+'" data-modulecode="'+i.module_code+'" /></div>').addClass("widget-active widget-show")}Strack.widget_init_dom(r,t,a,i)}},active_inputmask:function(e,t){t&&$("#"+e).inputmask(t)},widget_init_dom:function(t,e,a,i){var d=$("#"+t),r=i.value||i.default_val||"",o="tagbox";switch(i.editor){case"input":case"text":0<=i.validate.indexOf(",")?i.validate:i.validate;d.css({width:e-32,height:a-2,padding:"0px 15px"}).addClass("widget-edit").val(r).select(),Strack.active_inputmask(t,i.mask);break;case"combobox":if("horizontal_relationship"!==i.custom_type){var n=!0,s=!1;switch("yes"===i.multiple&&(s=!0),i.field){case"assignee":case"cc":d.combobox({url:StrackPHP.getWidgetData,queryParams:i,valueField:"id",textField:"name",groupField:i.group,multiple:s,width:e,height:a,editable:n,value:r,formatter:function(e){return Strack.build_comb_avatar(e)}}).next().find("input").eq(0).addClass("widget-edit");break;default:d.combobox({url:StrackPHP.getWidgetData,queryParams:i,valueField:"id",textField:"name",groupField:i.group,multiple:s,width:e,height:a,editable:n,value:r}).next().find("input").eq(0).addClass("widget-edit")}break}o="combobox";case"tagbox":var l={primary:0,add_default:"no",project_id:i.project_id,module:i.module,field_type:i.field_type,fields:i.fields,variable_id:i.variable_id,frozen_module:i.frozen_module,flg_module:i.flg_module,data_source:i.data_source,module_id:i.module_id},c={width:e,height:"auto",minHeight:a-2,valueField:"id",textField:"name",method:"post",url:StrackPHP.getWidgetData,hasDownArrow:!0,limitToList:!0,value:r,queryParams:l};0<=$.inArray(i.module,["tag","tag_link"])&&(c.limitToList=!1,c.allowInput=!0,c.appendToDB={allow:!0,param:l}),i.group&&(c.groupField="group"),("tagbox"===o?d.tagbox(c):d.combobox({url:StrackPHP.getWidgetData,queryParams:l,valueField:"id",textField:"name",groupField:i.group,multiple:!1,width:e,height:a,editable:n,value:r})).next().find("input").eq(0).addClass("widget-edit");break;case"checkbox":l=!(0===parseInt(i.value)||!i.value);d.attr("type","checkbox").attr("checked",l).parent().css("padding","0px 10px");break;case"datebox":d.datebox({width:e,height:a,editable:!1,value:r}).next().find("input").eq(0).addClass("widget-edit");break;case"datetimebox":d.datetimebox({width:e,height:a,editable:!1,value:r}).next().find("input").eq(0).addClass("widget-edit");break;case"timespinner":d.timespinner({width:e,height:a,editable:!0,value:r}).next().find("input").eq(0).addClass("widget-edit");break;case"textarea":d.html(r);break;case"upload":Strack.widget_init_upload_dom(t,e,a,i);break;case"task_repeat":r?$.ajax({type:"POST",url:StrackPHP.getWidgetData,data:JSON.stringify(i),contentType:"application/json",dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.G.repeatTaskConfigData=e,$("body").append(Strack.task_repeat_editor_dom(t,e)),Strack.init_task_repeat_editor(t,e)}}):($("body").append(Strack.task_repeat_editor_dom(t)),Strack.init_task_repeat_editor(t,{mode:"none"}))}},task_repeat_editor_dom:function(e,t){var a="",t=t||{};return 0<$(".task-repeat-editor").length&&Strack.remove_task_repeat_editor(),a+='<div id="task_repeat_'+e+'" class="task-repeat-editor combo-p" data-id="'+e+'"><div id="fixed_repeat_'+e+'"  class="dropdown-wrap ui vertical menu">'+Strack.task_repeat_editor_select_dom("none",t)+Strack.task_repeat_editor_select_dom("daily",t)+Strack.task_repeat_editor_select_dom("weekly",t)+Strack.task_repeat_editor_select_dom("monthly",t)+Strack.task_repeat_editor_select_dom("annually",t)+Strack.task_repeat_editor_select_dom("working_days",t)+'<div class="divider"></div>'+Strack.task_repeat_editor_select_dom("custom",t)+'<div id="tr_optional_tips_'+e+'" class="custom-tips"></div></div><div id="custom_repeat_'+e+'" class="custom-repeat"><div class="cr-head"><a href="javascript:;" class="cr-back" data-id="'+e+'" onclick="Strack.quit_task_custom_repeat(this);"><i class="icon-uniE768"></i>'+StrackLang.Back+'</a></div><div class="cr-form"><div class="cr-f-item cr-f-input"><div class="name aign-left">'+StrackLang.Repeat_Item_Name+'</div><div class="val aign-left"><input id="tr_method_'+e+'"></div></div><div class="cr-f-item cr-f-input"><div class="name aign-left">'+StrackLang.Repeat_Item_Inter+'</div><div class="val aign-left"><input id="tr_inter_'+e+'"><div id="tr_inter_unit_'+e+'" class="unit aign-right"></div></div></div><div class="cr-f-item"><ul id="tr_optional_day_'+e+'" class="optional-days"></ul></div><div class="cr-f-item"><p id="tr_optional_descr_'+e+'" class="repeat-description" data-type="">'+StrackLang.Repeat_Daily+'</p></div><div class="cr-f-item"><div class="aign-right"><a href="javascript:;" id="tr_optional_bnt_'+e+'" class="st-dialog-button st-button-base button-dgsub" onclick="Strack.submit_task_repeat(this);" data-id="'+e+'">'+StrackLang.OK+"</a></div></div></div></div></div>"},task_repeat_editor_select_dom:function(e,t){var a="",i={none:StrackLang.Not_Repeat,daily:StrackLang.Repeat_Daily,weekly:StrackLang.Repeat_Weekly,monthly:StrackLang.Repeat_Monthly,annually:StrackLang.Repeat_Annually,working_days:StrackLang.Repeat_Working_Days,custom:StrackLang.Repeat_Custom},d="none";return a+=e===(d=!$.isEmptyObject(t)?t.mode:d)?'<a href="javascript:;" class="item" onclick="Strack.click_task_repeat_item(this)" data-item="'+e+'">'+i[e]+'<span class="icon aign-right"><i class="icon-uniE764"></i></span></a>':'<a href="javascript:;" class="item" onclick="Strack.click_task_repeat_item(this)" data-item="'+e+'">'+i[e]+'<span class="icon aign-right"></span></a>'},quit_task_custom_repeat:function(e){e=$(e).data("id");$("#fixed_repeat_"+e).show(),$("#custom_repeat_"+e).hide()},click_task_repeat_item:function(e){var t=$(e).data("item"),a=$(e).closest(".task-repeat-editor").data("id"),e=$("#"+a),i="no";switch(t){case"none":i="no",Strack.save_task_repeat_param(a,t);break;case"daily":case"weekly":case"monthly":case"annually":case"working_days":i="yes",Strack.save_task_repeat_param(a,t);break;case"custom":i="yes",$("#fixed_repeat_"+a).hide(),$("#custom_repeat_"+a).show()}e.find("input").val(i),Strack.set_task_repeat_icon(a,t)},save_task_repeat_param:function(e,t){var a={},i=$("#"+e);switch(t){case"none":i.removeClass("active");break;case"daily":case"weekly":case"monthly":case"annually":case"working_days":a.mode=t,a.config={},i.addClass("active");break;case"custom":a.mode=t;var d={mode:"",inter:"",date:[]};d.mode=$("#tr_method_"+e).combobox("getValue"),d.inter=$("#tr_inter_"+e).combobox("getValue"),$("#tr_optional_day_"+e).find(".optional-day").each(function(){$(this).hasClass("active")&&d.date.push($(this).data("id"))}),a.config=d,i.addClass("active")}Strack.G.repeatTaskConfigData=a},set_task_repeat_icon:function(e,t){$("#fixed_repeat_"+e).find(".item").each(function(){$(this).data("item")===t?$(this).find(".icon").html('<i class="icon-uniE764"></i>'):$(this).find(".icon").empty()})},init_task_repeat_editor:function(a,e){var t="daily",i=1,d=$("#val_"+a);"none"!==Strack.G.repeatTaskConfigData.mode?d.val("yes"):d.val("no"),"custom"===Strack.G.repeatTaskConfigData.mode&&(t=Strack.G.repeatTaskConfigData.config.mode,i=Strack.G.repeatTaskConfigData.config.inter,Strack.generate_task_repeat_datebox(a,Strack.G.repeatTaskConfigData.config.mode,i)),$("#tr_method_"+a).combobox({valueField:"id",textField:"text",width:130,value:t,data:[{id:"daily",text:StrackLang.Repeat_Daily},{id:"weekly",text:StrackLang.Repeat_Weekly},{id:"monthly",text:StrackLang.Repeat_Monthly}],onSelect:function(e){var t=$("#tr_inter_unit_"+a);switch(e.id){case"daily":t.html(StrackLang.UnitTH);break;case"weekly":t.html(StrackLang.Week);break;case"monthly":t.html(StrackLang.Months)}$("#tr_inter_"+a).combobox("setValue",1),Strack.generate_task_repeat_datebox(a,e.id)}}),"custom"===e.mode&&"daily"===e.config.mode&&Strack.activate_task_repeat_bnt(a,"active"),$("#tr_inter_"+a).combobox({valueField:"id",textField:"text",width:100,value:i,data:[{id:1,text:1},{id:2,text:2},{id:3,text:3},{id:4,text:4},{id:5,text:5},{id:6,text:6},{id:7,text:7}],onSelect:function(e){var t=$("#tr_method_"+a).combobox("getValue");Strack.generate_task_repeat_datebox_descr(a,t)}})},generate_task_repeat_datebox:function(e,t,a){var i=$("#tr_optional_day_"+e),d=0,r="",o=[];switch(Strack.G.repeatTaskConfigData.config&&(o=Strack.G.repeatTaskConfigData.config.date),i.empty(),t){case"daily":break;case"weekly":for(var d=7,n=1;n<=d;n++)0<=$.inArray(n+"",o)?r+='<a href="javascript:;" data-id="'+n+'" class="optional-day  toggle-monthday-handle active" onclick="Strack.click_task_repeat_datebox(this)">'+n+"</li>":r+='<a href="javascript:;" data-id="'+n+'" class="optional-day  toggle-monthday-handle" onclick="Strack.click_task_repeat_datebox(this)">'+n+"</li>";i.append(r);break;case"monthly":d=31;for(n=1;n<=d;n++)0<=$.inArray(n+"",o)?r+='<a href="javascript:;" data-id="'+n+'" class="optional-day  toggle-monthday-handle active" onclick="Strack.click_task_repeat_datebox(this)">'+n+"</a>":r+='<a href="javascript:;" data-id="'+n+'" class="optional-day  toggle-monthday-handle" onclick="Strack.click_task_repeat_datebox(this)">'+n+"</a>";i.append(r)}Strack.generate_task_repeat_datebox_descr(e,t,a)},generate_task_repeat_datebox_descr:function(e,t,a){var i=$("#tr_optional_descr_"+e),d="",r=" ",o=[];i.empty();var n="";1<(a=a||$("#tr_inter_"+e).combobox("getValue"))&&(n=a);var s=[];$("#tr_optional_day_"+e).find(".optional-day").each(function(){$(this).hasClass("active")&&s.push($(this).data("id"))});var l="cancel";switch(t){case"daily":d+=StrackLang.Repeat_Prefix,d+=n,d+=StrackLang.Days,d+=StrackLang.Repeat,l="active";break;case"weekly":var c={1:StrackLang.Monday,2:StrackLang.Tuesday,3:StrackLang.Wednesday,4:StrackLang.Thursday,5:StrackLang.Friday,6:StrackLang.Saturday,7:StrackLang.Sunday};d+=StrackLang.Repeat_Prefix,d+=n,d+=StrackLang.Week,s.forEach(function(e){o.push(c[e])}),l=0<o.length?(r+=o.join(",")+" ","active"):"cancel",d+=r,d+=StrackLang.Repeat;break;case"monthly":d+=StrackLang.Repeat_Prefix,d+=n,d+=StrackLang.Month,s.forEach(function(e){o.push(e)}),l=0<o.length?(r+=o.join(",")+" ","active"):"cancel",d+=r,d+=StrackLang.Repeat_Monthly_Suffix}i.append(d),Strack.activate_task_repeat_bnt(e,l)},activate_task_repeat_bnt:function(e,t){e=$("#tr_optional_bnt_"+e);e.removeClass("button-dgcel").removeClass("button-dgsub"),"active"===t?e.addClass("button-dgsub"):e.addClass("button-dgcel")},submit_task_repeat:function(e){var t,a,i=$(e).data("id");$(e).hasClass("button-dgsub")?(t=$("#tr_optional_tips_"+i),a=$("#tr_optional_descr_"+i),t.html(a.html()),Strack.save_task_repeat_param(i,"custom"),Strack.quit_task_custom_repeat(e)):layer.msg(StrackLang.Select_Date_To_Repeat,{icon:2,time:1200,anim:6})},click_task_repeat_datebox:function(e){$(e).hasClass("active")?$(e).removeClass("active"):$(e).addClass("active");var t=$(e).closest(".task-repeat-editor").data("id"),e=$("#tr_method_"+t).combobox("getValue");0<=$.inArray(e,["weekly","monthly"])&&Strack.generate_task_repeat_datebox_descr(t,e)},remove_task_repeat_editor:function(){var e=$(".task-repeat-editor"),t=e.data("id");$("#tr_method_"+t).combobox("destroy"),$("#tr_inter_"+t).combobox("destroy"),Strack.G.repeatTaskConfigData={},e.remove()},toggle_task_repeat_editor:function(e,t){var a=$(e).data("id"),i=$("#task_repeat_"+a),d=$(e).offset(),a=$(window).height()-($(e).height()+d.top);t.stopPropagation(),$(e).hasClass("loaded")?($(e).removeClass("loaded"),i.hide()):($(e).addClass("loaded"),a<i.height()?i.show().css({position:"absolute",bottom:13+a+"px",left:d.left+"px","z-index":19999}):i.show().css({position:"absolute",top:d.top+25+"px",left:d.left+"px","z-index":19999}))},widget_init_upload_dom:function(e,t,a,i){var d;Strack.get_media_server(function(i){$("#"+e).uploadifive({auto:!1,width:258,token:i.token,formData:{timestamp:Strack.current_time(),belong_system:StrackPHP.Belong_System,size:"250x140"},multi:!1,queueSizeLimit:1,queueID:"widget_queue",uploadScript:i.upload_url,onUpload:function(e){var t=$(this).closest(".window-body"),a=t.find("#Nup_fields")[0],t=t.find("#st_dialog_form")[0];if(!(d=Strack.check_item_operate_fields(a,t)).allow_up||0===e)return!1;$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},onUploadComplete:function(e,t){var a=JSON.parse(t);200===parseInt(a.status)?(t=Strack.get_update_item_hide_param(this),d.up_data.media=Strack.generate_widget_media_fields(i,t,a.data[0]),Strack.submit_update_item(this,!0,t,d.up_data)):layer.msg(a.message,{icon:7,time:1200,anim:6})}})},function(e){layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#Nup_fields").combobox("unselect","media-thumb")})},generate_widget_media_fields:function(e,t,a){var i=Strack.assembly_media_thumb_data(e,a);return a.base_url=e.request_url+a.path,{type:Strack.G.batchUploadMediaType,data:[{field:"media-module_id",field_type:"built_in",value:t.module_id,variable_id:0},{field:"media-md5_name",field_type:"built_in",value:a.md5_name,variable_id:0},{field:"media-thumb",field_type:"built_in",value:i.thumb,variable_id:0},{field:"media-size",field_type:"built_in",value:i.size,variable_id:0},{field:"media-param",field_type:"built_in",value:a,variable_id:0},{field:"media-media_server_id",field_type:"built_in",value:e.id,variable_id:0}]}},item_operate_update:function(e){var t=$(e).closest(".window-body"),a=t.find(".media-upload-bnt"),i=t.find("#Nup_fields")[0],t=t.find("#st_dialog_form")[0];0<a.length?a.uploadifive("upload"):(t=Strack.check_item_operate_fields(i,t)).allow_up&&Strack.submit_update_item(e,!1,Strack.get_update_item_hide_param(e),t.up_data)},item_combobox_new_update:function(e){var t=$(e).closest(".window-body"),a=t.find(".media-upload-bnt"),i=t.find("#Ncomb_up_fields")[0],t=t.find("#st_dialog_form")[0];0<a.length?a.uploadifive("upload"):(t=Strack.check_item_operate_fields(i,t)).allow_up&&Strack.submit_update_item(e,!1,Strack.get_update_item_hide_param(e),t.up_data)},get_update_item_hide_param:function(e){var e=$(e).closest(".window-body"),t={};e.find("#st_dialog_form_hide input").each(function(){t[$(this).attr("data-name")]=$(this).val()});e=$("#Nprimary_id").val();return t.primary_id=0<e.length?e:0,t},submit_update_item:function(t,e,a,i){$.ajax({type:"POST",url:StrackPHP.updateItemDialog,data:JSON.stringify({param:a,data:i}),contentType:"application/json",dataType:"json",beforeSend:function(){e||$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),t&&Strack.check_dialog_keep_status(t),Strack.G.batchUploadMediaType=""):layer.msg(e.message,{icon:7,time:1200,anim:6}),$.messager.progress("close")}})},check_dialog_keep_status:function(e){var t;"no"===Strack.G.dialogKeepBntStatus.continue_next&&"no"===Strack.G.dialogKeepBntStatus.keep_data?e?Strack.dialog_cancel(e):Strack.dialog_cancel():"yes"===Strack.G.dialogKeepBntStatus.continue_next&&"no"===Strack.G.dialogKeepBntStatus.keep_data&&(t=(e=e?(t=$(e).closest(".window-body").attr("id"),$("#"+t)):$("#dialog")).find("#Nup_fields")[0],(e=e.find("#st_dialog_form")[0])&&t&&Strack.clear_dialog_editor_item_data(t,e))},widget_update:function(){var e=$(".widget-show");if(0<e.length){var t,a=e.find("a").eq(0),i=e.find(".info-content-edit").find("input").eq(0).attr("id"),d=a.attr("data-table"),r=a.attr("data-module"),o=a.attr("data-ofields"),n=a.attr("data-fields"),s=a.attr("data-fieldtype"),l=a.attr("data-editor"),c=a.attr("data-widgetid"),_=a.attr("data-variableid"),m=a.attr("data-primary"),u=a.attr("data-multiple"),g=a.attr("data-moduleid"),p=a.attr("data-modulecode"),f=a.attr("data-projectid"),h=a.attr("data-datasource"),k=a.attr("data-fielduuid"),v=$("#"+i),b="",S=!1,y={},a=(a=v.attr("data-value"))||"";switch(e.removeClass("widget-show").find("a").eq(0).show().next().show().next().hide(),l){case"text":b=v.val();break;case"tagbox":(b=Strack.get_combos_val("#"+i,"tagbox","getValues"))?b=b.join(","):S=!0;break;case"combobox":b="yes"===u?(b=Strack.get_combos_val("#"+i,"combobox","getValues"))&&b.join(","):Strack.get_combos_val("#"+i,"combobox","getValue");break;case"datebox":b=v.datebox("getValue");break;case"datetimebox":b=v.datetimebox("getValue");break;case"timespinner":b=v.timespinner("getValue");break;case"checkbox":b=v.is(":checked")?1:0;break;case"tags":var w=[];v.parent().find("span").each(function(){w.push($(this).attr("data-id"))}),b=0<w.length?w.join(","):"";break;case"textarea":var x=e.find(".info-content-edit").find("textarea").eq(0).attr("id"),b=$("#"+x).val();break;case"task_repeat":b=v.val(),S=!0,y=Strack.G.repeatTaskConfigData}b===a&&!S||(t={dom:k,editor:"common",original_field:o,other_param:y},$.ajax({type:"POST",url:StrackPHP.updateWidget,dataType:"json",contentType:"application/json",data:JSON.stringify({editor:l,table:d,module:r,project_id:f,field:n,original_field:o,field_type:s,primary_value:m,data_source:h,widget_id:c,variable_id:_,module_id:g,module_code:p,old_val:a,val:b,widget_param:t}),success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.Websocket.List.hasOwnProperty("update")||(e.data.status=200,Strack.update.widget(e.data,t))):Strack.top_message({bg:"r",msg:e.message})}}))}},listen_keyboard_event:function(t){var a={};$(document).on("keydown",function(e){switch(e.keyCode){case 13:a.code="enter";break;case 32:a.code="space";break;case 37:a.code="left";break;case 39:a.code="right";break;case 70:a.code="f_key";break;case 73:a.code="i_key";break;case 86:a.code="v_key";break;default:a.code=""}t&&t(e,a)})},load_info_panel:function(i,d){$.ajax({type:"POST",url:i.url,data:i.data,beforeSend:function(){$(i.id).prepend(Strack.loading_dom(i.loading_type),i.mask)},success:function(e){var t,a="detail_onset_field"===i.data.category?(t=i.data.onset_id,i.data.onset_module_id):(t=i.data.item_id,i.data.module_id),a=Strack.generate_widget(e.config,e.data,t,i.data.project_id,i.pos,a);$(i.id).empty().append(a),Strack.init_other_thumb_media("common"),$("#st-load_"+i.mask).remove(),d&&d(e)}})},get_item_fields:function(e,t){$.ajax({type:"POST",url:StrackPHP.getFields,dataType:"json",contentType:"application/json",data:JSON.stringify(e),success:function(e){Strack.G.dialogItemFieldsConfig=e,t(e)}})},get_item_onset_data:function(e,t){$.ajax({type:"POST",url:StrackPHP.getItemOnsetLinkData,dataType:"json",contentType:"application/json",data:JSON.stringify(e),success:function(e){t(e)}})},common_add_task:function(e){e=$(e).data("page");Strack.item_operate_dialog("任务",{mode:"create",field_list_type:["edit"],module_id:4,project_id:0,page:e,schema_page:"project_base",type:"add_panel",keep_panel:!0},function(){})},calendar_lock_plan:function(e){var t=$(e).closest(".my-scheduler-index").attr("id"),a=$(e).attr("data-mode"),e=$("#"+t).fullCalendar("getView");$.ajax({type:"POST",url:StrackPHP.lockTaskPlan,dataType:"json",data:{type:a,date:e.start.format()},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.reload_fullCalendar_data(t)):($.messager.progress("close"),layer.msg(e.message,{icon:7,time:1200,anim:6}))}})},copy_calendar_plan:function(e,t,a){e.stopPropagation(),e.preventDefault(),Strack.open_dialog("dialog",{title:StrackLang.Copy_Task_Plan_Title,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mparent_id",type:"hidden",name:"id",valid:1,value:a},{case:101,id:"Mplan_id",type:"hidden",name:"id",valid:1,value:t.item_id},{case:101,id:"Mlink_id",type:"hidden",name:"id",valid:1,value:t.link_id}],items:[{case:2,id:"Mplan_start_date",type:"text",lang:StrackLang.Plan_Start_Time,name:"name",valid:"1",value:"name"},{case:2,id:"Mplan_end_date",type:"text",lang:StrackLang.Plan_End_Time,name:"code",valid:"1",value:"code"}],footer:[{obj:"copy_calendar_plan_update",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.open_datetime_box("#Mplan_start_date",378,26),Strack.open_datetime_box("#Mplan_end_date",378,26)},close:function(){}})},copy_calendar_plan_update:function(){$("#Mplan_id").val();var e=$("#Mparent_id").val(),t=$("#Mlink_id").val(),a=$("#Mplan_start_date").datetimebox("getValue"),i=$("#Mplan_end_date").datetimebox("getValue"),d=!0;a||(d=!1,layer.msg(StrackLang.Base_Plan_Start_Time_Null,{icon:2,time:1200,anim:6})),i||(d=!1,layer.msg(StrackLang.Base_Plan_End_Time_Null,{icon:2,time:1200,anim:6})),d&&Strack.add_scheduler_task_plan_event_update({lock:"no",link_id:t,start_time:a,end_time:i,operation:"copy"},e,!0)},del_calendar_plan:function(e,t,a,i){e.stopPropagation(),e.preventDefault(),0<i&&$.messager.confirm(StrackLang.Confirmation_Box,StrackLang.Delete_Task_Plan_Notice,function(e){e&&$.ajax({type:"POST",url:StrackPHP.deleteTaskPlan,data:{primary_ids:i},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.reload_fullCalendar_data(a)):($.messager.progress("close"),layer.msg(e.message,{icon:7,time:1200,anim:6}))}})})},item_operate_dialog:function(e,o,t){var a="";switch(o.mode){case"create":case"create_related":a=StrackLang.Submit;break;case"modify":a=StrackLang.Update}var i=o.hasOwnProperty("from_module_id")?o.from_module_id:0,d=o.hasOwnProperty("from_item_id")?o.from_item_id:0,r=o.hasOwnProperty("horizontal_type")?o.horizontal_type:"",n=o.hasOwnProperty("variable_id")?o.variable_id:0,s=o.keep_panel||!1;Strack.open_dialog("dialog",{title:e,width:620,height:s?420:380,content:Strack.dialog_dom({type:"item_operation",keep_panel:s,hidden:[{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:o.module_id},{case:101,id:"Nfrom_module_id",type:"hidden",name:"from_module_id",valid:1,value:i},{case:101,id:"Nfrom_item_id",type:"hidden",name:"from_item_id",valid:1,value:d},{case:101,id:"Nhorizontal_type",type:"hidden",name:"horizontal_type",valid:1,value:r},{case:101,id:"Nvariable_id",type:"hidden",name:"variable_id",valid:1,value:n},{case:101,id:"Npage",type:"hidden",name:"page",valid:1,value:o.page},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:o.project_id},{case:101,id:"Nmode",type:"hidden",name:"mode",valid:1,value:o.mode},{case:101,id:"Ntype",type:"hidden",name:"type",valid:1,value:o.type},{case:101,id:"Nprimary_id",type:"hidden",name:"primary_id",valid:1,value:o.primary_id}],items:[{case:2,id:"Nup_fields",type:"text",lang:StrackLang.Fields,name:"fields",valid:1,value:""}],footer:[{obj:"item_operate_update",type:5,title:a},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel},{obj:"save_dialog_setting",type:8,title:StrackLang.Save_Setting}]}),inits:function(){var r=this;Strack.get_item_fields(o,function(a){var t,i=[];for(t in a.field_list)for(var d in a.field_list[t])"type"!==d&&a.field_list[t][d].fields.forEach(function(e){e.field_group_name=a.field_list[t][d].title,e.project_id=o.project_id,e.module_id=o.module_id,e.frozen_module=e.frozen_module,e.flg_module=e.flg_module,e.fields=e.module+"-"+e.id,i.push(e)});Strack.G.dialogItemMustFields=a.required_setting,$("#Nup_fields").combobox({data:i,width:350,valueField:"fields",textField:"lang",groupField:"field_group_name",multiple:!0,value:"",onSelect:function(e){var t;0===$("#dgup_i_"+e.fields).length&&(Strack.check_upload_editor_unique(r,e)?(o.hasOwnProperty("select_fields")&&o.select_fields.map.hasOwnProperty(e.fields)&&(e.value=o.select_fields.map[e.fields]),0<=$.inArray(e.fields,a.must_setting)&&(e.required=!0),t=Strack.field_item_dom(e,o,1),$("#st_dialog_item").append(t.item_dom),Strack.field_item_init(t.dom_id,o.primary_id,e,o)):$(this).combobox("unselect",e.fields))},onUnselect:function(e){$.inArray(e.fields,a.must_setting)<0?("task_repeat"===e.editor&&Strack.remove_task_repeat_editor(),Strack.destroy_field_item(e.fields)):($(this).combobox("select",e.fields),layer.msg(e.id+": "+StrackLang.Must_Field,{icon:2,time:1200,anim:6}))},onLoadSuccess:function(){var t=$(this);o.hasOwnProperty("select_fields")&&o.select_fields.config.forEach(function(e){0===$("#dgup_i_"+e.field).length&&t.combobox("select",e.field)}),a.user_setting.forEach(function(e){t.combobox("select",e)})}}),s&&Strack.set_dialog_keep_status_bnt("dialog",a.keep_status)})},close:function(){t()}})},check_upload_editor_unique:function(e,t){return!("upload"===t.editor&&0<$(e).find(".single-queue-item").length)||(layer.msg(StrackLang.Only_One_Media_Upload,{icon:2,time:1200,anim:6}),!1)},destroy_field_item:function(e){var t=$("#dgup_i_"+e),a=t.attr("data-widgetid"),e=t.attr("data-editor"),i=$("#"+a);switch(e){case"upload":try{i.uploadifive("destroy")}catch(e){}break;case"combobox":i.combobox("destroy");break;case"datebox":i.datebox("destroy");break;case"datetimebox":i.datetimebox("destroy");break;case"timespinner":i.timespinner("destroy")}t.remove()},field_item_dom:function(e,t,a){var i="",d="dgup_"+e.fields+Math.floor(1e3*Math.random()+1),r="",r=e.field_group_name?e.lang+" ("+e.field_group_name+")":e.lang,o=e.required?"required":"";return i+='<li id="dgup_i_'+e.fields+'" class="dg-report-item" data-field="'+e.fields+'" data-widgetid="'+d+'" data-editor="'+e.editor+'"><a href="javascript:;" onclick="Strack.field_item_delete(this)" class="dg-report-de aign-left"  data-field="'+e.fields+'" data-mode="'+t.mode+'" data-type="'+t.type+'"><i class="icon-uniE6DB"></i></a><div class="dg-report-step aign-left '+o+'"><label>'+r+'</label></div><div class="dg-report-user st-dialog-input aign-left">'+Strack.field_editor_dom(d,e)+"</div>","combobox"===e.editor&&"allow"===e.create_in_time&&1===a&&(i+='<a href="javascript:;" class="dg-report-add" onclick="Strack.add_combobox_new_val(this)" data-page="'+t.page+'" data-schemapage="'+t.schema_page+'" data-moduleid="'+e.module_id+'" data-projectid="'+t.project_id+'" data-widgetid="'+d+'" data-flgmodule="'+e.flg_module+'" data-modulecode="'+e.module_code+'"><i class="icon-uni3432"></i></a>'),{item_dom:i+="</li>",dom_id:d}},add_combobox_new_val:function(e){var t=$(e),a=t.attr("data-moduleid"),i=t.attr("data-flgmodule"),d=t.attr("data-widgetid"),o=t.attr("data-projectid"),n=t.attr("data-page"),s=t.attr("data-schemapage"),e="no";-1!==$.inArray(i,["status","step"])&&(e="yes");var l="yes";-1!==$.inArray(i,["status","step"])&&(l="yes");var t="Add_"+Strack.string_ucwords(i),c="dialog_combobox_add_"+Math.floor(1e4*Math.random()+1);Strack.open_dialog(c,{title:StrackLang[t],width:620,height:380,content:Strack.dialog_dom({type:"item_operation",hidden:[{case:101,id:"Ncomb_project_id",type:"hidden",name:"project_id",valid:1,value:o},{case:101,id:"Ncomb_module_id",type:"hidden",name:"module_id",valid:1,value:a},{case:101,id:"Ncomb_module_code",type:"hidden",name:"module_code",valid:1,value:i},{case:101,id:"Ncomb_update_template",type:"hidden",name:"update_template",valid:1,value:e},{case:101,id:"Ncomb_mode",type:"hidden",name:"mode",valid:1,value:"create"},{case:101,id:"Ncomb_type",type:"hidden",name:"type",valid:1,value:"combobox_add_panel"},{case:101,id:"Ncomb_page",type:"hidden",name:"page",valid:1,value:n}],items:[{case:2,id:"Ncomb_up_fields",type:"text",lang:StrackLang.Fields,name:"fields",valid:1,value:""}],footer:[{obj:"item_combobox_new_update",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var r={mode:"create",field_list_type:["edit"],from_module_id:a,module_code:i,project_id:o,has_schema:l,page:n,from_schema_page:s,type:"combobox_add_panel"};Strack.get_item_fields(r,function(a){var t,i=[];for(t in a.field_list)for(var d in a.field_list[t])"type"!==d&&a.field_list[t][d].fields.forEach(function(e){e.field_group_name=a.field_list[t][d].title,e.project_id=r.project_id,e.module_id=r.module_id,e.frozen_module=e.frozen_module,e.flg_module=e.flg_module,e.fields=e.module+"-"+e.id,i.push(e)});$("#Ncomb_up_fields").combobox({data:i,width:350,valueField:"fields",textField:"lang",groupField:"field_group_name",multiple:!0,value:"",onSelect:function(e){var t;0===$("#"+c+" #dgup_i_"+e.fields).length&&(t=Strack.field_item_dom(e,r,2),$("#"+c+" #st_dialog_item").append(t.item_dom),Strack.field_item_init(t.dom_id,r.project_id,e))},onUnselect:function(e){Strack.destroy_field_item(e.fields)},onLoadSuccess:function(){var t=$(this);a.user_setting.forEach(function(e){t.combobox("select",e)})}})})},close:function(){$("#"+d).combobox("reload")}})},field_item_init:function(e,t,a,i){if(a.primary=t,Strack.widget_init_dom(e,260,25,a),i&&"my_scheduler"===i.page){var d=$("#"+e);switch(Strack.G.dialogDomList[a.id]=d,a.id){case"project_id":d.combobox({onSelect:function(e){0===e.id?Strack.G.dialogDomList.status_id.combobox("setValue",0).combobox("disable"):Strack.combobox_append_project_id("status_id",e.id)}});break;case"status_id":d.combobox("disable")}}},combobox_append_project_id:function(e,t){var a=Strack.G.dialogDomList[e].combobox("options");a.queryParams.project_id=t,Strack.G.dialogDomList[e].combobox("reload",a.queryParams).combobox("enable")},field_item_delete:function(e){var t=$(e).data("field");("add_entity_task_panel"!==$(e).data("type")||0<$(e).closest("#st_dialog_form").length?$("#Nup_fields"):$("#m_review_task_fields")).combobox("unselect",t)},field_editor_dom:function(e,t){var a="",i="",i=t.field_group_name?t.lang+" ("+t.field_group_name+")":t.lang,d="built_in"===t.field_type?0:t.variable_id,r="entity"===t.module_type?"entity":t.module_code;switch(t.editor){case"upload":Strack.G.batchUploadMediaType="custom"===t.field_type?"horizontal":"direct",a='<div id="widget_queue" class="single-queue-item"></div><div class="widget-upload"><input id="'+e+'" class="media-upload-bnt field_edit_item" type="file" multiple="true" data-field="'+t.fields+'" data-variableid="'+d+'" data-fieldtype="'+t.field_type+'" data-lang="'+i+'" data-editor="'+t.editor+'" data-multiple="'+t.multiple+'" data-table="'+r+'"></div>';break;case"textarea":a='<textarea id="'+e+'" class="field_edit_item widget-edit" data-field="'+t.fields+'" data-variableid="'+d+'" data-fieldtype="'+t.field_type+'" data-lang="'+i+'" data-editor="'+t.editor+'" data-multiple="'+t.multiple+'" data-table="'+r+'"></textarea>';break;case"task_repeat":a+='<a href="javascript:;" id="'+e+'" class="task-repeat ui icon button" onclick="Strack.toggle_task_repeat_editor(this, event)" data-id="'+e+'"><i class="history icon"></i>',a+='<input id="val_'+e+'" type="hidden" value="no" class="field_edit_item" data-field="'+t.fields+'" data-variableid="'+d+'" data-fieldtype="'+t.field_type+'" data-lang="'+i+'" data-editor="'+t.editor+'" data-multiple="'+t.multiple+'" data-table="'+r+'">',a+="</a>";break;default:a='<input id="'+e+'" type="'+("password"===t.id?"password":"text")+'" class="field_edit_item" data-field="'+t.fields+'" data-variableid="'+d+'" data-fieldtype="'+t.field_type+'" data-lang="'+i+'" data-editor="'+t.editor+'" data-multiple="'+t.multiple+'" data-table="'+r+'">'}return a},dg_ask_repeat_editor_dom:function(e,t,a){var i="dgup_"+a.fields+Math.floor(1e3*Math.random()+1),d="",r=(a.row_h-26)/2,o=(a.row_w-26)/2,n="yes"===a.value?"active":"";d+='<div style="position: relative;background-color:#FFFFFF;width: 100%;height: '+a.row_h+'px">',d+='<a href="javascript:;" id="'+i+'" class="task-repeat ui icon button '+n+'" style="position: absolute;top:'+r+"px;left: "+o+'px" onclick="Strack.toggle_task_repeat_editor(this, event)" data-id="'+i+'">',d+='<i class="history icon"></i>',d+='<input id="val_'+i+'" type="hidden" value="no" class="field_edit_item" data-field="'+a.fields+'" data-variableid="'+a.variable_id+'" data-fieldtype="'+a.field_type+'" data-lang="'+StrackLang.Repeat+'" data-editor="'+a.editor+'" data-multiple="no" data-table="'+a.table+'">',d+="</a>",d+="</div>",e.empty().append(d),Strack.widget_init_dom(i,260,25,a)},check_item_operate_fields:function(e,t){var e=Strack.get_combos_val(e,"combobox","getValues"),c={},_=!0;return e?($(".form-tip").remove(),$(t).find(".field_edit_item").each(function(){var e,t=$(this).attr("data-lang"),a=$(this).attr("data-editor"),i=$(this).attr("data-field"),d=$(this).attr("data-fieldtype"),r=$(this).attr("data-multiple"),o=$(this).attr("data-variableid"),n=$(this).attr("data-table"),s="",l=[];switch(a){case"combobox":s="yes"===r?(l=Strack.get_combos_val(this,"combobox","getValues"))?l.join(","):"":Strack.get_combos_val(this,"combobox","getValue"),0<=$.inArray(i,Strack.G.dialogItemMustFields)&&0==s&&(s=""),$.inArray(i,Strack.G.dialogItemMustFields)<0&&-1!==i.search("id")&&!s&&(s=0);break;case"tagbox":case"horizontal_relationship":case"relation":s=(l=Strack.get_combos_val(this,"combobox","getValues"))?l.join(","):"";break;case"datebox":s=$(this).datebox("getValue");break;case"datetimebox":s=$(this).datetimebox("getValue");break;case"checkbox":s=$(this).is(":checked")?"yes":"no";break;case"upload":0<$("#widget_queue .uploadifive-queue-item").length&&(s="yes");break;case"task_repeat":"yes"!==(s=$(this).val())||$.isEmptyObject(Strack.G.repeatTaskConfigData)||((e=[]).push({field:"base_repeat_config-mode",field_type:"built_in",value:Strack.G.repeatTaskConfigData.mode,variable_id:0}),e.push({field:"base_repeat_config-config",field_type:"built_in",value:Strack.G.repeatTaskConfigData.config,variable_id:0}),c.base_repeat_config=e);break;default:s=$(this).val()}if(!(s||"combobox"===a&&0===s))return $(this).closest("li").append(Strack.dialog_error_icon("e")),layer.msg(t+" : "+StrackLang.Required_Field,{icon:2,time:1200,anim:6}),_=!1;$(this).closest("li").append(Strack.dialog_error_icon("t")),c.hasOwnProperty(n)?c[n].push({field:i,field_type:d,value:s,variable_id:o}):c[n]=[{field:i,field_type:d,value:s,variable_id:o}]})):(_=!1,layer.msg(StrackLang.Please_Select_Field,{icon:2,time:1200,anim:6})),{allow_up:_,up_data:c}},clear_dialog_editor_item_data:function(e,t){Strack.get_combos_val(e,"combobox","getValues")&&$(t).find(".field_edit_item").each(function(){$(this).attr("data-lang");var e=$(this).attr("data-editor");$(this).attr("data-field"),$(this).attr("data-fieldtype"),$(this).attr("data-multiple"),$(this).attr("data-variableid"),$(this).attr("data-table");switch(e){case"combobox":case"tagbox":case"horizontal_relationship":case"relation":$(this).combobox("clear");break;case"datebox":$(this).datebox("clear");break;case"datetimebox":$(this).datetimebox("clear");break;case"timespinner":$(this).timespinner("clear");break;case"checkbox":$(this).prop("checked",!1);break;case"upload":$("#widget_queue .uploadifive-queue-item").remove();break;default:$(this).val("")}})},entity_add_task:function(e){var t=$(e).closest(".datagrid-toolbar"),a=$(e).attr("data-lang"),i=$(e).attr("data-modulecode"),d=$(e).attr("data-taskmoduleid"),o=$(e).attr("data-schemapage"),r=$("#page_hidden_param input[name=module_name]").val(),n=t.attr("data-grid"),s=t.attr("data-page"),l=t.attr("data-maindom"),e=t.attr("data-bardom"),c=t.attr("data-moduleid"),_=t.attr("data-projectid"),t=$("#"+n).datagrid("getSelections"),m=[];t.forEach(function(e){m.push(parseInt(e.id))}),0<m.length?Strack.open_dialog("dialog",{title:StrackLang.Add_Task,width:920,height:500,content:Strack.dialog_dom({type:"add_entity_task",entity_title:a,hidden:[{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:c},{case:101,id:"Ntask_module_id",type:"hidden",name:"task_module_id",valid:1,value:d},{case:101,id:"Nmodule_name",type:"hidden",name:"module_name",valid:1,value:r},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:_},{case:101,id:"Ngrid",type:"hidden",name:"grid",valid:1,value:n},{case:101,id:"Npage",type:"hidden",name:"page",valid:1,value:s},{case:101,id:"Ntype",type:"hidden",name:"type",valid:1,value:"add_entity_task"},{case:101,id:"Nmain_dom",type:"hidden",name:"main_dom",valid:1,value:l},{case:101,id:"Nbar_dom",type:"hidden",name:"bar_dom",valid:1,value:e}],items:[],footer:[{obj:"entity_add_task_submit",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel},{obj:"save_dialog_setting",type:8,title:StrackLang.Save_Setting}]}),inits:function(){Strack.combobox_widget("#Mentity",{url:StrackPHP.getWidgetData,valueField:"id",textField:"name",multiple:!0,queryParams:{module:"entity",field_type:"built_in",fields:"entity_id",flg_module:"entity",project_id:_,entity_module_id:c,data_source:"entity"},onLoadSuccess:function(){$(this).combobox("setValues",m)}});var t={step_id:"Mstep",list_id:"stdg_etask_list",combox_id:"Nup_fields",edit_id:"st_dialog_item"};Strack.combobox_widget("#Mstep",{url:StrackPHP.getEntityStepList,valueField:"id",textField:"name",multiple:!0,queryParams:{project_id:_,module_code:i},onSelect:function(e){Strack.add_entity_step_task_group(t,e,"new")},onUnselect:function(e){Strack.remove_entity_step_task_group(t,e)}});var r={mode:"create",field_list_type:["edit"],module_id:d,project_id:_,page:s,schema_page:o,type:"add_entity_task_panel",not_fields:["entity_id","step_id","thumb"]};Strack.get_item_fields(r,function(a){var t,i=[];for(t in a.field_list)for(var d in a.field_list[t])a.field_list[t][d].fields.forEach(function(e){e.field_group_name=a.field_list[t][d].title,e.project_id=r.project_id,e.module_id=r.module_id,e.frozen_module=e.frozen_module,e.flg_module=e.flg_module,e.fields=e.module+"-"+e.id,i.push(e)});$("#Nup_fields").combobox({data:i,width:350,valueField:"fields",textField:"lang",groupField:"field_group_name",multiple:!0,value:"",onSelect:function(e){var t;0===$("#dgup_i_"+e.fields).length&&(t=Strack.field_item_dom(e,r,1),$("#st_dialog_item").append(t.item_dom),Strack.field_item_init(t.dom_id,r.project_id,e),"name"!==e.id&&"code"!==e.id||(e=$("#stdg_etask_list .etask-l-active").find(".etask-l-item-name").html(),$("#"+t.dom_id).val(e)))},onUnselect:function(e){Strack.destroy_field_item(e.fields)},onLoadSuccess:function(){var t=$(this);a.user_setting.forEach(function(e){t.combobox("select",e)})},onChange:function(e,t){$(".stdg-etask-l-item").removeClass("form_ok")}})})},close:function(){Strack.G.entityStepTaskAddData={status:!1,data:{}}}}):layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6})},entity_add_task_submit:function(){var e,t,a,i,d;$.isEmptyObject(Strack.G.entityStepTaskAddData.data)?layer.msg(StrackLang.Please_Select_Step,{icon:2,time:1200,anim:6}):(0<(d=$("#stdg_etask_list").find(".etask-l-active")).length&&(e=d.attr("id"),t=d.attr("data-stepcode"),a=Strack.check_item_operate_fields("#Nup_fields","#st_dialog_form"),Strack.G.entityStepTaskAddData.data[t][e]=a.up_data,a.allow_up&&d.addClass("form_ok")),Strack.G.entityStepTaskAddData.status=!0,$(".stdg-etask-l-item").each(function(){$(this).hasClass("form_ok")||(Strack.G.entityStepTaskAddData.status=!1)}),Strack.G.entityStepTaskAddData.status?(i={entity_param:{},task_rows:Strack.G.entityStepTaskAddData.data},$("#st_dialog_form_hide").find("input").each(function(){i.entity_param[$(this).attr("data-name")]=$(this).val()}),i.entity_ids=$("#Mentity").combobox("getRowValues","id"),i.step_ids=$("#Mstep").combobox("getRowValues","id"),0<i.entity_ids.length?$.ajax({type:"POST",url:StrackPHP.batchSaveEntityBase,data:JSON.stringify(i),contentType:"application/json",dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.dialog_cancel()):layer.msg(e.message,{icon:7,time:1200,anim:6})}}):(d=$("#Nmodule_name").val(),layer.msg(d+" : "+StrackLang.Required_Field,{icon:2,time:1200,anim:6}))):layer.msg(StrackLang.Please_Fill_Step_Task_Data,{icon:2,time:1200,anim:6}))},import_excel_data:function(e){var t=$("#import_excel_slider");t.hasClass("load-active")?Strack.reset_import_excel_step_data():t.addClass("load-active");var a=$(e).closest(".datagrid-toolbar"),i=Math.floor(1e5*Math.random()+1),e=Strack.G.pageHiddenParam.hasOwnProperty("item_id")?Strack.G.pageHiddenParam.item_id:0,o={page:a.attr("data-page"),schema_page:a.attr("data-schemapage"),module_id:a.attr("data-moduleid"),grid:a.attr("data-grid"),project_id:a.attr("data-projectid"),main_dom:a.attr("data-maindom"),bar_dom:a.attr("data-bardom"),batch_number:i,from_module_data:{item_id:e,module_id:Strack.G.pageHiddenParam.module_id,module_code:Strack.G.pageHiddenParam.module_code}};Strack.G.importExcelStep=$("#import_excel_step").step({mustStep:[],stepCallBack:function(i){var e={method:StrackLang.Please_Select_Import_Mode,import_paste:StrackLang.Please_Paste_Excel_Data,import_file:StrackLang.Please_Select_Excel_File,mapping:StrackLang.Must_Field_Completely_Mapping,result:""},d=!0,r="";if(["method","import","mapping","result"].forEach(function(e,t){if(!(t+1<i&&d))return!1;switch(r=e){case"method":var a=$(".import-method-active");0<a.length?Strack.G.importExcelData.method=a.attr("data-method"):d=!1;break;case"import":if(Strack.G.importExcelData.method)switch(Strack.G.importExcelData.method){case"paste":0===$("#import_method_paste").val().length&&(d=!1);break;case"file":0===$(".uploadifive-queue-item").length&&(d=!1)}else d=!1;break;case"mapping":$("#import_ex_must").find(".menu-icon").each(function(){if($(this).hasClass("icon-unchecked"))return d=!1})}return!!d&&void 0}),d)switch(parseInt(i)){case 1:Strack.G.importExcelStep.goStep(i),Strack.reset_import_excel_step_bnt(i);break;case 2:Strack.G.importExcelStep.goStep(i),$(".import-method-panel").hide(),Strack.init_excel_format_widget(o),Strack.reset_import_excel_step_bnt(i);break;case 3:switch(Strack.G.importExcelData.method){case"paste":Strack.format_excel_paste_data(o);break;case"file":Strack.format_excel_file_data()}break;case 4:Strack.import_excel_step_submit(o);break;default:Strack.format_excel_file_data(0)}else{var t="",t="import"===r?e[r+"_"+Strack.G.importExcelData.method]:e[r];layer.msg(t,{icon:2,time:1200,anim:6})}}}),t.sidebar("toggle")},close_import_excel_panel:function(){$("#import_excel_slider").sidebar("toggle")},reset_import_excel_step_data:function(){Strack.G.importExcelData={},$("#import_ex_list .step-list").hide(),$(".excel-in-submit").hide(),$("#import_excel_bnt_upload").hide(),$("#import_excel_bnt_prev").hide(),$("#import_excel_bnt_next").show(),$("#import_excel_bnt_submit").hide(),$(".import-excel-card").removeClass("import-method-active"),$(".import-method-panel").hide();var e=$("#method_paste_header");e.hasClass("switchbutton-f")&&(e.switchbutton("clear"),$("#import_method_paste").empty());e=$("#method_file_header");e.hasClass("switchbutton-f")&&(e.switchbutton("clear"),$("#excel_upload_widget").uploadifive("clearQueue"))},reset_import_excel_step_bnt:function(e){var t=$("#import_excel_bnt_upload"),a=$("#import_excel_bnt_prev"),i=$("#import_excel_bnt_next"),d=$("#import_excel_bnt_submit");switch(e){case 1:t.hide(),a.hide(),i.show(),d.hide();break;case 2:"file"===Strack.G.importExcelData.method&&t.show(),a.show(),i.show(),d.hide();break;case 4:t.hide(),a.show(),i.hide(),d.show();break;default:t.hide(),a.show(),i.show(),d.hide()}},import_excel_step_prev:function(){Strack.G.importExcelStep.preStep()},import_excel_step_next:function(){Strack.G.importExcelStep.nextStep()},init_excel_format_widget:function(e){var t=$("#excel_format_paste"),a=$("#excel_format_file");switch($(".import-method-"+Strack.G.importExcelData.method).show(),Strack.G.importExcelData.method){case"paste":t.hasClass("load_active")||(t.addClass("load_active"),Strack.init_open_switch({dom:"#method_paste_header",value:0,onText:StrackLang.Switch_ON,offText:StrackLang.Switch_OFF,width:100}));break;case"file":a.hasClass("load_active")||(a.addClass("load_active"),Strack.init_open_switch({dom:"#method_file_header",value:0,onText:StrackLang.Switch_ON,offText:StrackLang.Switch_OFF,width:100}),Strack.init_excel_file_upload(e))}},format_excel_paste_data:function(e){var t=new CSV($("#import_method_paste").val(),{cellDelimiter:"\t"}),a=Strack.get_switch_val("#method_paste_header"),t=t.parse();$.ajax({type:"POST",url:StrackPHP.formatExcelPasteData,data:JSON.stringify({has_header:a,parsed:t,module_id:e.module_id,project_id:e.project_id,page:e.page,schema_page:e.schema_page}),contentType:"application/json",beforeSend:function(){$("#import_excel_step").append(Strack.loading_dom("white","","excel_data"))},success:function(e){200===parseInt(e.status)?(Strack.G.importExcelStep.goStep(3),Strack.reset_import_excel_step_bnt(3),Strack.init_format_datagrid(e.data)):layer.msg(e.message,{icon:7,time:1200,anim:6}),$("#st-load_excel_data").remove()}})},format_excel_file_data:function(){var e=Strack.get_switch_val("#method_file_header");$("#excel_upload_widget").uploadifive("settings","formData","has_header",e),$(".uploadifive-queue-item").hasClass("complete")?(Strack.G.importExcelStep.goStep(3),Strack.reset_import_excel_step_bnt(3)):$("#excel_upload_widget").uploadifive("upload")},init_excel_file_upload:function(e){$("#excel_upload_widget").uploadifive({auto:!1,removeCompleted:!1,formData:{timestamp:Strack.current_time(),batch_number:e.batch_number,module_id:e.module_id,project_id:e.project_id,page:e.page,schema_page:e.schema_page,has_header:0},multi:!1,queueSizeLimit:1,fileSizeLimit:"100MB",fileType:"text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",queueID:"import_method_queue",uploadScript:StrackPHP.formatExcelFileData,onUploadComplete:function(e,t){t=JSON.parse(t);200===parseInt(t.status)?(Strack.G.importExcelStep.goStep(3),Strack.reset_import_excel_step_bnt(3),Strack.init_format_datagrid(t.data)):layer.msg(t.message,{icon:7,time:1200,anim:6})},onQueueComplete:function(e,t){}})},select_import_excel_method:function(e){$(".import-excel-card").removeClass("import-method-active"),$(e).addClass("import-method-active")},init_format_menu:function(e,t){var a,i,d,r="iconCls:'icon-unchecked'",o=$("#excel_fields_menu");return o.hasClass("st-menu")?($("#import_ex_must").find(".menu-item").each(function(){o.menu("removeItem",this)}),$("#import_ex_other").find(".menu-item").each(function(){o.menu("removeItem",this)}),a="",e.forEach(function(e){a="fexn_"+e.fields,"yes"===e.require?o.menu("appendItem",{parent:$("#import_ex_must_wrap")[0],id:a,text:e.lang,iconCls:"icon-unchecked"}):o.menu("appendItem",{parent:$("#import_ex_other_wrap")[0],id:a,text:e.lang,iconCls:"icon-unchecked"}),$("#"+a).attr("data-bnt","mapping_field").attr("data-fields",e.fields).attr("data-mapping","").attr("data-fieldtype",e.field_type)})):(d=i="",e.forEach(function(e){"yes"===e.require?i+='<div id="fexn_'+e.fields+'"  class="mapping-field" data-options="'+r+'" data-bnt="mapping_field" data-fields="'+e.fields+'" data-mapping="" data-fieldtype="'+e.field_type+'">'+e.lang+"</div>":d+='<div id="fexn_'+e.fields+'" class="mapping-field" data-options="'+r+'" data-bnt="mapping_field" data-fields="'+e.fields+'" data-mapping="" data-fieldtype="'+e.field_type+'">'+e.lang+"</div>"}),$("#import_ex_must").empty().append(i),$("#import_ex_other").empty().append(d),o.menu({onClick:function(e){var t=$("#excel_fields_val").val();Strack.toggle_map_excel_fields(this,e,t)},afterRender:function(){var e=this;$("#import_ex_must").find(".mapping-field").each(function(){Strack.auto_map_excel_fields(e,this,t)}),$("#import_ex_other").find(".mapping-field").each(function(){Strack.auto_map_excel_fields(e,this,t)})}})),{}},auto_map_excel_fields:function(e,t,a){var i=$(t).find(".menu-text").html();0<=$.inArray(i,a)&&(t=$(t)[0],t=$(e).menu("getItem",t),Strack.toggle_map_excel_fields(e,t,i))},toggle_map_excel_fields:function(e,t,a){var i,d,r=$("#cell_ckt_"+a),o=r.parent(),n=r.attr("data-ckfield"),s=$("#fexn_"+n),l=$(t.target);switch(l.data("bnt")){case"cancel_mapping":s.data("mapping",""),s.find(".menu-icon").removeClass("icon-checked").addClass("icon-unchecked"),$(e).menu("enableItem",s[0]),r.attr("data-ckfield","").html(StrackLang.Non_Mapping_Field),o.removeClass("excel-tac").removeClass("mapping-active");break;case"mapping_field":o.hasClass("mapping-active")||(o.addClass("mapping-active"),i=$(t.target).data("fields"),d=$(t.target).find(".menu-text").html(),$(t.target).attr("data-mapping",a),o.addClass("excel-tac"),r.attr("data-ckfield",i).html(d),l.find(".menu-icon").removeClass("icon-unchecked").addClass("icon-checked"),$(e).menu("disableItem",t.target))}},build_import_ex_columns:function(e,t){var i,a=[];return a.push({field:"ex_del_bnt",col_type:"bnt",title:StrackLang.Delete,align:"center",width:85,formatter:function(e,t,a){return'<a href="javascript:;" class="button" onclick="Strack.import_excel_grid_bnt(this)" data-rowid="'+t.id+'"><button class="ui basic red button">'+StrackLang.Delete+"</button></a>"}}),e.forEach(function(e){0<=$.inArray(e,t)?a.push({field:e,col_type:"field",title:e,align:"center",width:130,formatter:function(e,t,a){return i=StrackPHP.ROOT+e,Strack.build_grid_thumb_dom(i)}}):a.push({field:e,col_type:"field",title:e,align:"center",width:130,editor:{type:"text"}})}),[a]},import_excel_grid_bnt:function(e){e=$(e).attr("data-rowid");$("#import_excel_datagrid").datagrid("selectRecord",e);var e=$("#import_excel_datagrid").datagrid("getSelected"),t=$("#import_excel_datagrid").datagrid("getRowIndex",e);$("#import_excel_datagrid").datagrid("unselectRow",t),setTimeout(function(){$("#import_excel_datagrid").datagrid("deleteRow",t)},0)},init_format_datagrid:function(t){Strack.G.InputExCkfields={};var a={};t.header.forEach(function(e){a[e]={field_type:"excel",editor:"text",variable_id:0,primary:"",field_map:e,table:"Excel",module:"excel",module_type:"excel",field_value_map:e}});var e=$("#import_excel_datagrid");e.hasClass("datagrid-f")?e.datagrid("setOptions",{columnsFieldConfig:a,columns:Strack.build_import_ex_columns(t.header,t.images_column)}).datagrid("loadData",t.body):e.datagrid({data:t.body,fitColumns:!1,height:Strack.panel_height(".mapping-fields-wrap",0),rowheight:49,differhigh:!0,singleSelect:!0,HeaderField:!0,HeaderHeight:50,HeaderFieldData:{},idField:"id",cellUpdateMode:"manual",columnsFieldConfig:a,adaptive:{dom:".mapping-fields-wrap",min_width:1004,exth:115},frozenColumns:[[{field:"format_excel_id",checkbox:!0}]],columns:Strack.build_import_ex_columns(t.header,t.images_column),onLoadSuccess:function(e){Strack.init_format_menu(t.fields,t.header)}}).datagrid("enableCellEditing").datagrid("disableCellSelecting").datagrid("gotoCell",{index:0,field:"id"}).datagrid("columnMoving")},show_excel_check_fields:function(e,t){$("#excel_fields_val").val($(e).data("field")),$("#excel_fields_menu").menu("show",{left:t.clientX,top:t.clientY+15})},import_excel_step_submit:function(a){var e={};$("#import_ex_must").find(".menu-item").each(function(){$(this).data("mapping")&&(e[$(this).data("fields")]=$(this).data("mapping"))}),$("#import_ex_other").find(".menu-item").each(function(){$(this).data("mapping")&&(e[$(this).data("fields")]=$(this).data("mapping"))});var t=$("#import_excel_datagrid").datagrid("getData");$.ajax({type:"POST",url:StrackPHP.submitImportExcelData,dataType:"json",contentType:"application/json",data:JSON.stringify({param:a,field_mapping:e,grid_data:t.rows}),beforeSend:function(){$("#import_excel_step").append(Strack.loading_dom("white"))},success:function(e){var t;Strack.G.importExcelStep.goStep(4),Strack.reset_import_excel_step_bnt(4),$(".excel-in-submit").hide(),200===parseInt(e.status)?((t=$("#excel_in_success")).show(),t.find(".success-number").html(e.data.success_total),$("#"+a.grid).datagrid("reload")):((t=$("#excel_in_error")).show(),t.find(".error-code").html(e.status),t.find(".error-line").html(e.data.line),t.find(".error-msg").html(e.data.message)),$("#st-load").remove()}})},close_import_excel:function(){$("#import_excel_slider").sidebar("toggle")},change_field_col:function(a){var i=$("#"+a);$(".iex_text").on("blur",function(){var e=$(this).attr("data-index"),t=i.datagrid("selectRow",e).datagrid("getSelected");t[$(this).closest("td").attr("field")]=$(this).val(),i.datagrid("updateRow",{index:e,row:t}),$(this).off("blur"),Strack.change_field_col(a)})},export_excel_file:function(e){e=$(e).closest(".grid-toolbar").attr("data-grid");Strack.export_excel_dialog(e)},export_excel_dialog:function(e){Strack.open_dialog("dialog",{title:StrackLang.Export_Excel,width:480,height:180,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Egrid",type:"hidden",name:"grid",valid:1,value:e}],items:[{case:1,id:"Ename",type:"text",lang:StrackLang.Name,name:"excel_name",valid:1,value:""}],footer:[{obj:"export_excel",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]})})},export_excel:function(){var t,e=$("#Egrid").val(),a=$("#Ename").val(),i=$("#"+e).datagrid("options"),e=[],d=[];1<i.frozenColumns.length?(i.frozenColumns[0].forEach(function(e){d.push(e)}),t=[],i.frozenColumns[1].forEach(function(e){e&&"id"!==e.field&&t.push(e)}),i.columns[0].forEach(function(e){d.push(e)}),i.columns[1].forEach(function(e){e&&"id"!==e.field&&t.push(e)}),e.push(d,t)):(i.frozenColumns[0].forEach(function(e){e&&"id"!==e.field&&d.push(e)}),i.columns[0].forEach(function(e){e&&"id"!==e.field&&d.push(e)}),e.push(d)),$.ajax({type:"POST",url:StrackPHP.exportExcel,data:{filter_data:i.queryParams.filter_data,columns_data:JSON.stringify(e),excel_name:a,page:i.pageNumber,rows:i.pageSize},success:function(e){var t;200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.dialog_cancel(),t=StrackPHP.downloadExcel+"?id="+e.data.id,window.open(t)):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},manage_fields:function(e){var t=$(e).closest(".grid-toolbar"),t={lang:$(e).attr("data-lang"),page_name:t.attr("data-page"),grid:t.attr("data-grid"),module_id:t.attr("data-moduleid"),project_id:t.attr("data-projectid")};Strack.manage_fields_dialog(t)},manage_fields_dialog:function(i){Strack.open_dialog("dialog",{title:i.lang,width:680,height:464,content:Strack.dialog_dom({type:"datagrid",grid:{wrap_dom:"dialog_wrap",table_dom:"dialog_data",toolbar_show:!0,toolbar_id:"dialog_tb",toolbar_dom:[{obj:"Strack.add_custom_field",type:"button",icon:"icon-add",title:StrackLang.Add_Custom_Field}],top_notice:StrackLang.Manage_Custom_Fields_Notice,height:328},hidden:[{case:101,id:"Nlang",type:"hidden",name:"lang",valid:1,value:i.lang},{case:101,id:"Npage_name",type:"hidden",name:"page_name",valid:1,value:i.page_name},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:i.project_id},{case:101,id:"Ngrid",type:"hidden",name:"grid",valid:1,value:i.grid},{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:i.module_id}],footer:[{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$("#dialog_data").datagrid({url:StrackPHP.getCustomFieldsList,fitColumns:!1,height:Strack.panel_height("#dialog_wrap",0),differhigh:!1,rowheight:49,DragSelect:!0,queryParams:i,columnsFieldConfig:{name:{field_type:"custom",field_map:"name",field_value_map:"name",primary:"id",module:"variable",table:"Variable"},code:{field_type:"custom",field_map:"code",field_value_map:"code",primary:"id",module:"variable",table:"Variable"}},columns:[[{field:"variable_delete",title:StrackLang.Delete,align:"center",findex:0,width:60,formatter:function(e,t,a){return"yes"!==t.lock?'<a href="javascript:;" onclick="Strack.del_custom_field(this)" data-id="'+t.id+'" data-projectid="'+i.project_id+'" data-moduleid="'+i.module_id+'"><i class="icon-remove p-cursor"></i></a>':""}},{field:"variable_edit",title:StrackLang.Edit,align:"center",findex:0,width:60,formatter:function(e,t,a){return'<a href="javascript:;" onclick="Strack.edit_custom_field(this)" data-id="'+t.id+'" data-projectid="'+i.project_id+'" data-moduleid="'+i.module_id+'"><i class="icon-edit p-cursor"></i></a>'}},{field:"id",title:StrackLang.ID,align:"center",findex:1,width:60},{field:"name",title:StrackLang.Name,align:"center",findex:2,width:160,editor:{type:"text"}},{field:"code",title:StrackLang.Code,align:"center",findex:3,width:160,editor:{type:"text"}},{field:"type",title:StrackLang.Field_Type,align:"center",findex:4,width:120}]],toolbar:"#dialog_tb",pagination:!0,pageSize:100,pageList:[100,200],pageNumber:1,pagePosition:"bottom",remoteSort:!1}).datagrid("enableCellEditing").datagrid("disableCellSelecting").datagrid("gotoCell",{index:0,field:"id"})},close:function(){Strack.G.IsNewfileds&&(Strack.G.IsNewfileds=!1,window.location.reload())}})},del_custom_field:function(e){e=$(e),e={variable_id:e.data("id"),project_id:e.data("projectid"),module_id:e.data("moduleid")};Strack.G.IsNewfileds=!0,Strack.do_ajax_grid_delete("dialog_data",StrackLang.Del_Custom_Field_Notice,StrackPHP.deleteCustomField,!0,[e.variable_id],e)},edit_custom_field:function(e){var e=$(e),a={variable_id:e.data("id"),project_id:e.data("projectid"),module_id:e.data("moduleid"),lang:$("#Nlang").val(),page_name:$("#Npage_name").val(),grid:$("#Ngrid").val()},t=!1;Strack.G.IsNewfileds&&(Strack.G.IsNewfileds=!1,t=!0),Strack.dialog_cancel(),Strack.open_dialog("dialog",{title:StrackLang.Modify_Custom_Field,width:820,height:520,content:Strack.dialog_dom({type:"add_custom_field",hidden:[{case:101,id:"Nmode",type:"hidden",name:"mode",valid:1,value:"modify"},{case:101,id:"Nlang",type:"hidden",name:"lang",valid:1,value:a.lang},{case:101,id:"Npage_name",type:"hidden",name:"page_name",valid:1,value:a.page_name},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:a.project_id},{case:101,id:"Nvariable_id",type:"hidden",name:"variable_id",valid:1,value:a.variable_id},{case:101,id:"Ngrid",type:"hidden",name:"grid",valid:1,value:a.grid},{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:a.module_id}],footer:[{obj:"save_custom_field",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$.ajax({type:"POST",url:StrackPHP.getCustomFieldsConfig,data:a,dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close");var t={};switch(e.type){case"text":t={field_type:"text",lang:StrackLang.Input};break;case"combobox":t={field_type:"combobox",lang:StrackLang.Combobox};break;case"datebox":t={field_type:"datebox",lang:StrackLang.Datebox};break;case"datetimebox":t={field_type:"datetimebox",lang:StrackLang.Datetimebox};break;case"textarea":t={field_type:"textarea",lang:StrackLang.Text};break;case"checkbox":t={field_type:"checkbox",lang:StrackLang.Checkbox};break;case"belong_to":switch(e.relation_module_code){case"media":t={field_type:"media",lang:StrackLang.Media};break;case"status":t={field_type:"status",lang:StrackLang.Status}}break;case"horizontal_relationship":t={field_type:"horizontal_relationship",lang:StrackLang.Horizontal_Relationship}}$("#stdg_fd_list").empty().append(Strack.custom_field_type(t,a,!0)),Strack.select_field_type_active(t.lang,t.field_type,e)}})},close:function(){Strack.manage_fields_dialog(a),t&&(Strack.G.IsNewfileds=!0,t=!1)}})},select_field_type_active:function(e,t,a){switch($("#stdg_fd_title").html(e),Strack.fill_select_field_dom(t),$("#Fd_name").val(a.name),$("#Fd_code").val(a.code),t){case"text":$("#Fd_inputMask").combobox("setValue",a.input_mask),$("#Fd_inputMask_length").val(a.input_mask_length);break;case"combobox":for(var i in a.combo_list)$("#dg_comb_list").append(Strack.cf_comb_item_dom(a.combo_list[i]));Strack.rebuild_comb_index("#dg_comb_list",10);break;case"status":a.status_ids.forEach(function(e){var t="cf_"+Math.floor(1e4*Math.random()+1);$("#dg_status_comb_list").append(Strack.cf_status_comb_item_dom(t)),Strack.rebuild_comb_index("#dg_status_comb_list",1),Strack.combobox_widget("#"+t,{url:StrackPHP.getStatusList,valueField:"id",textField:"name",groupField:"correspond_name",width:250,height:26,value:e})});break;case"horizontal_relationship":$("#Fd_editor").combobox("setValue",a.editor),a.hasOwnProperty("relation_type")&&$("#Fd_relation_type").combobox("setValue",a.relation_type),$("#Fd_horizontal").combobox("disable").combobox("setValue",a.horizontal_config_id)}},add_custom_field:function(){var i={lang:$("#Nlang").val(),page_name:$("#Npage_name").val(),grid:$("#Ngrid").val(),module_id:$("#Nmodule_id").val(),project_id:$("#Nproject_id").val()},e=!1;Strack.G.IsNewfileds&&(Strack.G.IsNewfileds=!1,e=!0),Strack.dialog_cancel(),Strack.open_dialog("dialog",{title:StrackLang.Add_Custom_Field,width:820,height:520,content:Strack.dialog_dom({type:"add_custom_field",hidden:[{case:101,id:"Nmode",type:"hidden",name:"mode",valid:1,value:"add"},{case:101,id:"Nlang",type:"hidden",name:"lang",valid:1,value:i.lang},{case:101,id:"Npage_name",type:"hidden",name:"page_name",valid:1,value:i.page_name},{case:101,id:"Nproject_id",type:"hidden",name:"project_id",valid:1,value:i.project_id},{case:101,id:"Ngrid",type:"hidden",name:"grid",valid:1,value:i.grid},{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:i.module_id}],footer:[{obj:"save_custom_field",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$.ajax({type:"POST",url:StrackPHP.whetherSupportHorizontalRelation,dataType:"json",data:{module_id:i.module_id},success:function(e){var t=[{field_type:"text",lang:StrackLang.Input},{field_type:"combobox",lang:StrackLang.Combobox},{field_type:"datebox",lang:StrackLang.Datebox},{field_type:"datetimebox",lang:StrackLang.Datetimebox},{field_type:"textarea",lang:StrackLang.Text},{field_type:"checkbox",lang:StrackLang.Checkbox},{field_type:"timespinner",lang:StrackLang.TimeSpinner}];"yes"===e.data.allow_belong_to&&(t.push({field_type:"status",lang:StrackLang.Status}),t.push({field_type:"media",lang:StrackLang.Media})),"yes"===e.data.allow_horizontal&&t.push({field_type:"horizontal_relationship",lang:StrackLang.Horizontal_Relationship});var a="";t.forEach(function(e){a+=Strack.custom_field_type(e,i)}),$("#stdg_fd_list").empty().append(a)}})},close:function(){Strack.manage_fields_dialog(i),e&&(Strack.G.IsNewfileds=!0,e=!1)}})},custom_field_type:function(e,t,a){var i="";return i+=a?'<a href="javascript:;" class="stdg-left-item stdg-item-ac">'+e.lang+"</a>":'<a href="javascript:;" onclick="Strack.select_field_type(this)" class="stdg-left-item" data-fieldtype="'+e.field_type+'" data-lang="'+e.lang+'" data-moduleid="'+t.module_id+'">'+e.lang+"</a>"},select_field_type:function(e){var t=$(e).data("lang"),a=$(e).data("fieldtype");$(e).data("moduleid");$(".stdg-left-item").removeClass("stdg-item-ac"),$(e).addClass("stdg-item-ac"),$("#stdg_fd_title").html(t),Strack.fill_select_field_dom(a)},fill_select_field_dom:function(e){var t=null,a="",i=$("#stdg_fd_main");switch(e){case"text":t=Strack.custom_f_text_conf(e);break;case"combobox":t=Strack.custom_f_comb_conf(e);break;case"textarea":case"checkbox":t=Strack.custom_f_textarea_conf(e);break;case"datebox":case"datetimebox":case"media":case"timespinner":t=Strack.custom_f_date_conf(e);break;case"status":t=Strack.custom_f_status_conf(e);break;case"expression":t=Strack.custom_f_expression_conf(e);break;case"horizontal_relationship":t=Strack.custom_f_horizontal_conf(e)}var d=$("#Nmodule_id").val(),r=$("#Nproject_id").val();switch(t.hide.forEach(function(e){a+=Strack.dialog_items(e)}),t.show.forEach(function(e){e.module_id=d,e.project_id=r,a+=Strack.dialog_base_item(e.lang,e)}),i.empty().append(a),e){case"datebox":case"datetimebox":case"text":case"combobox":case"textarea":case"checkbox":case"horizontal_relationship":Strack.combobox_widget("#Fd_inputMask",{url:StrackPHP.getInputMaskList,valueField:"id",textField:"name",width:378,height:26,value:"arbitrary",onChange:function(e,t){var a=$("#Fd_inputMask_length").closest(".st-dialog-items");0<=$.inArray(e,["arbitrary","integer_no_range","letter_no_range"])?a.show():a.hide()}}),Strack.combobox_widget("#Fd_horizontal",{url:StrackPHP.getHorizontalRelationList,valueField:"id",textField:"name",width:378,height:26,queryParams:{module_id:d}})}"horizontal_relationship"===e&&(Strack.combobox_widget("#Fd_editor",{data:[{id:"horizontal_relationship",name:StrackLang.GridDialog},{id:"tagbox",name:StrackLang.TagBox}],valueField:"id",textField:"name",value:"tagbox",width:378,height:26}),Strack.combobox_widget("#Fd_relation_type",{data:[{id:"has_one",name:StrackLang.Has_One},{id:"has_many",name:StrackLang.Has_Many}],valueField:"id",textField:"name",value:"has_many",width:378,height:26})),$(":input").inputmask()},custom_f_text_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:2,id:"Fd_inputMask",type:"text",lang:StrackLang.Input_Mask,name:"input_mask",valid:"",value:""},{case:1,id:"Fd_inputMask_length",type:"text",lang:StrackLang.Input_Mask_Length,name:"input_mask_length",valid:"",value:"",mask:"9{1,999999999}"}]}},custom_f_comb_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:103,id:"Fd_comblist",type:"text",lang:StrackLang.Combo_List,name:"comb_list",valid:1,value:""}]}},custom_f_textarea_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"}]}},custom_f_date_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"}]}},custom_f_status_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:109,id:"Fd_comblist",type:"text",lang:StrackLang.Combo_List,name:"comb_list",valid:1,value:""}]}},custom_f_expression_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:110,id:"Fd_expression",type:"text",lang:StrackLang.Expression,name:"expression",valid:"1",value:"",mask:""}]}},add_new_custom_field_express:function(e){var t=Math.floor(1e6*Math.random()+1),a=$(e).closest(".dg-express-list").find(".exp-list-wrap"),i=$(e).data("moduleid"),e=$(e).data("projectid");a.append(Strack.custom_field_express_dom(t,"exp-field"));e={field_type:"built_in",data_source:"expression_fields",module_id:i,project_id:e};Strack.G.addCustomFieldExpressionData.param=e,Strack.combobox_widget("#cexp_"+t,{url:StrackPHP.getWidgetData,valueField:"id",textField:"name",groupField:"group_name",width:130,height:22,queryParams:e,onSelect:function(){Strack.generate_expression_data()}})},add_new_custom_operator_express:function(e){var t=Math.floor(1e6*Math.random()+1);$(e).closest(".dg-express-list").find(".exp-list-wrap").append(Strack.custom_field_express_dom(t,"exp-operator")),$("#cexp_"+t).combobox({data:[{id:"bracket_left",name:"("},{id:"bracket_right",name:")"},{id:"plus",name:"+"},{id:"minus",name:"-"},{id:"multiply",name:"*"},{id:"division",name:"/"}],height:22,width:70,valueField:"id",textField:"name",onSelect:function(){Strack.generate_expression_data()}})},generate_expression_data:function(){var e,t=$("#dg_express_setting"),a=t.find(".exp-list-wrap .express-item"),t=t.find(".dg-express-show"),i=1,d="",r={bracket_left:0,bracket_right:0,prev:"",prev_item:""},o={bracket_left:"(",bracket_right:")",plus:"+",minus:"-",multiply:"*",division:"/"},n=[],s={},l=[];a.each(function(){e=$(this).attr("id"),$(this).hasClass("exp-operator")?(d=Strack.get_combos_val("#"+e,"combobox","getValue"))?!$.isEmptyObject(r)&&"operator"===r.prev&&$.inArray(r.prev_item,["bracket_left","bracket_right"])<0?i=-2:(i=1,"bracket_left"!==d&&"bracket_right"!==d||r[d]++,r.prev="operator",r.prev_item=d,n.push(o[d]),l.push(o[d])):i=-1:($.isEmptyObject(Strack.G.addCustomFieldExpressionDataMap)&&$("#"+e).combobox("getData").forEach(function(e){Strack.G.addCustomFieldExpressionDataMap[e.id]=e}),(d=Strack.get_combos_val("#"+e,"combobox","getValue"))?$.isEmptyObject(r)||"field"!==r.prev&&("operator"!==r.prev||"bracket_right"!==r.prev_item)?(i=1,r.prev="field",r.prev_item=d,n.push(Strack.G.addCustomFieldExpressionDataMap[d].group_name+"."+Strack.G.addCustomFieldExpressionDataMap[d].name),l.push(d),s[d]=Strack.G.addCustomFieldExpressionDataMap[d]):i=-2:i=-1)}),r.bracket_left!==r.bracket_right&&(i=-2),"operator"===r.prev&&"bracket_right"!==r.prev_item&&(i=-2),Strack.G.addCustomFieldExpressionData.fill_status=i,Strack.G.addCustomFieldExpressionData.formula_fields=s,Strack.G.addCustomFieldExpressionData.formula=l.join(" "),t.empty().append(n.join(" "))},custom_field_express_dom:function(e,t){var a="";return a+='<div class="exp-input aign-left"><div class="exp-input-wg aign-left"><input id="cexp_'+e+'" class="'+t+' express-item"/></div><div class="exp-del-wg aign-left"><a href="javascript:;" class="exp-del-bnt" onclick="Strack.delete_custom_field_express_dom(this)"><i class="icon-uniE6D5"></i></a></div></div>'},delete_custom_field_express_dom:function(e){$(e).closest(".exp-input").remove(),Strack.generate_expression_data()},custom_f_horizontal_conf:function(e){return{hide:[{case:101,id:"Fd_type",type:"hidden",name:"field_type",valid:1,value:e}],show:[{case:1,id:"Fd_name",type:"text",lang:StrackLang.Field_Name,name:"name",valid:"1,128",value:"",mask:"*{1,128}"},{case:1,id:"Fd_code",type:"text",lang:StrackLang.Code,name:"code",valid:"1,128",value:"",mask:"alphaDash"},{case:2,id:"Fd_relation_type",type:"text",lang:StrackLang.Relation_Type,name:"relation_type",valid:"1",value:""},{case:2,id:"Fd_editor",type:"text",lang:StrackLang.Editor,name:"editor",valid:"1",value:""},{case:2,id:"Fd_horizontal",type:"text",lang:StrackLang.Relation_Module_List,name:"relation_module",valid:"1",value:""}]}},add_cf_comb_item:function(e){$("#dg_comb_list").append(Strack.cf_comb_item_dom("")),Strack.rebuild_comb_index("#dg_comb_list",10)},cf_comb_item_dom:function(e){var t="";return t+='<div class="dg-cblist-item"><div class="dgcb-id aign-left"><input type="text" disabled="disabled"></div><div class="dgcb-name aign-left"><input type="text" value="'+e+'"></div><a href="javascript:;" onclick="Strack.del_cf_comb_item(this)" class="dgcb-deitem aign-left"><i class="icon-uniEA34 icon-right"></i></a></div>'},del_cf_comb_item:function(e){$(e).parent().remove(),Strack.rebuild_comb_index("#dg_comb_list",10)},rebuild_comb_index:function(e,t){var a=0;$(e).find(".dg-cblist-item").each(function(){a+=t,$(this).find(".dgcb-id input").val(a)})},add_cf_status_comb_item:function(){var e="cf_"+Math.floor(1e4*Math.random()+1);$("#dg_status_comb_list").append(Strack.cf_status_comb_item_dom(e)),Strack.rebuild_comb_index("#dg_status_comb_list",1),Strack.combobox_widget("#"+e,{url:StrackPHP.getStatusList,valueField:"id",textField:"name",groupField:"correspond_name",width:250,height:26})},cf_status_comb_item_dom:function(e){var t="";return t+='<div class="dg-cblist-item"><div class="dgcb-id aign-left"><input type="text" disabled="disabled"></div><div class="dgcb-name aign-left"><input id="'+e+'" type="text"></div><a href="javascript:;" onclick="Strack.del_cf_status_comb_item(this)" class="dgcb-deitem aign-left" data-randomid="'+e+'"><i class="icon-uniEA34 icon-right"></i></a></div>'},del_cf_status_comb_item:function(e){var t=$(e).attr("data-randomid");$("#"+t).combobox("destroy"),$(e).parent().remove(),Strack.rebuild_comb_index("#dg_status_comb_list",1)},save_custom_field:function(){var e,t,a=$("#Fd_type").val(),d=[],r=!1,i={};if($(".st-dialog-input").children("i").remove(),$("#stdg_fd_main").find(".st-dialog-input").each(function(){var e,t,a=$(this).children("input"),i="";if(0===a.length&&(a=$(this).children("textarea")),!$.isEmptyObject(a[0])){if(e=a.attr("data-name"),t=a.data("valid"),i=a.hasClass("combobox-f")?Strack.get_combos_val("#"+a.attr("id"),"combobox","getValue"):$("#"+a.attr("id")).val(),!(0==t||0<i.length)){switch(e){case"name":layer.msg(StrackLang.Variable_Name_Null,{icon:2,time:1200,anim:6});break;case"code":layer.msg(StrackLang.Variable_Code_Null,{icon:2,time:1200,anim:6});break;case"editor":layer.msg(StrackLang.Variable_Editor_Null,{icon:2,time:1200,anim:6});break;case"relation_module":layer.msg(StrackLang.Variable_Relation_Module_Null,{icon:2,time:1200,anim:6})}return a.parent().append(Strack.dialog_error_icon("e")),r=!1}d.push({field:e,value:i}),a.parent().append(Strack.dialog_error_icon("t")),r=!0}}),r)switch(i.base_data=d,a){case"combobox":e=$("#dg_comb_list").find(".dgcb-name input"),t=[],0<e.length?(e.each(function(){var e=$(this).val();if(!e)return layer.msg(StrackLang.Variable_Combobox_Menu_Val_Null,{icon:2,time:1200,anim:6}),r=!1;t.push(e)}),i.field_type="combobox",i.comb_data=t):(r=!1,layer.msg(StrackLang.Variable_Combobox_Menu_Null,{icon:2,time:1200,anim:6}));break;case"status":e=$("#dg_status_comb_list").find("input.combobox-f"),t=[],0<e.length?(e.each(function(){var e=Strack.get_combos_val(this,"combobox","getValue");if(!e)return layer.msg(StrackLang.Variable_Combobox_Menu_Val_Null,{icon:2,time:1200,anim:6}),r=!1;t.push(e)}),i.field_type="belong_to",i.editor="combobox",i.comb_data=t,i.relation_module_code="status"):(r=!1,layer.msg(StrackLang.Variable_Combobox_Menu_Null,{icon:2,time:1200,anim:6}));break;case"media":i.field_type="belong_to",i.editor="upload",i.relation_module_code="media";break;case"expression":i.field_type="expression",$.isEmptyObject(Strack.G.addCustomFieldExpressionData)||1!==Strack.G.addCustomFieldExpressionData.fill_status?(r=!1,-2===Strack.G.addCustomFieldExpressionData.fill_status?layer.msg(StrackLang.Variable_Expression_Formula_Syntax_Error,{icon:2,time:1200,anim:6}):layer.msg(StrackLang.Variable_Expression_Formula_Null,{icon:2,time:1200,anim:6})):i.expression=Strack.G.addCustomFieldExpressionData;break;default:i.field_type=a}if(r){var o={};if($("#st_dialog_form_hide").find("input").each(function(){o[$(this).attr("data-name")]=$(this).val()}),i.base_data.push({field:"action_scope",value:"current"}),"text"===i.field_type){var n={field:"mask",value:""},s={};switch(i.base_data.forEach(function(e){s[e.field]=e.value}),s.input_mask){case"arbitrary":n.value=0<parseInt(s.input_mask_length)?"*{1,"+s.input_mask_length+"}":"*{1,999999999999999999}";break;case"integer_no_range":n.value=0<parseInt(s.input_mask_length)?"9{1,"+s.input_mask_length+"}":"9{1,999999999999999999}";break;case"letter_no_range":n.value=0<parseInt(s.input_mask_length)?"a{1,"+s.input_mask_length+"}":"a{1,999999999999999999}";break;default:n.value=s.input_mask}i.base_data.push(n)}var l="";switch(o.mode){case"add":l=StrackPHP.addCustomFields;break;case"modify":l=StrackPHP.modifyCustomFields}$.ajax({type:"POST",url:l,data:JSON.stringify({param:o,field_data:i}),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})}},frozen_col:function(e,t){var a=$(e).closest("td").attr("field"),i=$(e).find("i"),d=$(e).data("index"),e=$(e).closest(".datagrid-view").find(".datagrid-f").attr("id"),e=$("#"+e);t.stopPropagation(),(i.hasClass("icon-uniF023")?e.datagrid("FrozenColumn",{field:a,index:d,isfrozen:"frozen"}):e.datagrid("FrozenColumn",{field:a,index:d,isfrozen:"nofrozen"})).datagrid("reload"),e.datagrid("highlightViewSave")},build_comb_avatar:function(e){var t="";return t+='<div class="comb-avatar"><div class="comb-aimg aign-left">'+Strack.build_avatar(e.avatar,"e-avatar-small","d-avatar-small",Strack.JointLetter(e.first_name,e.last_name))+'</div><div class="comb-name text-ellipsis aign-left">'+e.uname+"</div></div>"},widget_status_dom:function(e,t,a){var i="";return i+='<i class="'+e+' icon-left" style="color:'+Strack.hex_to_rgb(a,1)+'" ></i>',i+=t},init_filter_event:function(e){e.find(".filter-task-panel input,.filter-task-panel textarea").off("change").on("change",function(){"checkbox"!=$(this).attr("type")&&Strack.filter_auto(this)})},filter_auto:function(e){$(e).closest(".datagrid-filter").find(".filter_auto_in").is(":checked")&&Strack.filter_apply($(e))},reset_filter_condition_value:function(e,t){var a=!1;return e.forEach(function(e){e.field===t.field&&(e.value=t.value,e.condition=t.condition,e.variable_id=t.variable_id,a=!0)}),a||e.push(t),e},filter_manual:function(e){Strack.filter_apply($(e))},filter_apply:function(e){var a,i,d,r,o,n,s,l,c,_,m,u,g,t,p,f,h=e.closest(".grid-filter-right").find(".filter-items");0<h.length?(g=[],h.each(function(){switch(a=$(this).attr("field"),i=$(this).attr("field_type"),d=$(this).attr("variable_id"),r=$(this).attr("editor"),o=$(this).attr("module"),n=$(this).attr("module_type"),s=$(this).attr("table"),l=$(this).find(".filter-input-wrap"),r){case"text":case"textarea":c=Strack.get_combos_val(l.find(".term-list")[0],"combobox","getValue"),(_=l.find(".input-text").val())&&c&&g.push({field:a,field_type:i,variable_id:d,value:_,condition:c,editor:r,module_code:o,module_type:n,table:s});break;case"timespinner":c=Strack.get_combos_val(l.find(".term-list")[0],"combobox","getValue"),(_=l.find(".input-timespinner").timespinner("getValue"))&&c&&g.push({field:a,field_type:i,variable_id:d,value:_,condition:c,editor:r,module_code:o,module_type:n,table:s});break;case"tagbox":case"horizontal_relationship":case"relation":case"checkbox":case"combobox":var e=l.find(".in-combobox"),t=e.combobox("options");u=t.multiple?(_=Strack.get_combos_val(e[0],"combobox","getValues"),"IN"):(_=Strack.get_combos_val(e[0],"combobox","getValue"),"EQ"),_&&g.push({field:a,field_type:i,variable_id:d,value:_,condition:u,editor:r,module_code:o,module_type:n,table:s});break;case"datebox":case"datetimebox":m=l.find(".in-date-term").prop("checked"),u=l.find(".in-date-range").prop("checked"),m&&(c=Strack.get_combos_val(l.find(".term-list")[0],"combobox","getValue"),(_=l.find(".term-date").datebox("getValue"))&&c&&g.push({field:a,field_type:i,variable_id:d,value:_,condition:c,editor:r,module_code:o,module_type:n,table:s})),u&&(c=l.find(".start-date").datebox("getValue"),(_=l.find(".end-date").datebox("getValue"))&&c&&g.push({field:a,field_type:i,variable_id:d,value:c+","+_,condition:"BETWEEN",editor:r,module_code:o,module_type:n,table:s}))}}),f=(p=e.closest(".datagrid-filter")).attr("data-maindom"),t=p.attr("data-bardom"),(e=(h=$("#"+f).find(".datagrid-f")).datagrid("options")).isKanban?(p=$(".datagrid-view-kanban").boards().data("boards"),(f=JSON.parse(e.queryParams.filter_data)).filter.filter_advance=[],f.filter.filter_input=[],f.filter.filter_panel=g,e.queryParams.filter_data=JSON.stringify(f),p.resetQueryConfig(e.queryParams),p.reload()):h.datagrid("setFilterParams",{filter_input:[],filter_panel:g,filter_advance:[]}).datagrid("reload"),Strack.save_filter_cache(t,"filter_panel",g),Strack.show_nosaved_filter(t,"filter_panel",StrackLang.Panel_Filter)):layer.msg(StrackLang.Please_Choice_Filter,{icon:2,time:1200,anim:6})},group_sort_change:function(e){var t=$(e).data("grid"),i=$(e).data("ptype"),d=$(e).data("pid"),r=$(e).data("sort");$("#"+t);$(e).hasClass("field-disable")&&($("#gasc_sort_"+i).addClass("field-disable"),$("#gdesc_sort_"+i).addClass("field-disable"),$(".gitem_"+i).each(function(){var e,t,a;$(this).find("i").hasClass("icon-checked")&&($("#g"+r+"_sort_"+i).removeClass("field-disable"),e={},a=$(this).data("field"),t=$(this).data("grid"),t=$("#"+t),a=[{sortName:a,sortOrder:e[a]=r}],Strack.DataSortAc(t,$(this),i,e,a,"noadv",!0),Strack.save_storage("GroupSort_"+d+"_"+i,JSON.stringify(a)),Strack.delete_storage("AdvSort_"+d+"_"+i))}))},thumb_media_widget:function(e,t,a){var i=Math.floor(1e6*Math.random()+1),d={id:i,css:"thumb-"+t.module_id+"-"+t.link_id,link_id:t.link_id,module_id:t.module_id,has_media:t.has_media,media_param:t.param};$(e).empty().append(Strack.thumb_media_widget_dom(i,d,a)),"yes"===t.has_media&&Strack.init_thumb_media(i),Strack.init_dropdown()},thumb_media_common_dom:function(e,t){var a=Math.floor(1e6*Math.random()+1),i=t.config.fields+"-"+t.param.module_id+"-"+t.param.primary,d="no",r={};if(e&&0<e.total)switch(d="yes",r=e.rows[0].param,t.from){case"common":Strack.G.infoMediaNeedInit.push(a);break;case"grid":Strack.G.gridMediaNeedInit.push(a)}r={id:a,css:i,link_id:t.param.primary,module_id:t.param.module_id,has_media:d,media_param:r};return Strack.thumb_media_widget_dom(a,r,{modify_thumb:"no",clear_thumb:"no"})},build_grid_preview_thumb_dom:function(e){var t={total:0,rows:[]};return e.thumb&&(t.total=1,t.rows.push({param:e.param})),Strack.thumb_media_common_dom(t,{param:{primary:e.id,module_id:e.module_id},from:"grid",config:e.field_config})},thumb_media_widget_dom:function(e,t,a){var i="";return i+='<div class="item-thumb-warp '+t.css+'" thumb-type="thumb"><div id="light_box_main_'+e+'" class="task-thumb-show" data-id="'+e+'">'+Strack.thumb_media_preview_dom(t)+'</div><div id="light_box_video_'+e+'" class="light-video">'+Strack.thumb_media_preview_video_dom(t)+"</div>","yes"===a.modify_thumb&&"yes"===a.clear_thumb&&(i+='<div class="ui secondary vertical menu thumb-menu-bnt" data-linkid="'+t.link_id+'" data-moduleid="'+t.module_id+'"><div class="ui dropdown item"><i class="icon-uniF03A"></i><div class="menu">',"yes"===a.modify_thumb&&(i+='<a href="javascript:;" class="item" onclick="Strack.change_item_media(this)">'+StrackLang.Modify_Thumb+"</a>"),"yes"===a.clear_thumb&&(i+='<a href="javascript:;" class="item" onclick="Strack.clear_item_thumb(this)">'+StrackLang.Clear_Thumb+"</a>"),i+="</div></div></div>"),i+="</div>"},init_thumb_media:function(e){lightGallery(document.getElementById("light_box_main_"+e),{galleryId:e,appendSubHtmlTo:".lg-item",addClass:"lg-comments",mode:"lg-fade",enableDrag:!1,download:!1,enableSwipe:!1})},init_other_thumb_media:function(e){switch(e){case"common":Strack.G.infoMediaNeedInit.forEach(function(e){Strack.init_thumb_media(e)}),Strack.G.infoMediaNeedInit=[];break;case"grid":Strack.G.gridMediaNeedInit.forEach(function(e){Strack.init_thumb_media(e)}),Strack.G.gridMediaNeedInit=[]}},thumb_media_preview_dom:function(e){var t="",a=e.media_param;return"yes"===e.has_media&&0<=$.inArray(a.type,["image","video"])?t+=Strack.light_box_item_dom(e.id,a).main_dom:t+='<div class="task-thumb-null"><i class="icon-left-p '+(e.media_param.icon||"icon-uniE61A")+'"></i></div>',t},thumb_media_preview_video_dom:function(e){var t="";return"yes"===e.has_media&&"video"===e.media_param.type&&(t+='<video class="lg-video-object lg-html5" controls preload="none" loop="loop" ><source src="'+(e.media_param.base_url+e.media_param.md5_name+".mp4")+'" type="video/mp4">Your browser does not support HTML5 video.</video>'),t},show_note_img_att:function(e,t){var a,i="",d="";return"yes"===t.has_media&&t.param.forEach(function(e){a="item"+Math.floor(1e5*Math.random()+1),a=Strack.light_box_item_dom(a,e),i+=a.main_dom,d+=a.video_dom}),'<div id="light_box_main_'+e+'">'+i+"</div>"+d},light_box_item_dom:function(e,t){var a="",i="";switch(t.type){case"image":var d,r=[],o="",n="",s=0;(Strack.is_string(t.size)?t.size.split(","):t.size).forEach(function(e){d=t.base_url+t.md5_name+"_"+e+"."+t.ext,"origin"===e?(s=t.width,n=d):s=e.split("x")[0],s<999999&&(o=d),r.push(d+" "+s)}),a='<a class="light-box" data-responsive="'+r.join(",")+'" data-src="'+n+'" ><img src="'+o+'" /><div class="light-poster"><i class="icon icon-uniE647"></i></div></a>';break;case"video":var l=t.base_url+t.md5_name+"_0.jpg",a='<a class="light-box" data-poster="'+l+'"  data-html="#light_box_video_'+e+'" ><img class="img-responsive" src="'+l+'"><div class="light-poster"><i class="icon icon-uniE647"></i></div></a>';i+='<div id="light_box_video_'+e+'" class="light-video"><video class="lg-video-object lg-html5" controls preload="none" loop="loop" ><source src="'+(t.base_url+t.md5_name+".mp4")+'" type="video/mp4">Your browser does not support HTML5 video.</video></div>'}return{main_dom:a,video_dom:i}},build_thumb_dom:function(e,t){var a="";return a+=e?'<img class="proj_thumb_ck" src="'+e+'">':'<div class="panel-thumb-null proj_thumb_ck"><i class="'+t+'"></i></div>'},build_grid_thumb_dom:function(e){var t="",a="";return a+='<a href="#" class="athumb"  >'+(t+=e?'<img src="'+e+'">':'<i class="icon-left-p icon-uniE61A"></i>')+"</a>"},get_media_server:function(t,a){$.ajax({type:"POST",url:StrackPHP.getMediaUploadServer,dataType:"json",success:function(e){200===parseInt(e.status)?(Strack.G.Media_Server=e.data,t(e.data)):a?a(e):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},assembly_media_thumb_data:function(e,t){var a={size:"",thumb:""};switch(t.type){case"video":a.size=t.width+"x"+t.height,a.thumb=e.request_url+""+t.path+t.md5_name+".jpg";break;case"image":a.size=t.size;var i=t.size.split(","),d="origin";i.forEach(function(e){"origin"!==e&&-1!==e.indexOf("x")&&e.split("x")[0]<999999&&(d=e)}),a.thumb=e.request_url+""+t.path+t.md5_name+"_"+d+"."+t.ext}return a},save_media_data:function(e,t){e.media_data.base_url=e.media_server.request_url+e.media_data.path,$.ajax({type:"POST",url:StrackPHP.saveMediaData,dataType:"json",data:JSON.stringify(e),contentType:"application/json",success:function(e){200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.Websocket.List.hasOwnProperty("update")||(e.data.status=200,Strack.update.thumbnail(e.data))):layer.msg(e.message,{icon:7,time:1200,anim:6}),t(e)}})},upload_avatar_dialog:function(e){var t=$(e).attr("data-userid"),a=$(e).attr("data-moduleid"),i=$(e).attr("data-avatarid");Strack.get_media_server(function(e){Strack.open_dialog("dialog",{title:StrackLang.Modify_Avatar,width:580,height:700,top:null,content:Strack.dialog_dom({type:"avatar",header_extra:{user_data:{dom_id:i,user_id:t,module_id:a},lang:StrackLang.Modify_Avatar},hidden:[{case:101,id:"Nuser_id",type:"hidden",name:"user_id",valid:1,value:t},{case:101,id:"Nmodule_id",type:"hidden",name:"module_id",valid:1,value:a}],footer:[{obj:"upload_avatar",type:5,title:StrackLang.Upload},{id:"delete_img",type:3,title:StrackLang.Clear_Canvas},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.js("crop_avatar_js",StrackPHP.JS+"/jquery.Jcrop.min.js"),$(".user-avatar-wrap").hide(),Strack.upload_preview({UpBtn:"img_upload",Showpanel:!0,Canvas:"canvas_crop_img",Cancel:[".user-avatar",".user-avatar-wrap","#delete_img"],Jcrop:"canvas_crop_tool",Width:522,Height:302,MinLimit:90})},close:function(){Strack.G.Jcrop_Thumb=null,Strack.G.Jcrop_Thumb_Ext=""}})})},base64ToFile:function(i){return new Promise(t=>{var e=document.createElement("canvas"),a=e.getContext("2d");e.width=Strack.G.Jcrop_Thumb.w,e.height=Strack.G.Jcrop_Thumb.h,a.putImageData(i,0,0,0,0,Strack.G.Jcrop_Thumb.w,Strack.G.Jcrop_Thumb.h),e.toBlob(function(e){t(new File([e],Math.random().toString(36).substr(2)+"."+Strack.G.Jcrop_Thumb_Ext,{type:Strack.G.Jcrop_Thumb_Mime}))},Strack.G.Jcrop_Thumb_Mime)})},upload_avatar:async function(){var t,a,e,i,d;Strack.G.Jcrop_Thumb?(t=$("#Nuser_id").val(),a=$("#Nmodule_id").val(),d=Strack.G.Jcrop_Canvas.getContext("2d").getImageData(Strack.G.Jcrop_Thumb.x,Strack.G.Jcrop_Thumb.y,Strack.G.Jcrop_Thumb.w,Strack.G.Jcrop_Thumb.h),e=await this.base64ToFile(d),i=Strack.G.Media_Server,(d=new FormData).append("belong_system",StrackPHP.Belong_System),d.append("size","90x90"),d.append("Filedata",e),$.ajax({type:"POST",url:i.upload_url,headers:{token:i.token},data:d,processData:!1,contentType:!1,beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){200===parseInt(e.status)?Strack.save_media_data({link_id:t,module_id:a,media_server:i,media_data:e.data[0],mode:"single"},function(e){$.messager.progress("close"),Strack.dialog_cancel()}):($.messager.progress("close"),layer.msg(e.message,{icon:7,time:1200,anim:6}))}})):layer.msg(StrackLang.Please_Select_Image_File,{icon:2,time:1200,anim:6})},change_item_media:function(e){var t=$(e).closest(".thumb-menu-bnt"),e=t.attr("data-linkid"),t=t.attr("data-moduleid");Strack.open_change_item_media({title:StrackLang.Modify_Thumb,link_id:e,module_id:t,mode:"single",from:"widget",field_type:"built_in",variable_id:0})},upload_onset_att:function(e){$(e).attr("data-from");var t=$(e).attr("data-moduleid"),e=$(e).attr("data-linkid");Strack.open_change_item_media({title:StrackLang.Upload_Onset_Reference,link_id:e,module_id:t,mode:"multiple",from:"onset",field_type:"built_in",variable_id:0})},load_onset_attachment:function(t,e){$.ajax({type:"POST",url:StrackPHP.getOnsetAttachment,contentType:"application/json",data:JSON.stringify(e),dataType:"json",beforeSend:function(){$(".onset-wrap-right").prepend(Strack.loading_dom("white","","onset_att"))},success:function(e){"yes"===e.has_media?Strack.generate_media_list_dom(t,e):$(t).html('<div class="datagrid-empty-no">'+StrackLang.Please_Upload_Onset_Reference+"</div>"),$("#st-load_onset_att").remove()}})},create_horizontal_relationship:function(e){var t=$(e).closest(".grid-toolbar"),e=$(e),e={project_id:t.data("projectid"),grid_id:t.data("grid"),variable_id:e.attr("variableid"),src_module_id:e.attr("srcmoduleid"),dst_module_id:e.attr("dstmoduleid"),src_link_id:e.attr("srclinkid"),horizontal_type:e.attr("horizontaltype"),link_data:[],from:"toolbar"};Strack.open_h_relationship_dialog(e)},open_h_relationship_dialog:function(a){Strack.open_dialog("dialog",{title:StrackLang.Horizontal_Relationship,width:1200,height:600,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mdst_module_id",type:"hidden",name:"temp_id",valid:1,value:a.dst_module_id},{case:101,id:"Mgrid_id",type:"hidden",name:"id_field",valid:1,value:a.grid_id},{case:101,id:"Msrc_link_id",type:"hidden",name:"category",valid:1,value:a.src_link_id},{case:101,id:"Msrc_module_id",type:"hidden",name:"category",valid:1,value:a.src_module_id},{case:101,id:"Mlink_ids",type:"hidden",name:"module_code",valid:1,value:a.link_data.join(",")}],items:[{case:12,id:"",type:"text",lang:"",name:"",valid:"",value:0}],footer:[{obj:"update_h_relate_set",type:5,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var t=$("#h_relationship_src");t.datagrid({url:StrackPHP.getHRelationDestData,width:540,height:460,fitColumns:!0,DragSelect:!0,frozenColumns:[[{field:"id",checkbox:!0}]],columns:[[{field:"show_id",title:StrackLang.ID,align:"center",width:80,formatter:function(e,t,a){return t.id}},{field:"name",title:StrackLang.Name,align:"center",width:160},{field:"code",title:StrackLang.Code,align:"center",width:160}]],queryParams:{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:"",mode:"all"},pagination:!0,pageNumber:1,pageSize:300,pageList:[300,500,1e3,2e3],pagePosition:"bottom",pageLayout:["list","prev","sep","manual","sep","next","refresh"]}),$("#h_relationship_search").searchbox({searcher:function(e){t.datagrid("reload",{filter_data:JSON.stringify(a),search_val:e,mode:"all"})},height:28,width:540,buttonRightVal:2,buttonRadius:!1,prompt:StrackLang.Search_More}),$("#h_relationship_dst").datagrid({url:StrackPHP.getHRelationDestData,width:540,height:488,fitColumns:!0,DragSelect:!0,frozenColumns:[[{field:"id",checkbox:!0}]],columns:[[{field:"show_id",title:StrackLang.ID,align:"center",width:80,formatter:function(e,t,a){return t.id}},{field:"name",title:StrackLang.Name,align:"center",width:160},{field:"code",title:StrackLang.Code,align:"center",width:160}]],queryParams:{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:"",mode:"selected"},pagination:!0,pageNumber:1,pageSize:300,pageList:[300,500,1e3,2e3],pagePosition:"bottom",pageLayout:["list","prev","sep","manual","sep","next","refresh"]})},close:function(){$("#"+a.grid_id).datagrid("reload")}})},move_to_h_relation_panel:function(){var t,a,e,i,d,r=$("#h_relationship_src"),o=$("#h_relationship_dst"),n=r.datagrid("getSelections");n.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):(t=0,a=[],e=r.datagrid("options"),i=JSON.parse(e.queryParams.selected_ids),n.forEach(function(e){t=r.datagrid("getRowIndex",e),-1===$.inArray(e.id,i)&&Strack.G.horizontalRelationIds.add.push(e.id),a.push(e.id),r.datagrid("deleteRow",t),o.datagrid("appendRow",e)}),d=[],Strack.G.horizontalRelationIds.delete.forEach(function(e){-1===$.inArray(e,a)&&d.push(e)}),Strack.G.horizontalRelationIds.delete=d)},remove_h_relate_set:function(){var e,t,a,i,d,r,o=$("#h_relationship_src"),n=$("#h_relationship_dst"),s=n.datagrid("getSelections");s.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):(e=o.datagrid("options"),t=JSON.parse(e.queryParams.filter_data),a=JSON.parse(e.queryParams.selected_ids),i=0,d=[],s.forEach(function(e){0<=$.inArray(e.id,a)&&Strack.G.horizontalRelationIds.delete.push(e.id),d.push(e.id),i=n.datagrid("getRowIndex",e),n.datagrid("deleteRow",i)}),r=[],Strack.G.horizontalRelationIds.add.forEach(function(e){-1===$.inArray(e,d)&&r.push(e)}),Strack.G.horizontalRelationIds.add=r,t.link_data=[],n.datagrid("getRows").forEach(function(e){t.link_data.push(e.id)}),e.queryParams.filter_data=JSON.stringify(t),o.datagrid("reload",e.queryParams))},update_h_relate_set:function(){var e=$("#h_relationship_dst").datagrid("options"),e=JSON.parse(e.queryParams.filter_data);Strack.G.horizontalRelationIds.add.length<1&&Strack.G.horizontalRelationIds.delete.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):$.ajax({type:"POST",url:StrackPHP.modifyHRelationDestData,data:JSON.stringify({param:e,up_data:Strack.G.horizontalRelationIds}),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.G.horizontalRelationIds={add:[],delete:[]},200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.dialog_cancel()):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},open_has_many_dialog:function(a){Strack.open_dialog("dialog",{title:StrackLang.Has_Many_Relation,width:1200,height:600,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mdst_module_id",type:"hidden",name:"temp_id",valid:1,value:a.dst_module_id},{case:101,id:"Mgrid_id",type:"hidden",name:"id_field",valid:1,value:a.grid_id},{case:101,id:"Msrc_link_id",type:"hidden",name:"category",valid:1,value:a.src_link_id},{case:101,id:"Msrc_module_id",type:"hidden",name:"category",valid:1,value:a.src_module_id},{case:101,id:"Mfield_module",type:"hidden",name:"category",valid:1,value:a.field_module},{case:101,id:"Mfield_table",type:"hidden",name:"category",valid:1,value:a.field_table},{case:101,id:"Mlink_ids",type:"hidden",name:"module_code",valid:1,value:a.link_data.join(",")}],items:[{case:12,id:"",type:"text",lang:"",name:"",valid:"",value:0}],footer:[{obj:"update_has_many_set",type:5,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var t=$("#h_relationship_src");t.datagrid({url:StrackPHP.getHasManyRelationData,width:540,height:460,fitColumns:!0,ctrlSelect:!0,DragSelect:!0,frozenColumns:[[{field:"id",checkbox:!0}]],columns:[[{field:"show_id",title:StrackLang.ID,align:"center",width:80,formatter:function(e,t,a){return t.id}},{field:"name",title:StrackLang.Name,align:"center",width:160},{field:"code",title:StrackLang.Code,align:"center",width:160}]],queryParams:{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:"",mode:"all"},pagination:!0,pageNumber:1,pageSize:300,pageList:[300,500,1e3,2e3],pagePosition:"bottom",pageLayout:["list","prev","sep","manual","sep","next","refresh"]}),$("#h_relationship_search").searchbox({searcher:function(e){t.datagrid("reload",{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:e,mode:"all"})},height:28,width:540,buttonRightVal:2,buttonRadius:!1,prompt:StrackLang.Search_More}),$("#h_relationship_dst").datagrid({url:StrackPHP.getHasManyRelationData,width:540,height:488,fitColumns:!0,DragSelect:!0,frozenColumns:[[{field:"id",checkbox:!0}]],columns:[[{field:"show_id",title:StrackLang.ID,align:"center",width:80,formatter:function(e,t,a){return t.id}},{field:"name",title:StrackLang.Name,align:"center",width:160},{field:"code",title:StrackLang.Code,align:"center",width:160}]],queryParams:{filter_data:JSON.stringify(a),selected_ids:JSON.stringify(a.link_data),search_val:"",mode:"selected"},pagination:!0,pageNumber:1,pageSize:300,pageList:[300,500,1e3,2e3],pagePosition:"bottom",pageLayout:["list","prev","sep","manual","sep","next","refresh"]})},close:function(){$("#"+a.grid_id).datagrid("reload")}})},update_has_many_set:function(){var e=$("#h_relationship_dst").datagrid("options"),e=JSON.parse(e.queryParams.filter_data);Strack.G.horizontalRelationIds.add.length<1&&Strack.G.horizontalRelationIds.delete.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):$.ajax({type:"POST",url:StrackPHP.modifyHasManyRelationData,data:JSON.stringify({param:e,up_data:Strack.G.horizontalRelationIds}),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.G.horizontalRelationIds={add:[],delete:[]},200===parseInt(e.status)?(Strack.top_message({bg:"g",msg:e.message}),Strack.dialog_cancel()):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},generate_media_list_dom:function(e,t){var a="main_"+Math.floor(1e4*Math.random()+1);$(e).empty().append(Strack.show_note_img_att(a,t)),Strack.init_thumb_media(a)},open_change_item_media:function(r,o){var e=1,t=240,a=11,n=!1;"multiple"===r.mode&&(t=380,a=9,n=!(e=0)),Strack.get_media_server(function(d){Strack.open_dialog("dialog",{title:r.title,width:480,height:t,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mlink_id",type:"hidden",name:"link_id",valid:1,value:r.link_id},{case:101,id:"Mmode",type:"hidden",name:"mode",valid:1,value:r.mode},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:r.module_id},{case:101,id:"Mfield_type",type:"hidden",name:"field_type",valid:1,value:r.field_type},{case:101,id:"Mvariable_id",type:"hidden",name:"variable_id",valid:1,value:r.variable_id}],items:[{case:a,id:"Mmedia_queue",type:"text",lang:StrackLang.Media_Attachment,name:"media_queue",valid:0,value:""}],footer:[{obj:"choice_media",type:6,title:""},{obj:"upload_item_thumb",type:5,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$("#choice_media").uploadifive({auto:!1,token:d.token,formData:{timestamp:Strack.current_time(),belong_system:StrackPHP.Belong_System,size:"250x140"},multi:n,queueSizeLimit:e,queueID:"queue",uploadScript:d.upload_url,onUpload:function(e){0==e?layer.msg(StrackLang.Please_Select_File,{icon:2,time:1200,anim:6}):$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},onUploadComplete:function(e,t){var a,i=JSON.parse(t);200===parseInt(i.status)?(a={},"grid"===r.from&&(a={type:"grid",index:r.index,dom:r.td_dom.attr("id"),editor:"media"}),Strack.save_media_data({link_id:r.link_id,mode:r.mode,field_type:r.field_type,variable_id:r.variable_id,module_id:r.module_id,media_server:d,media_data:i.data[0],widget_param:a},function(e){n||($.messager.progress("close"),Strack.dialog_cancel(),"grid"!==r.from||Strack.Websocket.List.hasOwnProperty("update")||(e.data.status=200,Strack.update.widget(e.data,a)))}),o&&!n&&o(t)):layer.msg(i.message,{icon:7,time:1200,anim:6})},onQueueComplete:function(){n&&($.messager.progress("close"),Strack.dialog_cancel())}})}})})},upload_item_thumb:function(){0<$(".uploadifive-queue-item").length?$("#choice_media").uploadifive("upload"):layer.msg(StrackLang.Please_Select_File,{icon:2,time:1200,anim:6})},clear_item_thumb:function(e){var t=$(e).closest(".thumb-menu-bnt"),e=t.attr("data-linkid"),t=t.attr("data-moduleid");Strack.submit_clear_item_thumb({link_id:e,module_id:t,mode:"single"})},submit_clear_item_thumb:function(e,t){$.ajax({type:"POST",url:StrackPHP.clearMediaThumbnail,dataType:"json",data:e,beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),t&&t()):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},grid_change_item_thumb:function(e){var t,a=$(e).data("grid"),i=$(e).data("moduleid"),e=$("#"+a).datagrid("getSelections");0<e.length?(t=[],e.forEach(function(e){t.push(e.id)}),Strack.open_change_item_media({title:StrackLang.Modify_Thumb,link_id:t.join(","),module_id:i,mode:"batch",from:"batch",field_type:"built_in",variable_id:0},function(){$("#"+a).datagrid("reload")})):layer.msg(StrackLang.Please_Select_Grid_One,{icon:2,time:1200,anim:6})},grid_clear_item_thumb:function(e){var t,a=$(e).data("grid"),i=$(e).data("moduleid"),e=$("#"+a).datagrid("getSelections");0<e.length?(t=[],e.forEach(function(e){t.push(e.id)}),Strack.submit_clear_item_thumb({link_id:t.join(","),module_id:i,mode:"batch"},function(){$("#"+a).datagrid("reload")})):layer.msg(StrackLang.Please_Select_Grid_One,{icon:2,time:1200,anim:6})},toggle_media_menu:function(e,t){var a=$(".st-menu-left"),i=$(".st-menu-right"),d=$(e).data("page"),e="";if(t)switch(e=t){case"show":a.css({width:"240px"}),i.css({left:"241px"}),a.removeClass("st-m-hide");break;case"hide":a.css({width:"60px"}),i.css({left:"61px"}),a.addClass("st-m-hide")}else a.hasClass("st-m-hide")?(e="show",a.css({width:"240px"}),i.css({left:"241px"}),a.removeClass("st-m-hide")):(e="hide",a.css({width:"60px"}),i.css({left:"61px"}),a.addClass("st-m-hide"));Strack.save_storage(d,e)},toggle_filter:function(e){var t=$(e).attr("data-maindom"),a=$(e).attr("data-bardom");Strack.do_toggle_filter(e,a,t,"")},apply_toggle_filter:function(e,t,a){var i=$("#"+t).find(".search-filter-button");Strack.do_toggle_filter(i[0],e,t,a)},do_toggle_filter:function(e,t,a,i){t=$("#"+t),a=$("#"+a);0<$(e).find(".icon-uniF141").length&&"show"!==i?($(e).html('<i class="icon-uniF142"></i>'),t.removeClass("filter-full-active").addClass("filter-full-hide").css({width:0}),a.css("width","100%")):($(e).html('<i class="icon-uniF141"></i>'),t.removeClass("filter-full-hide").addClass("filter-full-active"),t.hasClass("filter-min")?(a.css("width","calc(100% - 200px)"),t.css({width:200})):(a.css("width","calc(100% - 380px)"),t.css({width:380})))},toggle_filter_field:function(e){var t=$(e).attr("data-bardom"),a=$(e).offset(),e=0,e=0<$(".globel-top-notice").length?a.top-6:a.top+30;$("#search_list_"+t).css({top:e,left:a.left}).show()},toggle_filter_main:function(e){var t=$(e).closest(".datagrid-filter"),a=t.attr("data-maindom"),i=t.attr("data-bardom"),t=$("#"+i),i=$("#"+a),a=t.find(".filter-label-list");0<$(e).find(".icon-uniE94E").length?($(e).html('<i class="icon-uniE957"></i>'),t.removeClass("filter-min").css({width:380}),a.addClass("filter-lable-hide"),i.css("width","calc(100% - 380px)")):($(e).html('<i class="icon-uniE94E"></i>'),t.addClass("filter-min").css({width:200}),a.removeClass("filter-lable-hide"),i.css("width","calc(100% - 200px)"))},show_filter_filter:function(e){$(e).closest(".grid-filter-right").find(".filter-task-list").toggle()},toggle_filter_item:function(e){var t=$(e),a=t.closest(".grid-filter-right"),e=t.attr("from"),i={field:t.attr("field"),project_id:t.attr("project_id"),module_id:t.attr("module_id"),field_type:t.attr("field_type"),variable_id:t.attr("variable_id"),module:t.attr("module_code"),editor:t.attr("editor"),lang:t.attr("lang"),table:t.attr("table"),belong:t.attr("belong"),value_show:t.attr("value_show"),flg_module:t.attr("flg_module"),data_source:t.attr("data_source"),frozen_module:t.attr("frozen_module")};switch(e){case"bar":t.hasClass("item-active")?(r=t.closest(".grid-filter-right"),Strack.destroy_filter_item(r,i.field,i.module)):(t.addClass("item-active").find("i").removeClass("icon-unchecked").addClass("icon-checked"),Strack.filter_item_base(a,i),0<(o=a.find(".no-filter-task")).length&&o.remove());break;case"search":var d,r=t.closest(".filter-task-list"),o=r.attr("data-maindom");t.hasClass("item-active")?(t.removeClass("item-active").find("i").removeClass("icon-checked").addClass("icon-unchecked"),d=!0,r.find(".field-item").each(function(){$(this).find("i").hasClass("icon-checked")&&(d=!1)}),d&&$("#"+o).find(".search-filter-field").removeClass("search-bar-active")):(t.addClass("item-active").find("i").removeClass("icon-unchecked").addClass("icon-checked"),$("#"+o).find(".search-filter-field").addClass("search-bar-active"))}},clear_searchbox:function(e,t){$("#"+e).find("#grid_search").searchbox("clear"),$("#search_list_"+t).find(".field-item").each(function(){$(this).find("i").hasClass("icon-checked")&&Strack.toggle_filter_item(this)})},delete_filter_item:function(e){var t=$(e),a=t.closest(".filter-items").attr("field"),e=t.closest(".filter-items").attr("module"),t=t.closest(".grid-filter-right");Strack.destroy_filter_item(t,a,e)},destroy_filter_item:function(e,t,a){$("#fitem_"+a+"_"+t).remove(),e.find(".filter-task-list .item-active").each(function(){$(this).attr("field")==t&&$(this).attr("module_code")==a&&$(this).removeClass("item-active").find("i").removeClass("icon-checked").addClass("icon-unchecked")}),0==e.find(".filter-items").length&&e.find(".filter-task-panel").html('<div class="no-filter-task">'+StrackLang.No_Filter_Item+"</div>")},filter_item_delete:function(e){var t,a=$(e).attr("filter_id"),e=$(e).closest(".datagrid-filter"),e=(e.attr("data-bardom"),e.attr("data-maindom"));a&&(t=$("#"+e).find(".datagrid-table"),$.ajax({type:"POST",url:StrackPHP.deleteFilter,dataType:"json",data:{id:a},beforeSend:function(){t.datagrid("loading")},success:function(e){Strack.top_message({bg:"g",msg:e.message}),t.datagrid("loaded").datagrid("reloadFilterTags")}}))},filter_item_stick:function(e){var t,a=$(e).attr("filter_id"),i="yes"==$(e).attr("stick")?"no":"yes",e=$(e).closest(".datagrid-filter"),e=(e.attr("data-bardom"),e.attr("data-maindom"));a&&(t=$("#"+e).find(".datagrid-table"),$.ajax({type:"POST",url:StrackPHP.stickFilter,dataType:"json",data:{filter_id:a,stick:i},beforeSend:function(){t.datagrid("loading")},success:function(e){Strack.top_message({bg:"g",msg:e.message}),t.datagrid("loaded").datagrid("reloadFilterTags")}}))},save_filter_condition:function(e){e=$(e).closest(".datagrid-filter").find(".unsaved-filter-item");e.is(":hidden")?layer.msg(StrackLang.No_Filter_Need_Save,{icon:2,time:1200,anim:6}):(e=e.find(".fbar-save-bnt"),Strack.save_active_filter(e[0]))},save_active_filter:function(e){var t=$(e).closest(".datagrid-filter"),a=t.attr("data-bardom"),i=t.attr("data-maindom"),d=t.attr("data-page"),r=t.attr("data-projectid"),e=t.attr("data-moduletype"),t=t.attr("data-modulecode"),a=($("#"+a).find(".unsaved-filter-item").attr("data-from"),$("#"+i).find(".datagrid-table")),i=$(a).datagrid("options"),o=JSON.parse(i.queryParams.filter_data);o&&Strack.open_dialog("dialog",{title:StrackLang.Save_Filter,width:480,height:360,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:r},{case:101,id:"Mpage",type:"hidden",name:"page",valid:1,value:d},{case:101,id:"Mmodule_type",type:"hidden",name:"module_type",valid:1,value:e},{case:101,id:"Mmodule_code",type:"hidden",name:"module_code",valid:1,value:t},{case:101,id:"Mfilter",type:"hidden",name:"filter",valid:1,value:""},{case:101,id:"Mgrid",type:"hidden",name:"grid",valid:1,value:a.attr("id")}],items:[{case:1,id:"Mfilter_name",type:"text",lang:StrackLang.Name,name:"name",valid:"1,64",value:""},{case:2,id:"Mfilter_color",lang:StrackLang.Color,name:"color",valid:"1",value:""},{case:2,id:"Mfilter_stick",lang:StrackLang.Stick,name:"stick",valid:"1"},{case:2,id:"Mfilter_public",lang:StrackLang.Public,name:"public",valid:"1"}],footer:[{obj:"do_save_active_filter",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$("#Mfilter").val(JSON.stringify(o)),Strack.combobox_widget("#Mfilter_color",{url:StrackPHP.getFilterColorList,valueField:"id",textField:"name",value:"grey",formatter:function(e){return'<div class="combo-icons-warp" style="overflow: hidden"><div class="ui '+e.id+' label filter-tag-label"></div><div class="combo-name">'+e.name+"</div></div>"}}),Strack.combobox_widget("#Mfilter_stick",{url:StrackPHP.getStickType,valueField:"id",textField:"name",value:"no"}),Strack.combobox_widget("#Mfilter_public",{url:StrackPHP.getPublicType,valueField:"id",textField:"name",value:"yes"})}})},do_save_active_filter:function(){var e=$("#Mgrid").val(),t=$("#"+e);Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",StrackPHP.saveFilter,{back:function(e){Strack.top_message({bg:"g",msg:e.message}),t.datagrid("reloadFilterTags",e.data),t.datagrid("highlightViewSave"),Strack.dialog_cancel()}})},delete_unsave_filter:function(e){$(e).closest(".filter-tag-item").hasClass("filter-tag-ac")?Strack.reset_filter_default(e):(e=$(e).closest(".datagrid-filter").attr("data-bardom"),$("#"+e).find(".unsaved-filter-item").hide())},reset_filter_default:function(e){var t=$(e).closest(".datagrid-filter"),e=t.attr("data-bardom"),t=t.attr("data-maindom");Strack.do_reset_filter(t,e,!0)},do_reset_filter:function(e,t,a){var i;a&&((i=(r=$("#"+e).find(".datagrid-table")).datagrid("options")).isKanban?(d=$(".datagrid-view-kanban").boards().data("boards"),(a=JSON.parse(i.queryParams.filter_data)).filter.filter_advance=[],a.filter.filter_input=[],a.filter.filter_panel=[],i.queryParams.filter_data=JSON.stringify(a),d.resetQueryConfig(i.queryParams),d.reload()):r.datagrid("setFilterParams",{filter_input:[],filter_panel:[],filter_advance:[]}).datagrid("reload"),r.datagrid("highlightViewSave"));var d=$("#"+t),r=d.find(".unsaved-filter-item");r.hide(),d.find(".filter-tag-item").removeClass("filter-tag-ac");r=r.attr("data-from");Strack.clear_filter_cache(t),"filter_input"===r&&Strack.clear_searchbox(e,t)},get_filter_cache:function(e,t){e=Strack.read_storage("grid_filter_"+e);if(e){e=JSON.parse(e);return e.from==t?e.data:null}return null},save_filter_cache:function(e,t,a){Strack.save_storage("grid_filter_"+e,JSON.stringify({from:t,data:a}))},clear_filter_cache:function(e){Strack.delete_storage("grid_filter_"+e)},filter_item_base:function(e,t){var a="",i="fitem_"+t.module+"_"+t.field;return a+='<div id="'+i+'" class="filter-items" field="'+t.field+'" field_type="'+t.field_type+'" variable_id="'+t.variable_id+'" editor="'+t.editor+'" module="'+t.module+'" table="'+t.table+'" ><div class="filter-ilabel"><label class="aign-left"><strong>'+t.lang+'</strong><span class="text-faded"> ( '+t.belong+' ) </span></label><a href="javascript:;" class="pfilter-delete aign-right" onclick="Strack.delete_filter_item(this)"><i class="icon-uniE6DB"></i></a></div><div class=\'p-filter-inpt filter-input-wrap\'>'+Strack.filter_item_widget(t.editor,t)+"</div></div>",e.find(".filter-task-panel").append(a),Strack.init_filter_item("#"+i,t.editor,t),Strack.init_filter_event(e),a},init_filter_item:function(e,t,a){switch(t){case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":var i=$(e).find(".in-combobox")[0],d=0<=$.inArray(t,["tagbox","combobox","horizontal_relationship"]);Strack.combobox_widget(i,{url:StrackPHP.getWidgetData,valueField:"id",textField:"name",width:279,height:28,multiple:d,queryParams:{type:t,fields:a.value_show,field_type:a.field_type,variable_id:a.variable_id,project_id:a.project_id,module_id:a.module_id,module:a.module,primary:0,flg_module:a.flg_module,frozen_module:a.frozen_module,data_source:a.data_source},formatter:function(e){switch(a.fields){case"assignee":case"created_by":return Strack.build_comb_avatar(e);default:return e.name}},onLoadSuccess:function(){},onChange:function(e,t){Strack.filter_auto(this)}});break;case"text":case"textarea":var r=$(e).find(".term-list")[0];Strack.combobox_widget(r,{data:Strack.filter_express(["EQ","NEQ","LIKE","NOTLIKE"]),valueField:"id",textField:"name",height:28,onChange:function(e,t){$(this).data("ptype"),$(this).data("filter");Strack.filter_auto(this)}});break;case"timespinner":r=$(e).find(".term-list")[0],d=$(e).find(".input-timespinner");Strack.combobox_widget(r,{data:Strack.filter_express(["EQ","NEQ","GT","EGT","LT","ELT"]),valueField:"id",textField:"name",height:28,onChange:function(e,t){$(this).data("ptype"),$(this).data("filter");Strack.filter_auto(this)}}),d.timespinner({height:28,editable:!0,onSpinUp:function(){Strack.filter_auto(this)},onSpinDown:function(){Strack.filter_auto(this)}});break;case"datebox":case"datetimebox":var o=$(e).find(".in-date-term"),n=$(e).find(".in-date-range"),s=$(e).find(".data-input-wrap");o.on("click",function(){n.attr("checked",!1),o.is(":checked")?(s.empty().append(Strack.filter_item_widget("date_term",a)),Strack.init_filter_item(s,"date_term",a)):s.empty()}),n.on("click",function(){o.attr("checked",!1),n.is(":checked")?(s.empty().append(Strack.filter_item_widget("date_range",a)),Strack.init_filter_item(s,"date_range",a)):s.empty()});break;case"date_term":var l=e.find(".term-list"),c=e.find(".term-date");Strack.combobox_widget(l[0],{data:Strack.filter_express(["EQ","NEQ","GT","EGT","LT","ELT"]),valueField:"id",textField:"name",height:28,onChange:function(e,t){$(this).data("ptype"),$(this).data("filter");Strack.filter_auto(this)}}),Strack.filter_date_box(c[0],"",28,"",!1,8);break;case"date_range":l=e.find(".start-date"),c=e.find(".end-date");Strack.filter_date_box(l[0],"",28,"",!1,8),Strack.filter_date_box(c[0],"",28,"",!1,8)}},filter_express:function(e){var t=[];return e.forEach(function(e){t.push(Strack.express_item(e))}),t},express_item:function(e){switch(e){case"EQ":return{id:"EQ",name:StrackLang.Exp_EQ};case"NEQ":return{id:"NEQ",name:StrackLang.Exp_NEQ};case"GT":return{id:"GT",name:StrackLang.Exp_GT};case"EGT":return{id:"EGT",name:StrackLang.Exp_EGT};case"LT":return{id:"LT",name:StrackLang.Exp_LT};case"ELT":return{id:"ELT",name:StrackLang.Exp_ELT};case"LIKE":return{id:"LIKE",name:StrackLang.Exp_LIKE};case"NOTLIKE":return{id:"NOTLIKE",name:StrackLang.Exp_NOTLIKE};case"BETWEEN":return{id:"BETWEEN",name:StrackLang.Exp_BETWEEN};case"NOT BETWEEN":return{id:"NOT BETWEEN",name:StrackLang.Exp_NOT_BETWEEN};case"IN":return{id:"IN",name:StrackLang.Exp_IN};case"NOT IN":return{id:"NOT IN",name:StrackLang.Exp_NOT_IN}}},filter_item_widget:function(e,t){var a="";switch(e){case"combobox":case"tagbox":case"horizontal_relationship":case"relation":case"checkbox":a+='<input class="in-combobox" />';break;case"text":case"textarea":a+='<div  class="pf-widget-term aign-left"><input class="term-list" /></div><div  class="pf-widget-input aign-left"><input class="input-text" type="text" /></div>';break;case"timespinner":a+='<div  class="pf-widget-term aign-left"><input class="term-list" /></div><div  class="pf-widget-input aign-left"><input class="input-timespinner" /></div>';break;case"datebox":case"datetimebox":a='<div class=\'pf-widget-date\'><div class="widget-date-item"><div class="aign-left"><input type="checkbox" class="in-date-term"></div><div class="widget-date-name aign-left">'+StrackLang.Date+'</div></div><div class="widget-date-item"><div class="aign-left"><input type="checkbox" class="in-date-range"></div><div class="widget-date-name aign-left">'+StrackLang.Date_Range+'</div></div><div class="p-filter-inpt data-input-wrap"></div></div>';break;case"date_term":a='<div class="pf-widget-term aign-left"><input class="term-list"></div><div class="pf-widget-input aign-left"><input class="term-date"></div>';break;case"date_range":a='<div class="pf-widget-even aign-left interval-right-10"><input class="start-date"></div><div class="pf-widget-even aign-left"><input class="end-date"></div>'}return a},stick_filter_bar:function(e){var t=$(e).closest(".datagrid-filter").attr("data-page"),a=$(e).find("span"),i="",i=$(e).hasClass("stick-on")?(a.html(StrackLang.Keep_Display),$(e).removeClass("stick-on"),"no"):(a.html(StrackLang.Cancel_Keep),$(e).addClass("stick-on"),"yes");$.ajax({type:"POST",url:StrackPHP.saveUserFilterKeepConfig,data:{stick:i,page:t},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.top_message({bg:"g",msg:e.message})}})},get_logic_list:function(){return[{id:"and",name:"and"},{id:"or",name:"or"}]},open_advance_filter:function(e){var t=$(e).closest(".datagrid-filter"),a=t.attr("data-moduleid"),i=t.attr("data-maindom"),d=t.attr("data-bardom"),r=t.attr("data-projectid"),e=t.attr("data-page"),t=t.attr("data-schemapage");Strack.dialog_cancel(),Strack.open_dialog("dialog",{title:StrackLang.Advanced_Filter,width:620,height:440,content:Strack.dialog_dom({type:"adv_filter",hidden:[{case:101,id:"Fmodule_id",type:"hidden",name:"module_id",valid:1,value:a},{case:101,id:"Fpage",type:"hidden",name:"page",valid:1,value:e},{case:101,id:"Fschema_page",type:"hidden",name:"page",valid:1,value:t},{case:101,id:"Fmaindom",type:"hidden",name:"maindom",valid:1,value:i},{case:101,id:"Fbardom",type:"hidden",name:"maindom",valid:1,value:d},{case:101,id:"Fproject_id",type:"hidden",name:"project_id",valid:1,value:r}],footer:[{obj:"do_advance_filter",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#logic_comb",{data:Strack.get_logic_list(),valueField:"id",textField:"name",width:70,height:26,value:"and"}),Strack.init_advance_filter(d)}})},init_advance_filter:function(e){var a,i=Strack.get_filter_cache(e,"filter_advance"),d=["logic","multiple","number"];i&&(1<parseInt(i.number)?(a="",Strack.init_advance_group(i.number,"multiple"),$(".dgcb-query-group").each(function(e){for(var t in i[e])$.inArray(t,d)<0&&Strack.init_advance_item(this,i[e][t],"multiple");a=$(this).find(".advh_logic").attr("id"),$("#"+a).combobox("setValue",i[e].logic)})):(Strack.init_advance_group(i.number,"single"),$(".dgcb-query-group").each(function(){for(var e in i)$.inArray(e,d)<0&&Strack.init_advance_item(this,i[e],"single")})),$("#logic_comb").combobox("setValue",i.logic))},init_advance_group:function(e){for(var t=0;t<e;t++)Strack.add_filter_group("")},init_advance_item:function(e,t,a){var i,d="group_"+Math.floor(1e3*Math.random()+1),r=$(e).closest(".dgcb-query-group"),o=$("#Fpage").val(),n=$("#Fschema_page").val(),s=$("#Fproject_id").val(),e=$("#Fmodule_id").val(),l=null;switch(t.editor){case"text":case"textarea":l=["EQ","NEQ","LIKE","NOTLIKE"];break;case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":l=["EQ","IN","NOT IN"];break;case"timespinner":l=["EQ","NEQ","GT","EGT","LT","ELT"];break;case"datebox":case"datetimebox":l=["EQ","NEQ","GT","EGT","LT","ELT","BETWEEN"]}switch(r.find(".dgcb-query-cond").append(Strack.adv_filter_group_dom(d)),$("#condth_"+d).attr("data-field",t.field).attr("data-fieldtype",t.field_type).attr("data-variableid",t.variable_id).attr("data-editor",t.editor).attr("data-module",t.module_code).attr("data-moduletype",t.module_type).attr("data-frozenmodule",t.frozen_module).attr("data-multiple",a).attr("data-table",t.table),Strack.combobox_widget("#Fds_"+d,{url:StrackPHP.getAdvanceFilterFields,valueField:"id",textField:"lang",width:120,height:25,value:t.module_code+"."+t.field,groupField:"belong",queryParams:{module_id:e,page:o,schema_page:n,project_id:s},onSelect:function(e){var t=$(this).closest(".dgcb-cond-item"),a=t.find(".cond_lgoic").attr("id"),i=t.find(".cond-entity-in"),d=t.find(".cond_value").attr("id");t.attr("data-field",e.fields).attr("data-fieldtype",e.field_type).attr("data-variableid",e.variable_id).attr("data-editor",e.editor).attr("data-moduleid",e.module_id).attr("data-modulecode",e.module_code).attr("data-datasource",e.data_source).attr("data-module",e.module).attr("data-moduletype",e.module_type).attr("data-frozenmodule",e.frozen_module).attr("data-valueshow",e.value_show).attr("data-multiple","single").attr("data-table",e.table),Strack.init_adv_filter_cond(a,d,i,e)}}),$("#Fds_"+d).closest(".dgcb-cond-item").attr("data-field",t.fields).attr("data-fieldtype",t.field_type).attr("data-variableid",t.variable_id).attr("data-editor",t.editor).attr("data-moduleid",t.module_id).attr("data-modulecode",t.module_code).attr("data-datasource",t.data_source).attr("data-module",t.module).attr("data-moduletype",t.module_type).attr("data-valueshow",t.value_show).attr("data-frozenmodule",t.frozen_module).attr("data-multiple","single").attr("data-table",t.table),Strack.combobox_widget("#Fls_"+d,{data:Strack.filter_express(l),valueField:"id",textField:"name",width:120,height:25,value:t.condition,onSelect:function(e){var t,a="date_"+Math.floor(1e3*Math.random()+1),i=$(this).closest(".dgcb-cond-item"),d=i.attr("data-editor"),r=i.find(".cond-entity-in"),o=i.find(".cond_value").attr("id");switch(e.id){case"IN":case"NOT IN":$("#"+o).combobox("setOptions",{multiple:!0,value:""}).combobox("reload"),i.attr("data-multiple","multiple");break;case"BETWEEN":t='<input id="'+o+'" class="cond_value" style="width: 180px;display: none"><div class="cond-v-start aign-left"><input id="Fdis_'+a+'" class="condv_sdate cond_v_date" style="width: 90px;"></div><div class="cond-v-end aign-left"><input id="Fdie_'+a+'" class="condv_edate cond_v_date" style="width: 90px;"></div>',r.empty().append(t),Strack.filter_date_box("#Fdis_"+a,"",25,"",!1,8),Strack.filter_date_box("#Fdie_"+a,"",25,"",!1,8);break;default:switch(d){case"combobox":case"tagbox":case"checkbox":case"horizontal_relationship":case"relation":$("#"+o).combobox("setOptions",{multiple:!1,value:""}).combobox("reload"),i.attr("data-multiple","single");break;case"datebox":case"datetimebox":r.empty().append('<input id="'+o+'" class="cond_value" style="width: 180px">'),Strack.filter_date_box("#"+o,"",25,"",!1,8)}}}}),t.editor){case"text":case"textarea":case"timespinner":$("#Fvs_"+d).val(t.value);break;case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":var c="",_=!1,c="EQ"===t.condition?t.value:(_=!0,t.value.split(","));Strack.combobox_widget("#Fvs_"+d,{url:StrackPHP.getWidgetData,valueField:"id",textField:"name",height:25,value:c,queryParams:{primary:0,project_id:s,module:t.module,module_type:t.module_type,field_type:t.field_type,variable_id:t.variable_id,fields:t.value_show,module_id:t.module_id,data_source:t.data_source,flg_module:t.flg_module,frozen_module:t.frozen_module},multiple:_});break;case"datebox":case"datetimebox":"BETWEEN"===t.condition?(i="date_"+Math.floor(1e3*Math.random()+1),c="",_=t.value.split(","),c='<input id="Fvs_'+d+'" class="cond_value" style="width: 180px;display: none"><div class="cond-v-start aign-left"><input id="Fdis_'+i+'" class="condv_sdate cond_v_date" style="width: 90px;"></div><div class="cond-v-end aign-left"><input id="Fdie_'+i+'" class="condv_edate cond_v_date" style="width: 90px;"></div>',$("#condth_"+d).find(".cond-entity-in").empty().append(c),Strack.filter_date_box("#Fdis_"+i,"",25,_[0],!1,8),Strack.filter_date_box("#Fdie_"+i,"",25,_[1],!1,8)):Strack.filter_date_box("#Fvs_"+d,"",25,t.value,!1,8)}},do_advance_filter:function(){var e,t,a=$("#Fmaindom").val(),i=$("#Fbardom").val(),d=Strack.scan_advance_filter(),r=$("#"+a).find(".datagrid-table");$.isEmptyObject(d.adv_filter)||((e=$(r).datagrid("options")).isKanban?(t=$(".datagrid-view-kanban").boards().data("boards"),(a=JSON.parse(e.queryParams.filter_data)).filter.filter_advance=d.adv_filter,a.filter.filter_input=[],a.filter.filter_panel=[],e.queryParams.filter_data=JSON.stringify(a),t.resetQueryConfig(e.queryParams),t.reload()):$(r).datagrid("setFilterParams",{filter_input:[],filter_panel:[],filter_advance:d.adv_filter}).datagrid("reload"),Strack.save_filter_cache(i,"filter_advance",d.adv_filter),Strack.show_nosaved_filter(i,"filter_advance",StrackLang.Advanced_Filter),Strack.dialog_cancel())},show_nosaved_filter:function(e,t,a){var i=$("#"+e),e=i.find(".unsaved-filter-item");i.find(".exist-filter-item .filter-tag-item").removeClass("filter-tag-ac"),e.find(".filter-tag-item").addClass("filter-tag-ac"),e.attr("data-from",t).find(".filter-tag-name").html(a),e.show()},scan_advance_filter:function(e){var t=$("#dg_adv_filter").find(".dgcb-query-group"),a=$(".dgcb-query-group").length,r={},i="",o=0,n=!0;switch(t.length){case 0:20!=e&&layer.msg(StrackLang.Advanced_Filter_Group_Null,{icon:2,time:1200,anim:6});break;case 1:(i=Strack.get_combos_val("#logic_comb","combobox","getValue"))?(t.each(function(){var e,t=$(this).find(".dgcb-cond-item"),a=0;t.each(function(){return(e=Strack.get_adv_fd_item(this))?(r[a]=e,void a++):(r={},layer.msg(StrackLang.Advanced_Filter_Full_Null,{icon:2,time:1200,anim:6}),n=!1)})}),$.isEmptyObject(r)||(r.logic=i,r.number=a)):(layer.msg(StrackLang.Advanced_Filter_Logic_Null,{icon:2,time:1200,anim:6}),n=!1);break;default:(i=Strack.get_combos_val("#logic_comb","combobox","getValue"))?(t.each(function(){var e,t=$(this).find(".dgcb-cond-item"),a={},i=0,d=$(this).find(".advh_logic").attr("id"),d=Strack.get_combos_val("#"+d,"combobox","getValue");if(t.each(function(){return(e=Strack.get_adv_fd_item(this))?(a[i]=e,void i++):!(a={})}),$.isEmptyObject(a))return r={},layer.msg(StrackLang.Advanced_Filter_Full_Null,{icon:2,time:1200,anim:6}),n=!1;a.logic=d,r[o]=a,o++}),$.isEmptyObject(r)||(r.logic=i,r.number=a)):(layer.msg(StrackLang.Advanced_Filter_Logic_Null,{icon:2,time:1200,anim:6}),n=!1)}return{adv_filter:r,go_on:n,item_num:a}},get_adv_fd_item:function(e){var t,a,i,d,r,o=$(e).attr("data-editor"),n=$(e).attr("data-field"),s=$(e).attr("data-fieldtype"),l=$(e).attr("data-module"),c=$(e).attr("data-moduleid"),_=$(e).attr("data-modulecode"),m=$(e).attr("data-frozenmodule"),u=$(e).attr("data-moduletype"),g="built_in"==$(e).attr("data-fieldtype")?0:$(e).attr("data-variableid"),p=$(e).attr("data-valueshow"),f=$(e).attr("data-datasource"),h=$(e).attr("data-multiple"),k=$(e).attr("data-table"),v=$(e).find(".cond_field").attr("id"),b=$(e).find(".cond_lgoic").attr("id"),S=$(e).find(".cond_value").attr("id"),y="",v=Strack.get_combos_val("#"+v,"combobox","getValue"),w=Strack.get_combos_val("#"+b,"combobox","getValue");if(o){switch(o){case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":switch(h){case"single":y=Strack.get_combos_val("#"+S,"combobox","getValue");break;case"multiple":y=Strack.get_combos_val("#"+S,"combobox","getValues").join(",")}break;case"text":y=$(e).find(".cond_value").val();break;case"timespinner":y=$("#"+S).timespinner("getValue");break;case"datebox":case"datetimebox":y="BETWEEN"===w?(t=$(e).find(".condv_sdate").attr("id"),a=$(e).find(".condv_edate").attr("id"),i=[],r=d="",d=$("#"+t).datebox("getValue"),r=$("#"+a).datebox("getValue"),d&&r?(i.push(d),i.push(r),i.join(",")):""):$("#"+S).datebox("getValue")}return v&&w&&y?($(e).find(".cond-entity-en").empty().append(Strack.dialog_error_icon("t")),{field:n,field_type:s,variable_id:g,module:l,module_id:c,module_type:u,module_code:_,value_show:p,table:k,condition:w,data_source:f,frozen_module:m,value:y,editor:o,multiple:h}):($(e).find(".cond-entity-en").empty().append(Strack.dialog_error_icon("e")),!1)}return $(e).find(".cond-entity-en").empty().append(Strack.dialog_error_icon("e")),!1},add_filter_group:function(e){var t="group_"+Math.floor(1e3*Math.random()+1);$("#dg_adv_filter").append(Strack.filter_group_dom(t,"display-hide")),Strack.combobox_widget("#"+t,{data:Strack.get_logic_list(),valueField:"id",textField:"name",width:70,height:26,value:"and"}),Strack.toggle_filter_group()},filter_group_dom:function(e,t){var a="";return a+='<div class="dgcb-query-group"><div class="dgcb-query-hd"><div class="dgcb-item-log aign-left '+t+'"><div class="query-all-name aign-left">'+StrackLang.ConditionalLogic+'</div><div class="query-all-input aign-left"><input id="'+e+'" class="advh_logic" style="width: 53px;"></div></div><div class="dgcb-item-btn aign-left"><a href="javascript:;" onclick="Strack.add_adv_filter_item(this)" class="query-all-btn aign-left"><i class="icon-uniEA33"></i>'+StrackLang.AddFilterItem+'</a></div><div class="dgcb-item-btn aign-right"><a href="javascript:;" onclick="Strack.delete_filter_group(this)" class="query-all-btn aign-left"><i class="icon-uniE6DB"></i></a></div></div><div class="dgcb-query-cond"></div></div>'},adv_filter_group_dom:function(e){var t="";return t+='<div id="condth_'+e+'" class="dgcb-cond-item"><div class="cond-entity-fd aign-left"><input id="Fds_'+e+'" class="cond_field" style="width: 120px;"></div><div class="cond-entity-lg aign-left"><input id="Fls_'+e+'" class="cond_lgoic" style="width: 120px;"></div><div class="cond-entity-in aign-left"><input id="Fvs_'+e+'" class="cond_value" style="width: 180px;" ></div><a href="javascript:;" onclick="Strack.delete_filter_cond(this)" class="cond-entity-de aign-left"><i class="icon-uniEA34"></i></a><div class="cond-entity-en aign-left"></div></div>'},add_adv_filter_item:function(e){var t="group_"+Math.floor(1e3*Math.random()+1),a=$(e).closest(".dgcb-query-group"),i=$("#Fmodule_id").val(),d=($("#Fmodule_code").val(),$("#Fproject_id").val()),r=$("#Fpage").val(),e=$("#Fschema_page").val();a.find(".dgcb-query-cond").append(Strack.adv_filter_group_dom(t)),Strack.combobox_widget("#Fds_"+t,{url:StrackPHP.getAdvanceFilterFields,valueField:"id",textField:"lang",width:120,height:25,groupField:"belong",queryParams:{module_id:i,project_id:d,page:r,schema_page:e},onSelect:function(e){var t=$(this).closest(".dgcb-cond-item"),a=t.find(".cond_lgoic").attr("id"),i=t.find(".cond-entity-in"),d=t.find(".cond_value").attr("id");t.attr("data-field",e.fields).attr("data-fieldtype",e.field_type).attr("data-variableid",e.variable_id).attr("data-editor",e.editor).attr("data-moduleid",e.module_id).attr("data-modulecode",e.module_code).attr("data-datasource",e.data_source).attr("data-module",e.module_alias).attr("data-moduletype",e.module_type).attr("data-frozenmodule",e.frozen_module).attr("data-valueshow",e.value_show).attr("data-multiple","single").attr("data-table",e.table),Strack.init_adv_filter_cond(a,d,i,e)}}),Strack.combobox_widget("#Fls_"+t,{data:Strack.filter_express(["EQ","NEQ","GT","EGT","LT","ELT"]),valueField:"id",textField:"name",width:120,height:25,onSelect:function(e){var t,a="date_"+Math.floor(1e3*Math.random()+1),i=$(this).closest(".dgcb-cond-item"),d=i.attr("data-editor"),r=i.find(".cond-entity-in"),o=i.find(".cond_value").attr("id");switch(e.id){case"IN":case"NOT IN":$("#"+o).combobox("setOptions",{multiple:!0,value:""}).combobox("reload"),i.attr("data-multiple","multiple");break;case"BETWEEN":t='<input id="'+o+'" class="cond_value" style="width: 180px;display: none"><div class="cond-v-start aign-left"><input id="Fdis_'+a+'" class="condv_sdate cond_v_date" style="width: 90px;"></div><div class="cond-v-end aign-left"><input id="Fdie_'+a+'" class="condv_edate cond_v_date" style="width: 90px;"></div>',r.empty().append(t),Strack.filter_date_box("#Fdis_"+a,"",25,"",!1,8),Strack.filter_date_box("#Fdie_"+a,"",25,"",!1,8);break;default:switch(d){case"combobox":$("#"+o).combobox("setOptions",{multiple:!1,value:""}).combobox("reload"),i.attr("data-multiple","single");break;case"datebox":case"datetimebox":r.empty().append('<input id="'+o+'" class="cond_value" style="width: 180px">'),Strack.filter_date_box("#"+o,"",25,"",!1,8)}}}})},init_adv_filter_cond:function(e,t,a,i){var d=null,r=$("#Fproject_id").val();switch(a.empty().append('<input id="'+t+'" class="cond_value" style="width: 180px;" >'),i.editor){case"text":case"textarea":d=["EQ","NEQ","LIKE","NOTLIKE"];break;case"timespinner":d=["EQ","NEQ","GT","EGT","LT","ELT"],$("#"+t).timespinner({height:25,editable:!0});break;case"tagbox":case"horizontal_relationship":case"relation":case"combobox":case"checkbox":var d=["EQ","IN","NOT IN"],o={url:StrackPHP.getWidgetData,valueField:"id",textField:"name",height:25,queryParams:{primary:0,project_id:r,module_id:i.module_id,module:i.module,module_type:i.module_type,field_type:i.field_type,fields:i.value_show,data_source:i.data_source,variable_id:i.variable_id,flg_module:i.flg_module,frozen_module:i.frozen_module}};Strack.combobox_widget("#"+t,o);break;case"datebox":case"datetimebox":Strack.filter_date_box("#"+t,"",25,"",!(d=["EQ","NEQ","GT","EGT","LT","ELT","BETWEEN"]),8)}$("#"+e).combobox("loadData",Strack.filter_express(d)).combobox("setValue","EQ")},delete_filter_cond:function(e){$(e).closest(".dgcb-cond-item").remove()},delete_filter_group:function(e){$(e).closest(".dgcb-query-group").remove(),Strack.toggle_filter_group()},toggle_filter_group:function(){var e=$("#dg_adv_filter").find(".dgcb-query-group"),t=$(".dgcb-item-log");1<e.length?t.removeClass("display-hide"):t.addClass("display-hide")},toggle_ac_filter:function(e){var t=$(e).attr("filter_type"),a=$(e).attr("filter_id"),i=$(e).closest(".datagrid-filter"),d=i.attr("data-maindom"),r=i.attr("data-bardom"),o=$("#"+d).find(".datagrid-table");i.find(".filter-tag-item").removeClass("filter-tag-ac"),$(e).closest(".filter-tag-item").addClass("filter-tag-ac"),"exist"===t?$.ajax({type:"POST",url:StrackPHP.getFilterSingle,data:JSON.stringify({filter_id:a}),dataType:"json",contentType:"application/json",success:function(e){var t=o.datagrid("options"),a=JSON.parse(t.queryParams.filter_data);a.filter.filter_advance=e.filter.filter_advance,a.filter.filter_input=e.filter.filter_input,a.filter.filter_panel=e.filter.filter_panel,a.filter.request=e.filter.request,t.queryParams.filter_data=JSON.stringify(a),t.isKanban?((a=$(".datagrid-view-kanban").boards().data("boards")).resetQueryConfig(t.queryParams),a.reload()):o.datagrid("setOptions",{queryParams:t.queryParams}).datagrid("reload"),o.datagrid("highlightViewSave")}}):(t=$(e).closest(".unsaved-filter-item").attr("data-from"),a=o.datagrid("options"),(e=JSON.parse(a.queryParams.filter_data))[t]=Strack.get_filter_cache(r,t),a.queryParams.filter_data=JSON.stringify(e),o.datagrid("setOptions",{queryParams:a.queryParams}).datagrid("reload"))},click_view_mode_item:function(e){var t;$(e).attr("from");"kanban"===$(e).attr("view_mode")&&((t=$(e).closest(".entity-datalist").find(".datagrid-table").datagrid("options")).groupParam.grid_data.grid.view_mode="kanban",t.groupParam.group_param.hasOwnProperty("can_use_kanban")&&"no"===t.groupParam.group_param.can_use_kanban&&(Strack.check_whether_use_kanban_view(t.groupParam.grid_param.module_code,t.groupParam.grid_data).checkData.use_kanban_view||Strack.click_down_item($("#group_status_name")[0]))),Strack.save_view(e),window.location.reload()},toggle_kanban_view:function(e){var t=$(e),a=t.attr("belong"),i=(t.attr("from"),{field:t.attr("field"),field_type:t.attr("field_type"),module:t.attr("module"),module_code:t.attr("module_code"),module_type:t.attr("module_type"),table:t.attr("table"),value_show:t.attr("value_show"),editor:t.attr("editor"),lang:t.attr("lang"),sort:t.attr("field_sort"),edit:t.attr("field_edit"),belong:a,width:t.attr("field_width"),can_use_kanban:t.attr("can_use_kanban")}),a=$(e).closest(".entity-datalist").find(".datagrid-table");a.datagrid("highlightViewSave");t=a.datagrid("options").columnsFieldConfig,t=Strack.generate_grid_group_data(i,t);a.datagrid("setOptions",{groupActive:!0,groupField:i.value_show,groupFormatter:function(e,t){return'<span class="">'+e+"( "+t.length+" )</span>"}}).datagrid("setFilterParams",{group:t}),Strack.save_view(e),window.location.reload()},calendar_click_filter:function(e,t){e.stopPropagation(),e.preventDefault();var a=$(t).data("type"),e=$(t).data("value");if(Strack.handle_calendar_check_icon(t,e,a),"task_type"===a){var i=$("#fc_filter_wrap_user_receive"),d=$("#fc_filter_wrap_user_sent");switch(e){case"my_receive":i.hide(),d.show(),Strack.handle_calendar_filter(t,"user_receive","",!1);break;case"my_sent":i.show(),d.hide(),Strack.handle_calendar_filter(t,"user_sent","",!1);break;case"my_create":i.show(),d.show();break;default:i.hide(),d.hide(),Strack.handle_calendar_filter(t,"user_receive","",!1),Strack.handle_calendar_filter(t,"user_sent","",!1)}}},handle_calendar_check_icon:function(e,t,a){var i,d;"all"===t?0<=$.inArray(a,["task_type","end_time"])?($(e).closest(".menu").find(".item").each(function(){$(this).find("i").removeClass("icon-checked").addClass("icon-unchecked")}),"end_time"===a?($("#fc_endtime_from,#fc_endtime_to").datebox("clear"),Strack.handle_calendar_filter(e,a,{type:"fixed",value:null},!0)):Strack.handle_calendar_filter(e,a,"",!0)):($(e).closest(".menu").find(".scrolling  .item").each(function(){$(this).find("i").removeClass("icon-checked").addClass("icon-unchecked")}),Strack.handle_calendar_filter(e,a,"",!0)):"date_all"===t?$(e).closest(".menu").find(".item").each(function(){$(this).find("i").removeClass("icon-checked").addClass("icon-unchecked")}):(i=$(e).find("i"),0<=$.inArray(a,["task_type","end_time","department_members","view_type"])?($(e).closest(".menu").find(".item i.icon-checked").removeClass("icon-checked").addClass("icon-unchecked"),i.removeClass("icon-unchecked").addClass("icon-checked"),"end_time"===a?($("#fc_endtime_from,#fc_endtime_to").datebox("clear"),Strack.handle_calendar_filter(e,a,{type:"fixed",value:t},!0)):Strack.handle_calendar_filter(e,a,t,!0)):(i.hasClass("icon-unchecked")?i.removeClass("icon-unchecked").addClass("icon-checked"):i.removeClass("icon-checked").addClass("icon-unchecked"),d=[],$(e).closest(".scrolling").find(".item").each(function(){$(this).find("i").hasClass("icon-checked")&&d.push($(this).data("value"))}),Strack.handle_calendar_filter(e,a,d.join(","),!0)))},handle_calendar_filter:function(e,t,a,i){e=$(e).closest(".my-scheduler-index").attr("id");Strack.G.calendarEventsFilter[t]=a,i&&Strack.reload_fullCalendar_data(e)},click_down_item:function(e){var t=$(e),a=t.attr("belong"),i=t.attr("from"),d={field:t.attr("field"),field_type:t.attr("field_type"),module:t.attr("module"),module_code:t.attr("module_code"),module_type:t.attr("module_type"),table:t.attr("table"),value_show:t.attr("value_show"),editor:t.attr("editor"),lang:t.attr("lang"),sort:t.attr("field_sort"),edit:t.attr("field_edit"),belong:a,width:t.attr("field_width"),can_use_kanban:t.attr("can_use_kanban")},r=$(e).closest(".entity-datalist").find(".datagrid-table");r.datagrid("highlightViewSave");var o=r.datagrid("options").columnsFieldConfig,n=Strack.toggle_item_icon(e,i);switch(i){case"show":(n?r.datagrid("addQueryFields",d):r.datagrid("cutQueryFields",d)).datagrid("reload");break;case"group":n?(c=Strack.generate_grid_group_data(d,o),r.datagrid("setOptions",{groupActive:!0,groupField:d.value_show,groupFormatter:function(e,t){return'<span class="">'+e+"( "+t.length+" )</span>"}}).datagrid("setFilterParams",{group:c}).datagrid("reload")):r.datagrid("setOptions",{groupActive:!1}).datagrid("setFilterParams",{group:{}}).datagrid("reload");break;case"sort":var s={};s[d.value_show]={type:"asc",field:d.field,field_type:d.field_type,value_show:d.value_show,module_code:d.module_code},n?Strack.sort_grid_icon(r,s,"single"):Strack.sort_grid_icon(r,{},"single");break;case"view":var l=$(e).closest(".grid-toolbar"),c=$(e).attr("view_id"),s=l.attr("data-page"),l=l.attr("data-projectid");Strack.toggle_view(c,s,l)}},toggle_item_icon:function(e,t){var a=$(e).find("i"),i=!1;if(a.hasClass("icon-unchecked")){switch(t){case"group":$(e).closest(".grid_group").find(".group-field i").removeClass("icon-checked").addClass("icon-unchecked"),a.removeClass("icon-unchecked").addClass("icon-checked");break;case"sort":break;case"view":$(e).closest(".grid-toolbar").find(".view-g-item i").removeClass("icon-checked").addClass("icon-unchecked"),a.removeClass("icon-unchecked").addClass("icon-checked");break;case"view_mode":$(e).closest(".grid-toolbar").find(".view-mode-item i").removeClass("icon-checked").addClass("icon-unchecked"),a.removeClass("icon-unchecked").addClass("icon-checked");break;case"project_status":case"project_time":case"project_belong":var d=$(e).attr("options"),r=$(e).closest("."+t);("all"===d||"project_time"===t?r.find(".view-g-item i"):$(r.find(".view-g-item i")[0])).removeClass("icon-checked").addClass("icon-unchecked"),a.removeClass("icon-unchecked").addClass("icon-checked");break;default:a.removeClass("icon-unchecked").addClass("icon-checked")}i=!0}else"view"===t||a.removeClass("icon-checked").addClass("icon-unchecked");return i},generate_grid_user:function(e){var t="";return t=e&&0<e.rows.length?e.rows[0].name:t},generate_grid_group_data:function(e,t){var a={};return a[e.value_show]={type:"asc",field:e.field,field_type:e.field_type,value_show:e.value_show,module_code:e.module_code,can_use_kanban:e.can_use_kanban},a},get_grid_group_field:function(e,t){t=t||!1;var a,i={},d={can_use_kanban:"no"};for(a in e)if(i.field=a,i.order=e[a].type,t)for(var r in e[a])"can_use_kanban"===r&&(d.can_use_kanban=e[a][r]),d[r]=e[a][r];return t?d:i},check_whether_use_kanban_view:function(e,t){var a=Strack.get_grid_group_field(t.grid.group_name,!0),i={use_kanban_view:!1,use_pagination:!0,show_header:!0};return"kanban"===t.grid.view_mode&&!$.isEmptyObject(a)&&"status"===a.module_code||"kanban"===t.grid.view_mode&&"yes"===a.can_use_kanban?(i.use_kanban_view=!0,i.use_view=kanbanview,i.use_pagination=!1,i.show_header=!1):i.use_view=scrollview,{groupParam:a,checkData:i}},delete_group:function(e){$(e).attr("data-panel");$(e).closest(".grid_group").find(".group-field i").removeClass("icon-checked").addClass("icon-unchecked");e=$(e).closest(".entity-datalist").find(".datagrid-table");e.datagrid("setOptions",{groupActive:!1}).datagrid("setFilterParams",{group:[]}).datagrid("reload"),e.datagrid("highlightViewSave")},sort_grid_item:function(e){var t,a=$(e).data("grid"),i=$(e).data("field"),d=$(e).attr("data-sort"),e=$("#"+a),a={};switch(d){case"asc":t="desc";break;case"desc":t="empty";break;default:t="asc"}"empty"!==t&&(a[(d=e.datagrid("options").columnsFieldConfig)[i].field_map]={type:t,field:d[i].fields,field_type:d[i].field_type,value_show:d[i].field_map,module_code:d[i].module_code}),e.datagrid("highlightViewSave"),Strack.sort_grid_icon(e,a,"single")},sort_grid_icon:function(e,t,a){Strack.init_sort_grid_icon(e,t,a);var i=e.closest(".entity-datalist").find(".grid_sort");Strack.init_sort_icon(i,t,a),e.datagrid("setOptions",{sortConfig:t}),e.datagrid("setFilterParams",{sort:t}).datagrid("reload"),"advance"===a&&Strack.dialog_cancel()},init_sort_grid_icon:function(e,t,a){var i;e.closest(".datagrid-view").find(".datagrid-sort").each(function(){i=$(this).closest("td").attr("field"),$(this).removeClass("datagrid-sort-desc datagrid-sort-asc").children("a").attr("data-sort",""),t.hasOwnProperty(i)&&("empty"!==t[i].type&&$(this).addClass("datagrid-sort-"+t[i].type).children("a").attr("data-sort",t[i].type),$(this).find("a").attr("data-sort",t[i].type))})},init_sort_icon:function(e,t,a){var i;Strack.show_sort_down_icon(e,t,a),e.find(".sort-field").each(function(){i=$(this).attr("value_show"),t.hasOwnProperty(i)&&"empty"!==t[i]?$(this).find("i").removeClass("icon-unchecked").addClass("icon-checked"):$(this).find("i").removeClass("icon-checked").addClass("icon-unchecked")})},init_show_sort_down_icon:function(e,t,a){var i,d=[];for(i in t)d.push(i);d.length&&Strack.show_sort_down_icon(e,d,t,a)},show_sort_down_icon:function(e,t,a){var i,d,r="";for(d in t){r=t[d].type;break}e.find(".sort-bnt").each(function(){switch(i=$(this).attr("data-sort")){case"asc":case"desc":i===r&&"single"===a?$(this).removeClass("field-disable"):$(this).addClass("field-disable");break;case"advance":"advance"===a?$(this).removeClass("field-disable"):$(this).addClass("field-disable")}})},dropdown_sort:function(e){var t=$(e).attr("data-sort"),a=$(e).closest(".grid_sort"),i="",d="",r="",o="",n={};a.find(".sort-field").each(function(){$(this).attr("module"),$(this).find("i").hasClass("icon-checked")&&(d=$(this).attr("field"),i=$(this).attr("value_show"),r=$(this).attr("field_type"),o=$(this).attr("module_code"))});e=$(e).closest(".entity-datalist").find(".datagrid-table");0<i.length&&(n[i]={type:t,field:d,field_type:r,value_show:i,module_code:o},Strack.sort_grid_icon(e,n,"single"))},sort_cancel:function(e){e=$(e).closest(".entity-datalist").find(".datagrid-table");e.datagrid("setOptions",{sortConfig:{}}),Strack.sort_grid_icon(e,{},"single"),e.datagrid("highlightViewSave")},advance_sort:function(e){var t=$(e).closest(".grid-toolbar"),a=t.attr("data-projectid"),i=t.attr("id"),e=t.attr("data-grid"),d=t.attr("data-page"),r=t.attr("data-schemapage"),o=t.attr("data-moduleid");Strack.open_dialog("dialog",{title:StrackLang.Sort_Adv,width:420,height:320,content:Strack.dialog_dom({type:"adv_sort",hidden:[{case:101,id:"Mpanel_id",type:"hidden",name:"panel_id",valid:1,value:i},{case:101,id:"Mgrid",type:"hidden",name:"grid",valid:1,value:e}],footer:[{obj:"do_advance_sort",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#sort_first,#sort_second,#sort_third",{url:StrackPHP.getSortFields,valueField:"id",textField:"lang",width:160,height:25,groupField:"belong",queryParams:{project_id:a,page:d,schema_page:r,module_id:o,field_list_type:["sort"]},onSelect:function(e){}}),Strack.combobox_widget("#sort_first_func,#sort_second_func,#sort_third_func",{url:StrackPHP.getSortList,valueField:"id",textField:"name",width:110,height:25})}})},do_advance_sort:function(){var e=$("#Mgrid").val(),t=($("#Mpanel_id").val(),$("#"+e)),a=Strack.get_combos_val("#sort_first","combobox","getValue"),i=Strack.get_combos_val("#sort_second","combobox","getValue"),d=Strack.get_combos_val("#sort_third","combobox","getValue"),r=Strack.get_combos_val("#sort_first_func","combobox","getValue"),o=Strack.get_combos_val("#sort_second_func","combobox","getValue"),n=Strack.get_combos_val("#sort_third_func","combobox","getValue"),s=$("#sort_first").combobox("getRowValue","id"),l=$("#sort_second").combobox("getRowValue","id"),c=$("#sort_third").combobox("getRowValue","id"),_=t.datagrid("options").columnsFieldConfig;$("#shang_first,#shang_second,#shang_third").find("i").remove();e={};a&&r?($("#shang_first").append(Strack.dialog_error_icon("t")),e[_[s.value_show].field_map]={type:r,field:_[s.value_show].fields,field_type:_[s.value_show].field_type,value_show:_[s.value_show].field_map,module_code:_[s.value_show].module_code},i&&o&&($("#shang_second").append(Strack.dialog_error_icon("t")),e[_[l.value_show].field_map]={type:o,field:_[l.value_show].fields,field_type:_[l.value_show].field_type,value_show:_[l.value_show].field_map,module_code:_[l.value_show].module_code}),d&&n&&($("#shang_third").append(Strack.dialog_error_icon("t")),e[_[c.value_show].field_map]={type:n,field:_[c.value_show].fields,field_type:_[c.value_show].field_type,value_show:_[c.value_show].field_map,module_code:_[c.value_show].module_code}),Strack.sort_grid_icon(t,e,"advance")):(layer.msg(StrackLang.AdvSort_Null,{icon:2,time:1200,anim:6}),$("#shang_first").append(Strack.dialog_error_icon("e")))},save_view:function(e){var t=Strack.select_view_param(e);if("allow"===t.allow_edit){var a=$(e).attr("data-panel"),i="grid";switch(a){case"grid":var d=$(e).closest(".grid-toolbar");$(e).closest(".entity-datalist").find(".datagrid-table").datagrid("delHighlightViewSave"),i=$(e).attr("view_mode");break;case"list":d=$(e).closest(".list-toolbar"),Strack.del_highlight_view_save(e)}var r={view_type:0<t.view_id?"custom":"default",panel:a,type:i,page:d.attr("data-page"),project_id:d.attr("data-projectid"),maindom:d.attr("data-maindom"),bardom:d.attr("data-bardom")},a=Strack.get_view_data(r);Strack.submit_save_view(t.view_id,a,r)}else Strack.save_as_view(e)},submit_save_view:function(e,t,a){var i="default"===a.view_type?StrackPHP.saveDefaultView:StrackPHP.saveView,d=$(".exist-filter-item .filter-tag-ac").attr("filter_id");t.filter_bar_id=d||0,$.ajax({type:"POST",url:i,dataType:"json",data:{id:e,page:a.page,type:a.type,project_id:a.project_id,view_data:JSON.stringify(t)},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message})}})},select_view_param:function(e){var t;switch($(e).attr("data-panel")){case"grid":t=$(e).closest(".grid-toolbar");break;case"list":t=$(e).closest(".list-toolbar")}var a=t.find(".view-g-item"),i={};return i.project_id=t.attr("data-projectid"),a.each(function(){$(this).find("i").hasClass("icon-checked")&&(i.view_id=parseInt($(this).attr("view_id")),i.allow_edit=$(this).attr("allow_edit"))}),i},save_as_view:function(e){var t,a=$(e).attr("data-panel"),i="grid";switch(a){case"grid":t=$(e).closest(".grid-toolbar"),i="grid"===$(".grid_view_mode").attr("view_mode")?"kanban":"grid";break;case"list":t=$(e).closest(".list-toolbar")}Strack.open_dialog("dialog",{title:StrackLang.Save_View,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mpanel",type:"hidden",name:"panel",valid:1,value:a},{case:101,id:"Mpage",type:"hidden",name:"page",valid:1,value:t.attr("data-page")},{case:101,id:"Mproject_id",type:"hidden",name:"project_id",valid:1,value:t.attr("data-projectid")},{case:101,id:"Mmaindom",type:"hidden",name:"maindom",valid:1,value:t.attr("data-maindom")},{case:101,id:"Mbardom",type:"hidden",name:"bardom",valid:1,value:t.attr("data-bardom")},{case:101,id:"MviewMode",type:"hidden",name:"type",valid:1,value:i}],items:[{case:1,id:"Mview_name",type:"text",lang:StrackLang.Name,name:"name",valid:"1,128",value:""},{case:2,id:"Mview_public",lang:StrackLang.Public,name:"public",valid:"1",value:""}],footer:[{obj:"submit_save_as_view",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#Mview_public",{url:StrackPHP.getPublicType,valueField:"id",textField:"name",value:"yes"})}})},submit_save_as_view:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",StrackPHP.saveAsView,{back:function(e){Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),location.reload()}},{extra:function(e){return e.view_data=JSON.stringify(Strack.get_view_data({panel:e.panel,page:e.page,type:e.type,project_id:e.project_id,maindom:e.maindom,bardom:e.bardom})),e}})},modify_view:function(e){var t;switch($(e).attr("data-panel")){case"grid":t=$(e).closest(".grid-toolbar");break;case"list":t=$(e).closest(".list-toolbar")}var a=t.find(".view-g-active"),i={view_id:a.attr("view_id"),view_name:a.attr("view_name"),view_public:a.attr("view_public"),allow_edit:a.attr("allow_edit")};0<parseInt(i.view_id)&&"allow"==i.allow_edit?Strack.open_dialog("dialog",{title:StrackLang.Modify_View_Title,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mview_id",type:"hidden",name:"view_id",valid:1,value:i.view_id}],items:[{case:1,id:"Mview_name",type:"text",lang:StrackLang.Name,name:"name",valid:"1,128",value:i.view_name},{case:2,id:"Mview_public",lang:StrackLang.Public,name:"public",valid:"1",value:""}],footer:[{obj:"submit_modify_view",type:5,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#Mview_public",{url:StrackPHP.getPublicType,valueField:"id",textField:"name",value:i.view_public})}}):layer.msg(StrackLang.View_Deny_Modify,{icon:2,time:1200,anim:6})},submit_modify_view:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",StrackPHP.modifyView,{back:function(e){Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),window.location.reload()}})},get_view_data:function(e){var t,a,i,d,r,o={};return"grid"===e.panel&&(r=$("#"+e.maindom).find(".datagrid-table").datagrid("options"),t=JSON.parse(r.queryParams.filter_data),e=r.sortData,o.sort={sort_query:t.filter.sort,sort_data:e},o.group=t.filter.group,a=[],1<r.frozenColumns.length?(i=[],r.frozenColumns[0].forEach(function(e){i.push({colspan:e.colspan,frozen_status:!0})}),r.columns[0].forEach(function(e){e.frozen_status=!1,"yes"===e.step&&(0<$("#stid_"+e.fname).find("i.icon-uniEA39").length?e.hidden_status="no":e.hidden_status="yes"),i.push(e)}),d=[],r.frozenColumns[1].forEach(function(e){e&&"id"!==e.field&&d.push({field:e.field,width:parseInt(e.width),frozen_status:!0})}),r.columns[1].forEach(function(e){var t;e&&"id"!==e.field&&(e.step?(t={field:e.field,title:e.title,align:"center",width:parseInt(e.width),findex:e.findex,hidden:e.hidden,drag:e.drag,step:!0,step_index:e.step_index,belong:e.belong,frozen_status:!1},0<=$.inArray(e.step_index,["first","last"])&&(t.bdc=e.bdc,t.cbd=e.cbd,t.cellClass=e.cellClass,t.deltaWidth=e.deltaWidth),d.push(t)):d.push({field:e.field,width:parseInt(e.width),frozen_status:!1}))}),a.push(i,d)):(r.frozenColumns[0].forEach(function(e){e&&"id"!==e.field&&a.push({field:e.field,width:parseInt(e.width),frozen_status:!0})}),r.columns[0].forEach(function(e){e&&"id"!==e.field&&a.push({field:e.field,width:parseInt(e.width),frozen_status:!1})})),o.fields=a,r=$("#"+r.filterConfig.id).find(".exist-filter-item .filter-tag-ac").attr("filter_id"),o.filter=0<r?{filter_id:r,sort:{sort_data:e,sort_query:t.filter.sort},group:t.filter.group,request:t.filter.request,filter_input:t.filter.filter_input,filter_panel:t.filter.filter_panel,filter_advance:t.filter.filter_advance}:{filter_id:0,sort:{sort_data:{},sort_query:{}},group:{},request:{},filter_input:{},filter_panel:{},filter_advance:{}}),o},toggle_view:function(e,t,a){$.ajax({type:"POST",url:StrackPHP.toggleView,dataType:"json",data:{view_id:e,project_id:a,page:t},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),window.location.reload()}})},delete_view:function(e){var t,a=Strack.select_view_param(e);switch($(e).attr("data-panel")){case"grid":t=$(e).closest(".grid-toolbar");break;case"list":t=$(e).closest(".list-toolbar")}var i=t.attr("data-page");"allow"===a.allow_edit?$.ajax({type:"POST",url:StrackPHP.deleteView,dataType:"json",data:{id:a.view_id,project_id:a.project_id,page:i},beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),window.location.reload()}}):layer.msg(StrackLang.View_Deny_Remove,{icon:2,time:1200,anim:6})},highlight_view_save:function(e){$(e).closest(".list-toolbar").find(".grid-view-bnt").addClass("dg-bnt-active")},del_highlight_view_save:function(e){$(e).closest(".list-toolbar").find(".grid-view-bnt").removeClass("dg-bnt-active")},dialog_error_icon:function(e){var t="";switch(e){case"e":t+='<i class="dialog-form-error form-tip icon-uniF00D"></i>';break;case"t":t+='<i class="dialog-form-ok form-tip icon-uniF00C"></i>'}return t},dropdown_reset:function(){var e,t,a,i;$(".stdown-filter").each(function(){e=$(this).data("dtype"),i=$(this).data("height"),0<$("#filter_proj_"+e).length&&(t=$(this).offset().top,a=$(this).offset().left,100<e&&$(window).height()<t+i+71?(i=t-i-41,$("#filter_proj_"+e).css({top:35+i,left:a-160})):$("#filter_proj_"+e).css({top:t+30,left:a-160}))})},loading_dom:function(e,t,a){var i="",d=(d=t)||"";switch(a=a?"_"+a:"",e){case"black":i='<div id="st-load'+a+'" class="ui active dimmer st-load"><div class="ui text loader">'+d+"</div></div>";break;case"white":i='<div id="st-load'+a+'" class="ui active inverted dimmer st-load"><div class="ui text loader">'+d+"</div></div>";break;case"null":i='<div id="st-load'+a+'" class="ui active inverted stnull dimmer st-load"><div class="ui text loader">'+d+"</div></div>"}return i},upper_first_str:function(e){return""==e||null==e||"string"!=typeof e?"":e.charAt(0).toUpperCase()},build_avatar:function(e,t,a){e="thumb-34-"+e;return t?'<img class="'+e+'" src="'+t+'" thumb-type="avatar" />':'<span class="'+e+'" thumb-type="avatar">'+a+"</span>"},ajax_grid_delete:function(e,t,a,i,d,r){var o=d||"",d=$("#"+e).datagrid("getSelections"),n=[];d.forEach(function(e){n.push(e[t])}),d.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):Strack.do_ajax_grid_delete(e,a,i,r,n,o)},ajax_treegrid_delete:function(e,t,a,i,d,r){var o=d||"",d=$("#"+e).treegrid("getSelections"),n=[];d.forEach(function(e){n.push(e[t])}),d.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):Strack.do_ajax_grid_delete(e,a,i,r,n,o,"treegrid")},do_ajax_grid_delete:function(t,e,a,i,d,r,o){$.messager.confirm(StrackLang.Confirmation_Box,e,function(e){e&&$.ajax({type:"POST",url:a,data:JSON.stringify({primary_ids:d.join(","),param:r}),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(i||Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),"treegrid"===o&&$("#"+t).treegrid("reload"),$("#"+t).datagrid("reload")):layer.msg(e.message,{icon:7,time:1200,anim:6})}})})},ajax_base_delete:function(t,e,a,i){$.messager.confirm(StrackLang.Confirmation_Box,e,function(e){e&&$.ajax({type:"POST",url:a,data:{primary_ids:t},dataType:"json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message}),i(e)):layer.msg(e.message,{icon:7,time:1200,anim:6})}})})},ajax_dialog_form:function(e,t,a,i,d){var r=Strack.submit_dialog_form(e),o="";if(r.error_num<0)if(0<t.length)switch(r.error_num){case-1:case-2:o=r.error_name+""+r.error_num,layer.msg(t[o],{icon:2,time:1200,anim:6});break;default:o="illegal",layer.msg(StrackLang.Illegal_Operation,{icon:2,time:1200,anim:6})}else layer.msg(r.error_message,{icon:2,time:1200,anim:6});else{d=d?d.extra(r):r;if(!a)return d;$.ajax({type:"POST",url:a,data:JSON.stringify(d),dataType:"json",contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),i&&i.back(e)}})}},submit_dialog_form:function(e){$(".form-tip").remove();var c,_={},m=["input","widget","json","textarea","tags","datalist"];return $(e).each(function(){if(c=$(this).attr("data-widget"),0<=$.inArray(c,m)){var e,t=$(this).attr("id"),a=$(this).data("valid"),i=$(this).data("name"),d=this.className,r=$(this).attr("type"),o=null;switch(c){case"input":case"text":case"textarea":o=$(this).val();break;case"json":o=Strack.get_json_editor_val(t);break;case"widget":var n=d.split(" ");switch(String(n[1])){case"combobox-f":o=0<(e=Strack.get_combos_val("#"+this.id,"combobox","getValues")).length?e.join(","):"";break;case"combotree-f":o=0<(e=Strack.get_combos_val("#"+this.id,"combotree","getValues")).length?e.join(","):"";break;case"datebox-f":o=(o=$("#"+this.id).datebox("getValue"))||"";break;case"switchbutton-f":o=Strack.get_switch_val("#"+this.id);break;default:o=$(this).val()}break;case"tags":var s=[];$("#st_dialog_form").find(".tag-items").each(function(){s.push($(this).data("id"))}),o=s.join(",")}if(a){var l=$(this).closest(".st-dialog-input").prev().html(),l=Strack.valid_form(a,o,l);if(!l.status)return Strack.get_valid_icon(this.id,-1,r),_.error_message=l.message,_.error_num=parseInt(l.error_num),_.error_name=i,!1;Strack.get_valid_icon(this.id,1,r),_[i]=o}else _[i]=o}}),_},get_valid_icon:function(e,t,a){if("hidden"!==a){var i=$("#"+e);switch(t){case 1:i.parent().append(Strack.dialog_error_icon("t"));break;case-1:i.parent().append(Strack.dialog_error_icon("e"));break;default:i.parent().append(Strack.dialog_error_icon("t"))}}},rule_grid_header_checkbox:function(e){var t,a,i=$(e).data("pos"),d=$(e).data("field"),r=$(e).find(".tree-checkbox"),o=$(".datagrid-row td[field = "+d+"]"),n=$("#rule_header_checkbox_"+d),s=0,l=0,c=0,_=0,m={};switch(i){case"header":r.hasClass("tree-checkbox1")||r.hasClass("tree-checkbox2")?(r.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"),o.each(function(){$(this).find(".tree-checkbox").removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0")})):(r.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"),o.each(function(){$(this).find(".tree-checkbox").removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1")}));break;case"parent":var u=$(e).data("code");r.hasClass("tree-checkbox1")||r.hasClass("tree-checkbox2")?(r.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"),o.each(function(){a=$(this).find(".dg-rule-checkbox"),(p=a.data("parent"))===u?($(this).find(".tree-checkbox").removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"),c++,s++,0<$(this).find(".tree-checkbox1").length&&(_++,l++)):p&&(s++,0<$(this).find(".tree-checkbox1").length&&l++),a.data("code")===u&&(t=a)})):(r.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"),o.each(function(){a=$(this).find(".dg-rule-checkbox"),(p=a.data("parent"))===u?($(this).find(".tree-checkbox").removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"),c++,s++,0<$(this).find(".tree-checkbox1").length&&(_++,l++)):p&&(s++,0<$(this).find(".tree-checkbox1").length&&l++),a.data("code")===u&&(t=a)})),(m={top_item_number:s,top_checked_number:l,top_checkbox:n,parent_items:[]}).parent_items[d]={parent_item_number:c,parent_checked_number:_,parent_checkbox:t},Strack.reset_rule_grid_data(m);break;case"single":var g,p=$(e).data("parent");r.hasClass("tree-checkbox1")||r.hasClass("tree-checkbox2")?r.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"):r.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"),o.each(function(){(a=$(this).find(".dg-rule-checkbox")).data("code")===p&&(t=a),(g=a.data("parent"))===p?(c++,s++,0<$(this).find(".tree-checkbox1").length&&(_++,l++)):g&&(s++,0<$(this).find(".tree-checkbox1").length&&l++)}),(m={top_item_number:s,top_checked_number:l,top_checkbox:n,parent_items:[]}).parent_items[d]={parent_item_number:c,parent_checked_number:_,parent_checkbox:t},Strack.reset_rule_grid_data(m)}},init_rule_grid_data:function(e){var t,a,i,d,r,o={view:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}},create:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}},clear:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}},modify:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}},delete:{top_item_number:0,top_checked_number:0,top_checkbox:null,parent_items:{}}};for(r in $("#rule_tab_field_function").find(".dg-rule-checkbox").each(function(){switch(t=$(this).attr("data-pos"),a=$(this).attr("data-field"),t){case"header":o[a].top_checkbox=$(this);break;case"parent":i=$(this).attr("data-code"),o[a].parent_items[i]={parent_item_number:0,parent_checked_number:0,parent_checkbox:$(this)};break;case"single":d=$(this).attr("data-parent"),i=$(this).attr("data-code"),o[a].top_item_number++,o[a].parent_items[d].parent_item_number++,$(this).find(".tree-checkbox").hasClass("tree-checkbox1")&&(o[a].top_checked_number++,o[a].parent_items[d].parent_checked_number++)}}),o)Strack.reset_rule_grid_data(o[r])},reset_rule_grid_data:function(e){var t,a=e.top_checkbox.find(".tree-checkbox");for(t in 0<e.top_checked_number?e.top_checked_number===e.top_item_number?a.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"):a.removeClass("tree-checkbox0").removeClass("tree-checkbox1").addClass("tree-checkbox2"):a.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0"),e.parent_items){var i,d=(i=e.parent_items[t]).parent_checkbox.find(".tree-checkbox");0<i.parent_checked_number?i.parent_checked_number===i.parent_item_number?d.removeClass("tree-checkbox0").removeClass("tree-checkbox2").addClass("tree-checkbox1"):d.removeClass("tree-checkbox0").removeClass("tree-checkbox1").addClass("tree-checkbox2"):d.removeClass("tree-checkbox1").removeClass("tree-checkbox2").addClass("tree-checkbox0")}},color_pick_widget:function(e,t,a,i,d){$(e).addClass("color-pick"),$(e).val(i),d&&$(e).attr("style","width:"+d+"px;border-color:#"+i),$(e).colpick({layout:t,submit:0,color:i,colorScheme:a,onChange:function(e,t,a,i,d){$(i).css("border-color","#"+t),d||$(i).val(t)}}).keyup(function(){$(this).colpickSetColor(this.value)})},build_dialog:function(e){$("body").append('<div id="'+e+'"></div>')},open_dialog:function(e,t){Strack.build_dialog(e),$("#"+e).dialog({title:t.title,width:t.width,height:t.height,top:t.top,closed:!1,cache:!1,modal:!0,content:t.content,onMove:function(e,t){Strack.dropdown_reset()},onOpen:function(){t.inits&&t.inits.call(this)},onClose:function(){$(this).dialog("destroy"),t.close&&t.close.call(this)}})},init_json_editor:function(e,t,a){var i=t||{},t=document.getElementById(e);Strack.G.jsonEditor[e]=new JSONEditor(t,i),a&&Strack.G.jsonEditor[e].set(a)},destroy_json_editor:function(e){Strack.G.jsonEditor[e]&&(Strack.G.jsonEditor[e].destroy(),delete Strack.G.jsonEditor[e])},get_json_editor_val:function(e){return Strack.G.jsonEditor[e]?Strack.G.jsonEditor[e].get():{}},get_combos_val:function(e,t,a){var i,d="";return t?(i=$(e)[t]("panel"),d=$(e)[t](a),i.children("div").hasClass("combobox-item-selected")||"combotree"===t?d||"":d=""):d},combobox_widget:function(e,t){t=t||{};$(e).combobox(t)},combotree_widget:function(e,t){t=t||{};$(e).combotree(t)},set_switch_val:function(e){return 1===parseInt(e)},init_open_switch:function(t,a){var e=t.height||26,e={checked:Strack.set_switch_val(t.value),width:t.width,height:e,onText:t.onText,offText:t.offText,onChange:function(e){e=e?1:0;$(t.dom).next().children("input").val(e),a&&a(e)}};t.disabled&&(e.disabled=t.disabled),$(t.dom).switchbutton(e),$(t.dom).next().prepend('<input type="hidden" name="switchbutton" value="'+t.value+'" >')},open_date_box:function(e,t,a,i){$(e).datebox({width:t,height:a,value:i,editable:!1})},open_datetime_box:function(e,t,a,i){$(e).datetimebox({width:t,height:a,value:i,editable:!1})},filter_date_box:function(e,t,a,i,d){$(e).datebox({width:t,height:a,value:i,editable:!1,onSelect:function(e){$(this).data("ptype"),$(this).data("filter");Strack.filter_auto(this)}})},get_switch_val:function(e){e=(e?$(e).next().children("input"):$(".switchbutton input[name=switchbutton]")).val();return"undefined"!==e?parseInt(e):0},panel_height:function(e,t){return $(e).height()-t},auto_resize_datagrid:function(e,t,a,i,d){d?$(t).on("mresize",function(){Strack.do_resize_datagrid(e,t,a,i)}):$(window).resize(function(){Strack.do_resize_datagrid(e,t,a,i)})},do_resize_datagrid:function(e,t,a,i){var d;$(t).is(":hidden")?(d=$(t).show().offset(),Strack.resize_datagrid_active(e,d,a,i),$(t).removeAttr("style")):(d=$(t).offset(),Strack.resize_datagrid_active(e,d,a,i),Strack.dropdown_reset())},resize_datagrid_active:function(e,t,a,i){var d=0<(d=$(e).closest(".entity-datalist").next(".datagrid-filter").width())?d:0,r=$(".grid-right-wrap"),o=0;r.is(":hidden")||(o=0<(o=r.width())?o+1:0);var n=$.data(e,"datagrid"),s=n.options,l=n.dc,c=n.panel,_=window.innerWidth-t.left-2-d-o,m=window.innerHeight-t.top-2-i,u=l.view,r=l.view1,e=l.view2,n=r.children("div.datagrid-header"),d=e.children("div.datagrid-header"),o=n.find("table"),t=d.find("table");c.css({width:_,height:m}),u.width(_);i=n.children("div.datagrid-header-inner").show();r.width(i.find("table").width()),s.showHeader||i.hide(),e.width(_-r._outerWidth()),r.children()._outerWidth(r.width()),e.children()._outerWidth(e.width());_=n.add(d).add(o).add(t);_.css("height","");n=0,n=s.HeaderHeight||Math.max(o.height(),t.height());_._outerHeight(n);var l=l.body2.children("table.datagrid-btable-frozen")._outerHeight(),g=l+d._outerHeight()+e.children(".datagrid-footer")._outerHeight();c.children(":not(.datagrid-view,.datagrid-mask,.datagrid-mask-msg)").each(function(){g+=$(this)._outerHeight()});c.outerHeight(),c.height();r.add(e).children("div.datagrid-body").css({marginTop:l,height:isNaN(parseInt(m))?"":m-g}),u.height(e.height()),e.find(".datagrid-body").css("overflow","auto")},fit_columns:function(e,t){return $(e).width()>t},get_datagrid_select_data:function(e,t){var e=$(e).datagrid("getSelections"),a=[];e.forEach(function(e){a.push(e.id)}),e.length<1?layer.msg(StrackLang.Please_Select_One,{icon:2,time:1200,anim:6}):t(a)},save_dialog_setting:function(){var t=$("#Ntype").val(),e=$("#Npage").val(),a=[];$(".dg-report-de").each(function(){a.push($(this).attr("data-field"))}),$.ajax({type:"POST",url:StrackPHP.saveDialogSetting,dataType:"json",contentType:"application/json",data:JSON.stringify({fields:a,keep_status:Strack.G.dialogKeepBntStatus,type:t,page:e}),beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){Strack.G.DialogAddSetting[t]=e,$.messager.progress("close"),Strack.top_message({bg:"g",msg:StrackLang.Dialog_Setting_Save_SC})}})},main_fields_config:function(e){var t=$(e).data("type"),a=$(e).data("pos"),i=$(e).closest(".menu"),d=i.attr("data-page"),r=i.attr("data-projectid"),o=i.attr("data-moduleid"),n=i.attr("data-modulecode"),s=i.attr("data-templateid");switch(t){case"important":Strack.set_info_main_show_mode({category:"fields_show_mode",module_code:n,template_id:0,config:{mode:"important"},pos:a}),Strack.update_info_main_show_mode_dom(e,"important");break;case"all":Strack.set_info_main_show_mode({category:"fields_show_mode",module_code:n,template_id:0,config:{mode:"all"},pos:a}),Strack.update_info_main_show_mode_dom(e,"all");break;case"setting":Strack.template_set_dialog({datalist_url:StrackPHP.getDetailsModuleColumns,config_url:StrackPHP.getTemplateUserConfig,title:StrackLang.Template_Details_Main_Field,temp_id:s,module_code:n,module_id:o,project_id:r,category:"main_field",type:"main_field",page:d,id_field:"field_group_id",text_field:"lang",text_field_lang:StrackLang.Column,group:"belong_table",limit:0,submit_bnt:"update_details_top_fields_set",pos:a})}},update_info_main_show_mode_dom:function(e,t){$(e).closest(".st-dropdown").find(".info-down-title").text($(e).text())},set_info_main_show_mode_dom:function(e,t){var a="",a="important"===t?StrackLang.Important_Info:StrackLang.All_Info;$("#"+e).find(".info-down-title").text(a),$("#"+e).find(".menu .item").each(function(){$(this).hasClass(t)?$(this).addClass("active"):$(this).removeClass("active")})},set_info_main_show_mode:function(t){$.ajax({type:"POST",url:StrackPHP.modifyUserTemplateConfig,data:JSON.stringify(t),dataType:"json",contentType:"application/json",beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){$("#st-load_config").remove(),Strack.top_message({bg:"g",msg:e.message}),$.isEmptyObject(Strack.G.topfieldsRequestParam)&&$.isEmptyObject(Strack.G.sliderTopfieldsRequestParam)||("slider"===t.pos?0<=$.inArray(t.category,["main_field","fields_show_mode"])?Strack.load_info_panel(Strack.G.sliderMainfieldsRequestParam):Strack.load_info_panel(Strack.G.sliderTopfieldsRequestParam):0<=$.inArray(t.category,["main_field","fields_show_mode"])?Strack.load_info_panel(Strack.G.mainfieldsRequestParam):Strack.load_info_panel(Strack.G.topfieldsRequestParam)),Strack.dialog_cancel()}})},top_fields_config:function(e){var t=$(e).attr("data-page"),a=$(e).attr("data-pos"),i=$(e).attr("data-projectid"),d=$(e).attr("data-moduleid"),r=$(e).attr("data-modulecode"),e=$(e).attr("data-templateid");Strack.template_set_dialog({datalist_url:StrackPHP.getDetailsModuleColumns,config_url:StrackPHP.getTemplateUserConfig,title:StrackLang.Template_Details_Top_Field,temp_id:e,module_code:r,module_id:d,project_id:i,category:"top_field",type:"top_field",page:t,id_field:"field_group_id",text_field:"lang",text_field_lang:StrackLang.Column,group:"belong_table",limit:3,submit_bnt:"update_details_top_fields_set",pos:a})},template_set_dialog:function(d){var e=d.item_id||0;Strack.open_dialog("dialog",{title:d.title,width:800,height:520,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mtemp_id",type:"hidden",name:"temp_id",valid:1,value:d.temp_id},{case:101,id:"Mid_field",type:"hidden",name:"id_field",valid:1,value:d.id_field},{case:101,id:"Mmodule_code",type:"hidden",name:"module_code",valid:1,value:d.module_code},{case:101,id:"Mcategory",type:"hidden",name:"category",valid:1,value:d.category},{case:101,id:"Mtype",type:"hidden",name:"type",valid:1,value:d.type},{case:101,id:"Mpage",type:"hidden",name:"page",valid:1,value:d.page},{case:101,id:"Mpos",type:"hidden",name:"pos",valid:1,value:d.pos}],items:[{case:5,id:"",type:"text",lang:"",name:"",valid:"",value:0}],footer:[{obj:d.submit_bnt,type:5,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var i;$("#template-field").datalist({url:d.datalist_url,width:320,height:380,idField:d.id_field,valueField:d.id_field,textField:d.text_field,groupField:d.group,checkbox:!0,singleSelect:!1,queryParams:{item_id:e,module_code:d.module_code,category:d.category,module_id:d.module_id,project_id:d.project_id,template_id:d.temp_id},onLoadSuccess:function(e){var a=$(this);$.ajax({type:"POST",url:d.config_url,dataType:"json",data:{template_id:d.temp_id,module_code:d.module_code,category:d.category},beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){var t=[{field:d.id_field,checkbox:!0},{field:d.text_field,title:d.text_field_lang,align:"center",width:160}];d.group&&t.push({field:d.group,title:StrackLang.Group,align:"center",width:160}),$("#template-columns").datagrid({data:[],width:380,height:380,rownumbers:!0,fitColumns:!0,columns:[t],dragSelection:!0,onLoadSuccess:function(){(i=$(this)).datagrid("enableDnd")}}),e.forEach(function(e){a.datalist("selectRecord",e[d.id_field])}),$("#st-load_config").remove()}})},onSelect:function(e,t){var a=$("#template-columns");a.datagrid("appendRow",t),i.datagrid("enableDnd"),0<d.limit&&a.datagrid("getRows").length>d.limit&&$(this).datagrid("unselectRow",e)},onUnselect:function(e,t){var a=$("#template-columns"),t=a.datagrid("getRowIndex",t);a.datagrid("deleteRow",t)}})}})},get_home_template_config:function(){var e=$("#Mtemp_id").val(),t=$("#Mmodule_code").val(),a=$("#Mcategory").val(),i=$("#Mpos").val(),d=$("#Mid_field").val(),r=$("#template-columns").datagrid("getRows"),o=[];return r.forEach(function(e){switch(a){case"top_field":case"main_field":case"tab":case"step":case"step_fields":o.push(e);break;default:var t={};t[d]=e[d],o.push(t)}}),{template_id:e,module_code:t,category:a,config:o,pos:i}},update_details_top_fields_set:function(){var t=Strack.get_home_template_config();$.ajax({type:"POST",url:StrackPHP.modifyUserTemplateConfig,data:JSON.stringify(t),dataType:"json",contentType:"application/json",beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){$("#st-load_config").remove(),Strack.top_message({bg:"g",msg:e.message}),$.isEmptyObject(Strack.G.topfieldsRequestParam)&&$.isEmptyObject(Strack.G.sliderTopfieldsRequestParam)||("slider"===t.pos?"main_field"===t.category?Strack.load_info_panel(Strack.G.sliderMainfieldsRequestParam):Strack.load_info_panel(Strack.G.sliderTopfieldsRequestParam):"main_field"===t.category?Strack.load_info_panel(Strack.G.mainfieldsRequestParam):Strack.load_info_panel(Strack.G.topfieldsRequestParam)),Strack.dialog_cancel()}})},update_details_tab_set:function(){var t=Strack.get_home_template_config();$.ajax({type:"POST",url:StrackPHP.modifyTemplateConfig,data:JSON.stringify(t),dataType:"json",contentType:"application/json",beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){$("#st-load_config").remove(),Strack.top_message({bg:"g",msg:e.message}),("slider"===t.pos?Strack:obj).refresh_details_tab(t.config),Strack.dialog_cancel()}})},refresh_details_tab:function(e){var t=$("#grid_slider_tab .tab_item.active").attr("data-tabid"),a={};e.forEach(function(e){a=a||e,e.tab_id===t&&(a=e)}),Strack.generate_tab_list("grid_slider_tab",Strack.G.gridSliderParam,e),Strack.show_datagrid_slider_tab(a)},upload_image:function(e,t,d,r){var a=["gif","jpeg","jpg","bmp","png"],i=[StrackLang.Image_Format_Limit,StrackLang.Browser_Support];document.getElementById(e).onchange=function(){var e;if(this.value)return RegExp(".("+a.join("|")+")$","i").test(this.value.toLowerCase())?-1<navigator.userAgent.indexOf("MSIE")?(Strack.top_message({bg:"r",msg:i[1]}),this.value="",!1):($("#"+t).val(this.value),void(this.files[0]&&((e=new FileReader).addEventListener("load",function(e){var e=e.target.result,i=new Image;i.addEventListener("load",function(){var e=0<parseInt(r)?r:280,t=i.width*(e/i.height);$("#"+d).empty().append('<canvas id="img_cas" width="'+t+'" height="'+e+'"></canvas>');var a=document.getElementById("img_cas");a.getContext("2d").drawImage(i,0,0,t,e),Strack.G.Jcrop_Canvas=a},!1),i.src=e},!1),e.readAsDataURL(this.files[0])))):(Strack.top_message({bg:"r",msg:i[0]}),this.value="",!1)}},top_message:function(e){var t;switch(String(e.bg)){case"r":t="error";break;case"g":t="success";break;case"w":t="warn";break;default:t="success"}layer.msg(e.msg,{offset:"10px",skin:"a-bounceinT layui-layer-bmsg layui-layer-"+t,time:3e3})},upload_preview:function(e){var m=this,u=null,g=null,p="",f="";m.IsNull=function(e){return"function"!=typeof e&&(null==e||""==e||0==e.length)},m.DefautlSetting={UpBtn:"",Canvas:"",Cancel:[""],Jcrop:"",Showpanel:!1,Width:100,Height:100,MinLimit:50,ImgType:["gif","jpeg","jpg","bmp","png"],ErrMsg:[StrackLang.Image_Format_Limit,StrackLang.Browser_Support],callback:function(){}},m.Setting={UpBtn:(m.IsNull(e.UpBtn)?m.DefautlSetting:e).UpBtn,Canvas:(m.IsNull(e.Canvas)?m.DefautlSetting:e).Canvas,Cancel:(m.IsNull(e.Cancel)?m.DefautlSetting:e).Cancel,Jcrop:(m.IsNull(e.Jcrop)?m.DefautlSetting:e).Jcrop,Showpanel:(m.IsNull(e.Showpanel)?m.DefautlSetting:e).Showpanel,Width:(m.IsNull(e.Width)?m.DefautlSetting:e).Width,Height:(m.IsNull(e.Height)?m.DefautlSetting:e).Height,MinLimit:(m.IsNull(e.MinLimit)?m.DefautlSetting:e).MinLimit,ImgType:(m.IsNull(e.ImgType)?m.DefautlSetting:e).ImgType,ErrMsg:(m.IsNull(e.ErrMsg)?m.DefautlSetting:e).ErrMsg,callback:(m.IsNull(e.callback)?m.DefautlSetting:e).callback},m.drawImg=function(e,_){var t;e&&((t=new FileReader).addEventListener("load",function(e){var e=e.target.result,c=new Image;c.addEventListener("load",function(){var e=c.width,t=c.height,a=m.Setting.Width,i=m.Setting.Height,d=m.Setting.MinLimit,r=e/t,o=a/d<=r?d*r:r<=d/i?d<e?e:d:a<=e?a:t<=i?i*r:e,n=o/r,s=(a-o)/2,l=-(n-i)/2,t=a<o?a:o,e=i<n?i:n,r=-(e-i)/2,i=(a-t)/2;$(".crop-avatar-img").html('<canvas id="'+_+'" height="'+e+'px" width="'+t+'px" style="position: absolute;top:'+r+"px;left:"+i+'px">'),g=document.getElementById(_);a=(Strack.G.Jcrop_Canvas=g).getContext("2d");a.globalCompositeOperation="copy",""!=m.Setting.Jcrop&&(null!=u&&""!=u&&$(".jcrop-holder").remove(),$("#"+_).parent().after('<div id="'+m.Setting.Jcrop+'"></div>'),$("#"+m.Setting.Jcrop).css({width:t+"px",height:e+"px",top:r+"px",left:i+"px"}),$("#"+m.Setting.Jcrop).Jcrop({minSize:[d,d],onChange:function(e){var t=(Strack.G.Jcrop_Thumb=e).x,a=e.y,e=d/e.w;$(".avatar-view-sm1>img").css({"margin-top":"-"+a*e+"px","margin-left":"-"+t*e+"px",width:o*e+"px"}),$(".avatar-view-sm2>img").css({"margin-top":"-"+2*a/3*e+"px","margin-left":"-"+2*t/3*e+"px",width:2*o/3*e+"px"}),$(".avatar-view-sm3>img").css({"margin-top":"-"+a/3*e+"px","margin-left":"-"+t/3*e+"px",width:o/3*e+"px"})},aspectRatio:1},function(){this.getBounds(),(u=this).animateTo([0,0,d,d])}));r=0,i=0;t<o&&(r=s),p=o,f=n,a.drawImage(c,r,i=e<n?l:i,o,n),""!=m.Setting.Jcrop&&(n=g.toDataURL("image/png"),$(".avatar-view-sm1").html('<img  src="'+n+'" />'),$(".avatar-view-sm2").html('<img  src="'+n+'" />'),$(".avatar-view-sm3").html('<img  src="'+n+'" />'),$(".avatar-view-sm2>img").css({width:2*o/3+"px"}),$(".avatar-view-sm3>img").css({width:o/3+"px"}))},!1),c.src=e},!1),t.readAsDataURL(e))},m.Cancel=function(){g&&(g.getContext("2d").clearRect(0,0,p,f),null!=u&&""!=u&&($(".jcrop-holder").remove(),$(".avatar-view-sm1,.avatar-view-sm2,.avatar-view-sm3").empty(),Strack.G.Jcrop_Thumb=""),g=null,Strack.G.Jcrop_Canvas=g)},m.Bind=function(){if(document.getElementById(m.Setting.UpBtn).onchange=function(){if(this.value){var e=this.value.toLowerCase();if(!RegExp(".("+m.Setting.ImgType.join("|")+")$","i").test(e))return Strack.top_message({bg:"r",msg:m.Setting.ErrMsg[0]}),this.value="",!1;if(-1<navigator.userAgent.indexOf("MSIE"))return Strack.top_message({bg:"r",msg:m.Setting.ErrMsg[1]}),this.value="",!1;e=e.split(".");Strack.G.Jcrop_Thumb_Ext=e[e.length-1],Strack.G.Jcrop_Thumb_Mime=this.files[0].type,m.drawImg(this.files[0],m.Setting.Canvas),m.Setting.callback()}},m.Setting.Cancel){for(var e="",t=$(".crop-avatar-wrap"),a=0;a<m.Setting.Cancel.length;a++)e+=m.Setting.Cancel[a]+",";e=e.substring(0,e.length-1),m.Setting.Showpanel?(t.show(),$(e).click(function(){m.Cancel()})):$(e).click(function(){t.slideToggle(function(){m.Cancel()})})}},m.Bind()},global_loading:function(){return'<div class="global-loading-wrap"><div class="global-masked"><i class="icon-strack_logo"></i></div></div>'},cancel_global_loading:function(){setTimeout(function(){$(".global-masked").hide(),$(".global-loading-wrap").addClass("a-fadeout"),setTimeout(function(){$(".global-loading-wrap").remove()},1e3)},500)},init_dropdown:function(e){$(e||".ui.menu , .ui.dropdown").dropdown({on:"hover",onHide:function(e){return!Strack.G.isClickDropdown.status||Strack.G.isClickDropdown.target.html()!==$(this).html()||(Strack.G.isClickDropdown.target=$(this),Strack.G.isClickDropdown.status=!1)}})},close_notice_message:function(){$(".globel-top-notice").remove(),$("body").removeClass("has-top-notice-body")},click_admin_menu:function(e){Strack.save_storage("admin_menu_top",$(".admin-page-left").scrollTop())},on_before_unload_notice:function(){return"The current page is not saved! Is it overloaded?"},build_top_menu:function(){$.ajax({type:"POST",url:StrackPHP.getTopMenuData,dataType:"json",data:{menu_name:Strack.G.MenuName,module_id:Strack.G.ModuleId,module_type:Strack.G.ModuleType,project_id:Strack.G.ProjectId},success:function(e){Strack.TopMenuData=e.menu_data,Strack.generate_top_menu(e.menu_data),0<=$.inArray(Strack.G.MenuName,["project_inside","project_detail"])&&($(".nav-breadcrumb-name").attr("title",e.project_data.current_project.name),$(".nav-breadcrumb-text").html(e.project_data.current_project.name),Strack.top_menu_project_item_dom(e.project_data),$(".nav-project-head").show()),Strack.top_menu_on_resize()}})},generate_top_menu:function(e){var t=$("#nav_main_bar").width(),a=$("#nav_main_list"),i=$("#nav_hide_list"),d=$(".nav-main-bar-hide");d.hide().removeClass("nav_main_active"),a.empty(),i.empty();var r,o=46,n="",s=!0,l=!1;e.forEach(function(e){t<o?(l=!0,s&&($("#"+n).remove(),"yes"===r.active&&d.addClass("nav_main_active"),i.append(Strack.top_menu_hide_dom(r)),s=!1),i.append(Strack.top_menu_hide_dom(e))):a.append(Strack.top_menu_main_dom(e)),n="top_m_"+(r=e).code,o+=$("#top_m_"+e.code).width()+2}),l?d.show():$(".nav-main-bar-show").css("margin-left",(t-o)/2)},refresh_top_menu:function(e){Strack.TopMenuData=e,Strack.generate_top_menu(e)},top_menu_on_resize:function(){$(".header-main").on("mresize",function(){Strack.generate_top_menu(Strack.TopMenuData)})},top_menu_project_item_dom:function(t){var a="",i=Strack.remove_html_ext(StrackPHP.Project_Url)+"/"+t.project_last_url;t.active_project_list.forEach(function(e){a+='<a href="'+i+e.project_id+'.html" class="item" data-value="'+t.current_project.name+'"><span class="project-menu-name text-ellipsis">'+e.name+"</span></a>"}),$("#to_menu_project_list").empty().append(a)},top_menu_main_dom:function(e){var t="",a="yes"===e.active?"nav_main_active":"";return t+='<li id="top_m_'+e.code+'" class="nav-main-items '+a+'">',"#"!==e.url?t+='<a href="'+e.url+'">'+e.name+"</a>":t+='<a href="'+e.url+'" >'+e.name+"</a>",t+="</li>"},top_menu_hide_dom:function(e){var t="",a="yes"===e.active?"active":"";return"yes"===e.active&&$(".nav-main-bar-hide").addClass("nav_main_active"),t+='<a href="'+e.url+'" class="item '+a+'" data-text="'+e.name+'">'+e.name+"</a>"},body_click_event:function(){$(document).mouseup(function(e){var t=$(".widget_input");(!t.is(e.target)&&0===t.has(e.target).length&&0===$(e.target).closest(".combo-p").length||!$(e.target).hasClass("widget-show")&&0===$(e.target).closest(".widget-show").length&&0===$(e.target).closest(".combo-p").length)&&Strack.widget_update(),0<$(e.target).closest(".st-down-menu").length||0<$(e.target).closest(".dropdown").length||0<$(e.target).closest(".combo-p").length?(Strack.G.isClickDropdown.status=!0,Strack.G.isClickDropdown.target=$(e.target).closest(".dropdown")):(Strack.G.isClickDropdown.status=!1,Strack.G.isClickDropdown.target=$(e.target).closest(".dropdown"),$(".ui.menu , .ui.dropdown").dropdown("hide"));t=$("#project_top_name");t.is(e.target)||0!==t.has(e.target).length||t.is(":visible")&&obj.modify_project_name(t);t=$(".filter-task-list");t.is(e.target)||0!==t.has(e.target).length||t.slideUp(100);t=$(".layui-layer-content");!t.is(e.target)&&0===t.has(e.target).length&&0<$(".layui-layer-tips").length&&layer.tips("close");t=$(".datagrid-btable");t.is(e.target)||0!==t.has(e.target).length||0!=$(e.target).closest(".combo-p").length||0<(t=$(".datagrid-editable")).length&&(a=parseInt(t.closest(".datagrid-row").attr("datagrid-row-index")),t.closest(".datagrid-view").find(".datagrid-f").datagrid("endEdit",a));var a=$(".task-repeat-editor");a.is(e.target)||0!=$(e.target).closest(".task-repeat-editor").length||0!=$(e.target).closest(".combo-p").length||(a.hide(),a=a.data("id"),$("#"+a).removeClass("loaded")),$(e.target).hasClass("st-grid-mask")&&!Strack.G.onSideHandleResize&&Strack.close_datagrid_slider("")})},G:{userId:0,Default_Mail:"@strack.com",Jcrop_Thumb:"",Jcrop_Thumb_Ext:"",Jcrop_Thumb_Mime:"image/png",Note_Uploadifive_Imgs:[],Note_Delete_Img_Ids:[],Note_Has_Img_Length:0,Jcrop_Canvas:"",Media_Server:{},cnotedom:"",topMenuActive:!1,Geditor:{},GeditorParam:{},MDeditor:null,Gfilter_data:{},Group_data:{},Gfilter_list:{},GanttFilter:{},MediaFilter:{},WebplayerPage:!1,GacPlaylist:[],Gmindex:0,GridPage:{},KankanItem:{},FilterAutoCheck:!1,FilterProjFirst:0,FilterStepsFirst:0,FilterData:{},FilterProj:"",FilterEntity:"",FilterTopJob:{},FilterTopMsg:{},InputExCkfields:{},CustomEditIndex:[],MenuName:"",ProjectId:0,ModuleId:0,ModuleType:0,AccMenu:"",TlStart:0,TllogTerval:{},SumFilters:null,IsNewfileds:!1,Gplaylistid:0,GridStepsHidelist:[],FrameRates:{film:24,NTSC:29.97,NTSC_Film:23.98,NTSC_HD:59.94,PAL:25,PAL_HD:50,web:30,high:60},Timesheet:"now",TimesheetOld:"",FilterWidget:[],CurrentView:{},ViewsetData:{},DialogAddSetting:{},ImgViewzoom:1,ImgZoomSpeed:.1,ImgZoomX:0,ImgZoomY:0,Project_Menu:[],comboxItemType:0,comboxItemDom:"",comboxStepDom:"",groupview:null,gridFieldCache:{},leftScrolling:0,TopMenuData:[],jsonEditor:{},entityStepTaskAddData:{status:!1,data:{}},importExcelStep:null,importExcelData:{},mediaScreenshotStatus:!1,gridFirstColMap:{},gridSliderActiveTab:{},gridSliderParam:{},gridSliderGridParam:{},mediaViewPlayIndex:0,closeNoteObj:null,horizontalRelationIds:{add:[],delete:[]},UnReadMessageData:null,topfieldsRequestParam:{},sliderTopfieldsRequestParam:{},mainfieldsRequestParam:{},sliderMainfieldsRequestParam:{},sideTimelogParam:{},dataGridStepColunmsConfig:{},onSideHandleResize:!1,isClickDropdown:{status:!1,target:""},infoMediaNeedInit:[],gridMediaNeedInit:[],batchUploadMediaType:"",pageHiddenParam:{},calendarEventsFilter:{department_members:"",project:"",task_type:"",end_time:{type:"fixed",value:null},user_receive:"",user_sent:""},calendarLoadMode:"",calendarLockDateList:[],calendarTaskRemainderLime:{},dialogDomList:{},dialogItemMustFields:[],dialogItemFieldsConfig:{},dialogKeepBntStatus:{continue_next:"no",keep_data:"no"},tempStartTimelogids:{ids:[],status:{}},myScheduleSideParam:{},myScheduleDeleteTaskData:{},repeatTaskConfigData:{},addCustomFieldExpressionDataMap:{},addCustomFieldExpressionData:{fill_status:0,param:{},formula_fields:{},formula:""}},Websocket:{List:{},heartbeatList:{},init:function(t,a){var i,d,e;window.WebSocket?Strack.Websocket.List[t]?a.afterInit&&a.afterInit({status:"exist"}):(e="",e=0<$(".st-bg-black").length?"black":"white",$(".pushable").prepend(Strack.loading_dom(e,StrackLang.Starting_Action,"run_action")),"centrifuge"===a.ws_type?((i=new Centrifuge(a.data.websocket_url)).setToken(a.data.token),e={publish:function(e){a.onMessage&&(console.log(e),a.onMessage(e.data))},join:function(e){console.log(e.data)},leave:function(e){console.log(e),a.onClose&&a.onClose(e.data)},subscribe:function(e){console.log(e),Strack.Websocket.List[t]=i,a.afterInit&&($("#st-load_run_action").remove(),a.afterInit({status:"new",data:e}))},error:function(e){Strack.Websocket.close(t),a.afterInit&&($("#st-load_run_action").remove(),a.afterInit({status:"error",data:e,message:"Connection error."}))},unsubscribe:function(e){console.log(e),a.onClose&&a.onClose(e)}},i.subscribe(a.data.channel,e),i.connect()):((d=new WebSocket(a.url)).onopen=function(e){Strack.Websocket.List[t]=d,Strack.Websocket.heartbeat(t),a.afterInit&&($("#st-load_run_action").remove(),a.afterInit({status:"new",data:e}))},d.onclose=function(e){a.onClose&&a.onClose(e.data)},d.onmessage=function(e){a.onMessage&&a.onMessage(e.data)},d.onerror=function(e){Strack.Websocket.close(t),a.afterInit&&($("#st-load_run_action").remove(),a.afterInit({status:"error",data:e,message:"Connection error."}))})):a.afterInit&&a.afterInit({status:"error",message:"No support for webSocket."})},bind:function(e,t){Strack.Websocket.List[e].send(JSON.stringify({method:"bind",data:t}))},heartbeat:function(e){Strack.Websocket.List[e]&&(Strack.Websocket.heartbeatList[e]=window.setInterval(function(){Strack.Websocket.List[e].send(JSON.stringify({method:"heartbeat"}))},3e4))},send:function(e,t){Strack.Websocket.List[e].send(JSON.stringify(t))},close:function(e){var t={},a={};if(Strack.Websocket.List[e]){for(var i in Strack.Websocket.List[e].send("close"),Strack.Websocket.List[e].close(),Strack.Websocket.List)e!==i&&(t[i]=Strack.Websocket.List[i]);for(var d in Strack.Websocket.List=t,clearInterval(Strack.heartbeatList.List[e]),Strack.heartbeatList.List)e!==d&&(a[d]=Strack.heartbeatList.List[d]);Strack.heartbeatList.List=a}}},Notify:{obj:null,init:function(){Strack.Notify.obj=new Notify({effect:"flash",interval:1e3,notification:{title:"Notification",icon:StrackPHP.IMG+"/strack_notice.ico",body:"You have a new message!",openurl:""}})},show:function(e,t,a){Strack.Notify.obj.notify({title:e,body:t,openurl:a})}},update:{init:function(){$.ajax({type:"POST",url:StrackPHP.getLogServerConfig,dataType:"json",success:function(e){"yes"===e.active&&e.websocket_url&&Strack.Websocket.init("update",{ws_type:"centrifuge",data:e,afterInit:function(e){"error"===e.status&&console.log("ws error:"+e.message)},onMessage:function(e){switch(e.type){case"connect":Strack.Websocket.bind("update",Strack.get_page_uuid());break;case"message":Strack.update.message(e)}}})}})},refresh:function(){},message:function(n){var e="",t="";if(n.belong_system===StrackPHP.Belong_System){if(0<=$.inArray(Strack.G.userId,n.member)){switch(Strack.G.UnReadMessageData.created=n.created,Strack.G.UnReadMessageData.massage_number=Strack.G.UnReadMessageData.massage_number+1,Strack.top_tool_number("#top_msg_number",Strack.G.UnReadMessageData.massage_number),n.message.operate){case"update":e+=StrackLang.Modify+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Modify+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"add":e+=StrackLang.Create+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Create+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"delete":e+=StrackLang.Delete+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Delete+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"apply":e+=StrackLang.Application_For_Settlement+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Application_For_Settlement+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"reject":e+=StrackLang.Reject_For_Settlement+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Reject_For_Settlement+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"confirm":e+=StrackLang.Confirmation_For_Settlement+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Confirmation_For_Settlement+" "+n.message.title.module_name+" "+n.message.title.item_name;break;case"reminder":e+=StrackLang.Reminder+"-"+n.module_data.name,t+=n.message.title.created_by+" "+StrackLang.Reminder+" "+n.message.title.module_name+" "+n.message.title.item_name}var a="";n.message.title.url?a=n.message.title.url:n.message.position&&n.message.position.url&&(a=n.message.position.url),Strack.Notify.show(e,t,a)}switch(n.status=200,console.log(n),n.from_type){case"thumb":Strack.update.thumbnail(n);break;case"note":Strack.update.note(n);break;case"widget_common":Strack.update.widget(n,n.param.widget_param);break;case"widget_grid":switch(n.message.operate){case"add":"my_scheduler"!==n.param.page&&"plan"!==n.module_data.code||0<=$.inArray(Strack.G.userId,n.member)&&Strack.reload_fullCalendar_data("scheduler_my_index");break;case"update":"plan"===n.module_data.code&&0<=$.inArray(Strack.G.userId,n.member)&&Strack.reload_fullCalendar_data("scheduler_my_index")}break;case"timelog_bnt_schedule":case"timelog_bnt_slider":case"timelog_bnt_kanban":$.each($(".time_log_bnt_"+n.data.link_id),function(e,t){var a=$(t).attr("data-id"),i=$(t).attr("data-linkid"),d=$(t).attr("data-timelogid"),r=$(t).attr("data-moduleid"),o=$(t).attr("data-from");Strack.item_timelog_bnt_refresh(t,"update",{id:a,link_id:i,timelog_id:d,module_id:r,from:o,data:n.data})});break;case"base_confirmation":var i="";switch(n.data.operation){case"apply":i=".settlement_bnt_af_"+n.data.link_id;break;case"reject":i=".settlement_bnt_jj_"+n.data.link_id;break;case"confirm":i=".settlement_bnt_cf_"+n.data.link_id}$.each($(i),function(e,t){Strack.refrash_confirmation_bnt_show(t,n.data.operation),Strack.reset_my_schedule(t)})}}},widget:function(e,t){var a,i,d,r,o="",n=e.param,s=e.data;"media"!==t.editor&&(r=(a=$("."+t.dom)).find(".widget-edit"),i=a.find(".info-content-show"),r.attr("data-value",n.val),s.value_show&&s.value_show.hasOwnProperty("rows")?(d=[],0<s.value_show.total&&s.hasOwnProperty("custom_config")&&"belong_to"===s.custom_config.field_type?"status"===s.custom_config.relation_module_code?(o=Strack.hex_to_rgb(s.value_show.rows[0].color,.3),a.css("background-color",o),i.html(Strack.widget_status_dom(s.value_show.rows[0].icon,s.value_show.rows[0].name,s.value_show.rows[0].color))):(s.value_show.rows.forEach(function(e){d.push(e.name)}),i.html(d.join(","))):(s.value_show.rows.forEach(function(e){d.push(e.name)}),i.html(d.join(",")))):(r=s.value_show,"timespinner"===n.editor&&(r=Strack.format_timespinner_val(s.value_show)),i.html(r)),Strack.update.excessive_color(e.status,a,o));var l,c=$("td[id="+t.dom+"]");0<c.length&&c.hasClass("is-grid-td")&&(Strack.update.excessive_color(e.status,c,o),"media"===t.editor?"yes"===(e=e.data).has_media&&(l="origin",e.param.size.forEach(function(e){"origin"!==e&&e.split("x")[0]<99999&&(l=e)}),e=e.param.base_url+"/"+e.param.md5_name+"_"+l+"."+e.param.ext,t.dom.find(".athumb").empty().append('<img src="'+e+'">')):setTimeout(function(){var e=c.attr("data-grid"),t=c.attr("field"),a=$("#"+e),i=c.closest(".datagrid-row").attr("datagrid-row-index"),e=a.datagrid("getRow",i);e[t]=s.value_show,a.datagrid("updateRow",{index:i,row:e})},600))},note:function(e){var t=$("."+e.param.list_class+"_"+e.data.link_id);switch(e.operate){case"add":("yes"===e.data.stick?t.find(".note-stick"):t.find(".note-no-stick")).prepend(Strack.notes_single_item_dom(e.data,"add")),Strack.init_note_att_event(".comment_note_"+e.data.id);break;case"update":var a=$(".comment_note_"+e.data.id),i=Strack.notes_single_item_dom(e.data,"modify");a.attr("stick")!==e.data.stick?(a.remove(),("yes"===e.data.stick?t.find(".note-stick"):t.find(".note-no-stick")).prepend(Strack.notes_single_item_dom(e.data,"add"))):a.empty().append(i),Strack.init_note_att_event(".comment_note_"+e.data.id);break;case"delete":$(".comment_note_"+e.data.id).remove()}Strack.update.fix_note_stick_class(t)},fix_note_stick_class:function(e){e=e.find(".note-stick");0<e.find(".comment").length?e.addClass("note-stick-bottom"):e.removeClass("note-stick-bottom")},thumbnail:function(t){var e=[],e="direct"===t.param.relation_type?$(".thumb-"+t.param.module_id+"-"+t.param.link_id):$("."+t.param.relation_custom_fields+"-"+t.param.module_id+"-"+t.param.link_id),a=null;e.each(function(){switch($(this).attr("thumb-type")){case"avatar":a=$(this).parent().html(Strack.build_avatar(t.param.link_id,t.param.thumb,""));break;case"thumb":a=$(this).parent();var e=t.data;e.link_id=t.param.link_id,e.module_id=t.module_data.id,e.param.icon=t.module_data.icon,a.hasClass(".datagrid-cell"),Strack.thumb_media_widget(a[0],e,{modify_thumb:t.param.rule_thumb_modify,clear_thumb:t.param.rule_thumb_clear})}})},excessive_color:function(e,t,a){var e=200===parseInt(e)?"#00FF54":"#FF4739",i=a||"transparent";t.css({"background-color":e,transition:"background-color 100ms ease-in","-moz-transition":"background-color 100ms ease-in","-webkit-transition":"background-color 100ms ease-in","-o-transition":"background-color 100ms ease-in"}),setTimeout(function(){t.css({"background-color":i,transition:"background-color 300ms ease-in","-moz-transition":"background-color 300ms ease-in","-webkit-transition":"background-color 300ms ease-in","-o-transition":"background-color 300ms ease-in"})},300)}},notice:{license:function(e){var t=parseInt(Strack.read_storage("last_notice_date"));parseInt(e.expiry_days)<30&&t!==parseInt(e.last_notice_date)&&(Strack.save_storage("last_notice_date",e.last_notice_date),e=Strack.notice.dom({bg_color:"notice-color-red",count_down:"10 S",content:StrackLang.License_Warn_Notice_1+" "+e.expiry_date+" "+StrackLang.License_Warn_Notice_2+" "+StrackLang.License_Warn_Notice_3,content_css:"",close:!0}),$("body").addClass("has-top-notice-body").before(e),Strack.notice.auto_close(10))},demo_project:function(t){var e;$.isEmptyObject(t)||(e=1,0<$(".globel-top-notice").length&&(e=10010),setTimeout(function(){0<$(".globel-top-notice").length&&Strack.close_notice_message();var e=Strack.notice.dom({bg_color:"notice-color-green",count_down:"",content:StrackLang.Project_Demo+"  "+t.name,content_css:"text-align-center",close:!1});$("body").addClass("has-top-notice-body").before(e)},e))},dom:function(e){var t="";return t+='<header class="globel-top-notice '+e.bg_color+'"><div class="notice-count aign-left">'+e.count_down+'</div><div class="notice-content aign-left '+e.content_css+'">'+e.content+"</div>",e.close&&(t+='<a href="javascript:;" class="notice-close aign-right" onclick="Strack.close_notice_message(this)"><i class="icon-uniE6DB"></i></a>'),t+="</header>"},auto_close:function(e){var t=setInterval(function(){e--,$(".notice-count").html(e+" S")},100*e);setTimeout(function(){0<$(".globel-top-notice").length&&Strack.close_notice_message(),clearTimeout(t)},1e3*e)}}};$(function(){var e,t,a,i,d;Strack.init_dropdown(),Strack.body_click_event(),Strack.Notify.init(),Strack.build_top_menu(),Strack.top_header(),!Strack.G.MenuName||(e=$("#admin_"+Strack.G.MenuName)).length&&(t=Strack.read_storage("admin_menu_top"),a=$(".admin-page-left"),e.addClass("admin-menu-active"),d=0,i=document.documentElement.clientHeight,0<(d=0<t?t:(a.scrollTop(0),e.offset().top-i+82))&&a.scrollTop(d)),Strack.G.AccMenu&&$("#account-"+Strack.G.AccMenu).addClass("account-menu-active"),Strack.update.init()});