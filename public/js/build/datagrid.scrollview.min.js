var scrollview=$.extend({},$.fn.datagrid.defaults.view,{render:function(r,t,a){$(r).datagrid("loaded");$.data(r,"datagrid");for(var e=this.groups,d=[],o=0;o<e.length;o++)d.push(this.renderGroup.call(this,r,o,e[o],a));$(t).html(d.join(""))},renderGroup:function(r,t,a,e){var d,o=$.data(r,"datagrid"),s=o.options,i=$(r).datagrid("getColumnFields",e),n=[];s.groupActive&&(n.push('<div class="datagrid-group" group-index='+t+">"),n.push('<table cellspacing="0" cellpadding="0" border="0" style="height:100%"><tbody>'),n.push("<tr>"),(e&&(s.rownumbers||s.frozenColumns.length)||!e&&!s.rownumbers&&!s.frozenColumns.length)&&n.push('<td style="border:0;text-align:center;width:25px"><span class="datagrid-row-expander datagrid-row-collapse icon-uniF077" style="display:inline-block;margin-left: 8px;cursor:pointer">&nbsp;</span></td>'),n.push('<td style="border:0;">'),t=s.columns.length-1,d="","string"==typeof a.value?d=a.value:a.value&&a.value.hasOwnProperty("rows")&&a.value.rows.forEach(function(r){d+=r.name}),e?(n.push('<span class="datagrid-group-title frozen_gtitle text-ellipsis">'),2<=s.frozenColumns[t].length&&n.push(s.groupFormatter.call(r,d,a.rows))):(n.push('<span class="datagrid-group-title unfrozen_gtitle text-ellipsis">'),s.frozenColumns[t].length<2&&n.push(s.groupFormatter.call(r,d,a.rows))),n.push("</span>"),n.push("</td>"),n.push("</tr>"),n.push("</tbody></table>"),n.push("</div>")),n.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var l=a.startIndex,g=0;g<a.rows.length;g++){var p=s.rowStyler?s.rowStyler.call(r,l,a.rows[g]):"",u="",h="";"string"==typeof p?h=p:p&&(u=p.class||"",h=p.style||"");p=[];h&&p.push(h);h='class="datagrid-row '+(l%2&&s.striped?"datagrid-row-alt ":" ")+u+'"',u=0<p.length?'style="'+p.join(";")+'"':"",p=o.rowIdPrefix+"-"+(e?1:2)+"-"+l;n.push('<tr id="'+p+'" datagrid-row-index="'+l+'" '+h+" "+u+">"),n.push(this.renderRow.call(this,r,i,e,l,a.rows[g])),n.push("</tr>"),l++}return n.push("</tbody></table>"),n.join("")},bindEvents:function(e){var r=$.data(e,"datagrid").dc,r=r.body1.add(r.body2),d=($.data(r[0],"events")||$._data(r[0],"events")).click[0].handler;r.unbind("click").bind("click",function(r){var t,a=$(r.target).closest("span.datagrid-row-expander");a.length?(t=a.closest("div.datagrid-group").attr("group-index"),a.hasClass("datagrid-row-collapse")?$(e).datagrid("collapseGroup",t):$(e).datagrid("expandGroup",t)):d(r),r.stopPropagation()}),$(".datagrid-view2 .datagrid-body").scroll(function(r){$(".datagrid-group").css("width","calc(100% + "+this.scrollLeft+"px)")})},onBeforeRender:function(r,t){var a=$.data(r,"datagrid"),e=a.options;$("#datagrid-group-style").length||$("head").append('<style id="datagrid-group-style">.datagrid-group{height:25px;overflow:hidden;font-weight:bold;border-bottom:1px solid #ccc;background-color: #E6E6E6}</style>');for(var d=[],o=0;o<t.length;o++){var s=t[o];(i=function(r){for(var t=0;t<d.length;t++){var a=d[t];if(p(a.value)==p(r))return a}return null}(s[e.groupField]))?i.rows.push(s):(i={value:s[e.groupField],rows:[s]},d.push(i))}for(var i,n=0,l=[],o=0;o<d.length;o++)(i=d[o]).startIndex=n,n+=i.rows.length,l=l.concat(i.rows);a.data.rows=l,this.groups=d;var g=this;function p(r){return r&&r.hasOwnProperty("rows")?r.rows[0].name:r}setTimeout(function(){g.bindEvents(r)},0)}});$.extend($.fn.datagrid.methods,{expandGroup:function(r,a){return r.each(function(){var r=$.data(this,"datagrid").dc.view.find(null!=a?'div.datagrid-group[group-index="'+a+'"]':"div.datagrid-group"),t=r.find("span.datagrid-row-expander");t.hasClass("datagrid-row-expand")&&(t.removeClass("datagrid-row-expand").removeClass(" icon-uniF078").addClass("datagrid-row-collapse").addClass(" icon-uniF077"),r.next("table").show()),$(this).datagrid("fixRowHeight")})},collapseGroup:function(r,a){return r.each(function(){var r=$.data(this,"datagrid").dc.view.find(null!=a?'div.datagrid-group[group-index="'+a+'"]':"div.datagrid-group"),t=r.find("span.datagrid-row-expander");t.hasClass("datagrid-row-collapse")&&(t.removeClass("datagrid-row-collapse").removeClass(" icon-uniF077").addClass("datagrid-row-expand").addClass(" icon-uniF078"),r.next("table").hide()),$(this).datagrid("fixRowHeight")})}}),$.extend(scrollview,{refreshGroupTitle:function(r,t){var a=$.data(r,"datagrid"),e=a.options,d=a.dc,a=this.groups[t];d.body2.children("div.datagrid-group[group-index="+t+"]").find("span.datagrid-group-title").html(e.groupFormatter.call(r,a.value,a.rows))},insertRow:function(e,r,t){for(var a,d=$.data(e,"datagrid"),o=d.options,s=d.dc,i=null,n=0;n<this.groups.length;n++)if(this.groups[n].value==t[o.groupField]){i=this.groups[n],a=n;break}function l(r,t){var a=t?1:2,t=o.finder.getTr(e,r-1,"body",a);o.finder.getTr(e,r,"body",a).insertAfter(t)}i?((r=null==r?d.data.rows.length:r)<i.startIndex?r=i.startIndex:r>i.startIndex+i.rows.length&&(r=i.startIndex+i.rows.length),$.fn.datagrid.defaults.view.insertRow.call(this,e,r,t),r>=i.startIndex+i.rows.length&&(l(r,!0),l(r,!1)),i.rows.splice(r-i.startIndex,0,t)):(i={value:t[o.groupField],rows:[t],startIndex:d.data.rows.length},a=this.groups.length,s.body1.append(this.renderGroup.call(this,e,a,i,!0)),s.body2.append(this.renderGroup.call(this,e,a,i,!1)),this.groups.push(i),d.data.rows.push(t)),this.refreshGroupTitle(e,a)},updateRow:function(r,t,a){var e=$.data(r,"datagrid").options;$.fn.datagrid.defaults.view.updateRow.call(this,r,t,a);t=e.finder.getTr(r,t,"body",2).closest("table.datagrid-btable"),t=parseInt(t.prev().attr("group-index"));e.groupFormatter&&this.refreshGroupTitle(r,t)},deleteRow:function(r,t){var a=$.data(r,"datagrid"),e=a.options,a=a.dc,d=a.body1.add(a.body2),e=e.finder.getTr(r,t,"body",2).closest("table.datagrid-btable"),e=parseInt(e.prev().attr("group-index"));$.fn.datagrid.defaults.view.deleteRow.call(this,r,t);var o=this.groups[e];if(1<o.rows.length)o.rows.splice(t-o.startIndex,1),this.refreshGroupTitle(r,e);else{d.children("div.datagrid-group[group-index="+e+"]").remove();for(var s=e+1;s<this.groups.length;s++)d.children("div.datagrid-group[group-index="+s+"]").attr("group-index",s-1);this.groups.splice(e,1)}for(t=0,s=0;s<this.groups.length;s++)(o=this.groups[s]).startIndex=t,t+=o.rows.length}});