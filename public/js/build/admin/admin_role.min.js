$(function(){obj={auth_role_add:function(){Strack.open_dialog("dialog",{title:StrackLang.Add_Auth_Role,width:480,height:240,content:Strack.dialog_dom({type:"normal",items:[{case:1,id:"Nname",lang:StrackLang.Name,name:"name",valid:"1,128",value:""},{case:1,id:"Ncode",lang:StrackLang.Code,name:"code",valid:"1,128",value:""}],footer:[{obj:"role_add_submit",type:1,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),close:function(){}})},role_add_submit:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",RolePHP.addAuthRole,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),obj.auth_role_filter(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}},{extra:function(e){return e.type="custom",e}})},auth_role_modify:function(e){var a=$(e).data("roleid"),t=$(e).data("name"),e=$(e).data("code");Strack.open_dialog("dialog",{title:StrackLang.Modify_Auth_Role,width:480,height:240,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mauth_role_id",type:"hidden",name:"id",valid:1,value:a}],items:[{case:1,id:"Mauth_role_name",type:"text",lang:StrackLang.Name,name:"name",valid:1,value:t},{case:1,id:"Mauth_role_code",type:"text",lang:StrackLang.Code,name:"code",valid:1,value:e}],footer:[{obj:"modify_auth_role",type:1,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),close:function(){}})},modify_auth_role:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",RolePHP.modifyAuthRole,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),obj.auth_role_filter(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},auth_role_delete:function(e){e=$(e).data("roleid");Strack.ajax_base_delete(e,StrackLang.Delete_AuthRole_Notice,RolePHP.deleteAuthRole,function(e){obj.auth_role_filter()})},auth_role_filter:function(){var e=$("#search_val").val(),a="";0<e.length&&(a=JSON.stringify({name:["LIKE","%"+e+"%"]})),obj.reset_right_panel(),t(a)},select_auth_role:function(e){var a=$(e).data("roleid"),t=$(e).data("name"),i=$(e).data("code");$(".temp-setlist-no").hide(),$(".temp-setlists").show(),$("#hide_role_id").val(a),$("#hide_role_name").val(t),$("#hide_role_code").val(i),$(".role-items").removeClass("templates-active"),$(e).closest(".role-items").addClass("templates-active"),obj.reset_right_rule_panel(),o("project")},select_role_tab:function(e){var a=$("#hide_role_id").val(),e=$(e).data("tab");obj.reset_right_rule_panel(),o(e)},select_module:function(e){var a=$("#hide_role_id").val(),t=$(e).data("tab"),i=$(e).data("type"),o=$(e).data("id"),d=$(e).data("classtype"),o=r[o];o.role_id=a,o.mode=t,o.class_type=d,$(".nation-items").removeClass("admin-bid-ac"),$(e).addClass("admin-bid-ac");e=$("#content_right_"+i);e.find(".temp-content-right-no").hide(),e.find(".temp-content-right-wrap").show(),$("#rule_tab_"+i+"_function").show(),t=t,o=o,$("#hide_role_rule_id").val(o.id),$("#hide_role_rule_code").val(o.code),$("#hide_role_template_id").val(o.template_id),$("#hide_role_module_id").val(o.module_id),function(n,l){$.ajax({url:RolePHP.getAuthModuleRules,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(n),beforeSend:function(){$("#content_right_func").append(Strack.loading_dom("white","","module_item"))},success:function(e){$("#st-load_module_item").remove();var a,t,i=[];switch(l){case"project":case"front":case"admin":case"api":case"client":e.view&&(i.push("view"),$("#rule_page_function_list").tree({data:e.view,checkbox:!0}));break;case"field":var o,d,r=$("#rule_auth_field_list");e.column&&(i.push("column"),(o=$("#rule_tab_project_field")).addClass("active"),r.hasClass("datagrid-f")?r.treegrid("loadData",c(e.column)):(d=c(e.column),r.treegrid({data:d,idField:"id",treeField:"lang",dataGridType:"treegrid",headerAddCheckbox:!0,rowheight:36,height:Strack.panel_height(".role-rule-wrap",0),adaptive:{dom:".role-rule-wrap",min_width:1004,exth:0},columns:[[{field:"lang",title:StrackLang.Authority,width:220},{field:"view",title:StrackLang.Check,width:120,align:"center",formatter:function(e,a,t){return s("view",a,e)}},{field:"create",title:StrackLang.Create,width:120,align:"center",formatter:function(e,a,t){return s("create",a,e)}},{field:"clear",title:StrackLang.Clear,width:120,align:"center",formatter:function(e,a,t){return s("clear",a,e)}},{field:"modify",title:StrackLang.Modify,width:120,align:"center",formatter:function(e,a,t){return s("modify",a,e)}},{field:"delete",title:StrackLang.Delete,width:120,align:"center",formatter:function(e,a,t){return s("delete",a,e)}}]],onAfterRender:function(e){Strack.init_rule_grid_data(e)}})),o.removeClass("active"));break;case"data_range":i.push("data_range"),$("#data_range_rules_list").empty().append((a=n.id,t="",e.forEach(function(e){t+='<div class="rr-data-r-item">',"yes"===e.checked?t+='<input type="radio" name="'+a+'" checked="checked" data-page="'+a+'" data-authpage="'+e.page+'" data-authid ="'+e.id+'" data-authcode ="'+e.code+'">':t+='<input type="radio" name="'+a+'"  data-page="'+a+'" data-authpage="'+e.page+'" data-authid ="'+e.id+'" data-authcode ="'+e.code+'">',t+=StrackLang[e.lang],t+="</div>"}),t))}$("#hide_role_rule_tab").val(i.join(","))}})}(o,t)},toggle_rule_tab:function(e){},auth_module_tab_save:function(){var e={};$("#hide_role_param input").each(function(){e[$(this).attr("name")]=$(this).val()}),function(o){var e=o.role_rule_tab.split(","),a={};{var t,i,d,r,n,l;0<=$.inArray("view",e)&&(d=$("#rule_page_function_list"),t=d.tree("getRoots"),i=d.tree("getChecked",["checked"]),d=d.tree("getChecked",["indeterminate"]),r=[],i.forEach(function(e){r.push(e.code+"_"+e.id)}),n=[],d.forEach(function(e){n.push(e.code+"_"+e.id)}),l={},t.forEach(function(e){l=function a(e,t,i,o,d){var r="deny";0<=$.inArray(e.code+"_"+e.id,i)&&(r="allow");0<=$.inArray(e.code+"_"+e.id,o)&&(r="indeterminate");t[e.id]={role_id:d,auth_id:e.id,page:e.page,type:"page",param:e.param,permission:r};e.children&&e.children.forEach(function(e){a(e,t,i,o,d)});return t}(e,l,r,n,o.role_id)}),a.view=l)}{var c,s,_,u,h,p,g,m,f,v,k;0<=$.inArray("column",e)&&(c={},h=!(s={}),g=p=u=_="",$("#rule_tab_field_function .dg-rule-checkbox").each(function(){"single"===(p=$(this).data("pos"))?(_=$(this).data("parent")+"_"+$(this).data("code"),u=$(this).data("field"),h=!!$(this).find(".tree-checkbox").hasClass("tree-checkbox1"),c[_]||(c[_]={}),c[_][u]=h):"parent"===p&&(g=$(this).data("code"),h=!$(this).find(".tree-checkbox").hasClass("tree-checkbox0"),s[g]&&!h||(s[g]=h))}),m=[],f={},v={},k=["view","create","modify","delete","clear"],$("#rule_auth_field_list").treegrid("getRoots").forEach(function(a){a.children.forEach(function(e){f=c[a.code+"_"+e.code],v=[],k.forEach(function(e){f[e]&&v.push(e)}),m.push({role_id:o.role_id,auth_id:e.id,page:a.code,param:"",type:"field",permission:v.join(","),module_id:e.module_id,project_id:e.project_id})})}),a.column=m)}{var b;0<=$.inArray("data_range",e)&&(b=[],$("#data_range_rules_list input").each(function(){var e,a,t,i;$(this).prop("checked")&&(e=$(this).data("authid"),i=$(this).data("authcode"),a=$(this).data("page"),t=$(this).data("authpage"),i={role_id:o.role_id,auth_id:e,page:"",param:"",type:"data_range",permission:i,module_id:0,project_id:0},"task_related_user"===t?(i.page=t,i.param=a,o.auth_param=a):(i.page=a,o.auth_param=""),b.push(i))}),a.data_range=b)}$.ajax({url:RolePHP.saveAuthAccess,type:"POST",dataType:"json",data:JSON.stringify({param:o,config:a}),contentType:"application/json",beforeSend:function(){$.messager.progress({title:StrackLang.Waiting,msg:StrackLang.loading})},success:function(e){$.messager.progress("close"),200===parseInt(e.status)?Strack.top_message({bg:"g",msg:e.message}):layer.msg(e.message,{icon:7,time:1200,anim:6})}})}(e)},reset_right_rule_panel:function(){$(".temp-content-right-no").show(),$(".temp-content-right-wrap").hide()},reset_right_panel:function(){$(".temp-setlist-no").show(),$(".temp-setlists").hide()}};var r={};function t(e){$.ajax({url:RolePHP.getAuthRoleList,type:"POST",dataType:"json",data:{filter:e},beforeSend:function(){$("#auth_role_list").empty().append(Strack.loading_dom("null"))},success:function(e){var t="",a=$("#auth_role_list"),i=$("#role_id").val();e.rows.forEach(function(e){var a;t+=(a="",a+='<li id="role_id_'+e.auth_role_id+'" class="role-items" ><div class="role-name text-ellipsis aign-left"><a href="javascript:;" onclick="obj.select_auth_role(this);" data-roleid="'+e.auth_role_id+'" data-name="'+e.name+'" data-code="'+e.code+'">'+e.name+'</a></div><div class="role-bnt aign-right"><a href="javascript:;" class="aign-left" onclick="obj.auth_role_modify(this);" data-roleid="'+e.auth_role_id+'" data-name="'+e.name+'" data-code="'+e.code+'"><i class="icon-uniE684"></i></a><a href="javascript:;" class="aign-left" onclick="obj.auth_role_delete(this);" data-roleid="'+e.auth_role_id+'"><i class="icon-uniE6DB"></i></a></div></li>')}),t?($("#pactive_notice").remove(),a.append(t)):0===$("#pactive_notice").length&&a.before('<div id="pactive_notice" class="datagrid-empty-no">'+StrackLang.Datagird_No_Data+"</div>"),0<i&&$("#role_id_"+i).addClass("templates-active"),$("#st-load").remove()}})}function d(e,a,t,i,o){var d="";return r[e.id]=e,"project"===a&&(r[e.id].template_id=t.template_id),d+='<a href="javascript:;" class="nation-items" onclick="obj.select_module(this)" data-id="'+e.id+'" data-type="'+i+'" data-tab="'+a+'" data-classtype="'+o+'"><div class="nation-items-wrap min"><div class="aign-left"><span>'+e.lang+"</span></div></div></a>"}function c(e){var a,t,i=[],o={};for(t in e)o={id:t,lang:StrackLang[e[t].lang],code:t,is_parent:"yes",state:"open",children:[]},e[t].list.forEach(function(e){a="custom"===e.type?e.lang:StrackLang[e.lang],o.children.push({id:e.id,code:e.name,lang:a,is_parent:"no",parent_code:t,module_id:e.module_id,project_id:e.project_id,view:e.permission.view,create:e.permission.create,modify:e.permission.modify,clear:e.permission.clear,delete:e.permission.delete})}),i.push(o);return i}function s(e,a,t){return"yes"===a.is_parent?'<a href="javascript:;" onclick="Strack.rule_grid_header_checkbox(this)" class="dg-rule-checkbox" style="margin-right: 5px" data-pos="parent" data-field="'+e+'" data-code="'+a.code+'"><div class="tree-checkbox tree-checkbox0"></div></a>':'<a href="javascript:;" onclick="Strack.rule_grid_header_checkbox(this)" class="dg-rule-checkbox" style="margin-right: 5px" data-pos="single" data-field="'+e+'" data-parent="'+a.parent_code+'" data-code="'+a.code+'"><div class="tree-checkbox '+("allow"===t?"tree-checkbox1":"tree-checkbox0")+'"></div></a>'}function o(e){$("#hide_role_tab").val(e),$(".group-item").each(function(){$(this).data("tab")===e?$(this).addClass("active"):$(this).removeClass("active")}),$(".admin-group-content").removeClass("active");var o,a=$("#page_auth_panel"),t=$("#field_auth_panel"),i=$("#data_range_panel");switch(e){case"project":case"front":case"admin":case"api":case"client":a.addClass("active"),$.ajax({url:RolePHP.getAuthPageModuleData,type:"POST",data:{tab:e},dataType:"json",beforeSend:function(){$("#field_module").append(Strack.loading_dom("white","","module"))},success:function(a){var t,i="";for(t in a)i+='<li class="module-items-title">'+a[t].lang+"</li>",a[t].list.forEach(function(e){i+=d(e,"admin",a[t],"page",t)});$("#page_module_list").empty().append(i),$("#st-load_module").remove()}});break;case"field":t.addClass("active"),o=e,$.ajax({url:RolePHP.getAuthFieldModuleData,type:"POST",beforeSend:function(){$("#project_module").append(Strack.loading_dom("white","","module"))},success:function(a){var t,i="";for(t in a)i+='<li class="module-items-title">'+a[t].lang+"</li>",a[t].list&&a[t].list.forEach(function(e){i+=d(e,o,a[t],"field",t)});$("#field_module_list").empty().append(i),$("#st-load_module").remove()}});break;case"data_range":i.addClass("active"),$.ajax({url:RolePHP.getAuthPageModuleData,type:"POST",data:{tab:e},dataType:"json",beforeSend:function(){$("#data_range_module_list").append(Strack.loading_dom("white","","data_range"))},success:function(a){var t,i="";for(t in a)i+='<li class="module-items-title">'+a[t].lang+"</li>",a[t].list.forEach(function(e){i+=d(e,"data_range",a[t],"data_range",t)});$("#data_range_module_list").empty().append(i),$("#st-load_data_range").remove()}})}}t(""),Strack.listen_keyboard_event(function(e,a){"enter"===a.code&&$("#tab_project").hasClass("active")&&$("#search_val").is(":focus")&&(e.preventDefault(),obj.auth_role_filter(Strack.get_obj_by_id("search_auth_role")))})});