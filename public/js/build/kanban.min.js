!function(){"use strict";var a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e=function(e,t,i){return t&&s(e.prototype,t),i&&s(e,i),e};function s(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e){a(this,n),$.extend(this,o,e),e.className&&(this.className=$.extend({},o.className,e.className)),e.message&&(this.message=$.extend({},o.message,e.message))}var r,o={readonly:!1,key:"state",name:"board",message:{loading:"loading ...",stateDisabled:"Current issue cannot switch to this state",allComplete:"Showing all issues",empty:"There are no issues here",btnSetFirst:"Move it to the first",btnSetLast:"Move it to the last"},className:{iconComment:"icon comments outline",iconAngleLeft:"icon angle double left",iconAngleRight:"icon angle double right",iconIssue:"note outline",card:"ui link card",action:"ui button",actions:"ui mini basic icon buttons",avatar:"ui avatar image"},actions:function(a){return a.plugins.Sortable?[{id:"btn-set-first",class:a.className.action,icon:a.className.iconAngleLeft,title:a.message.btnSetFirst,callback:function(e,t){var i=t.state.toString(),s=e.sortable.toArray(),t=s.indexOf(i);0<=t&&(s.splice(t,1),s.splice(0,0,i),e.sortable.sort(s),a.onSorted(s),e.load())}},{id:"btn-set-last",class:a.className.action,icon:a.className.iconAngleRight,title:a.message.btnSetLast,callback:function(e,t){var i=t.state.toString(),s=e.sortable.toArray(),t=s.indexOf(i);0<=t&&(s.splice(t,1),s.push(i),e.sortable.sort(s),a.onSorted(s),e.load())}}]:[]},data:[{order:1,name:"Backlog",state:"open",color:"#ffa726",issuesCount:0},{order:2,name:"Done",state:"closed",color:"#2baf2b",issuesCount:0}],plugins:{},types:[],user:{id:0,admin:!1},onLoad:function(e,t){$.ajax({url:"issues",data:{state:e.state,page:e.page}}).done(function(){t([],0)}).fail(function(){t([],0)})},onUpdate:function(e,t){var i=this;$.ajax({type:"PUT",url:e.url,data:{state:e.state}}).done(function(e){i.updateIssue(e)}).fail(function(){i.setIssueState(e.id,t)})},onRender:function(e,t){return t.addClass("issue-state-"+e.state),t},onSorted:function(e){window.console.log(e)}},l=(r=$("<div/>"),function(e){return r.text(e).html()}),d=(e(u,[{key:"getAvatarUrl",value:function(e,t){var i=this.config.plugins.LetterAvatar;return t&&0!==t.indexOf("no_portrait.png")||!i?t:i(e)}},{key:"getCardId",value:function(e){return this.config.getIusseId?this.config.getIusseId(e):"issue-card-"+e.id}}]),u);function u(e){a(this,u),this.config=e}var c=(t(h,d),e(h,[{key:"render",value:function(e){var t=this.config.user,i=this.config.readonly,s="",a=this.config.className.card;i||!t.admin&&t.id!==e.author.id||(s='draggable="true"',a+=" card-draggable");var n="#464a4b";0<e.base_status_id&&(n="#"+this.config.paramConfig.status_config[e.base_status_id].color);Strack.calculation_progress_bar(0,Strack.translate_timespinner_val(e.base_plan_duration),0);var r="#e1e1e1";e.base_end_time&&(r=this.config.paramConfig.time_config.current_time<e.base_end_time?e.base_end_time<this.config.paramConfig.time_config.urgent_time?"#faad14":"#1890ff":"#f5222d");i="grid_kanban_tg_"+Math.floor(1e4*Math.random()+1),t={},t=this.config.paramConfig.timelog_config.active_timelog&&this.config.paramConfig.timelog_config.active_timelog[e.id]?{id:this.config.paramConfig.timelog_config.active_timelog[e.id],color:"red"}:{id:0,color:"green"},t=Strack.generate_kanban_timelog_bnt({user_id:this.config.paramConfig.timelog_config.my_user_id,random_id:i,item_id:e.id,timelog:t,module_id:this.config.gridParam.grid_param.module_id},e[this.config.paramConfig.formula_config.assignee_field.field]);return['<li class="',a,'" ',s,'id="',this.config.name,"-issue-",e.id,'" data-id="',e.id,'">','<div class="kanban-card-title" style="overflow: hidden">','<div class="aign-left"><div class="kanban-card-status" style="background-color: '+n+'"></div></div>','<div class="issue-name text-ellipsis aign-left">'+e.title+"</div>",'<div class="issue-assignee text-ellipsis aign-left">',"<div>分派人："+Strack.generate_grid_user(e[this.config.paramConfig.formula_config.reviewed_by.field])+"</div>","<div>执行人："+Strack.generate_grid_user(e[this.config.paramConfig.formula_config.assignee_field.field])+"</div>","</div>","</div>",'<div class="kanban-card-bnt" style="overflow: hidden">','<div class="aign-left">',t,"</div>",'<div class="kanban-card-end aign-right">','<div class="card-end-time" style="background-color: '+r+'">'+e.base_end_time+"</div>","</div>","</div>","</div>","</li>"].join("")}},{key:"renderState",value:function(e){e=e.state_data;return e&&"state"!==this.config.key?['<div class="state">','<i title="',e.name,'" class="',e.icon,'"','style="color: ',e.color,'"></i>',"</div>"].join(""):""}},{key:"renderAssignee",value:function(e){var t=e.assignee;return t&&t.id&&"state"===this.config.key?['<div class="assignee">','<a target="_blank" href="',(e=t).html_url||e.path,'" title="',l(t.name),'">','<img src="',this.getAvatarUrl(t.name,t.avatar_url),'" alt="',l(t.name),'" class="',this.config.className.avatar,'">',"</a>","</div>"].join(""):""}},{key:"renderComments",value:function(e){var t=this.config.className.iconComment;return e.comments?'<span class="card-comments"><i class="'+t+'"></i>'+e.comments+"</span>":""}}]),h);function h(){return a(this,h),i(this,(h.__proto__||Object.getPrototypeOf(h)).apply(this,arguments))}var f=(t(g,d),e(g,[{key:"render",value:function(e){return['<div class="board" data-state="',e.state,'">','<div class="board-inner">',this.renderHeader(e),'<div class="board-list-wrapper">','<ul class="board-list"></ul>','<div class="ui inverted dimmer">','<div class="ui loader"></div>',"</div>",'<div class="board-blur-message">','<p><i class="icon ban"></i></p>',"<p>",this.config.message.stateDisabled,"</p>","</div>",'</div><a href="javascript:;" class="board-list-bottom" data-state="',e.state,'"><span><i class="icon-uniE672"></i></span><span>添加任务</span></a>',"</div>","</div>"].join("")}},{key:"renderHeader",value:function(e){var t,i,s="",a="board-header";return e.color&&(s="background"===e.colorTarget?"background-color: "+(t=e.color,i=.04,t=/^#([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})$/.exec(t),"rgba("+parseInt(t[1],16)+","+parseInt(t[2],16)+","+parseInt(t[3],16)+","+i+")"):(a+=" has-border","border-color: "+e.color)),['<div class="',a,'" style="',s,'">','<h3 class="board-title">',this.renderActions(),'<div class="right floated issues-count-badge">','<i class="',this.config.className.iconIssue,'" />','<span class="issues-count">',e.issuesCount,"</span>","</div>",this.renderAvatar(e),(a="",(s=e).color&&(a='style="color: '+s.color+'"'),s.icon?'<i class="iconfont '+s.icon+'" '+a+"></i>":""),l(e.name),"</h3>","</div>"].join("")}},{key:"renderActions",value:function(){var e=this.config,t=e.actions;return"function"==typeof t&&(t=t(e)),['<div class="right floated board-actions ',e.className.actions,'">',t.map(function(e){return['<button type="button" class="board-action ',e.class,'" title="',e.title,'" data-id="',e.id,'">','<i class="',e.icon,'" />',"</button>"].join("")}).join(""),"</div>"].join("")}},{key:"renderAvatar",value:function(e){return e.avatarUrl?['<img class="',this.config.className.avatar,' board-avatar" alt="',e.state,'" src="',this.getAvatarUrl(e.name,e.avatarUrl),'">'].join(""):""}},{key:"renderTip",value:function(e){var t=this.config.message;return(e.loadable?['<li class="board-tip">','<span class="ui active mini inline loader" /> ',t.loading,"</li>"]:e.completed&&0<e.issues.length?['<li class="board-tip">',t.allComplete,"</li>"]:['<li class="board-tip">',t.empty,"</li>"]).join("")}}]),g);function g(){return a(this,g),i(this,(g.__proto__||Object.getPrototypeOf(g)).apply(this,arguments))}var v=(e(p,[{key:"add",value:function(e){this.issues.push(e),this.issuesCount+=1,this.$issuesCount.text(this.issuesCount)}},{key:"find",value:function(e){for(var t=0;t<this.issues.length;++t)if(this.issues[t].id===e)return t;return-1}},{key:"get",value:function(e){e=this.find(e);return 0<=e?this.issues[e]:null}},{key:"remove",value:function(e){e=this.find(e);return 0<=e?(--this.issuesCount,this.$issuesCount.text(this.issuesCount),this.issues.splice(e,1)):null}},{key:"clear",value:function(){this.page=0,this.issues=[],this.issuesCount=0,this.loading=!1,this.loadable=!0,this.completed=!1,this.$issuesCount.text(0),this.$issues.empty(),this.$tip=null}},{key:"autoload",value:function(){this.completed||(!this.$tip||this.$tip.position().top<this.$issues.height())&&this.load()}},{key:"load",value:function(){return!this.loading&&(this.page+=1,this.loading=!0,1===this.page&&this.$dimmer.addClass("active"),this.config.onLoad(this,this.onLoadDone.bind(this)),!0)}},{key:"onLoadDone",value:function(e,t){this.issuesCount=t,this.$issuesCount.text(this.issuesCount),this.appendIssues(e),!(0<this.issuesCount)||e.length<1||this.issuesCount===e.length?(this.loadable=!1,this.completed=!0):(this.loadable=!0,this.completed=!1),1===this.page&&this.$dimmer.removeClass("active"),this.loading=!1,this.updateTip(),this.autoload()}},{key:"firstload",value:function(){return!(0<this.page)&&this.load()}},{key:"updateTip",value:function(){this.$tip&&this.$tip.remove(),this.$tip=$(this.renderer.renderTip(this)),this.$issues.append(this.$tip)}},{key:"createCard",value:function(i){var e=$(this.cardRenderer.render(i)),s=this.config.onSelect;return s&&e.on("click",function(e){var t=$(e.target);!(t=!t.is("a")?t.parent():t).parent().hasClass("card-header")&&t.is("a")&&t.attr("href")||s(i,e)}),this.config.onRender(i,e,this.config)}},{key:"appendIssue",value:function(e){this.issues.push(e),this.$issues.append(this.createCard(e))}},{key:"prependIssue",value:function(e){this.issuesCount+=1,this.issues.splice(0,0,e),this.$issues.prepend(this.createCard(e)),this.$issuesCount.text(this.issuesCount)}},{key:"updateIssue",value:function(e){var t=$("#"+this.config.name+"-issue-"+e.id);t.length<1?this.prependIssue(e):t.before(this.createCard(e)).remove()}},{key:"appendIssues",value:function(e){var i=this;e.filter(function(t){return i.issues.every(function(e){return e.id!==t.id})}).forEach(function(e){e[i.config.Key]=i.state,i.appendIssue(e)})}},{key:"clickAddIssue",value:function(e){var t=this.config.gridParam.grid_param,i={};switch(this.config.gridParam.group_raw_param.field_type){case"custom":i.field=this.config.gridParam.group_raw_param.module_code+"-"+this.config.gridParam.group_raw_param.field_value_map;break;case"built_in":i.field=this.config.gridParam.group_raw_param.module+"-"+this.config.gridParam.group_raw_param.field_value_map}i.value=e;var s={};s[i.field]=e,Strack.item_operate_dialog(this.config.gridParam.grid_param.module_name,{mode:"create",field_list_type:["edit"],module_id:t.module_id,project_id:t.project_id,page:t.page,schema_page:t.page,type:"add_panel",select_fields:{config:[i],map:s}},function(){$(".datagrid-view-kanban").boards().data("boards").reload(e)})}}]),p);function p(e,t){var i=this;a(this,p),this.page=0,this.loadable=!0,this.loading=!1,this.completed=!1,this.issues=[],this.name=e.name,this.icon=e.icon,this.state=e.state,this.color=e.color,this.colorTarget=e.colorTarget,this.issuesCount=e.issuesCount||0,this.avatarUrl=e.avatarUrl,this.config=t,this.renderer=new f(t),this.cardRenderer=new c(t),this.$tip=null,this.$el=$(this.renderer.render(this)),this.$dimmer=this.$el.find(".ui.dimmer"),this.$issues=this.$el.find(".board-list"),this.$issuesCount=this.$el.find(".issues-count");var s=this;this.$el.find(".board-list-bottom").on("click",function(){var e=$(this).data("state");s.clickAddIssue(e)}),this.$issues.on("scroll",function(){i.autoload()})}var m=(e(b,[{key:"initPlugins",value:function(){this.initSortable()}},{key:"initSortable",value:function(){var a=this,e=a.config.plugins.Sortable;return!!e&&(a.$el.addClass("boards-sortable"),a.sortable=e.create(a.$el[0],{handle:".board-title",dataIdAttr:"data-state",onUpdate:function(){a.config.onSorted(a.sortable.toArray())}}),a.$el.on("click",".board-action",function(t){var e=$(this),i=e.data("id"),s=e.parents(".board").data("state"),e=a.config.actions;(e="function"==typeof e?e(a.config):e).some(function(e){return!(e.id!==i||!e.callback)&&(e.callback(a,a.boards[s],t),!0)})}),!0)}},{key:"bindScroll",value:function(){var e=this,t=null;function i(){t&&clearTimeout(t),t=setTimeout(function(){t=null,e.load()},200)}$(window).on("resize",i),this.$el.on("scroll",i)}},{key:"bindDrag",value:function(){var n=this;n.config.readonly||(n.$el.on("dragstart",".card",function(e){var t=$(this).data("id"),i=n.getIssue(t);i&&n.setFocus(i.type,i.state),n.$selectedIssue=$(this),e.originalEvent.dataTransfer.setData("text/plain",t),e.stopPropagation()}),n.$el.on("dragend",".card",function(){n.clearFocus()}),n.$el.on("drop",".board-list",function(e){if(e.preventDefault(),e.stopPropagation(),n.$hoverIssue&&n.$hoverIssue.removeClass("card-dragover"),!n.$selectedIssue)return!1;if(n.config.readonly)return!1;var t=n.$selectedIssue,i=t.data("id"),e=$(this).parents(".board").data("state"),s=t.parents(".board").data("state"),a=n.$hoverIssue?n.$hoverIssue.data("id"):null;return n.setIssueState(i,e,a,function(e){n.config.onUpdate(e,s,a)}),!0}),n.$el.on("dragover",".board-list",function(e){var t=n.config.key,i=$(e.target);if(n.$selectedIssue){for(e.preventDefault();0<i.length&&!i.hasClass("card");)i=i.parent();if(i.length<1)return n.$hoverIssue&&n.$hoverIssue.removeClass("card-dragover"),void(n.$hoverIssue=null);n.$hoverIssue&&n.$hoverIssue.removeClass("card-dragover"),n.$hoverIssue=i;var s=n.getIssue(i.data("id")),e=n.getIssue(n.$selectedIssue.data("id"));s&&e&&s[t]!==e[t]&&n.$hoverIssue.addClass("card-dragover")}}))}},{key:"clickCardShowSidebar",value:function(){var t=this;t.config.readonly||t.$el.on("click",".card",function(e){t.config.gridParam.grid_param.item_id=$(e.currentTarget).data("id"),Strack.open_datagrid_slider(t.config.gridParam.grid_param)})}},{key:"setFocus",value:function(t,i){var s=this,a=[],n=null;"state"===this.config.key&&(this.config.types.some(function(e){return e.id===t&&(n=e,!0)}),n&&(a=n.states.map(function(e){return e.id.toString()})),Object.keys(this.boards).forEach(function(e){e!==i.toString()&&-1===a.indexOf(e)&&s.boards[e].$el.addClass("board-blur")}))}},{key:"clearFocus",value:function(){var t=this;Object.keys(this.boards).forEach(function(e){t.boards[e].$el.removeClass("board-blur")})}},{key:"getIssueCard",value:function(e){return $("#"+this.config.name+"-issue-"+e)}},{key:"getIssue",value:function(e){var t=this.getIssueCard(e).parents(".board").data("state"),t=this.boards[t];return t?t.get(e):null}},{key:"removeIssue",value:function(e){var t=null,i=this.getIssueCard(e);if(i.length<1)return t;var s=i.parents(".board").data("state");return!s||(s=this.boards[s])&&(t=s.remove(e)),i.remove(),t}},{key:"updateIssue",value:function(e){var t=this.boards[e[this.config.key]];return!!t&&(t.updateIssue(e),!0)}},{key:"prependIssue",value:function(e){var t=this.boards[e[this.config.key]];return!!t&&(t.prependIssue(e),!0)}},{key:"setIssueState",value:function(e,t,i,s){var a=this.getIssueCard(e),n=i?this.getIssueCard(i):null;if(a.length<1)return null;var r=this.config.user,o=a.parents(".board").data("state"),i=this.boards[o],l=this.boards[t];if(i.state===t)return null;if(l.exclude&&0<=l.exclude.indexOf(o))return null;var d=i.get(e);return r.admin||d.author.id===r.id?(d[this.config.key]=t,l.add(d),i.remove(d.id),a.hide(256,function(){n?n.before(a):l.$issues.prepend(a),a.show(256,function(){s&&s(d)})}),l.updateTip(),i.updateTip(),i.autoload(),d):null}},{key:"load",value:function(){var i=this,s=0,a=this.$el.offset();return a.width=this.$el.width(),a.height=this.$el.height(),Object.keys(this.boards).forEach(function(e){var t=i.boards[e],e=t.$el.offset();e.top+t.$el.height()>a.top&&e.left+t.$el.width()>a.left&&e.top<a.top+a.height&&e.left<a.left+a.width&&t.firstload()&&(s+=1)}),s}},{key:"resetQueryConfig",value:function(e){e=JSON.parse(e.filter_data);return this.config.filter_param.filter=e.filter,this}},{key:"reload",value:function(e){if(e)this.boards[e].clear(),this.boards[e].load();else for(var t in this.clearData(),this.boards)this.boards[t].load()}},{key:"setData",value:function(e){var i=this;this.boards={},this.$el.addClass("boards-list").empty(),e.forEach(function(e){var t=new v(e,i.config);i.boards[e.state]=t,i.$el.append(t.$el)})}},{key:"clearData",value:function(){var t=this;Object.keys(this.boards).forEach(function(e){t.boards[e].clear()})}}]),b);function b(e,t){a(this,b);var i=new n(t);this.$el=e,this.config=i,this.boards={},this.gridParam={},this.paramConfig={},this.$hoverIssue=null,this.$selectedIssue=null,this.timerForScrollLoad=null,t.drag_card&&this.bindDrag(),this.bindScroll(),this.initPlugins(),this.clickCardShowSidebar(),this.setData(i.data)}$.fn.boards=function(e){var t=this.data("boards"),e=$.extend({},$.fn.boards.settings,e);return t||(t=new m(this,e),this.data("boards",t),t.load()),this},$.fn.boards.settings=o}();