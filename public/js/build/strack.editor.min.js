!function(e,i){"function"==typeof define&&define.amd?define("simple-module",["jquery"],function(t){return e.Module=i(t)}):"object"==typeof exports?module.exports=i(require("jquery")):e.SimpleModule=i(jQuery)}(this,function(a){var i=[].slice;function t(t){var r,e,i,o,n,s;if(this.opts=a.extend({},this.opts,t),(t=this.constructor)._connectedClasses||(t._connectedClasses=[]),o=function(){for(var t=this.constructor._connectedClasses,e=[],i=0,o=t.length;i<o;i++)r=t[i],s=r.pluginName.charAt(0).toLowerCase()+r.pluginName.slice(1),r.prototype._connected&&(r.prototype._module=this),e.push(this[s]=new r);return e}.call(this),this._connected)this.opts=a.extend({},this.opts,this._module.opts);else for(this._init(),e=0,n=o.length;e<n;e++)"function"==typeof(i=o[e])._init&&i._init();this.trigger("initialized")}return t.extend=function(t){var e,i,o;if(null!=t&&"object"==typeof t){for(e in t)o=t[e],"included"!==e&&"extended"!==e&&(this[e]=o);return null!=(i=t.extended)?i.call(this):void 0}},t.include=function(t){var e,i,o;if(null!=t&&"object"==typeof t){for(e in t)o=t[e],"included"!==e&&"extended"!==e&&(this.prototype[e]=o);return null!=(i=t.included)?i.call(this):void 0}},t.connect=function(t){if("function"==typeof t){if(!t.pluginName)throw new Error("Module.connect: cannot connect plugin without pluginName");return t.prototype._connected=!0,this._connectedClasses||(this._connectedClasses=[]),this._connectedClasses.push(t),t.pluginName?this[t.pluginName]=t:void 0}},t.prototype.opts={},t.prototype._init=function(){},t.prototype.on=function(){var t,e=1<=arguments.length?i.call(arguments,0):[];return(t=a(this)).on.apply(t,e),this},t.prototype.one=function(){var t,e=1<=arguments.length?i.call(arguments,0):[];return(t=a(this)).one.apply(t,e),this},t.prototype.off=function(){var t,e=1<=arguments.length?i.call(arguments,0):[];return(t=a(this)).off.apply(t,e),this},t.prototype.trigger=function(){var t,e=1<=arguments.length?i.call(arguments,0):[];return(t=a(this)).trigger.apply(t,e),this},t.prototype.triggerHandler=function(){var t,e=1<=arguments.length?i.call(arguments,0):[];return(t=a(this)).triggerHandler.apply(t,e)},t.prototype._t=function(){var t,e=1<=arguments.length?i.call(arguments,0):[];return(t=this.constructor)._t.apply(t,e)},t._t=function(){var t,e=arguments[0],o=2<=arguments.length?i.call(arguments,1):[],e=(null!=(t=this.i18n[this.locale])?t[e]:void 0)||"";return 0<o.length?(e=e.replace(/([^%]|^)%(?:(\d+)\$)?s/g,function(t,e,i){return i?e+o[parseInt(i)-1]:e+o.shift()})).replace(/%%s/g,"%s"):e},t.i18n={"zh-CN":{}},t.locale="zh-CN",t}),function(i,o){"function"==typeof define&&define.amd?define("simple-hotkeys",["jquery","simple-module"],function(t,e){return i.hotkeys=o(t,e)}):"object"==typeof exports?module.exports=o(require("jquery"),require("simple-module")):(i.simple=i.simple||{},i.simple.hotkeys=o(jQuery,SimpleModule))}(this,function(t,e){var i,r={}.hasOwnProperty;function o(){return o.__super__.constructor.apply(this,arguments)}return function(t,e){for(var i in e)r.call(e,i)&&(t[i]=e[i]);function o(){this.constructor=t}o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype}(o,e),o.count=0,o.keyNameMap={8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",91:"Meta",93:"Meta",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"Multiply",107:"Add",109:"Subtract",110:"Decimal",111:"Divide",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",124:"F13",125:"F14",126:"F15",127:"F16",128:"F17",129:"F18",130:"F19",131:"F20",132:"F21",133:"F22",134:"F23",135:"F24",59:";",61:"=",186:";",187:"=",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},o.aliases={escape:"esc",delete:"del",return:"enter",ctrl:"control",space:"spacebar",ins:"insert",cmd:"meta",command:"meta",wins:"meta",windows:"meta"},o.normalize=function(t){for(var e,i,o=t.toLowerCase().replace(/\s+/gi,"").split("+"),r=e=0,n=o.length;e<n;r=++e)i=o[r],o[r]=this.aliases[i]||i;return t=o.pop(),o.sort().push(t),o.join("_")},o.prototype.opts={el:document},o.prototype._init=function(){return this.id=++this.constructor.count,this._map={},this._delegate="string"==typeof this.opts.el?document:this.opts.el,t(this._delegate).on("keydown.simple-hotkeys-"+this.id,this.opts.el,(i=this,function(t){var e;return null!=(e=i._getHander(t))?e.call(i,t):void 0}));var i},o.prototype._getHander=function(t){var e,i;if(e=this.constructor.keyNameMap[t.which])return i="",t.altKey&&(i+="alt_"),t.ctrlKey&&(i+="control_"),t.metaKey&&(i+="meta_"),t.shiftKey&&(i+="shift_"),i+=e.toLowerCase(),this._map[i]},o.prototype.respondTo=function(t){return"string"==typeof t?null!=this._map[this.constructor.normalize(t)]:null!=this._getHander(t)},o.prototype.add=function(t,e){return this._map[this.constructor.normalize(t)]=e,this},o.prototype.remove=function(t){return delete this._map[this.constructor.normalize(t)],this},o.prototype.destroy=function(){return t(this._delegate).off(".simple-hotkeys-"+this.id),this._map={},this},i=o,function(t){return new i(t)}}),function(r,n){"function"==typeof define&&define.amd?define("simditor",["jquery","simple-module","simple-hotkeys","simple-uploader"],function(t,e,i,o){return r.Simditor=n(t,e,i,o)}):"object"==typeof exports?module.exports=n(require("jquery"),require("simple-module"),require("simple-hotkeys"),require("simple-uploader")):r.Simditor=n(jQuery,SimpleModule,simple.hotkeys,simple.uploader)}(this,function(k,t,n,s){function e(t,e){for(var i in e)_.call(e,i)&&(t[i]=e[i]);function o(){this.constructor=t}return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t}var i,o,r,a,l,d,p,h,c,u,f,g,m,y,_={}.hasOwnProperty,v=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1},b=[].slice;function w(){return w.__super__.constructor.apply(this,arguments)}function x(){return x.__super__.constructor.apply(this,arguments)}function C(){return C.__super__.constructor.apply(this,arguments)}function T(){return T.__super__.constructor.apply(this,arguments)}function S(){return S.__super__.constructor.apply(this,arguments)}function N(){return N.__super__.constructor.apply(this,arguments)}function A(){return A.__super__.constructor.apply(this,arguments)}function E(){return E.__super__.constructor.apply(this,arguments)}function B(){return B.__super__.constructor.apply(this,arguments)}function R(){return R.__super__.constructor.apply(this,arguments)}function L(t){this.editor=t.editor,this.title=this._t(this.name),L.__super__.constructor.call(this,t)}function M(t){this.button=t.button,this.editor=t.button.editor,M.__super__.constructor.call(this,t)}function I(){return I.__super__.constructor.apply(this,arguments)}function P(){return P.__super__.constructor.apply(this,arguments)}function O(){return O.__super__.constructor.apply(this,arguments)}function j(){return j.__super__.constructor.apply(this,arguments)}function F(){return F.__super__.constructor.apply(this,arguments)}function z(){return z.__super__.constructor.apply(this,arguments)}function q(){return q.__super__.constructor.apply(this,arguments)}function W(){return W.__super__.constructor.apply(this,arguments)}function D(){return D.__super__.constructor.apply(this,arguments)}function H(){return H.__super__.constructor.apply(this,arguments)}function U(){return U.__super__.constructor.apply(this,arguments)}function K(){return K.__super__.constructor.apply(this,arguments)}function V(){return V.__super__.constructor.apply(this,arguments)}function X(){return X.__super__.constructor.apply(this,arguments)}function Q(){return Q.__super__.constructor.apply(this,arguments)}function J(){return J.__super__.constructor.apply(this,arguments)}function G(){return G.__super__.constructor.apply(this,arguments)}function Z(){return Z.__super__.constructor.apply(this,arguments)}function $(){return $.__super__.constructor.apply(this,arguments)}function Y(){return Y.__super__.constructor.apply(this,arguments)}function tt(){return tt.__super__.constructor.apply(this,arguments)}function et(){return et.__super__.constructor.apply(this,arguments)}return e(w,t),w.pluginName="Selection",w.prototype._range=null,w.prototype._startNodes=null,w.prototype._endNodes=null,w.prototype._containerNode=null,w.prototype._nodes=null,w.prototype._blockNodes=null,w.prototype._rootNodes=null,w.prototype._init=function(){var e,i;return this.editor=this._module,this._selection=document.getSelection(),this.editor.on("selectionchanged",(e=this,function(t){return e.reset(),e._range=e._selection.getRangeAt(0)})),this.editor.on("blur",(i=this,function(t){return i.reset()}))},w.prototype.reset=function(){return this._range=null,this._startNodes=null,this._endNodes=null,this._containerNode=null,this._nodes=null,this._blockNodes=null,this._rootNodes=null},w.prototype.clear=function(){try{this._selection.removeAllRanges()}catch(t){0}return this.reset()},w.prototype.range=function(t){return t?(this.clear(),this._selection.addRange(t),this._range=t,t=this.editor.util.browser.firefox||this.editor.util.browser.msie,!this.editor.inputManager.focused&&t&&this.editor.body.focus()):!this._range&&this.editor.inputManager.focused&&this._selection.rangeCount&&(this._range=this._selection.getRangeAt(0)),this._range},w.prototype.startNodes=function(){var e;return this._range&&(this._startNodes||(this._startNodes=(e=this,function(){var t=k(e._range.startContainer).parentsUntil(e.editor.body).get();return t.unshift(e._range.startContainer),k(t)}()))),this._startNodes},w.prototype.endNodes=function(){var t;return this._range&&(this._endNodes||(this._endNodes=this._range.collapsed?this.startNodes():((t=k(this._range.endContainer).parentsUntil(this.editor.body).get()).unshift(this._range.endContainer),k(t)))),this._endNodes},w.prototype.containerNode=function(){return this._range&&(this._containerNode||(this._containerNode=k(this._range.commonAncestorContainer))),this._containerNode},w.prototype.nodes=function(){var s;return this._range&&(this._nodes||(this._nodes=(s=this,function(){var n=[];return s.startNodes().first().is(s.endNodes().first())?n=s.startNodes().get():(s.startNodes().each(function(t,e){var i,o,r=k(e);return-1<s.endNodes().index(r)?n.push(e):r.parent().is(s.editor.body)||-1<(o=s.endNodes().index(r.parent()))?(e=o&&-1<o?s.endNodes().eq(o-1):s.endNodes().last(),o=(i=r.parent().contents()).index(r),e=i.index(e),k.merge(n,i.slice(o,e).get())):(r=(i=r.parent().contents()).index(r),k.merge(n,i.slice(r).get()))}),s.endNodes().each(function(t,e){var i=k(e);return i.parent().is(s.editor.body)||-1<s.startNodes().index(i.parent())?(n.push(e),!1):(i=(e=i.parent().contents()).index(i),k.merge(n,e.slice(0,i+1)))})),k(k.unique(n))}()))),this._nodes},w.prototype.blockNodes=function(){var i;if(this._range)return this._blockNodes||(this._blockNodes=(i=this).nodes().filter(function(t,e){return i.editor.util.isBlockNode(e)})),this._blockNodes},w.prototype.rootNodes=function(){var i;if(this._range)return this._rootNodes||(this._rootNodes=(i=this).nodes().filter(function(t,e){e=k(e).parent();return e.is(i.editor.body)||e.is("blockquote")})),this._rootNodes},w.prototype.rangeAtEndOf=function(t,e){var i,o,r,n,s;if((e=null==e?this.range():e)&&e.collapsed)return t=k(t)[0],o=e.endContainer,r=this.editor.util.getNodeLength(o),i=e.endOffset===r-1,n=k(o).contents().last().is("br"),r=e.endOffset===r,!!(i&&n||r)&&(t===o||!!k.contains(t,o)&&(s=!0,k(o).parentsUntil(t).addBack().each(function(t,e){var i=k(e).parent().contents().filter(function(){return!(this!==e&&3===this.nodeType&&!this.nodeValue)}).last(),o=i.get(0)===e,i=i.is("br")&&i.prev().get(0)===e;if(!o&&!i)return s=!1}),s))},w.prototype.rangeAtStartOf=function(t,e){var i,o;if((e=null==e?this.range():e)&&e.collapsed)return t=k(t)[0],o=e.startContainer,0===e.startOffset&&(t===o||!!k.contains(t,o)&&(i=!0,k(o).parentsUntil(t).addBack().each(function(t,e){if(k(e).parent().contents().filter(function(){return!(this!==e&&3===this.nodeType&&!this.nodeValue)}).first().get(0)!==e)return i=!1}),i))},w.prototype.insertNode=function(t,e){if(e=null==e?this.range():e)return t=k(t)[0],e.insertNode(t),this.setRangeAfter(t,e)},w.prototype.setRangeAfter=function(t,e){if(null!=(e=null==e?this.range():e))return t=k(t)[0],e.setEndAfter(t),e.collapse(!1),this.range(e)},w.prototype.setRangeBefore=function(t,e){if(null!=(e=null==e?this.range():e))return t=k(t)[0],e.setEndBefore(t),e.collapse(!1),this.range(e)},w.prototype.setRangeAtStartOf=function(t,e){return null==e&&(e=this.range()),t=k(t).get(0),e.setEnd(t,0),e.collapse(!1),this.range(e)},w.prototype.setRangeAtEndOf=function(t,e){var i,o,r;return null==e&&(e=this.range()),t=(o=k(t))[0],o.is("pre")?0<(o=o.contents()).length?(o=(r=o.last()).text(),i=this.editor.util.getNodeLength(r[0]),"\n"===o.charAt(o.length-1)?e.setEnd(r[0],i-1):e.setEnd(r[0],i)):e.setEnd(t,0):(r=this.editor.util.getNodeLength(t),3!==t.nodeType&&0<r&&((i=k(t).contents().last()).is("br")?--r:3!==i[0].nodeType&&this.editor.util.isEmptyNode(i)&&(i.append(this.editor.util.phBr),t=i[0],r=0)),e.setEnd(t,r)),e.collapse(!1),this.range(e)},w.prototype.deleteRangeContents=function(t){var e=(t=null==t?this.range():t).cloneRange(),i=t.cloneRange();return e.collapse(!0),i.collapse(!1),e=this.rangeAtStartOf(this.editor.body,e),i=this.rangeAtEndOf(this.editor.body,i),!t.collapsed&&e&&i?(this.editor.body.empty(),t.setStart(this.editor.body[0],0),t.collapse(!0),this.range(t)):t.deleteContents(),t},w.prototype.breakBlockEl=function(t,e){return null==e&&(e=this.range()),t=k(t),e.collapsed?(e.setStartBefore(t.get(0)),e.collapsed?t:t.before(e.extractContents())):t},w.prototype.save=function(t){var e,i,o;if(null==t&&(t=this.range()),!this._selectionSaved)return(i=t.cloneRange()).collapse(!1),o=k("<span/>").addClass("simditor-caret-start"),e=k("<span/>").addClass("simditor-caret-end"),i.insertNode(e[0]),t.insertNode(o[0]),this.clear(),this._selectionSaved=!0},w.prototype.restore=function(){var t,e,i,o,r,n,s;return!!this._selectionSaved&&(r=this.editor.body.find(".simditor-caret-start"),t=this.editor.body.find(".simditor-caret-end"),r.length&&t.length?(s=(n=r.parent()).contents().index(r),i=(e=t.parent()).contents().index(t),n[0]===e[0]&&--i,(o=document.createRange()).setStart(n.get(0),s),o.setEnd(e.get(0),i),r.remove(),t.remove(),this.range(o)):(r.remove(),t.remove()),this._selectionSaved=!1,o)},d=w,e(x,t),x.pluginName="Formatter",x.prototype.opts={allowedTags:[],allowedAttributes:{},allowedStyles:{}},x.prototype._init=function(){return this.editor=this._module,this._allowedTags=k.merge(["br","span","a","img","b","strong","i","strike","u","font","p","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","hr"],this.opts.allowedTags),this._allowedAttributes=k.extend({img:["src","alt","width","height","data-non-image"],a:["href","target","data-uid"],font:["color"],code:["class"]},this.opts.allowedAttributes),this._allowedStyles=k.extend({span:["color","font-size"],b:["color"],i:["color"],strong:["color"],strike:["color"],u:["color"],p:["margin-left","text-align"],h1:["margin-left","text-align"],h2:["margin-left","text-align"],h3:["margin-left","text-align"],h4:["margin-left","text-align"]},this.opts.allowedStyles),this.editor.body.on("click","a",function(t){return!1})},x.prototype.decorate=function(t){return null==t&&(t=this.editor.body),this.editor.trigger("decorate",[t]),t},x.prototype.undecorate=function(t){return null==t&&(t=this.editor.body.clone()),this.editor.trigger("undecorate",[t]),t},x.prototype.autolink=function(o){var t,r,e,i,n,s,a,l,d,p,h;for(null==o&&(o=this.editor.body),s=[],(r=function(t){return t.contents().each(function(t,e){var i=k(e);if(!i.is("a")&&!i.closest("a, pre",o).length)return!i.is("iframe")&&i.contents().length?r(i):(e=i.text())&&/https?:\/\/|www\./gi.test(e)?s.push(i):void 0})})(o),l=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,e=0,n=s.length;e<n;e++){for(p=(t=s[e]).text(),d=[],i=0;null!==(a=l.exec(p));)h=p.substring(i,a.index),d.push(document.createTextNode(h)),i=l.lastIndex,h=/^(http(s)?:\/\/|\/)/.test(a[0])?a[0]:"http://"+a[0],h=k('<a href="'+h+'" rel="nofollow"></a>').text(a[0]),d.push(h[0]);d.push(document.createTextNode(p.substring(i))),t.replaceWith(k(d))}return o},x.prototype.format=function(t){var e,i,o,r,n,s,a,l,d,p;if((t=null==t?this.editor.body:t).is(":empty"))return t.append("<p>"+this.editor.util.phBr+"</p>"),t;for(o=0,n=(d=t.contents()).length;o<n;o++)a=d[o],this.cleanNode(a,!0);for(r=0,s=(p=t.contents()).length;r<s;r++)l=p[r],(e=k(l)).is("br")?(null!=i&&(i=null),e.remove()):this.editor.util.isBlockNode(l)?e.is("li")?(i&&i.is("ul, ol")?i:i=k("<ul/>").insertBefore(l)).append(l):i=null:((i=!i||i.is("ul, ol")?k("<p/>").insertBefore(l):i).append(l),this.editor.util.isEmptyNode(i)&&i.append(this.editor.util.phBr));return t},x.prototype.cleanNode=function(t,e){var i,o,r,n,s,a,l,d,p,h,c,u,f,g=k(t);if(0<g.length){if(3!==g[0].nodeType){if(a=g.is("iframe")?null:g.contents(),t=this.editor.util.isDecoratedNode(g),g.is(this._allowedTags.join(","))||t){if(g.is("a")&&0<(o=g.find("img")).length&&(g.replaceWith(o),g=o,a=null),g.is("td")&&0<(i=g.find(this.editor.util.blockNodes.join(","))).length&&(i.each(function(t,e){return k(e).contents().unwrap()}),a=g.contents()),g.is("img")&&g.hasClass("uploading")&&g.remove(),!t){for(n=this._allowedAttributes[g[0].tagName.toLowerCase()],p=(u=k.makeArray(g[l=0].attributes)).length;l<p;l++)"style"!==(s=u[l]).name&&(null!=n&&(f=s.name,0<=v.call(n,f))||g.removeAttr(s.name));this._cleanNodeStyles(g),g.is("span")&&0===g[0].attributes.length&&g.contents().first().unwrap()}}else 1!==g[0].nodeType||g.is(":empty")?(g.remove(),a=null):g.is("div, article, dl, header, footer, tr")?(g.append("<br/>"),a.first().unwrap()):g.is("table")?(r=k("<p/>"),g.find("tr").each(function(t,e){return r.append(k(e).text()+"<br/>")}),g.replaceWith(r),a=null):g.is("thead, tfoot")?(g.remove(),a=null):g.is("th")?(t=k("<td/>").append(g.contents()),g.replaceWith(t)):a.first().unwrap();if(e&&null!=a&&!g.is("pre"))for(d=0,h=a.length;d<h;d++)c=a[d],this.cleanNode(c,!0);return null}(e=g.text().replace(/(\r\n|\n|\r)/gm,""))?(e=document.createTextNode(e),g.replaceWith(e)):g.remove()}},x.prototype._cleanNodeStyles=function(t){var e,i,o,r,n,s,a,l=t.attr("style");if(l){if(t.removeAttr("style"),!((e=this._allowedStyles[t[0].tagName.toLowerCase()])&&0<e.length))return t;for(a={},i=0,o=(n=l.split(";")).length;i<o;i++)s=n[i],(r=(s=k.trim(s)).split(":")).length=2,s=r[0],0<=v.call(e,s)&&(a[k.trim(r[0])]=k.trim(r[1]));return 0<Object.keys(a).length&&t.css(a),t}},x.prototype.clearHtml=function(t,o){var r,n,s;return null==o&&(o=!0),t=k("<div/>").append(t),r=t.contents(),n="",r.each((s=this,function(t,e){var i;return 3===e.nodeType?n+=e.nodeValue:1===e.nodeType&&((e=(i=k(e)).is("iframe")?null:i.contents())&&0<e.length&&(n+=s.clearHtml(e)),o&&t<r.length-1&&i.is("br, p, div, li,tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2,h3, h4, header"))?n+="\n":void 0})),n},x.prototype.beautify=function(t){var i=function(t){return!!(t.is("p")&&!t.text()&&t.children(":not(br)").length<1)};return t.each(function(t,e){e=k(e);return(e.is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')||i(e))&&e.remove(),e.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()})},p=x,e(C,t),C.pluginName="InputManager",C.prototype._modifierKeys=[16,17,18,91,93,224],C.prototype._arrowKeys=[37,38,39,40],C.prototype._init=function(){var t,e,i,o,r,n,s,a,l;return this.editor=this._module,this.throttledValueChanged=this.editor.util.throttle((e=this,function(t){return setTimeout(function(){return e.editor.trigger("valuechanged",t)},10)}),300),this.throttledSelectionChanged=this.editor.util.throttle((i=this,function(){return i.editor.trigger("selectionchanged")}),50),k(document).on("selectionchange.simditor"+this.editor.id,(o=this,function(t){var e;if(o.focused&&!o.editor.clipboard.pasting)return(e=function(){return o._selectionTimer&&(clearTimeout(o._selectionTimer),o._selectionTimer=null),0<o.editor.selection._selection.rangeCount?o.throttledSelectionChanged():o._selectionTimer=setTimeout(function(){if(o._selectionTimer=null,o.focused)return e()},10)})()})),this.editor.on("valuechanged",(r=this,function(){var t;if(r.lastCaretPosition=null,t=r.editor.body.children().filter(function(t,e){return r.editor.util.isBlockNode(e)}),r.focused&&0===t.length&&(r.editor.selection.save(),r.editor.formatter.format(),r.editor.selection.restore()),r.editor.body.find("hr, pre, .simditor-table").each(function(t,e){var i=k(e);if((i.parent().is("blockquote")||i.parent()[0]===r.editor.body[0])&&(e=!1,0===i.next().length&&(k("<p/>").append(r.editor.util.phBr).insertAfter(i),e=!0),0===i.prev().length&&(k("<p/>").append(r.editor.util.phBr).insertBefore(i),e=!0),e))return r.throttledValueChanged()}),r.editor.body.find("pre:empty").append(r.editor.util.phBr),!r.editor.util.support.onselectionchange&&r.focused)return r.throttledSelectionChanged()})),this.editor.body.on("keydown",k.proxy(this._onKeyDown,this)).on("keypress",k.proxy(this._onKeyPress,this)).on("keyup",k.proxy(this._onKeyUp,this)).on("mouseup",k.proxy(this._onMouseUp,this)).on("focus",k.proxy(this._onFocus,this)).on("blur",k.proxy(this._onBlur,this)).on("drop",k.proxy(this._onDrop,this)).on("input",k.proxy(this._onInput,this)),this.editor.util.browser.firefox&&(this.editor.hotkeys.add("cmd+left",(a=this,function(t){return t.preventDefault(),a.editor.selection._selection.modify("move","backward","lineboundary"),!1})),this.editor.hotkeys.add("cmd+right",(s=this,function(t){return t.preventDefault(),s.editor.selection._selection.modify("move","forward","lineboundary"),!1})),t=this.editor.util.os.mac?"cmd+a":"ctrl+a",this.editor.hotkeys.add(t,(n=this,function(t){var e,i,o=n.editor.body.children();if(0<o.length)return e=o.first().get(0),i=o.last().get(0),(o=document.createRange()).setStart(e,0),o.setEnd(i,n.editor.util.getNodeLength(i)),n.editor.selection.range(o),!1}))),t=this.editor.util.os.mac?"cmd+enter":"ctrl+enter",this.editor.hotkeys.add(t,(l=this,function(t){return l.editor.el.closest("form").find("button:submit").click(),!1}))},C.prototype._onFocus=function(t){var i;if(!this.editor.clipboard.pasting)return this.editor.el.addClass("focus").removeClass("error"),this.focused=!0,setTimeout((i=this,function(){var t,e=i.editor.selection._selection.getRangeAt(0);if(e.startContainer===i.editor.body[0]&&(i.lastCaretPosition?i.editor.undoManager.caretPosition(i.lastCaretPosition):(t=i.editor.body.children().first(),e=document.createRange(),i.editor.selection.setRangeAtStartOf(t,e))),i.lastCaretPosition=null,i.editor.triggerHandler("focus"),!i.editor.util.support.onselectionchange)return i.throttledSelectionChanged()}),0)},C.prototype._onBlur=function(t){var e;if(!this.editor.clipboard.pasting)return this.editor.el.removeClass("focus"),this.editor.sync(),this.focused=!1,this.lastCaretPosition=null!=(e=this.editor.undoManager.currentState())?e.caret:void 0,this.editor.triggerHandler("blur")},C.prototype._onMouseUp=function(t){if(!this.editor.util.support.onselectionchange)return this.throttledSelectionChanged()},C.prototype._onKeyDown=function(t){var e;return!1!==this.editor.triggerHandler(t)&&(this.editor.hotkeys.respondTo(t)?void 0:this.editor.keystroke.respondTo(t)?(this.throttledValueChanged(),!1):(e=t.which,0<=v.call(this._modifierKeys,e)||(e=t.which,0<=v.call(this._arrowKeys,e))||this.editor.util.metaKey(t)&&86===t.which?void 0:(this.editor.util.support.oninput||this.throttledValueChanged(["typing"]),null)))},C.prototype._onKeyPress=function(t){if(!1===this.editor.triggerHandler(t))return!1},C.prototype._onKeyUp=function(t){var e;if(!1===this.editor.triggerHandler(t))return!1;!this.editor.util.support.onselectionchange&&(e=t.which,0<=v.call(this._arrowKeys,e))?this.throttledValueChanged():8!==t.which&&46!==t.which||!this.editor.util.isEmptyNode(this.editor.body)||(this.editor.body.empty(),t=k("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body),this.editor.selection.setRangeAtStartOf(t))},C.prototype._onDrop=function(t){return!1!==this.editor.triggerHandler(t)&&this.throttledValueChanged()},C.prototype._onInput=function(t){return this.throttledValueChanged(["oninput"])},r=C,e(T,t),T.pluginName="Keystroke",T.prototype._init=function(){return this.editor=this._module,this._keystrokeHandlers={},this._initKeystrokeHandlers()},T.prototype.add=function(t,e,i){return t=t.toLowerCase(),t=this.editor.hotkeys.constructor.aliases[t]||t,this._keystrokeHandlers[t]||(this._keystrokeHandlers[t]={}),this._keystrokeHandlers[t][e]=i},T.prototype.respondTo=function(o){var r,n=null!=(e=this.editor.hotkeys.constructor.keyNameMap[o.which])?e.toLowerCase():void 0;if(n){var s,t=getSelection(),e=new Range;if(e.selectNode(o.target),"backspace"===n){var i=t.anchorNode.children,a=k(t.focusNode.parentElement);if(i)for(var l=i.length-1;0<=l;l--)if("br"!=i[l].nodeName.toLowerCase()){var d=t.getRangeAt(0).commonAncestorContainer.textContent.split(" "),p=d.length;0!=d[p-1].indexOf("@")&&0!=d[p-1].indexOf("#")||k(i[l]).empty();break}a.hasClass("simditor-mention")&&k(".simditor-mention-popover").is(":hidden")&&a.empty(),a.hasClass("todo_show")&&a.empty()}return!!(n in this._keystrokeHandlers&&((r="function"==typeof(a=this._keystrokeHandlers[n])["*"]?a["*"](o):void 0)||this.editor.selection.startNodes().each((s=this,function(t,e){var i;if(e.nodeType===Node.ELEMENT_NODE)return i=null!=(i=s._keystrokeHandlers[n])?i[e.tagName.toLowerCase()]:void 0,!0!==(r="function"==typeof i?i(o,k(e)):void 0)&&!1!==r&&void 0})),r))||void 0}},T.prototype._initKeystrokeHandlers=function(){var t,i,o,r,n,s,a,d,l,p;return this.editor.util.browser.safari&&this.add("enter","*",(i=this,function(t){var e;if(t.shiftKey&&!(e=i.editor.selection.blockNodes().last()).is("pre"))return t=k("<br/>"),i.editor.selection.rangeAtEndOf(e)?(i.editor.selection.insertNode(t),i.editor.selection.insertNode(k("<br/>")),i.editor.selection.setRangeBefore(t)):i.editor.selection.insertNode(t),!0})),(this.editor.util.browser.webkit||this.editor.util.browser.msie)&&(t=function(t,e){if(o.editor.selection.rangeAtEndOf(e))return e=k("<p/>").append(o.editor.util.phBr).insertAfter(e),o.editor.selection.setRangeAtStartOf(e),!0},(o=this).add("enter","h1",t),this.add("enter","h2",t),this.add("enter","h3",t),this.add("enter","h4",t),this.add("enter","h5",t),this.add("enter","h6",t)),this.add("backspace","*",(r=this,function(t){var e=r.editor.selection.rootNodes().first(),i=e.prev();return i.is("hr")&&r.editor.selection.rangeAtStartOf(e)?(r.editor.selection.save(),i.remove(),r.editor.selection.restore(),!0):(i=r.editor.selection.blockNodes().last(),r.editor.util.browser.webkit&&r.editor.selection.rangeAtStartOf(i)?(r.editor.selection.save(),r.editor.formatter.cleanNode(i,!0),r.editor.selection.restore(),null):void 0)})),this.add("enter","li",(n=this,function(t,e){var i,o,r=e.clone();if(r.find("ul, ol").remove(),n.editor.util.isEmptyNode(r)&&e.is(n.editor.selection.blockNodes().last())){if(r=e.parent(),0<e.next("li").length){if(!n.editor.util.isEmptyNode(e))return;0<r.parent("li").length?(i=k("<li/>").append(n.editor.util.phBr).insertAfter(r.parent("li")),o=k("<"+r[0].tagName+"/>").append(e.nextAll("li")),i.append(o)):(i=k("<p/>").append(n.editor.util.phBr).insertAfter(r),o=k("<"+r[0].tagName+"/>").append(e.nextAll("li")),i.after(o))}else 0<r.parent("li").length?(i=k("<li/>").insertAfter(r.parent("li")),0<e.contents().length?i.append(e.contents()):i.append(n.editor.util.phBr)):(i=k("<p/>").append(n.editor.util.phBr).insertAfter(r),0<e.children("ul, ol").length&&i.after(e.children("ul, ol")));return(e.prev("li").length?e:r).remove(),n.editor.selection.setRangeAtStartOf(i),!0}})),this.add("enter","pre",(s=this,function(t,e){var i;return t.preventDefault(),t.shiftKey?(i=k("<p/>").append(s.editor.util.phBr).insertAfter(e),s.editor.selection.setRangeAtStartOf(i)):(t=null,(i=s.editor.selection.range()).deleteContents(),!s.editor.util.browser.msie&&s.editor.selection.rangeAtEndOf(e)?(t=document.createTextNode("\n\n"),i.insertNode(t),i.setEnd(t,1)):(t=document.createTextNode("\n"),i.insertNode(t),i.setStartAfter(t)),i.collapse(!1),s.editor.selection.range(i)),!0})),this.add("enter","blockquote",(a=this,function(t,e){var i=a.editor.selection.blockNodes().last();if(i.is("p")&&!i.next().length&&a.editor.util.isEmptyNode(i))return e.after(i),e=document.createRange(),a.editor.selection.setRangeAtStartOf(i,e),!0})),this.add("backspace","li",(d=this,function(t,e){var i,o,r,n,s,a=e.children("ul, ol"),l=e.prev("li");return 0<a.length&&0<l.length&&(s="",o=null,e.contents().each(function(t,e){return(1!==e.nodeType||!/UL|OL/.test(e.nodeName))&&(1===e.nodeType&&/BR/.test(e.nodeName)?void 0:(3===e.nodeType&&e.nodeValue?s+=e.nodeValue:1===e.nodeType&&(s+=k(e).text()),o=k(e)))}),r=d.editor.util.browser.firefox&&!o.next("br").length,o&&1===s.length&&r?(i=k(d.editor.util.phBr).insertAfter(o),o.remove(),d.editor.selection.setRangeBefore(i),!0):!(0<s.length)&&(n=document.createRange(),0<(r=l.children("ul, ol")).length?(i=k("<li/>").append(d.editor.util.phBr).appendTo(r),r.append(a.children("li")),e.remove(),d.editor.selection.setRangeAtEndOf(i,n)):(d.editor.selection.setRangeAtEndOf(l,n),l.append(a),e.remove(),d.editor.selection.range(n)),!0))})),this.add("backspace","pre",(l=this,function(t,e){var i;if(l.editor.selection.rangeAtStartOf(e))return i=e.html().replace("\n","<br/>")||l.editor.util.phBr,i=k("<p/>").append(i).insertAfter(e),e.remove(),e=document.createRange(),l.editor.selection.setRangeAtStartOf(i,e),!0})),this.add("backspace","blockquote",(p=this,function(t,e){var i;if(p.editor.selection.rangeAtStartOf(e))return i=e.children().first().unwrap(),e=document.createRange(),p.editor.selection.setRangeAtStartOf(i,e),!0}))},a=T,e(S,t),S.pluginName="UndoManager",S.prototype._index=-1,S.prototype._capacity=20,S.prototype._startPosition=null,S.prototype._endPosition=null,S.prototype._init=function(){var t,e,i,o,r,n,s,a,l;return this.editor=this._module,this._stack=[],t=this.editor.util.os.mac?(e="cmd+z","shift+cmd+z"):this.editor.util.os.win?(e="ctrl+z","ctrl+y"):(e="ctrl+z","shift+ctrl+z"),this.editor.hotkeys.add(e,(i=this,function(t){return t.preventDefault(),i.undo(),!1})),this.editor.hotkeys.add(t,(o=this,function(t){return t.preventDefault(),o.redo(),!1})),this.throttledPushState=this.editor.util.throttle((r=this,function(){return r._pushUndoState()}),2e3),this.editor.on("valuechanged",(n=this,function(t,e){if("undo"!==e&&"redo"!==e)return n.throttledPushState()})),this.editor.on("selectionchanged",(s=this,function(t){return s.resetCaretPosition(),s.update()})),this.editor.on("focus",(a=this,function(t){if(0===a._stack.length)return a._pushUndoState()})),this.editor.on("blur",(l=this,function(t){return l.resetCaretPosition()}))},S.prototype.resetCaretPosition=function(){return this._startPosition=null,this._endPosition=null},S.prototype.startPosition=function(){return this.editor.selection._range&&(this._startPosition||(this._startPosition=this._getPosition("start"))),this._startPosition},S.prototype.endPosition=function(){var t;return this.editor.selection._range&&(this._endPosition||(this._endPosition=(t=this).editor.selection.range().collapsed?t._startPosition:t._getPosition("end"))),this._endPosition},S.prototype._pushUndoState=function(){if(!1!==this.editor.triggerHandler("pushundostate")&&this.caretPosition().start)return this._index+=1,this._stack.length=this._index,this._stack.push({html:this.editor.body.html(),caret:this.caretPosition()}),this._stack.length>this._capacity?(this._stack.shift(),--this._index):void 0},S.prototype.currentState=function(){return this._stack.length&&-1<this._index?this._stack[this._index]:null},S.prototype.undo=function(){var t;if(!(this._index<1||this._stack.length<2))return this.editor.hidePopover(),--this._index,t=this._stack[this._index],this.editor.body.get(0).innerHTML=t.html,this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},S.prototype.redo=function(){var t;if(!(this._index<0||this._stack.length<this._index+2))return this.editor.hidePopover(),this._index+=1,t=this._stack[this._index],this.editor.body.get(0).innerHTML=t.html,this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["redo"])},S.prototype.update=function(){var t=this.currentState();if(t)return t.html=this.editor.body.html(),t.caret=this.caretPosition()},S.prototype._getNodeOffset=function(i,o){var t=k.isNumeric(o)?k(i):k(i).parent(),r=0,n=!1;return t.contents().each(function(t,e){return i!==e&&(o!==t||0!==t)&&(e.nodeType===Node.TEXT_NODE?!n&&0<e.nodeValue.length&&(r+=1,n=!0):(r+=1,n=!1),o-1!==t&&null)}),r},S.prototype._getPosition=function(t){var e,i,o,r,n,s;if(null==t&&(t="start"),o=this.editor.selection.range()[t+"Offset"],(i=(e=this.editor.selection[t+"Nodes"]()).first()[0]).nodeType===Node.TEXT_NODE){for(n=i.previousSibling;n&&n.nodeType===Node.TEXT_NODE;)i=n,o+=this.editor.util.getNodeLength(n),n=n.previousSibling;(t=e.get())[0]=i,e=k(t)}else o=this._getNodeOffset(i,o);return r=[o],e.each((s=this,function(t,e){return r.unshift(s._getNodeOffset(e))})),r},S.prototype._getNodeByPosition=function(t){for(var e,i,o,r,n=this.editor.body[0],s=t.slice(0,t.length-1),a=o=0,l=s.length;o<l;a=++o){if((r=s[a])>(i=n.childNodes).length-1){if(a!==t.length-2||!k(n).is("pre:empty")){n=null;break}e=document.createTextNode(""),n.appendChild(e),i=n.childNodes}n=i[r]}return n},S.prototype.caretPosition=function(t){var e,i,o,r;if(!t)return i=this.editor.selection.range(),t=this.editor.inputManager.focused&&null!=i?{start:this.startPosition(),end:this.endPosition(),collapsed:i.collapsed}:{};if(t.start){if(o=this._getNodeByPosition(t.start),r=t.start[t.start.length-1],t=t.collapsed?(e=o,r):(e=this._getNodeByPosition(t.end),t.start[t.start.length-1]),o&&e)return(i=document.createRange()).setStart(o,r),i.setEnd(e,t),this.editor.selection.range(i);"undefined"!=typeof console&&null!==console&&"function"==typeof console.warn&&console.warn("simditor: invalid caret state")}},h=S,e(N,t),N.pluginName="Util",N.prototype._init=function(){if(this.editor=this._module,this.browser.msie&&this.browser.version<11)return this.phBr=""},N.prototype.phBr="<br/>",N.prototype.os=(y={},/Mac/.test(navigator.appVersion)?y.mac=!0:/Linux/.test(navigator.appVersion)?y.linux=!0:/Win/.test(navigator.appVersion)?y.win=!0:/X11/.test(navigator.appVersion)&&(y.unix=!0),/Mobi/.test(navigator.appVersion)&&(y.mobile=!0),y),N.prototype.browser=(c=navigator.userAgent,u=/(msie|trident)/i.test(c),f=/chrome|crios/i.test(c),g=/safari/i.test(c)&&!f,m=/firefox/i.test(c),y=/edge/i.test(c),u?{msie:!0,version:+(null!=(u=c.match(/(msie |rv:)(\d+(\.\d+)?)/i))?u[2]:void 0)}:y?{edge:!0,webkit:!0,version:+(null!=(y=c.match(/edge\/(\d+(\.\d+)?)/i))?y[1]:void 0)}:f?{webkit:!0,chrome:!0,version:+(null!=(f=c.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))?f[1]:void 0)}:g?{webkit:!0,safari:!0,version:+(null!=(g=c.match(/version\/(\d+(\.\d+)?)/i))?g[1]:void 0)}:m?{mozilla:!0,firefox:!0,version:+(null!=(c=c.match(/firefox\/(\d+(\.\d+)?)/i))?c[1]:void 0)}:{}),N.prototype.support={onselectionchange:function(){var t=document.onselectionchange;if(void 0!==t)try{return document.onselectionchange=0,null===document.onselectionchange}catch(t){0}finally{document.onselectionchange=t}return!1}(),oninput:!/(msie|trident)/i.test(navigator.userAgent)},N.prototype.reflow=function(t){return null==t&&(t=document),k(t)[0].offsetHeight},N.prototype.metaKey=function(t){return/Mac/.test(navigator.userAgent)?t.metaKey:t.ctrlKey},N.prototype.isEmptyNode=function(t){t=k(t);return t.is(":empty")||!t.text()&&!t.find(":not(br, span, div)").length},N.prototype.isDecoratedNode=function(t){return k(t).is('[class^="simditor-"]')},N.prototype.blockNodes=["div","p","ul","ol","li","blockquote","hr","pre","h1","h2","h3","h4","h5","table"],N.prototype.isBlockNode=function(t){return!(!(t=k(t)[0])||3===t.nodeType)&&new RegExp("^("+this.blockNodes.join("|")+")$").test(t.nodeName.toLowerCase())},N.prototype.getNodeLength=function(t){switch((t=k(t)[0]).nodeType){case 7:case 10:return 0;case 3:case 8:return t.length;default:return t.childNodes.length}},N.prototype.dataURLtoBlob=function(t){var e,i,o,r,n,s,a=window.Blob&&function(){try{return Boolean(new Blob)}catch(t){return!1}}(),l=a&&window.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(t){return!1}}(),d=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(!((a||d)&&window.atob&&window.ArrayBuffer&&window.Uint8Array))return!1;for(i=(0<=t.split(",")[0].indexOf("base64")?atob:decodeURIComponent)(t.split(",")[1]),e=new ArrayBuffer(i.length),r=new Uint8Array(e),o=n=0,s=i.length;0<=s?n<=s:s<=n;o=0<=s?++n:--n)r[o]=i.charCodeAt(o);return t=t.split(",")[0].split(":")[1].split(";")[0],a?new Blob([l?r:e],{type:t}):((d=new d).append(e),d.getBlob(t))},N.prototype.throttle=function(t,e){var i,o,r=0,n=0,s=i=o=null,a=function(){return n=0,r=+new Date,o=t.apply(s,i),i=s=null},l=function(){var t;return s=this,i=arguments,t=new Date-r,n||(e<=t?a():n=setTimeout(a,e-t)),o};return l.clear=function(){if(n)return clearTimeout(n),a()},l},N.prototype.formatHTML=function(t){for(var e,i,o=/<(\/?)(.+?)(\/?)>/g,r="",n=0,s=null,a=function(t,e){return new Array(e+1).join(t)};null!==(e=o.exec(t));)e.isBlockNode=-1<k.inArray(e[2],this.blockNodes),e.isStartTag="/"!==e[1]&&"/"!==e[3],e.isEndTag="/"===e[1]||"/"===e[3],i=s?s.index+s[0].length:0,0<(i=t.substring(i,e.index)).length&&k.trim(i)&&(r+=i),e.isBlockNode&&e.isEndTag&&!e.isStartTag&&--n,e.isBlockNode&&e.isStartTag&&(s&&s.isBlockNode&&s.isEndTag||(r+="\n"),r+=a("  ",n)),r+=e[0],e.isBlockNode&&e.isEndTag&&(r+="\n"),e.isBlockNode&&e.isStartTag&&(n+=1),s=e;return k.trim(r)},f=N,e(A,t),A.pluginName="Toolbar",A.prototype.opts={toolbar:!0,toolbarFloat:!0,toolbarHidden:!1,toolbarFloatOffset:0},A.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'},A.prototype._fields={wrapper:'<div class="simditor-fields"><ul></ul></div>'},A.prototype._retask={wrapper:'<div class="simditor-retask"><div class="retask_header"><div class="aign-left ed_task_id"></div><div class="aign-left ed_task_name">'+StrackLang.task_name+'</div><div class="aign-left ed_step">'+StrackLang.Steps+'</div><div class="aign-left ed_status">'+StrackLang.Status+'</div><div class="aign-left ed_assigned">'+StrackLang.Assignee+"</div></div><form></form></div>"},A.prototype._rethumb={wrapper:'<div class="simditor-rethumb"></div>'},A.prototype._footer={wrapper:'<div class="simditor-footer"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'},A.prototype._init=function(){var r,n,s,e,i,a,t,o,l;if(this.editor=this._module,this.opts.toolbar)return k.isArray(this.opts.toolbar)||(this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]),this._render(),this.list.on("click",function(t){return!1}),this.wrapper.on("mousedown",(e=this,function(t){return e.list.find(".menu-on").removeClass(".menu-on")})),k(document).on("mousedown.simditor"+this.editor.id,(i=this,function(t){return i.list.find(".menu-on").removeClass(".menu-on")})),!this.opts.toolbarHidden&&this.opts.toolbarFloat&&(this.wrapper.css("top",this.opts.toolbarFloatOffset),s=0,t=this,n=function(){return t.wrapper.css("position","static"),t.wrapper.width("auto"),t.editor.util.reflow(t.wrapper),t.wrapper.width(t.wrapper.outerWidth()),t.wrapper.css("left",(t.editor.util.os.mobile?t.wrapper.position():t.wrapper.offset()).left),t.wrapper.css("position",""),s=t.wrapper.outerHeight(),t.editor.placeholderEl.css("top",s),!0},r=null,k(window).on("resize.simditor-"+this.editor.id,function(t){return r=n()}),k(window).on("scroll.simditor-"+this.editor.id,(a=this,function(t){var e,i,o;if(a.wrapper.is(":visible"))if(e=(o=a.editor.wrapper.offset().top)+a.editor.wrapper.outerHeight()-80,(i=k(document).scrollTop()+a.opts.toolbarFloatOffset)<=o||e<=i){if(a.editor.wrapper.removeClass("toolbar-floating").css("padding-top",""),a.editor.util.os.mobile)return a.wrapper.css("top",a.opts.toolbarFloatOffset)}else if(r=r||n(),a.editor.wrapper.addClass("toolbar-floating").css("padding-top",s),a.editor.util.os.mobile)return a.wrapper.css("top",i-o+a.opts.toolbarFloatOffset)}))),this.editor.on("destroy",(o=this,function(){return o.buttons.length=0})),k(document).on("mousedown.simditor-"+this.editor.id,(l=this,function(t){return l.list.find("li.menu-on").removeClass("menu-on")}))},A.prototype._render=function(){var t,e,i,o;for(this.buttons=[],this.wrapper=k(this._tpl.wrapper).prependTo(this.editor.wrapper),this.wrapperfields=k(this._fields.wrapper).appendTo(this.editor.wrapper),0==this.opts.toolbartype&&(this.wrapperretask=k(this._retask.wrapper).appendTo(this.editor.wrapper)),this.wrapperrethumb=k(this._rethumb.wrapper).appendTo(this.editor.wrapper),this.wrapperfoot=k(this._footer.wrapper).appendTo(this.editor.wrapper),this.list=this.wrapper.find("ul"),this.fieldslist=this.wrapperfields.find("ul"),this.flist=this.wrapperfoot.find("ul"),t=0,e=(o=this.opts.toolbar).length;t<e;t++)if("|"!==(i=o[t])){if(!this.constructor.buttons[i])throw new Error("simditor: invalid toolbar button "+i);this.buttons.push(new this.constructor.buttons[i]({editor:this.editor}))}else k(this._tpl.separator).appendTo(this.list);0==this.opts.toolbartype&&this.wrapperretask.find("form").addClass("ed_retask_"+this.opts.toolbartype),this.wrapperrethumb.addClass("ed_rethumb_"+this.opts.toolbartype);var r="";if(this.opts.footer_control&&(r+='<a  class="toolbar-foot-item" href="javascript:;" onclick="Strack.click_editor_footer(this);" toolbar_type="'+this.opts.toolbartype+'" toolbar_area="stick" lang="'+StrackLang.Stick+'"><span class="icon-uniF08D"></span></a>',r+='<a  class="toolbar-foot-item" href="javascript:;" onclick="Strack.click_editor_footer(this);" toolbar_type="'+this.opts.toolbartype+'" toolbar_area="status" lang="'+StrackLang.Status+'"><span class="icon-uniF042"></span></a>',r+='<a  class="toolbar-foot-item" href="javascript:;" onclick="Strack.click_editor_footer(this);" toolbar_type="'+this.opts.toolbartype+'" toolbar_area="tag" lang="'+StrackLang.Tag+'"><span class="icon-uniE950"></span></a>',"base"===this.opts.module_type&&(r+='<a  class="toolbar-foot-item" href="javascript:;" onclick="Strack.click_editor_footer(this);" toolbar_type="'+this.opts.toolbartype+'" toolbar_area="version" lang="'+StrackLang.Version+'"><span class="icon-uniE7092"></span></a>'),r+='<a  class="toolbar-foot-item" href="javascript:;" onclick="Strack.click_editor_footer(this);" toolbar_type="'+this.opts.toolbartype+'" toolbar_area="image" edit_mode="'+this.opts.edit_mode+'" list_class="'+this.opts.list_class+'" ><span class="icon-uniE61A"></span></a>'),"dialog"!==this.opts.from&&(r+='<div class="st-editor-footer">',r+='<a href="javascript:;" class="st-edit-button button-dgcel" onclick="Strack.close_note(this);" toolbar_type="'+this.opts.toolbartype+'" style="margin-right:5px">'+StrackLang.Cancel+"</a>",r+='<a href="javascript:;" class="st-edit-button button-dgsub" onclick="Strack.add_note(this);" toolbar_type="'+this.opts.toolbartype+'" list_class="'+this.opts.list_class+'">'+StrackLang.Submit+"</a>",r+="</div>"),this.flist.append(r),this.wrapper.addClass("toolbar_"+this.opts.toolbartype),this.wrapperfields.addClass("fieldsbar_"+this.opts.toolbartype),this.wrapperfoot.addClass("toolbar_"+this.opts.toolbartype),k(".ui.dropdown").dropdown({on:"hover"}),this.opts.toolbarHidden)return this.wrapper.hide(),this.wrapperfoot.hide(),!0},A.prototype.findButton=function(t){t=this.list.find(".toolbar-item-"+t).data("button");return null!=t?t:null},A.addButton=function(t){return this.buttons[t.prototype.name]=t},A.buttons={},g=A,e(E,t),E.pluginName="Indentation",E.prototype.opts={tabIndent:!0},E.prototype._init=function(){return this.editor=this._module,this.editor.keystroke.add("tab","*",(i=this,function(t){var e=i.editor.toolbar.findButton("code");if(i.opts.tabIndent||e&&e.active)return i.indent(t.shiftKey)}));var i},E.prototype.indent=function(i){this.editor.selection.startNodes(),this.editor.selection.endNodes();var o,r,t=this.editor.selection.blockNodes(),a=[];return t=t.each(function(t,e){for(var i,o,r=!0,n=i=0,s=a.length;i<s;n=++i){if(o=a[n],k.contains(e,o)){r=!1;break}if(k.contains(o,e)){a.splice(n,1,e),r=!1;break}}if(r)return a.push(e)}),t=k(a),o=!1,t.each((r=this,function(t,e){e=i?r.outdentBlock(e):r.indentBlock(e);if(e)return o=e})),o},E.prototype.indentBlock=function(t){var e,i,o,r,t=k(t);if(t.length){if(t.is("pre")){if(!(i=this.editor.selection.containerNode()).is(t)&&!i.closest("pre").is(t))return;this.indentText(this.editor.selection.range())}else if(t.is("li")){if((e=t.prev("li")).length<1)return;this.editor.selection.save(),r=t.parent()[0].tagName,0<(i=e.children("ul, ol")).length?i.append(t):k("<"+r+"/>").append(t).appendTo(e),this.editor.selection.restore()}else if(t.is("p, h1, h2, h3, h4"))o=parseInt(t.css("margin-left"))||0,o=(Math.round(o/this.opts.indentWidth)+1)*this.opts.indentWidth,t.css("margin-left",o);else{if(!t.is("table")&&!t.is(".simditor-table"))return!1;if(0<(e=(r=this.editor.selection.containerNode().closest("td, th")).next("td, th")).length||(e=(t=(t=(o=r.parent("tr")).next("tr")).length<1&&o.parent().is("thead")?o.parent("thead").next("tbody").find("tr:first"):t).find("td:first, th:first")),!(0<r.length&&0<e.length))return;this.editor.selection.setRangeAtEndOf(e)}return!0}},E.prototype.indentText=function(t){var e=t.toString().replace(/^(?=.+)/gm,"  "),i=document.createTextNode(e||"  ");return t.deleteContents(),t.insertNode(i),e?(t.selectNode(i),this.editor.selection.range(t)):this.editor.selection.setRangeAfter(i)},E.prototype.outdentBlock=function(t){var e,i,o,r,n=k(t);if(n&&0<n.length){if(n.is("pre")){if(!(t=this.editor.selection.containerNode()).is(n)&&!t.closest("pre").is(n))return;this.outdentText(r)}else if(n.is("li"))i=(e=n.parent()).parent("li"),this.editor.selection.save(),i.length<1?((r=document.createRange()).setStartBefore(e[0]),r.setEndBefore(n[0]),e.before(r.extractContents()),k("<p/>").insertBefore(e).after(n.children("ul, ol")).append(n.contents()),n.remove()):(0<n.next("li").length&&k("<"+e[0].tagName+"/>").append(n.nextAll("li")).appendTo(n),n.insertAfter(i),e.children("li").length<1&&e.remove()),this.editor.selection.restore();else if(n.is("p, h1, h2, h3, h4"))o=parseInt(n.css("margin-left"))||0,o=Math.max(Math.round(o/this.opts.indentWidth)-1,0)*this.opts.indentWidth,n.css("margin-left",0==o?"":o);else{if(!n.is("table")&&!n.is(".simditor-table"))return!1;if(0<(e=(i=this.editor.selection.containerNode().closest("td, th")).prev("td, th")).length||(e=(n=(n=(o=i.parent("tr")).prev("tr")).length<1&&o.parent().is("tbody")?o.parent("tbody").prev("thead").find("tr:first"):n).find("td:last, th:last")),!(0<i.length&&0<e.length))return;this.editor.selection.setRangeAtEndOf(e)}return!0}},E.prototype.outdentText=function(t){},m=E,e(B,t),B.pluginName="Clipboard",B.prototype.opts={pasteImage:!1,cleanPaste:!1},B.prototype._init=function(){return this.editor=this._module,this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this.editor.body.on("paste",(i=this,function(t){var e;if(!i.pasting&&!i._pasteBin)return!1!==i.editor.triggerHandler(t)&&(e=i.editor.selection.deleteRangeContents(),i.editor.body.html()?e.collapsed||e.collapse(!0):(i.editor.formatter.format(),i.editor.selection.setRangeAtStartOf(i.editor.body.find("p:first"))),!i._processPasteByClipboardApi(t)&&(i.editor.inputManager.throttledValueChanged.clear(),i.editor.inputManager.throttledSelectionChanged.clear(),i.editor.undoManager.throttledPushState.clear(),i.editor.selection.reset(),i.editor.undoManager.resetCaretPosition(),i.pasting=!0,i._getPasteContent(function(t){return i._processPasteContent(t),i._pasteInBlockEl=null,i._pastePlainText=null,i.pasting=!1})))}));var i},B.prototype._processPasteByClipboardApi=function(t){var e,i;if(!this.editor.util.browser.edge)return t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items&&0<t.originalEvent.clipboardData.items.length&&(i=t.originalEvent.clipboardData.items[0],/^image\//.test(i.type)&&null!=(e=i.getAsFile())&&this.opts.pasteImage&&(e.name||(e.name="Clipboard Image.png"),!1!==this.editor.triggerHandler("pasting",[e])))?((t={})[this.opts.pasteImage]=!0,null!=(i=this.editor.uploader)&&i.upload(e,t),!0):void 0},B.prototype._getPasteContent=function(e){var i,o;return this._pasteBin=k('<div contenteditable="true" />').addClass("simditor-paste-bin").attr("tabIndex","-1").appendTo(this.editor.el),i={html:this.editor.body.html(),caret:this.editor.undoManager.caretPosition()},this._pasteBin.focus(),setTimeout((o=this,function(){var t;return o.editor.hidePopover(),o.editor.body.get(0).innerHTML=i.html,o.editor.undoManager.caretPosition(i.caret),o.editor.body.focus(),o.editor.selection.reset(),o.editor.selection.range(),o._pasteInBlockEl=o.editor.selection.blockNodes().last(),o._pastePlainText=o.opts.cleanPaste||o._pasteInBlockEl.is("pre, table"),t=o._pastePlainText?o.editor.formatter.clearHtml(o._pasteBin.html(),!0):((t=k("<div/>").append(o._pasteBin.contents())).find("table colgroup").remove(),o.editor.formatter.format(t),o.editor.formatter.decorate(t),o.editor.formatter.beautify(t.children()),t.contents()),o._pasteBin.remove(),o._pasteBin=null,e(t)}),0)},B.prototype._processPasteContent=function(t){var e,i,o,r,n,s,a,l,d,p,h,c,u,f,g,m,y,_,v,b,w;if(!1!==this.editor.triggerHandler("pasting",[t])&&(e=this._pasteInBlockEl,t)){if(this._pastePlainText)if(e.is("table")){for(v=(u=t.split("\n")).pop(),n=0,a=u.length;n<a;n++)c=u[n],this.editor.selection.insertNode(document.createTextNode(c)),this.editor.selection.insertNode(k("<br/>"));this.editor.selection.insertNode(document.createTextNode(v))}else for(s=0,l=(_=(t=k("<div/>").text(t)).contents()).length;s<l;s++)g=_[s],this.editor.selection.insertNode(k(g)[0]);else if(e.is(this.editor.body))for(f=0,d=t.length;f<d;f++)g=t[f],this.editor.selection.insertNode(g);else{if(t.length<1)return;if(1===t.length)if(t.is("p")){if(1===(r=t.contents()).length&&r.is("img")){if(i=r,/^data:image/.test(i.attr("src")))return this.opts.pasteImage?((o=this.editor.util.dataURLtoBlob(i.attr("src"))).name="Clipboard Image.png",(w={})[this.opts.pasteImage]=!0,void(null!=(v=this.editor.uploader)&&v.upload(o,w))):void 0;if(i.is('img[src^="webkit-fake-url://"]'))return}for(m=0,p=r.length;m<p;m++)g=r[m],this.editor.selection.insertNode(g)}else if(e.is("p")&&this.editor.util.isEmptyNode(e))e.replaceWith(t),this.editor.selection.setRangeAtEndOf(t);else if(t.is("ul, ol"))if(1===t.find("li").length)for(y=0,h=(b=(t=k("<div/>").text(t.text())).contents()).length;y<h;y++)g=b[y],this.editor.selection.insertNode(k(g)[0]);else(e.is("li")?e.parent():e).after(t),this.editor.selection.setRangeAtEndOf(t);else e.after(t),this.editor.selection.setRangeAtEndOf(t);else(e=e.is("li")?e.parent():e)[this.editor.selection.rangeAtStartOf(e)?"before":this.editor.selection.rangeAtEndOf(e)?"after":(this.editor.selection.breakBlockEl(e),"before")](t),this.editor.selection.setRangeAtEndOf(t.last())}return this.editor.inputManager.throttledValueChanged()}},c=B,e(R,t),R.connect(f),R.connect(r),R.connect(d),R.connect(h),R.connect(a),R.connect(p),R.connect(g),R.connect(m),R.connect(c),R.count=0,R.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1,indentWidth:40},R.prototype._init=function(){var t,e,i,o,r;if(this.textarea=k(this.opts.textarea),this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder"),!this.textarea.length)throw new Error("simditor: param textarea is required.");if(null!=(t=this.textarea.data("simditor"))&&t.destroy(),this.id=++R.count,this._render(),!n)throw new Error("simditor: simple-hotkeys is required.");if(this.hotkeys=n({el:this.body}),this.opts.upload&&s&&(e="object"==typeof this.opts.upload?this.opts.upload:{},this.uploader=s(e)),(e=this.textarea.closest("form")).length&&(e.on("submit.simditor-"+this.id,(o=this,function(){return o.sync()})),e.on("reset.simditor-"+this.id,(i=this,function(){return i.setValue("")}))),this.on("initialized",(r=this,function(){if(r.opts.placeholder&&r.on("valuechanged",function(){return r._placeholder()}),r.setValue(r.textarea.val().trim()||""),r.textarea.attr("autofocus"))return r.focus()})),this.util.browser.mozilla){this.util.reflow();try{return document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(t){}}},R.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>',R.prototype._render=function(){var t,e,i,o;if(this.el=k(this._tpl).insertBefore(this.textarea),this.wrapper=this.el.find(".simditor-wrapper"),this.body=this.wrapper.find(".simditor-body"),this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder),this.el.data("simditor",this),this.wrapper.append(this.textarea),this.textarea.data("simditor",this).blur(),this.body.attr("tabindex",this.textarea.attr("tabindex")),this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux"),this.util.os.mobile&&this.el.addClass("simditor-mobile"),this.opts.params){for(t in i=[],e=this.opts.params)o=e[t],i.push(k("<input/>",{type:"hidden",name:t,value:o}).insertAfter(this.textarea));return i}},R.prototype._placeholder=function(){var t=this.body.children();return 0===t.length||1===t.length&&this.util.isEmptyNode(t)&&parseInt(t.css("margin-left")||0)<this.opts.indentWidth?this.placeholderEl.show():this.placeholderEl.hide()},R.prototype.setValue=function(t){return this.hidePopover(),this.textarea.val(t),this.body.get(0).innerHTML=t,this.formatter.format(),this.formatter.decorate(),this.util.reflow(this.body),this.inputManager.lastCaretPosition=null,this.trigger("valuechanged")},R.prototype.getValue=function(){return this.sync()},R.prototype.sync=function(){var t,e,i,o,r=this.body.clone();for(this.formatter.undecorate(r),this.formatter.format(r),this.formatter.autolink(r),o=(t=r.children()).last("p"),i=t.first("p");o.is("p")&&this.util.isEmptyNode(o);)o=(e=o).prev("p"),e.remove();for(;i.is("p")&&this.util.isEmptyNode(i);)e=i,i=o.next("p"),e.remove();return r.find("img.uploading").remove(),r=k.trim(r.html()),this.textarea.val(r),r},R.prototype.focus=function(){var t,e;if(this.body.is(":visible")&&this.body.is("[contenteditable]"))return this.inputManager.lastCaretPosition?(this.undoManager.caretPosition(this.inputManager.lastCaretPosition),this.inputManager.lastCaretPosition=null):((t=this.body.children().last()).is("p")||(t=k("<p/>").append(this.util.phBr).appendTo(this.body)),e=document.createRange(),this.selection.setRangeAtEndOf(t,e));this.el.find("textarea:visible").focus()},R.prototype.blur=function(){return(this.body.is(":visible")&&this.body.is("[contenteditable]")?this.body:this.body.find("textarea:visible")).blur()},R.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(t,e){if((e=k(e).data("popover")).active)return e.hide()})},R.prototype.destroy=function(){return this.triggerHandler("destroy"),this.textarea.closest("form").off(".simditor .simditor-"+this.id),this.selection.clear(),this.inputManager.focused=!1,this.textarea.insertBefore(this.el).hide().val("").removeData("simditor"),this.el.remove(),k(document).off(".simditor-"+this.id),k(window).off(".simditor-"+this.id),this.off()},(p=R).i18n={"zh-CN":{bold:StrackLang.Bold,link:StrackLang.Todo_Select,code:StrackLang.Insert_Code,color:StrackLang.Text_Color,coloredText:StrackLang.Colored_Text,hr:StrackLang.Horiz_Line,image:StrackLang.Insert_Image,externalImage:StrackLang.External_Image,uploadImage:StrackLang.Upload_Image,uploadFailed:StrackLang.Upload_Failed,uploadError:StrackLang.Upload_Error,imageUrl:StrackLang.Image_Url,imageSize:StrackLang.Image_Size,imageAlt:StrackLang.Image_Alt,restoreImageSize:StrackLang.Restore_Image_Size,uploading:StrackLang.Uploading,indent:StrackLang.Indent,outdent:StrackLang.Outdent,italic:StrackLang.Italic,ol:StrackLang.Ordered_List,ul:StrackLang.Unordered_List,strikethrough:StrackLang.Strikethrough,table:StrackLang.Table,deleteRow:StrackLang.Delete_Row,insertRowAbove:StrackLang.Insert_Row_Above,insertRowBelow:StrackLang.Insert_Row_Below,deleteColumn:StrackLang.Delete_Column,insertColumnLeft:StrackLang.Insert_Column_Left,insertColumnRight:StrackLang.Insert_Column_Right,deleteTable:StrackLang.Delete_Table,title:StrackLang.Title,normalText:StrackLang.Normal_Text,underline:StrackLang.Underline,alignment:StrackLang.Alignment,alignCenter:StrackLang.Align_Center,alignLeft:StrackLang.Align_Left,alignRight:StrackLang.Align_Right,selectLanguage:StrackLang.Select_Language,fontScale:StrackLang.Font_Scale,fontScaleXLarge:StrackLang.Font_Scale_XLarge,fontScaleLarge:StrackLang.Font_Scale_Large,fontScaleNormal:StrackLang.Font_Scale_Normal,fontScaleSmall:StrackLang.Font_Scale_Small,fontScaleXSmall:StrackLang.Font_Scale_XSmall}},e(L,t),L.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menufooterWrapper:'<div class="footbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'},L.prototype.name="",L.prototype.icon="",L.prototype.title="",L.prototype.text="",L.prototype.htmlTag="",L.prototype.disableTag="",L.prototype.menu=!1,L.prototype.active=!1,L.prototype.disabled=!1,L.prototype.needFocus=!0,L.prototype.shortcut=null,L.prototype._init=function(){var t,e,i,o,r,n,s,a,l;for(this.render(),this.el.on("mousedown",(r=this,function(t){return t.preventDefault(),t=r.needFocus&&!r.editor.inputManager.focused,r.el.hasClass("disabled")||t||(r.menu?(r.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on"),r.wrapper.is(".menu-on")&&(0<r.menuWrapper.offset().left+r.menuWrapper.outerWidth()+5-r.editor.wrapper.offset().left-r.editor.wrapper.outerWidth()&&r.menuWrapper.css({left:"auto",right:0}),r.trigger("menuexpand"))):(t=r.el.data("param"),r.command(t))),!1})),this.wrapper.on("click","a.menu-item",(n=this,function(t){var e;return t.preventDefault(),e=k(t.currentTarget),n.wrapper.removeClass("menu-on"),t=n.needFocus&&!n.editor.inputManager.focused,e.hasClass("disabled")||t||(n.editor.toolbar.wrapper.removeClass("menu-on"),e=e.data("param"),n.command(e)),!1})),this.wrapper.on("mousedown","a.menu-item",function(t){return!1}),this.editor.on("blur",(s=this,function(){if(s.editor.body.is(":visible")&&s.editor.body.is("[contenteditable]")&&!s.editor.clipboard.pasting)return s.setActive(!1),s.setDisabled(!1)})),null!=this.shortcut&&this.editor.hotkeys.add(this.shortcut,(a=this,function(t){return a.el.mousedown(),!1})),t=0,e=(i=this.htmlTag.split(",")).length;t<e;t++)o=i[t],(o=k.trim(o))&&k.inArray(o,this.editor.formatter._allowedTags)<0&&this.editor.formatter._allowedTags.push(o);return this.editor.on("selectionchanged",(l=this,function(t){if(l.editor.inputManager.focused)return l._status()}))},L.prototype.iconClassOf=function(t){return t?"simditor-icon icon-"+t:""},L.prototype.setIcon=function(t){return this.el.find("span").removeClass().addClass(this.iconClassOf(t)).text(this.text)},L.prototype.render=function(){if(this.wrapper=k(this._tpl.item).appendTo(this.editor.toolbar.list),this.el=this.wrapper.find("a.toolbar-item"),this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this),this.setIcon(this.icon),this.menu)return this.menuWrapper=k(this._tpl.menuWrapper).appendTo(this.wrapper),this.menuWrapper.addClass("toolbar-menu-"+this.name),this.renderMenu()},L.prototype.renderMenu=function(){var t,e,i,o,r,n;if(k.isArray(this.menu)){for(this.menuEl=k("<ul/>").appendTo(this.menuWrapper),n=[],t=0,e=(o=this.menu).length;t<e;t++)"|"!==(i=o[t])?(r=k(this._tpl.menuItem).appendTo(this.menuEl).find("a.menu-item").attr({title:null!=(r=i.title)?r:i.text,"data-param":i.param}).addClass("menu-item-"+i.name),i.icon?n.push(r.find("span").addClass(this.iconClassOf(i.icon))):n.push(r.find("span").text(i.text))):k(this._tpl.separator).appendTo(this.menuEl);return n}},L.prototype.setActive=function(t){if(t!==this.active)return this.active=t,this.el.toggleClass("active",this.active)},L.prototype.setDisabled=function(t){if(t!==this.disabled)return this.disabled=t,this.el.toggleClass("disabled",this.disabled)},L.prototype._disableStatus=function(){var t=this.editor.selection.startNodes(),e=this.editor.selection.endNodes(),e=0<t.filter(this.disableTag).length||0<e.filter(this.disableTag).length;return this.setDisabled(e),this.disabled&&this.setActive(!1),this.disabled},L.prototype._activeStatus=function(){var t=this.editor.selection.startNodes(),e=this.editor.selection.endNodes(),t=t.filter(this.htmlTag),e=e.filter(this.htmlTag),e=0<t.length&&0<e.length&&t.is(e);return this.node=e?t:null,this.setActive(e),this.active},L.prototype._status=function(){if(this._disableStatus(),!this.disabled)return this._activeStatus()},L.prototype.command=function(t){},L.prototype._t=function(){var t,e=1<=arguments.length?b.call(arguments,0):[],i=L.__super__._t.apply(this,e);return i=i||(t=this.editor)._t.apply(t,e)},p.Button=g=L,e(M,t),M.prototype.offset={top:4,left:0},M.prototype.target=null,M.prototype.active=!1,M.prototype._init=function(){var e,i;return this.el=k('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this),this.render(),this.el.on("mouseenter",(e=this,function(t){return e.el.addClass("hover")})),this.el.on("mouseleave",(i=this,function(t){return i.el.removeClass("hover")}))},M.prototype.render=function(){},M.prototype._initLabelWidth=function(){var i,t=this.el.find(".settings-field");if(0<t.length)return this._labelWidth=0,t.each((i=this,function(t,e){e=k(e).find("label");if(0<e.length)return i._labelWidth=Math.max(i._labelWidth,e.width())})),t.find("label").width(this._labelWidth)},M.prototype.show=function(t,e){if(!k(t).hasClass("simditor-mention")&&(null==e&&(e="bottom"),null!=t))return this.el.siblings(".simditor-popover").each(function(t,e){if((e=k(e).data("popover")).active)return e.hide()}),this.active&&this.target&&this.target.removeClass("selected"),this.target=t.addClass("selected"),this.active||(this.active=!0,this.el.css({left:-9999}).show(),this._labelWidth||this._initLabelWidth()),this.refresh(e),this.trigger("popovershow")},M.prototype.hide=function(){if(this.active)return this.target&&this.target.removeClass("selected"),this.target=null,this.active=!1,this.el.hide(),this.trigger("popoverhide")},M.prototype.refresh=function(t){var e,i,o,r;if(null==t&&(t="bottom"),this.active)return e=this.editor.el.offset(),o=this.target.offset(),i=this.target.outerHeight(),"bottom"===t?r=o.top-e.top+i:"top"===t&&(r=o.top-e.top-this.el.height()),t=this.editor.wrapper.width()-this.el.outerWidth()-10,t=Math.min(o.left-e.left,t),this.el.css({top:r+this.offset.top,left:t+this.offset.left})},M.prototype.destroy=function(){return this.target=null,this.active=!1,this.editor.off(".linkpopover"),this.el.remove()},M.prototype._t=function(){var t,e=1<=arguments.length?b.call(arguments,0):[],i=M.__super__._t.apply(this,e);return i=i||(t=this.button)._t.apply(t,e)},p.Popover=m=M,e(I,g),I.prototype.name="title",I.prototype.htmlTag="h1, h2, h3, h4, h5",I.prototype.disableTag="pre, table",I.prototype._init=function(){return this.menu=[{name:"normal",text:this._t("normalText"),param:"p"},"|",{name:"h1",text:this._t("title")+" 1",param:"h1"},{name:"h2",text:this._t("title")+" 2",param:"h2"},{name:"h3",text:this._t("title")+" 3",param:"h3"},{name:"h4",text:this._t("title")+" 4",param:"h4"},{name:"h5",text:this._t("title")+" 5",param:"h5"}],I.__super__._init.call(this)},I.prototype.setActive=function(t,e){if(I.__super__.setActive.call(this,t),t&&(e=e||this.node[0].tagName.toLowerCase()),this.el.removeClass("active-p active-h1 active-h2 active-h3 active-h4 active-h5"),t)return this.el.addClass("active active-"+e)},I.prototype.command=function(i){var o,t=this.editor.selection.rootNodes();return this.editor.selection.save(),t.each((o=this,function(t,e){e=k(e);if(!(e.is("blockquote")||e.is(i)||e.is(o.disableTag)||o.editor.util.isDecoratedNode(e)))return k("<"+i+"/>").append(e.contents()).replaceAll(e)})),this.editor.selection.restore(),this.editor.trigger("valuechanged")},p.Toolbar.addButton(I),e(P,g),P.prototype.name="fontScale",P.prototype.icon="font",P.prototype.disableTag="pre",P.prototype.htmlTag="span",P.prototype.sizeMap={"x-large":"1.5em",large:"1.25em",small:".75em","x-small":".5em"},P.prototype._init=function(){return this.menu=[{name:"150%",text:this._t("fontScaleXLarge"),param:"5"},{name:"125%",text:this._t("fontScaleLarge"),param:"4"},{name:"100%",text:this._t("fontScaleNormal"),param:"3"},{name:"75%",text:this._t("fontScaleSmall"),param:"2"},{name:"50%",text:this._t("fontScaleXSmall"),param:"1"}],P.__super__._init.call(this)},P.prototype._activeStatus=function(){this.editor.selection.range();var t=this.editor.selection.startNodes(),e=this.editor.selection.endNodes(),i=t.filter('span[style*="font-size"]'),o=e.filter('span[style*="font-size"]'),o=0<t.length&&0<e.length&&i.is(o);return this.setActive(o),this.active},P.prototype.command=function(t){var o,e=this.editor.selection.range();if(!e.collapsed)return document.execCommand("styleWithCSS",!1,!0),document.execCommand("fontSize",!1,t),document.execCommand("styleWithCSS",!1,!1),this.editor.selection.reset(),this.editor.selection.range(),((t=this.editor.selection.containerNode())[0].nodeType===Node.TEXT_NODE?t.closest('span[style*="font-size"]'):t.find('span[style*="font-size"]')).each((o=this,function(t,e){var i=k(e),e=e.style.fontSize;return/large|x-large|small|x-small/.test(e)?i.css("fontSize",o.sizeMap[e]):"medium"===e?i.replaceWith(i.contents()):void 0})),this.editor.trigger("valuechanged")},p.Toolbar.addButton(P),e(O,g),O.prototype.name="bold",O.prototype.icon="uniF032",O.prototype.htmlTag="b, strong",O.prototype.disableTag="pre",O.prototype.shortcut="cmd+b",O.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + b )":(this.title=this.title+" ( Ctrl + b )",this.shortcut="ctrl+b"),O.__super__._init.call(this)},O.prototype._activeStatus=function(){var t=!0===document.queryCommandState("bold");return this.setActive(t),this.active},O.prototype.command=function(){return document.execCommand("bold"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),k(document).trigger("selectionchange")},p.Toolbar.addButton(O),e(j,g),j.prototype.name="italic",j.prototype.icon="italic",j.prototype.htmlTag="i",j.prototype.disableTag="pre",j.prototype.shortcut="cmd+i",j.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + i )":(this.title=this.title+" ( Ctrl + i )",this.shortcut="ctrl+i"),j.__super__._init.call(this)},j.prototype._activeStatus=function(){var t=!0===document.queryCommandState("italic");return this.setActive(t),this.active},j.prototype.command=function(){return document.execCommand("italic"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),k(document).trigger("selectionchange")},p.Toolbar.addButton(j),e(F,g),F.prototype.name="underline",F.prototype.icon="underline",F.prototype.htmlTag="u",F.prototype.disableTag="pre",F.prototype.shortcut="cmd+u",F.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + u )":(this.title=this.title+" ( Ctrl + u )",this.shortcut="ctrl+u"),F.__super__.render.call(this)},F.prototype._activeStatus=function(){var t=!0===document.queryCommandState("underline");return this.setActive(t),this.active},F.prototype.command=function(){return document.execCommand("underline"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),k(document).trigger("selectionchange")},p.Toolbar.addButton(F),e(z,g),z.prototype.name="color",z.prototype.icon="uniF031",z.prototype.disableTag="pre",z.prototype.menu=!0,z.prototype.render=function(){var t=1<=arguments.length?b.call(arguments,0):[];return z.__super__.render.apply(this,t)},z.prototype.renderMenu=function(){return k('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-default"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-1"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-8"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-9"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-10"></a></li>\n  <li><a href="javascript:;" class="font-color font-color-11"></a></li>\n</ul>').appendTo(this.menuWrapper),this.menuWrapper.on("mousedown",".color-list",function(t){return!1}),this.menuWrapper.on("click",".font-color",(o=this,function(t){var e,i;if(o.wrapper.removeClass("menu-on"),(t=k(t.currentTarget)).hasClass("font-color-default")){if(!(0<(e=o.editor.body.find("p, li")).length))return;i=window.getComputedStyle(e[0],null).getPropertyValue("color"),e=o._convertRgbToHex(i)}else i=window.getComputedStyle(t[0],null).getPropertyValue("background-color"),e=o._convertRgbToHex(i);if(e)return i=o.editor.selection.range(),!t.hasClass("font-color-default")&&i.collapsed&&(t=document.createTextNode(o._t("coloredText")),i.insertNode(t),i.selectNodeContents(t),o.editor.selection.range(i)),document.execCommand("styleWithCSS",!1,!0),document.execCommand("foreColor",!1,e),document.execCommand("styleWithCSS",!1,!1),o.editor.util.support.oninput?void 0:o.editor.trigger("valuechanged")}));var o},z.prototype._convertRgbToHex=function(t){t=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g.exec(t);return t?function(t,e,i){var o=function(t){t=t.toString(16);return 1===t.length?"0"+t:t};return"#"+o(t)+o(e)+o(i)}(+t[1],+t[2],+t[3]):""},p.Toolbar.addButton(z),e(q,g),q.prototype.type="",q.prototype.disableTag="pre, table",q.prototype.command=function(t){var o,r,e=this.editor.selection.blockNodes(),n="ul"===this.type?"ol":"ul";return this.editor.selection.save(),o=null,e.each((r=this,function(t,e){var i=k(e);if(!(i.is("blockquote, li")||i.is(r.disableTag)||r.editor.util.isDecoratedNode(i))&&k.contains(document,e))return i.is(r.type)?(i.children("li").each(function(t,e){k(e).children("ul, ol").insertAfter(i);return k("<p/>").append(k(e).html()||r.editor.util.phBr).insertBefore(i)}),i.remove()):i.is(n)?k("<"+r.type+"/>").append(i.contents()).replaceAll(i):o&&i.prev().is(o)?(k("<li/>").append(i.html()||r.editor.util.phBr).appendTo(o),i.remove()):((o=k("<"+r.type+"><li></li></"+r.type+">")).find("li").append(i.html()||r.editor.util.phBr),o.replaceAll(i))})),this.editor.selection.restore(),this.editor.trigger("valuechanged")},e(W,c=q),W.prototype.type="ol",W.prototype.name="ol",W.prototype.icon="uniF0CB",W.prototype.htmlTag="ol",W.prototype.shortcut="cmd+/",W.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + / )":(this.title=this.title+" ( ctrl + / )",this.shortcut="ctrl+/"),W.__super__._init.call(this)},t=W,e(D,c),D.prototype.type="ul",D.prototype.name="ul",D.prototype.icon="uniF0CA",D.prototype.htmlTag="ul",D.prototype.shortcut="cmd+.",D.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + . )":(this.title=this.title+" ( Ctrl + . )",this.shortcut="ctrl+."),D.__super__._init.call(this)},c=D,p.Toolbar.addButton(t),p.Toolbar.addButton(c),e(H,g),H.prototype.name="blockquote",H.prototype.icon="uniF10D",H.prototype.htmlTag="blockquote",H.prototype.disableTag="pre, table",H.prototype.command=function(){var o,r,t,n,e=this.editor.selection.rootNodes();return e=e.filter(function(t,e){return!k(e).parent().is("blockquote")}),this.editor.selection.save(),r=[],t=this,o=function(){if(0<r.length)return k("<"+t.htmlTag+"/>").insertBefore(r[0]).append(r),r.length=0},e.each((n=this,function(t,e){var i=k(e);if(i.parent().is(n.editor.body))return i.is(n.htmlTag)?(o(),i.children().unwrap()):i.is(n.disableTag)||n.editor.util.isDecoratedNode(i)?o():r.push(e)})),o(),this.editor.selection.restore(),this.editor.trigger("valuechanged")},p.Toolbar.addButton(H),e(U,g),U.prototype.name="code",U.prototype.icon="uniF121",U.prototype.htmlTag="pre",U.prototype.disableTag="ul, ol, table",U.prototype._init=function(){var i,o;return U.__super__._init.call(this),this.editor.on("decorate",(i=this,function(t,e){return e.find("pre").each(function(t,e){return i.decorate(k(e))})})),this.editor.on("undecorate",(o=this,function(t,e){return e.find("pre").each(function(t,e){return o.undecorate(k(e))})}))},U.prototype.render=function(){var t=1<=arguments.length?b.call(arguments,0):[];return U.__super__.render.apply(this,t),this.popover=new i({button:this})},U.prototype._checkMode=function(){var t=this.editor.selection.range();return 0<k(t.cloneContents()).find(this.editor.util.blockNodes.join(","))||t.collapsed&&0===this.editor.selection.startNodes().filter("code").length?(this.inlineMode=!1,this.htmlTag="pre"):(this.inlineMode=!0,this.htmlTag="code")},U.prototype._status=function(){if(this._checkMode(),U.__super__._status.call(this),!this.inlineMode)return this.active?this.popover.show(this.node):this.popover.hide()},U.prototype.decorate=function(t){var e,i,o=t.find("> code");if(0<o.length&&(i=null!=(e=o.attr("class"))&&null!=(i=e.match(/lang-(\S+)/))?i[1]:void 0,o.contents().unwrap(),i))return t.attr("data-lang",i)},U.prototype.undecorate=function(t){var e=t.attr("data-lang"),i=k("<code/>");return e&&-1!==e&&i.addClass("lang-"+e),t.wrapInner(i).removeAttr("data-lang")},U.prototype.command=function(){return this.inlineMode?this._inlineCommand():this._blockCommand()},U.prototype._blockCommand=function(){var r,e,n,t=this.editor.selection.rootNodes(),s=[],a=[];return e=this,r=function(){var t;if(0<s.length)return t=k("<"+e.htmlTag+"/>").insertBefore(s[0]).text(e.editor.formatter.clearHtml(s)),a.push(t[0]),s.length=0},t.each((n=this,function(t,e){var i,o=k(e);return o.is(n.htmlTag)?(r(),i=k("<p/>").append(o.html().replace("\n","<br/>")).replaceAll(o),a.push(i[0])):o.is(n.disableTag)||n.editor.util.isDecoratedNode(o)||o.is("blockquote")?r():s.push(e)})),r(),this.editor.selection.setRangeAtEndOf(k(a).last()),this.editor.trigger("valuechanged")},U.prototype._inlineCommand=function(){var t,e=this.editor.selection.range();return this.active?(e.selectNodeContents(this.node[0]),this.editor.selection.save(e),this.node.contents().unwrap(),this.editor.selection.restore()):(t=k(e.extractContents()),t=k("<"+this.htmlTag+"/>").append(t.contents()),e.insertNode(t[0]),e.selectNodeContents(t[0]),this.editor.selection.range(e)),this.editor.trigger("valuechanged")},c=U,e(K,m),K.prototype.render=function(){var t,e,i,o,r,n;for(this._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">'+this._t("selectLanguage")+"</option>\n    </select>\n  </div>\n</div>",this.langs=this.editor.opts.codeLanguages||[{name:"Bash",value:"bash"},{name:"C++",value:"c++"},{name:"C#",value:"cs"},{name:"CSS",value:"css"},{name:"Erlang",value:"erlang"},{name:"Less",value:"less"},{name:"Sass",value:"sass"},{name:"Diff",value:"diff"},{name:"CoffeeScript",value:"coffeescript"},{name:"HTML,XML",value:"html"},{name:"JSON",value:"json"},{name:"Java",value:"java"},{name:"JavaScript",value:"js"},{name:"Markdown",value:"markdown"},{name:"Objective C",value:"oc"},{name:"PHP",value:"php"},{name:"Perl",value:"parl"},{name:"Python",value:"python"},{name:"Ruby",value:"ruby"},{name:"SQL",value:"sql"}],this.el.addClass("code-popover").append(this._tpl),this.selectEl=this.el.find(".select-lang"),t=0,i=(o=this.langs).length;t<i;t++)e=o[t],k("<option/>",{text:e.name,value:e.value}).appendTo(this.selectEl);return this.selectEl.on("change",(r=this,function(t){var e;return r.lang=r.selectEl.val(),e=r.target.hasClass("selected"),r.target.removeClass().removeAttr("data-lang"),-1!==r.lang&&r.target.attr("data-lang",r.lang),e&&r.target.addClass("selected"),r.editor.trigger("valuechanged")})),this.editor.on("valuechanged",(n=this,function(t){if(n.active)return n.refresh()}))},K.prototype.show=function(){var t=1<=arguments.length?b.call(arguments,0):[];return K.__super__.show.apply(this,t),this.lang=this.target.attr("data-lang"),null!=this.lang?this.selectEl.val(this.lang):this.selectEl.val(-1)},i=K,p.Toolbar.addButton(c),e(V,g),V.prototype.name="link",V.prototype.icon="todo",V.prototype.htmlTag="a",V.prototype.disableTag="pre",V.prototype.render=function(){var t=1<=arguments.length?b.call(arguments,0):[];return V.__super__.render.apply(this,t),this.popover=new l({button:this})},V.prototype._status=function(){if(V.__super__._status.call(this),this.active&&!this.editor.selection.rangeAtEndOf(this.node))return this.popover.show(this.node);var t=k(".todo_show");return 0<t.length&&(t.attr("data-todo")||t.remove()),this.popover.hide()},V.prototype.command=function(){var t,e,i,o,r,n=this.editor.selection.range();return this.active?(i=document.createTextNode(this.node.text()),this.node.replaceWith(i),n.selectNode(i)):(e="#"+StrackLang.TodoSelect+"#",o=k("<a/>",{class:"todo_show",href:"javascript:;",text:e}),0<this.editor.selection.blockNodes().length&&0==k(".todo_show").length&&(t=this.editor.selection.startNodes(),i=k(t).parent().children().first(),i=(e=k(t).parent().children().first().children().first())[0]?e[0].previousSibling&&e[0].previousSibling.textContent?e[0].previousSibling:e[0]:i[0].firstChild,t[0].tagName&&"P"!=t[0].tagName||this.editor.selection.setRangeBefore(i),n.insertNode(o[0]),i=document.createTextNode(" "),o.after(i),this.editor.selection.setRangeAtEndOf(i,n)),n.selectNodeContents(o[0]),this.popover.one("popovershow",(r=this,function(){return r.popover.textEl.focus(),r.popover.textEl[0].select()}))),this.editor.selection.range(n),this.editor.trigger("valuechanged")},c=V,e(X,m),X.prototype.render=function(){var t='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+StrackLang.TodoName+'</label>\n    <input class="link-text" type="text"/>\n </div>\n  <div class="settings-field">\n    <label>'+StrackLang.Issues+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n </div>';this.el.addClass("link-popover").append(t),this.textEl=this.el.find(".link-text"),this.urlEl=this.el.find(".link-url");var e,i,o=StrackPHP.IssuesList.replace(".html","");this.urlData=o,this.textEl.combobox({onSelect:function(t){k(".todo_show").html("#"+t.name+"#").attr("data-todo",t.todo_id).attr("data-issues","");t=o+"/todo_id/"+t.todo_id+".html";k(".link-url").combobox("reload",t).combobox("clear")}}),this.urlEl.on("keyup",(e=this,function(t){if(13!==t.which)return t=e.urlEl.val(),!/https?:\/\/|^\//gi.test(t)&&t&&(t="http://"+t),e.target.attr("href",t),e.editor.inputManager.throttledValueChanged()})),k([this.urlEl[0],this.textEl[0]]).on("keydown",(i=this,function(t){if(13===t.which||27===t.which||!t.shiftKey&&9===t.which&&k(t.target).hasClass("link-url"))return t.preventDefault(),t=document.createRange(),i.editor.selection.setRangeAfter(i.target,t),i.hide(),i.editor.inputManager.throttledValueChanged()}))},X.prototype.show=function(){var i,t,e=k("input[name=p_ty]").val(),o=k("input[name=t_id]").val(),r=1<=arguments.length?b.call(arguments,0):[];X.__super__.show.apply(this,r),k(this.target).hasClass("todo_show")&&(i=k(".todo_show"),t=(t=k(this.target).attr("data-todo"))||"",r=(r=k(this.target).attr("data-issues"))?r.split(","):"",this.textEl.combobox({url:StrackPHP.TodoList,valueField:"todo_id",textField:"name",value:t,queryParams:{t_id:o,type:e}}),this.urlEl.combobox({valueField:"issue_id",textField:"content",multiple:!0,value:r,onSelect:function(t){var e=i.attr("data-issues");e?(e=e.split(",")).indexOf(t.issue_id)<0&&(e.push(t.issue_id),e=e.join(","),i.attr("data-issues",e)):i.attr("data-issues",t.issue_id)},onUnselect:function(t){var e=i.attr("data-issues"),t=(e=e.split(",")).indexOf(t.issue_id);-1<t&&e.splice(t,1),e=e.join(","),i.attr("data-issues",e)}}),t&&(t=this.urlData+"/todo_id/"+t+".html",k(".link-url").combobox("reload",t)))},l=X,p.Toolbar.addButton(c),e(Q,g),Q.prototype.name="image",Q.prototype.icon="picture-o",Q.prototype.htmlTag="img",Q.prototype.disableTag="pre, table",Q.prototype.defaultImage="",Q.prototype.needFocus=!1,Q.prototype._init=function(){var t,e,i,o,r,n,s;if(this.editor.opts.imageButton)if(Array.isArray(this.editor.opts.imageButton))for(this.menu=[],e=0,i=(o=this.editor.opts.imageButton).length;e<i;e++)t=o[e],this.menu.push({name:t+"-image",text:this._t(t+"Image")});else this.menu=!1;else null!=this.editor.uploader?this.menu=[{name:"upload-image",text:this._t("uploadImage")},{name:"external-image",text:this._t("externalImage")}]:this.menu=!1;return this.defaultImage=this.editor.opts.defaultImage,this.editor.body.on("click","img:not([data-non-image])",(r=this,function(t){var e=k(t.currentTarget),t=document.createRange();return t.selectNode(e[0]),r.editor.selection.range(t),r.editor.util.support.onselectionchange||r.editor.trigger("selectionchanged"),!1})),this.editor.body.on("mouseup","img:not([data-non-image])",function(t){return!1}),this.editor.on("selectionchanged.image",(n=this,function(){var t,e=n.editor.selection.range();if(null!=e)return 1===(t=k(e.cloneContents()).contents()).length&&t.is("img:not([data-non-image])")?(e=k(e.startContainer).contents().eq(e.startOffset),n.popover.show(e)):n.popover.hide()})),this.editor.on("valuechanged.image",(s=this,function(){var t=s.editor.wrapper.find(".simditor-image-loading");if(0<t.length)return t.each(function(t,e){var i,o=k(e),e=o.data("img");if(!(e&&0<e.parent().length)&&(o.remove(),e&&(i=e.data("file"))&&(s.editor.uploader.cancel(i),s.editor.body.find("img.uploading").length<1)))return s.editor.uploader.trigger("uploadready",[i])})})),Q.__super__._init.call(this)},Q.prototype.render=function(){var t=1<=arguments.length?b.call(arguments,0):[];if(Q.__super__.render.apply(this,t),this.popover=new o({button:this}),"upload"===this.editor.opts.imageButton)return this._initUploader(this.el)},Q.prototype.renderMenu=function(){return Q.__super__.renderMenu.call(this),this._initUploader()},Q.prototype._initUploader=function(t){var e,i;if(null==t&&(t=this.menuEl.find(".menu-item-upload-image")),null!=this.editor.uploader){var o,r,n,s,a,l=null;return o=this,(e=function(){return l&&l.remove(),l=k("<input/>",{type:"file",title:o._t("uploadImage"),multiple:!0,accept:"image/*"}).appendTo(t)})(),t.on("click mousedown","input[type=file]",function(t){return t.stopPropagation()}),t.on("change","input[type=file]",(r=this,function(t){return r.editor.inputManager.focused?(r.editor.uploader.upload(l,{inline:!0}),e()):(r.editor.one("focus",function(t){return r.editor.uploader.upload(l,{inline:!0}),e()}),r.editor.focus()),r.wrapper.removeClass("menu-on")})),this.editor.uploader.on("beforeupload",(n=this,function(t,e){var i;if(e.inline)return e.img?i=k(e.img):(i=n.createImage(e.name),e.img=i),i.addClass("uploading"),i.data("file",e),n.editor.uploader.readImageFile(e.obj,function(t){if(i.hasClass("uploading"))return t=t?t.src:n.defaultImage,n.loadImage(i,t,function(){if(n.popover.active)return n.popover.refresh(),n.popover.srcEl.val(n._t("uploading")).prop("disabled",!0)})})})),i=k.proxy(this.editor.util.throttle(function(t,e,i,o){var r;if(e.inline&&(r=e.img.data("mask"))){if((e=r.data("img")).hasClass("uploading")&&0<e.parent().length)return 99<(o=(100*(o=i/o)).toFixed(0))&&(o=99),r.find(".progress").height(100-o+"%");r.remove()}},500),this),this.editor.uploader.on("uploadprogress",i),this.editor.uploader.on("uploadsuccess",(s=this,function(t,e,i){var o,r;if(e.inline&&(o=e.img).hasClass("uploading")&&0<o.parent().length){if("object"!=typeof i)try{i=k.parseJSON(i)}catch(t){i={success:!1}}return r=!1===i.success?(r=i.msg||s._t("uploadFailed"),alert(r),s.defaultImage):i.file_path,s.loadImage(o,r,function(){var t;if(o.removeData("file"),o.removeClass("uploading").removeClass("loading"),(t=o.data("mask"))&&t.remove(),o.removeData("mask"),s.editor.trigger("valuechanged"),s.editor.body.find("img.uploading").length<1)return s.editor.uploader.trigger("uploadready",[e,i])}),s.popover.active?(s.popover.srcEl.prop("disabled",!1),s.popover.srcEl.val(i.file_path)):void 0}})),this.editor.uploader.on("uploaderror",(a=this,function(t,e,i){var o,r,n;if(e.inline&&"abort"!==i.statusText){if(i.responseText){try{r=(n=k.parseJSON(i.responseText)).msg}catch(t){r=a._t("uploadError")}alert(r)}if((o=e.img).hasClass("uploading")&&0<o.parent().length)return a.loadImage(o,a.defaultImage,function(){var t;return o.removeData("file"),o.removeClass("uploading").removeClass("loading"),(t=o.data("mask"))&&t.remove(),o.removeData("mask")}),a.popover.active&&(a.popover.srcEl.prop("disabled",!1),a.popover.srcEl.val(a.defaultImage)),a.editor.trigger("valuechanged"),a.editor.body.find("img.uploading").length<1?a.editor.uploader.trigger("uploadready",[e,n]):void 0}}))}this.el.find(".btn-upload").remove()},Q.prototype._status=function(){return this._disableStatus()},Q.prototype.loadImage=function(i,o,r){var n,s,a,l,d;return l=this,a=function(){var t=i.offset(),e=l.editor.wrapper.offset();return n.css({top:t.top-e.top,left:t.left-e.left,width:i.width(),height:i.height()}).show()},i.addClass("loading"),(n=i.data("mask"))||(n=k('<div class="simditor-image-loading">\n  <div class="progress"></div>\n</div>').hide().appendTo(this.editor.wrapper),a(),i.data("mask",n),n.data("img",i)),(s=new Image).onload=(d=this,function(){var t,e;if(i.hasClass("loading")||i.hasClass("uploading"))return e=s.width,t=s.height,i.attr({src:o,width:e,height:t,"data-image-size":e+","+t}).removeClass("loading"),i.hasClass("uploading")?(d.editor.util.reflow(d.editor.body),a()):(n.remove(),i.removeData("mask")),k.isFunction(r)?r(s):void 0}),s.onerror=function(){return k.isFunction(r)&&r(!1),n.remove(),i.removeData("mask").removeClass("loading")},s.src=o},Q.prototype.createImage=function(t){var e;return null==t&&(t="Image"),this.editor.inputManager.focused||this.editor.focus(),(e=this.editor.selection.range()).deleteContents(),this.editor.selection.range(e),t=k("<img/>").attr("alt",t),e.insertNode(t[0]),this.editor.selection.setRangeAfter(t,e),this.editor.trigger("valuechanged"),t},Q.prototype.command=function(t){var e,i=this.createImage();return this.loadImage(i,t||this.defaultImage,(e=this,function(){return e.editor.trigger("valuechanged"),e.editor.util.reflow(i),i.click(),e.popover.one("popovershow",function(){return e.popover.srcEl.focus(),e.popover.srcEl[0].select()})}))},c=Q,e(J,m),J.prototype.offset={top:6,left:-4},J.prototype.render=function(){var e,i,o,r,n,s,a,l,d,t='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("imageUrl")+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;"\n      title="'+this._t("uploadImage")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-upload"></span>\n    </a>\n  </div>\n  <div class=\'settings-field\'>\n    <label>'+this._t("imageAlt")+'</label>\n    <input class="image-alt" id="image-alt" type="text" tabindex="1" />\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("imageSize")+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">×</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;"\n      title="'+this._t("restoreImageSize")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-undo"></span>\n    </a>\n  </div>\n</div>';return this.el.addClass("image-popover").append(t),this.srcEl=this.el.find(".image-src"),this.widthEl=this.el.find("#image-width"),this.heightEl=this.el.find("#image-height"),this.altEl=this.el.find("#image-alt"),this.srcEl.on("keydown",(e=this,function(t){if(13===t.which&&!e.target.hasClass("uploading"))return t.preventDefault(),t=document.createRange(),e.button.editor.selection.setRangeAfter(e.target,t),e.hide()})),this.srcEl.on("blur",(i=this,function(t){return i._loadImage(i.srcEl.val())})),this.el.find(".image-size").on("blur",(o=this,function(t){return o._resizeImg(k(t.currentTarget)),o.el.data("popover").refresh()})),this.el.find(".image-size").on("keyup",(r=this,function(t){var e=k(t.currentTarget);if(13!==t.which&&27!==t.which&&9!==t.which)return r._resizeImg(e,!0)})),this.el.find(".image-size").on("keydown",(n=this,function(t){var e,i=k(t.currentTarget);return 13===t.which||27===t.which?(t.preventDefault(),13===t.which?n._resizeImg(i):n._restoreImg(),e=n.target,n.hide(),i=document.createRange(),n.button.editor.selection.setRangeAfter(e,i)):9===t.which?n.el.data("popover").refresh():void 0})),this.altEl.on("keydown",(s=this,function(t){if(13===t.which)return t.preventDefault(),t=document.createRange(),s.button.editor.selection.setRangeAfter(s.target,t),s.hide()})),this.altEl.on("keyup",(a=this,function(t){if(13!==t.which&&27!==t.which&&9!==t.which)return a.alt=a.altEl.val(),a.target.attr("alt",a.alt)})),this.el.find(".btn-restore").on("click",(l=this,function(t){return l._restoreImg(),l.el.data("popover").refresh()})),this.editor.on("valuechanged",(d=this,function(t){if(d.active)return d.refresh()})),this._initUploader()},J.prototype._initUploader=function(){var e,t,i,o=this.el.find(".btn-upload");if(null!=this.editor.uploader)return t=this,(e=function(){return t.input&&t.input.remove(),t.input=k("<input/>",{type:"file",title:t._t("uploadImage"),multiple:!0,accept:"image/*"}).appendTo(o)})(),this.el.on("click mousedown","input[type=file]",function(t){return t.stopPropagation()}),this.el.on("change","input[type=file]",(i=this,function(t){return i.editor.uploader.upload(i.input,{inline:!0,img:i.target}),e()}));o.remove()},J.prototype._resizeImg=function(t,e){var i,o,r;if(null==e&&(e=!1),o=+t.val(),this.target&&(k.isNumeric(o)||o<0))return t.is(this.widthEl)?(i=this.height*(r=o)/this.width,this.heightEl.val(i)):(r=this.width*(i=o)/this.height,this.widthEl.val(r)),e?void 0:(this.target.attr({width:r,height:i}),this.editor.trigger("valuechanged"))},J.prototype._restoreImg=function(){var t=(null!=(t=this.target.data("image-size"))?t.split(","):void 0)||[this.width,this.height];return this.target.attr({width:+t[0],height:+t[1]}),this.widthEl.val(t[0]),this.heightEl.val(t[1]),this.editor.trigger("valuechanged")},J.prototype._loadImage=function(i,o){var r;if(!/^data:image/.test(i)||this.editor.uploader){if(this.target.attr("src")!==i)return this.button.loadImage(this.target,i,(r=this,function(t){var e;if(t)return r.active&&(r.width=t.width,r.height=t.height,r.widthEl.val(r.width),r.heightEl.val(r.height)),/^data:image/.test(i)?((e=r.editor.util.dataURLtoBlob(i)).name="Base64 Image.png",r.editor.uploader.upload(e,{inline:!0,img:r.target})):r.editor.trigger("valuechanged"),o?o(t):void 0}))}else o&&o(!1)},J.prototype.show=function(){var t=1<=arguments.length?b.call(arguments,0):[];return J.__super__.show.apply(this,t),t=this.target,this.width=t.width(),this.height=t.height(),this.alt=t.attr("alt"),t.hasClass("uploading")?this.srcEl.val(this._t("uploading")).prop("disabled",!0):(this.srcEl.val(t.attr("src")).prop("disabled",!1),this.widthEl.val(this.width),this.heightEl.val(this.height),this.altEl.val(this.alt))},o=J,p.Toolbar.addButton(c),e(G,g),G.prototype.name="indent",G.prototype.icon="indent",G.prototype._init=function(){return this.title=this._t(this.name)+" (Tab)",G.__super__._init.call(this)},G.prototype._status=function(){},G.prototype.command=function(){return this.editor.indentation.indent()},p.Toolbar.addButton(G),e(Z,g),Z.prototype.name="outdent",Z.prototype.icon="outdent",Z.prototype._init=function(){return this.title=this._t(this.name)+" (Shift + Tab)",Z.__super__._init.call(this)},Z.prototype._status=function(){},Z.prototype.command=function(){return this.editor.indentation.indent(!0)},p.Toolbar.addButton(Z),e($,g),$.prototype.name="hr",$.prototype.icon="uniEA34",$.prototype.htmlTag="hr",$.prototype._status=function(){},$.prototype.command=function(){var t,e=this.editor.selection.rootNodes().first();return 0<e.next().length?this.editor.selection.save():t=k("<p/>").append(this.editor.util.phBr),e=k("<hr/>").insertAfter(e),t?(t.insertAfter(e),this.editor.selection.setRangeAtStartOf(t)):this.editor.selection.restore(),this.editor.trigger("valuechanged")},p.Toolbar.addButton($),e(Y,g),Y.prototype.name="table",Y.prototype.icon="uniEA9A",Y.prototype.htmlTag="table",Y.prototype.disableTag="pre, li, blockquote",Y.prototype.menu=!0,Y.prototype._init=function(){var i,o,r,e,n,s,a,l;return Y.__super__._init.call(this),k.merge(this.editor.formatter._allowedTags,["thead","th","tbody","tr","td","colgroup","col"]),k.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),k.extend(this.editor.formatter._allowedStyles,{td:["text-align"],th:["text-align"]}),this._initShortcuts(),this.editor.on("decorate",(i=this,function(t,e){return e.find("table").each(function(t,e){return i.decorate(k(e))})})),this.editor.on("undecorate",(o=this,function(t,e){return e.find("table").each(function(t,e){return o.undecorate(k(e))})})),this.editor.on("selectionchanged.table",(r=this,function(t){var e,i;if(r.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active"),i=r.editor.selection.range())return e=r.editor.selection.containerNode(),i.collapsed&&e.is(".simditor-table")&&(e=r.editor.selection.rangeAtStartOf(e)?e.find("th:first"):e.find("td:last"),r.editor.selection.setRangeAtEndOf(e)),e.closest("td, th",r.editor.body).addClass("active")})),this.editor.on("blur.table",(e=this,function(t){return e.editor.body.find(".simditor-table td, .simditor-table th").removeClass("active")})),this.editor.keystroke.add("up","td",(n=this,function(t,e){return n._tdNav(e,"up"),!0})),this.editor.keystroke.add("up","th",(s=this,function(t,e){return s._tdNav(e,"up"),!0})),this.editor.keystroke.add("down","td",(a=this,function(t,e){return a._tdNav(e,"down"),!0})),this.editor.keystroke.add("down","th",(l=this,function(t,e){return l._tdNav(e,"down"),!0}))},Y.prototype._tdNav=function(t,e){var i;return i="up"===(e=null==e?"up":e)?"prev":"next",e="up"===e?["tbody","thead"]:["thead","tbody"],e=t.parent("tr"),!(0<(i=this["_"+i+"Row"](e)).length)||(t=e.find("td, th").index(t),this.editor.selection.setRangeAtEndOf(i.find("td, th").eq(t)))},Y.prototype._nextRow=function(t){var e=t.next("tr");return e=e.length<1&&0<t.parent("thead").length?t.parent("thead").next("tbody").find("tr:first"):e},Y.prototype._prevRow=function(t){var e=t.prev("tr");return e=e.length<1&&0<t.parent("tbody").length?t.parent("tbody").prev("thead").find("tr"):e},Y.prototype.initResize=function(t){var o,h=t.parent(".simditor-table"),r=t.find("colgroup");return r.length<1&&(r=k("<colgroup/>").prependTo(t),t.find("thead tr th").each(function(t,e){return k("<col/>").appendTo(r)}),this.refreshTableWidth(t)),o=k("<div />",{class:"simditor-resize-handle",contenteditable:"false"}).appendTo(h),h.on("mousemove","td, th",function(t){var e,i;if(!h.hasClass("resizing"))if(e=k(t.currentTarget),(e=t.pageX-k(t.currentTarget).offset().left<5&&0<e.prev().length?e.prev():e).next("td, th").length<1)o.hide();else if(null!=(i=o.data("td"))&&i.is(e))o.show();else{if(t=e.parent().find("td, th").index(e),i=r.find("col").eq(t),null==(t=o.data("col"))||!t.is(i))return o.css("left",e.position().left+e.outerWidth()-5).data("td",e).data("col",i).show();o.show()}}),h.on("mouseleave",function(t){return o.hide()}),h.on("mousedown",".simditor-resize-handle",function(t){var o=k(t.currentTarget),e=o.data("td"),r=o.data("col"),i=e.next("td, th"),n=r.next("col"),s=t.pageX,a=+e.outerWidth(),l=+i.outerWidth(),d=parseFloat(o.css("left")),p=e.closest("table").width();return k(document).on("mousemove.simditor-resize-table",function(t){var e=t.pageX-s,i=a+e,t=l-e;return i<50?t=l-(e=(i=50)-a):t<50&&(i=a+(e=l-(t=50))),r.attr("width",i/p*100+"%"),n.attr("width",t/p*100+"%"),o.css("left",d+e)}),k(document).one("mouseup.simditor-resize-table",function(t){return k(document).off(".simditor-resize-table"),h.removeClass("resizing")}),h.addClass("resizing"),!1})},Y.prototype._initShortcuts=function(){var e,i,o,r;return this.editor.hotkeys.add("ctrl+alt+up",(e=this,function(t){return e.editMenu.find(".menu-item[data-param=insertRowAbove]").click(),!1})),this.editor.hotkeys.add("ctrl+alt+down",(i=this,function(t){return i.editMenu.find(".menu-item[data-param=insertRowBelow]").click(),!1})),this.editor.hotkeys.add("ctrl+alt+left",(o=this,function(t){return o.editMenu.find(".menu-item[data-param=insertColLeft]").click(),!1})),this.editor.hotkeys.add("ctrl+alt+right",(r=this,function(t){return r.editMenu.find(".menu-item[data-param=insertColRight]").click(),!1}))},Y.prototype.decorate=function(t){var e,i;return 0<t.parent(".simditor-table").length&&this.undecorate(t),t.wrap('<div class="simditor-table"></div>'),t.find("thead").length<1&&(i=k("<thead />"),e=t.find("tr").first(),i.append(e),this._changeCellTag(e,"th"),0<(e=t.find("tbody")).length?e.before(i):t.prepend(i)),this.initResize(t),t.parent()},Y.prototype.undecorate=function(t){if(0<t.parent(".simditor-table").length)return t.parent().replaceWith(t)},Y.prototype.renderMenu=function(){var o,r,n;return k('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteRow">\n        <span>'+this._t("deleteRow")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowAbove">\n        <span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + ↑ )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertRowBelow">\n        <span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + ↓ )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteCol">\n        <span>'+this._t("deleteColumn")+'</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColLeft">\n        <span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + ← )</span>\n      </a>\n    </li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="insertColRight">\n        <span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + → )</span>\n      </a>\n    </li>\n    <li><span class="separator"></span></li>\n    <li>\n      <a tabindex="-1" unselectable="on" class="menu-item"\n        href="javascript:;" data-param="deleteTable">\n        <span>'+this._t("deleteTable")+"</span>\n      </a>\n    </li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),o=this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td, th",(r=this,function(t){var e,i;return r.createMenu.find("td, th").removeClass("selected"),t=(e=(i=k(t.currentTarget)).parent()).find("td, th").index(i)+1,i=e.prevAll("tr").addBack(),(i=e.parent().is("tbody")?i.add(o.find("thead tr")):i).find("td:lt("+t+"), th:lt("+t+")").addClass("selected")})),this.createMenu.on("mouseleave",function(t){return k(t.currentTarget).find("td, th").removeClass("selected")}),this.createMenu.on("mousedown","td, th",(n=this,function(t){var e,i;if(n.wrapper.removeClass("menu-on"),n.editor.inputManager.focused)return t=(e=(i=k(t.currentTarget)).parent()).find("td").index(i)+1,i=e.prevAll("tr").length+1,e.parent().is("tbody")&&(i+=1),o=n.createTable(i,t,!0),t=n.editor.selection.blockNodes().last(),n.editor.util.isEmptyNode(t)?t.replaceWith(o):t.after(o),n.decorate(o),n.editor.selection.setRangeAtStartOf(o.find("th:first")),n.editor.trigger("valuechanged"),!1}))},Y.prototype.createTable=function(t,e,i){for(var o,r,n,s,a,l=k("<table/>"),d=k("<thead/>").appendTo(l),p=k("<tbody/>").appendTo(l),h=n=0,c=t;0<=c?n<c:c<n;h=0<=c?++n:--n)for((r=k("<tr/>")).appendTo(0===h?d:p),s=0,a=e;0<=a?s<a:a<s;0<=a?++s:--s)o=k(0===h?"<th/>":"<td/>").appendTo(r),i&&o.append(this.editor.util.phBr);return l},Y.prototype.refreshTableWidth=function(t){var i=t.width(),o=t.find("col");return t.find("thead tr th").each(function(t,e){return o.eq(t).attr("width",k(e).outerWidth()/i*100+"%")})},Y.prototype.setActive=function(t){return Y.__super__.setActive.call(this,t),t?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},Y.prototype._changeCellTag=function(t,i){return t.find("td, th").each(function(t,e){e=k(e);return e.replaceWith("<"+i+">"+e.html()+"</"+i+">")})},Y.prototype.deleteRow=function(t){var e,i=t.parent("tr");return i.closest("table").find("tr").length<1?this.deleteTable(t):(0<(e=this._nextRow(i)).length||(e=this._prevRow(i)),t=i.find("td, th").index(t),i.parent().is("thead")&&(e.appendTo(i.parent()),this._changeCellTag(e,"th")),i.remove(),this.editor.selection.setRangeAtEndOf(e.find("td, th").eq(t)))},Y.prototype.insertRow=function(t,e){var i,o,r,n,s,a,l;for(null==e&&(e="after"),o=(r=t.parent("tr")).closest("table"),s=0,o.find("tr").each(function(t,e){return s=Math.max(s,k(e).find("td").length)}),t=r.find("td, th").index(t),i=k("<tr/>"),n="td","after"===e&&r.parent().is("thead")?r.parent().next("tbody").prepend(i):"before"===e&&r.parent().is("thead")?(r.before(i),r.parent().next("tbody").prepend(r),this._changeCellTag(r,"td"),n="th"):r[e](i),a=1,l=s;1<=l?a<=l:l<=a;1<=l?++a:--a)k("<"+n+"/>").append(this.editor.util.phBr).appendTo(i);return this.editor.selection.setRangeAtStartOf(i.find("td, th").eq(t))},Y.prototype.deleteCol=function(t){var i,e=t.parent("tr"),o=e.closest("table").find("tr").length<2,r=t.siblings("td, th").length<1;return o&&r?this.deleteTable(t):(i=e.find("td, th").index(t),0<(t=t.next("td, th")).length||(t=e.prev("td, th")),(e=e.closest("table")).find("col").eq(i).remove(),e.find("tr").each(function(t,e){return k(e).find("td, th").eq(i).remove()}),this.refreshTableWidth(e),this.editor.selection.setRangeAtEndOf(t))},Y.prototype.insertCol=function(t,o){var e,i,r,n,s,a;return null==o&&(o="after"),s=t.parent("tr"),n=s.find("td, th").index(t),e=(r=t.closest("table")).find("col").eq(n),r.find("tr").each((a=this,function(t,e){var i=k(e).parent().is("thead")?"th":"td",i=k("<"+i+"/>").append(a.editor.util.phBr);return k(e).find("td, th").eq(n)[o](i)})),i=k("<col/>"),e[o](i),s=r.width(),s=Math.max(parseFloat(e.attr("width"))/2,50/s*100),e.attr("width",s+"%"),i.attr("width",s+"%"),this.refreshTableWidth(r),t="after"===o?t.next("td, th"):t.prev("td, th"),this.editor.selection.setRangeAtStartOf(t)},Y.prototype.deleteTable=function(t){var e=t.closest(".simditor-table"),t=e.next("p");if(e.remove(),0<t.length)return this.editor.selection.setRangeAtStartOf(t)},Y.prototype.command=function(t){var e=this.editor.selection.containerNode().closest("td, th");if(0<e.length){if("deleteRow"===t)this.deleteRow(e);else if("insertRowAbove"===t)this.insertRow(e,"before");else if("insertRowBelow"===t)this.insertRow(e);else if("deleteCol"===t)this.deleteCol(e);else if("insertColLeft"===t)this.insertCol(e,"before");else if("insertColRight"===t)this.insertCol(e);else{if("deleteTable"!==t)return;this.deleteTable(e)}return this.editor.trigger("valuechanged")}},p.Toolbar.addButton(Y),e(tt,g),tt.prototype.name="strikethrough",tt.prototype.icon="uniF0CC",tt.prototype.htmlTag="strike",tt.prototype.disableTag="pre",tt.prototype._activeStatus=function(){var t=!0===document.queryCommandState("strikethrough");return this.setActive(t),this.active},tt.prototype.command=function(){return document.execCommand("strikethrough"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),k(document).trigger("selectionchange")},p.Toolbar.addButton(tt),e(et,g),et.prototype.name="alignment",et.prototype.icon="align-left",et.prototype.htmlTag="p, h1, h2, h3, h4, td, th",et.prototype._init=function(){return this.menu=[{name:"left",text:this._t("alignLeft"),icon:"align-left",param:"left"},{name:"center",text:this._t("alignCenter"),icon:"align-center",param:"center"},{name:"right",text:this._t("alignRight"),icon:"align-right",param:"right"}],et.__super__._init.call(this)},et.prototype.setActive=function(t,e){return"left"===(e="left"!==(e=null==e?"left":e)&&"center"!==e&&"right"!==e?"left":e)?et.__super__.setActive.call(this,!1):et.__super__.setActive.call(this,t),this.el.removeClass("align-left align-center align-right"),t&&this.el.addClass("align-"+e),this.setIcon("align-"+e),this.menuEl.find(".menu-item").show().end().find(".menu-item-"+e).hide()},et.prototype._status=function(){return this.nodes=this.editor.selection.nodes().filter(this.htmlTag),this.nodes.length<1?(this.setDisabled(!0),this.setActive(!1)):(this.setDisabled(!1),this.setActive(!0,this.nodes.first().css("text-align")))},et.prototype.command=function(t){if("left"!==t&&"center"!==t&&"right"!==t)throw new Error("simditor alignment button: invalid align "+t);return this.nodes.css({"text-align":"left"===t?"":t}),this.editor.trigger("valuechanged"),this.editor.inputManager.throttledSelectionChanged()},p.Toolbar.addButton(et),p}),function(i,o){"function"==typeof define&&define.amd?define("simditor-emoji",["jquery","simditor"],function(t,e){return i.EmojiButton=o(t,e)}):"object"==typeof exports?module.exports=o(require("jquery"),require("Simditor")):i.SimditorEmoji=o(jQuery,Simditor)}(this,function(l,t){var r={}.hasOwnProperty,e=[].slice;function d(){var t=1<=arguments.length?e.call(arguments,0):[];d.__super__.constructor.apply(this,t),l.merge(this.editor.formatter._allowedAttributes.img,["data-emoji","alt"])}return function(t,e){for(var i in e)r.call(e,i)&&(t[i]=e[i]);function o(){this.constructor=t}o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype}(d,t.Button),d.i18n={"zh-CN":{emoji:StrackLang.Emoji}},d.images=["smile","smiley","laughing","blush","heart_eyes","smirk","flushed","grin","wink","kissing_closed_eyes","stuck_out_tongue_winking_eye","stuck_out_tongue","sleeping","worried","expressionless","sweat_smile","cold_sweat","joy","sob","angry","mask","scream","sunglasses","heart","broken_heart","star","anger","exclamation","question","zzz","thumbsup","thumbsdown","ok_hand","punch","v","clap","muscle","pray","skull","trollface"],d.prototype.name="emoji",d.prototype.icon="uniEA08",d.prototype.menu=!0,d.prototype.renderMenu=function(){for(var t,e,i=l.extend({imagePath:"./images/emoji/",images:d.images},this.editor.opts.emoji||{}),o="",r=StrackPHP.BASE_URL+StrackPHP.IMG+"/emoji/",n=i.images,s=0,a=n.length;s<a;s++)o+="<li data-name='"+(t=n[s])+"'><img src='"+r+t+".png' width='16' height='16' alt='"+t+"' /></li>";return(i=l('<ul class="emoji-list">\n</ul>')).html(o).appendTo(this.menuWrapper),i.on("mousedown","li",(e=this,function(t){if(e.wrapper.removeClass("menu-on"),e.editor.inputManager.focused)return t=l(t.currentTarget).find("img").clone().attr({"data-emoji":!0,"data-non-image":!0}),e.editor.selection.insertNode(t),e.editor.trigger("valuechanged"),e.editor.trigger("selectionchanged"),!1}))},d.prototype.status=function(){},t.Toolbar.addButton(t=d),t}),function(o,r){"function"==typeof define&&define.amd?define("simditor-mention",["jquery","simditor","simple-module"],function(t,e,i){return o.SimditorMention=r(t,e,i)}):"object"==typeof exports?module.exports=r(require("jquery"),require("simditor"),require("simple-module")):o.SimditorMention=r(jQuery,Simditor,SimpleModule)}(this,function(d,t,e){var r={}.hasOwnProperty;function i(){return i.__super__.constructor.apply(this,arguments)}return function(t,e){for(var i in e)r.call(e,i)&&(t[i]=e[i]);function o(){this.constructor=t}o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype}(i,e),i.pluginName="Mention",i.prototype.opts={mention:!1},i.prototype.active=!1,i.prototype._init=function(){if(this.opts.mention){if(this.editor=this._module,this.opts.mention=d.extend({items:[],url:"",nameKey:"name",pinyinKey:"pinyin",abbrKey:"abbr",itemRenderer:null,linkRenderer:null},this.opts.mention),!d.isArray(this.opts.mention.items)&&""===this.opts.mention.url)throw new Error("Must provide items or source url");return this.items=[],this.editor.formatter._allowedAttributes.a?this.editor.formatter._allowedAttributes.a.push("data-mention"):this.editor.formatter._allowedAttributes.a=["data-mention"],0<this.opts.mention.items.length?(this.items=this.opts.mention.items,this._renderPopover()):this.getItems(),this._bind()}},i.prototype.getItems=function(){return d.ajax({type:"post",url:this.opts.mention.url,dataType:"json",data:this.opts.mention.param}).done((e=this,function(t){return e.items=t,e._renderPopover()}));var e},i.prototype._bind=function(){var i,o,e,r,n,t,s,a;return this.editor.on("decorate",(i=this,function(t,e){return e.find("a[data-mention]").each(function(t,e){return i.decorate(d(e))})})),this.editor.on("undecorate",(o=this,function(t,e){return e.find("a[data-mention]").each(function(t,e){return o.undecorate(d(e))}),e.find("simditor-mention").children().unwrap()})),this.editor.on("pushundostate",(e=this,function(t){return!(0<e.editor.body.find("span.simditor-mention").length)&&t.result})),this.editor.on("keydown",(r=this,function(t){if(229===t.which)return setTimeout(function(){var t=r.editor.selection.range();if(null!=t&&t.collapsed)return(t=t.cloneRange()).setStart(t.startContainer,Math.max(t.startOffset-1,0)),"@"!==t.toString()||r.active?void 0:r.editor.trigger(d.Event("keypress",{which:64}))},50)})),this.editor.on("keypress",(n=this,function(t){var e;switch(t.which){case 8:if(e=n.editor.selection.range(),n.editor.selection.blockNodes().last().is("pre"))return;break;case 64:return n.editor.selection.blockNodes().last().is("pre")?void 0:setTimeout(function(){if(null!=(e=n.editor.selection.range())&&((e=e.cloneRange()).setStart(e.startContainer,Math.max(e.startOffset-2,0)),!/^[A-Za-z0-9]@/.test(e.toString())))return n.show()},50);default:return}})),this.editor.on("keydown.simditor-mention",d.proxy(this._onKeyDown,this)).on("keyup.simditor-mention",d.proxy(this._onKeyUp,this)),this.editor.on("blur",(t=this,function(){if(t.active)return t.hide()})),this.editor.body.on("mousedown",".simditor-mention",(s=this,function(t){var e;return"Mention"==s.constructor.pluginName&&(t=(e=d(t.currentTarget)).context.outerHTML,t=d('<span class="simditor-mention edit" />').append(t),e.replaceWith(t),s.show(t),e=t.contents().eq(0),(t=document.createRange()).selectNodeContents(e[0]),t.setStart(t.startContainer,1),s.editor.selection.range(t)),!1})),this.editor.wrapper.on("mousedown.simditor-mention",(a=this,function(t){if(!d(t.target).closest(".simditor-mention-popover",a.editor.wrapper).length)return a.hide()}))},i.prototype.show=function(t){var e;return this.active=!0,t?this.target=t:(this.target=d('<span class="simditor-mention" />'),(e=this.editor.selection.range()).setStart(e.startContainer,e.endOffset-1),e.surroundContents(this.target[0])),this.editor.selection.setRangeAtEndOf(this.target,e),this.popoverEl.find(".item:first").addClass("selected").siblings(".item").removeClass("selected"),this.popoverEl.show(),this.popoverEl.find(".item").show(),this.refresh()},i.prototype.refresh=function(){var t=this.editor.wrapper.offset(),e=this.target.offset(),i=this.popoverEl.height(),o=e.top-t.top+this.target.height()+2;return e.top-d(document).scrollTop()+i>d(window).height()&&(o=e.top-t.top-i),this.popoverEl.css({top:o,left:e.left-t.left+this.target.width()})},i.prototype._renderPopover=function(){var t,e,i,o,r,n,s,a,l;for(this.popoverEl=d("<div class='simditor-mention-popover'>\n  <div class='items'></div>\n</div>").appendTo(this.editor.el),t=this.popoverEl.find(".items"),o=0,r=(a=this.items).length;o<r;o++)n=(i=a[o])[this.opts.mention.nameKey],s=i[this.opts.mention.pinyinKey],e=i[this.opts.mention.abbrKey],(e=d('<a class="item" href="javascript:;"\n  data-pinyin="'+s+'"\n  data-abbr="'+e+'">\n  <span></span>\n</a>')).attr("data-name",n).find("span").text(n),(e=this.opts.mention.itemRenderer?this.opts.mention.itemRenderer(e,i):e).appendTo(t).data("item",i);return this.popoverEl.on("mouseenter",".item",function(t){return d(this).addClass("selected").siblings(".item").removeClass("selected")}),this.popoverEl.on("mousedown",".item",(l=this,function(t){return l.selectItem(),!1})),t.on("mousewheel",function(t,e){return d(this).scrollTop(d(this).scrollTop()-10*e),!1})},i.prototype.decorate=function(t){return t.addClass("simditor-mention")},i.prototype.undecorate=function(t){return t.removeClass("simditor-mention")},i.prototype.hide=function(){return this.target&&(this.target.contents().first().unwrap(),this.target=null),this.popoverEl.hide().find(".item").removeClass("selected"),this.active=!1,null},i.prototype.selectItem=function(){var t,e,i=this.popoverEl.find(".item.selected");if(0<i.length)return t=(e=i.data("item")).url||"javascript:;",i=d("<a/>",{class:"simditor-mention",text:"@"+i.attr("data-name"),href:t,"data-uid":i.attr("data-abbr"),"data-mention":!0}),this.target.replaceWith(i),this.editor.trigger("mention",[i,e]),this.opts.mention.linkRenderer&&this.opts.mention.linkRenderer(i,e),i=(e=(this.target.hasClass("edit")&&this.editor.selection.setRangeAfter(i),document.createTextNode(" ")),i.after(e),document.createRange()),this.editor.selection.setRangeAtEndOf(e,i),this.hide()},i.prototype.filterItem=function(){var i,t=this.target.text().toLowerCase().substr(1).replace(/'/g,"");t=(t=t.replace(String.fromCharCode(12288),"")).replace(String.fromCharCode(160),"");try{i=new RegExp("(|\\s)"+t,"i")}catch(t){i=new RegExp("","i")}return t=this.popoverEl.find(".item").hide().removeClass("selected").filter(function(t){var e=d(this),e=[e.data("name"),e.data("pinyin"),e.data("abbr")].join(" ");return i.test(e)}),this.popoverEl.show(),this.active=!0,t.show().first().addClass("selected")},i.prototype._changeFocus=function(t){var e,i,o,r=this.popoverEl.find(".item.selected");return r.length<1?(this.popoverEl.find(".item:first".addClass("selected")),!1):!((e=r[t+"All"](".item:visible").first()).length<1)&&(r.removeClass("selected"),e.addClass("selected"),o=(i=e.parent()).height(),t=e.position(),r=e.outerHeight(),i.scrollTop(r*e.prevAll(".item:visible").length-o+r),t.top<0?i.scrollTop(r*e.prevAll(".item:visible").length):void 0)},i.prototype._onKeyDown=function(t){var e,i;if(this.active)return 37===t.which||39===t.which||27===t.which?(this.editor.selection.save(),this.hide(),this.editor.selection.restore(),!1):38===t.which||80===t.which&&t.ctrlKey?(this._changeFocus("prev"),!1):40===t.which||78===t.which&&t.ctrlKey?(this._changeFocus("next"),!1):13===t.which||9===t.which?(i=this.popoverEl.find(".item.selected")).length?(this.selectItem(),!1):(e=document.createTextNode(this.target.text()),this.target.before(e).remove(),this.hide(),this.editor.selection.setRangeAtEndOf(e)):8!==t.which||"@"!==this.target.text()&&""!==this.target.text()?32===t.which?(t=this.target.text(),(i=this.popoverEl.find(".item.selected")).length&&t.substr(1)===i.text().trim()?this.selectItem():(e=document.createTextNode(t+" "),this.target.before(e).remove(),this.hide(),this.editor.selection.setRangeAtEndOf(e)),!1):void 0:(e=document.createTextNode("@"),this.target.replaceWith(e),this.hide(),this.editor.selection.setRangeAtEndOf(e))},i.prototype._onKeyUp=function(t){if(!(!this.active||-1<d.inArray(t.which,[9,16,17,27,37,38,39,40])||t.shiftKey&&50===t.which||t.ctrlKey&&(78===t.which||80===t.which)))return this.filterItem(),this.refresh()},t.connect(t=i),t}),function(i,o){"function"==typeof define&&define.amd?define("simditor-fullscreen",["jquery","simditor"],function(t,e){return i.SimditorFullscreen=o(t,e)}):"object"==typeof exports?module.exports=o(require("jquery"),require("simditor")):i.SimditorFullscreen=o(jQuery,Simditor)}(this,function(t,e){var r={}.hasOwnProperty;function i(){return i.__super__.constructor.apply(this,arguments)}return function(t,e){for(var i in e)r.call(e,i)&&(t[i]=e[i]);function o(){this.constructor=t}o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype}(i,e.Button),i.cls="simditor-fullscreen",i.i18n={"zh-CN":{fullscreen:"全屏"}},i.prototype.name="fullscreen",i.prototype.needFocus=!1,i.prototype.iconClassOf=function(){return"icon-uniE74B"},i.prototype._init=function(){return i.__super__._init.call(this),this.window=t(window),this.body=t("body"),this.editable=this.editor.body,this.toolbar=this.editor.toolbar.wrapper},i.prototype.status=function(){return this.setActive(this.body.hasClass(this.constructor.cls))},i.prototype.command=function(){var t,e,i;return this.body.toggleClass(this.constructor.cls),(e=this.body.hasClass(this.constructor.cls))?(t=this.editable.outerHeight()-this.editable.height(),this.window.on("resize.simditor-fullscreen-"+this.editor.id,(i=this,function(){return i._resize({height:i.window.height()-i.toolbar.outerHeight()-t})})).resize()):(this.window.off("resize.simditor-fullscreen-"+this.editor.id).resize(),this._resize({height:"auto"})),this.setActive(e)},i.prototype._resize=function(t){return this.editable.height(t.height)},e.Toolbar.addButton(e=i),e});