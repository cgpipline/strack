$(function(){obj={template_add:function(){Strack.open_dialog("dialog",{title:StrackLang.Add_Project_Template,width:480,height:310,content:Strack.dialog_dom({type:"normal",items:[{case:1,id:"Nname",lang:StrackLang.Name,name:"name",valid:"1,128",value:""},{case:1,id:"Ncode",lang:StrackLang.Code,name:"code",valid:"1,128",value:""},{case:2,id:"Nschema",lang:StrackLang.Schema,name:"schema_id",valid:1}],footer:[{obj:"template_add_submit",type:1,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#Nschema",{url:TemplatePHP.getEntitySchemaComboboxList,valueField:"id",textField:"name",width:378,height:26})},close:function(){}})},template_add_submit:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",TemplatePHP.addProjectTemplate,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),obj.reset_template_list(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},template_filter:function(){var e=$("#search_val").val();t=0<e.length?{name:["-lk","%"+e+"%"]}:"",obj.reset_template_list()},template_modify:function(e){var t=$(e).data("tempid"),a=$(e).data("tempname"),i=$(e).data("tempcode");Strack.open_dialog("dialog",{title:StrackLang.Modify_Project_Template_Title,width:480,height:280,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mtemplate_id",type:"hidden",name:"id",valid:1,value:t}],items:[{case:1,id:"name",lang:StrackLang.Name,name:"name",valid:"1,128",value:a},{case:1,id:"code",lang:StrackLang.Code,name:"code",valid:"1,128",value:i}],footer:[{obj:"template_modify_submit",type:1,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),close:function(){}})},template_modify_submit:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",TemplatePHP.modifyProjectTemplate,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),obj.reset_template_list(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},template_to_default:function(e){var t=$(e).data("tempid"),a=$(e).data("tempname");0<t&&Strack.open_dialog("dialog",{title:StrackLang.Template_Rollback_Default,width:480,height:220,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mtemplate_id",type:"hidden",name:"src_template_id",valid:1,value:t}],items:[{case:1,id:"Mdist_template",lang:StrackLang.Builtin_template,name:"dist_template_id",valid:1,value:a}],footer:[{obj:"project_template_reset",type:1,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#Mdist_template",{url:TemplatePHP.getProjectBuiltinTemplateList,valueField:"project_template_id",textField:"name"})}})},project_template_reset:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",TemplatePHP.resetTemplateConfig,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),obj.reset_template_list(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}})},template_delete:function(e){var t=$(e).data("tempid");Strack.ajax_base_delete(t,StrackLang.Del_Template_Notice,TemplatePHP.deleteProjectTemplate,function(e){obj.reset_template_list()})},select_template:function(e){var t,a=$(e).data("tempid"),i=$(e).data("tempname"),d=$(e).data("tempcode"),l=$(e).data("pid");$("#hide_temp_id").val(a),$("#hide_temp_name").val(i),$("#hide_temp_code").val(d),$("#hide_project_id").val(l),$(".templates-items").removeClass("templates-active"),$("#temp_id_"+a).addClass("templates-active"),$(".temp-content-right-no").show(),$(".temp-set-main").hide(),$(".temp-setlist-no").hide(),$(".temp-setlists").show(),t=a,$.ajax({url:TemplatePHP.getProjectTemplateModuleList,type:"POST",dataType:"json",data:{template_id:t},beforeSend:function(){$("#temp_module").append(Strack.loading_dom("white","","module"))},success:function(t){var i="";$("#project_schema_name").html(t.schema_name),["fixed","entity"].forEach(function(e){i+='<li class="module-items-title">'+t[e].title+"</li>",t[e].data.forEach(function(e){var t,a;"media"!==e.code&&(i+=(a="",a+='<a href="javascript:;" class="nation-items" onclick="obj.select_module(this)" data-moduleid="'+(t=e).id+'" data-modulename="'+t.name+'" data-moduletype="'+t.type+'" data-modulecode="'+t.code+'"><div class="nation-items-wrap min"><div class="aign-left"><i class="'+t.icon+' icon-left"></i><span>'+t.name+"</span></div></div></a>"))})}),$("#module_list").empty().append(i),$("#st-load_module").remove()}})},select_module:function(e){var t,a=$(e).data("moduleid"),i=$(e).data("modulename"),d=$(e).data("moduletype"),l=$(e).data("modulecode"),o=$("#temp_base_tfield"),n=$("#temp_fixed_tab");switch(d){case"entity":t=d;break;default:switch(l){case"base":o.show(),n.show(),t=d;break;case"onset":case"file":case"file_commit":case"timelog":o.hide(),n.hide(),t=d;break;default:t=l}}$(".nation-items").removeClass("admin-bid-ac"),$(e).addClass("admin-bid-ac"),$("#hide_module_id").val(a),$("#hide_module_name").val(i),$("#hide_module_code").val(l),$(".temp-content-right-no").hide(),$(".temp-set-main").hide(),$("#temp_set_"+t).show()},reset_template_list:function(){$(".temp-content-right-no").show(),$(".temp-set-main").hide(),$(".temp-setlist-no").show(),$(".temp-setlists").hide(),$("#hide_temp_id").val(""),$("#hide_temp_name").val(""),$("#hide_temp_code").val(""),e(t)},project_set_nav:function(e){var t=$(e).attr("data-category"),a=$(e).attr("data-title"),i=$("#hide_module_id").val(),d=$("#hide_module_code").val(),l=$("#hide_temp_id").val();n({datalist_url:TemplatePHP.getProjectNavModuleList,title:a,temp_id:l,module_code:d,module_id:i,category:t,id_field:"module_id",text_field:"name",text_field_lang:StrackLang.Module,group:"module_name",limit:0})},template_set_status:function(e){var t=$(e).attr("data-category"),a=$(e).attr("data-title"),i=$("#hide_module_id").val(),d=$("#hide_module_code").val(),l=$("#hide_temp_id").val();n({datalist_url:TemplatePHP.getStatusDataList,title:a,temp_id:l,module_code:d,module_id:i,category:t,id_field:"id",text_field:"name",text_field_lang:StrackLang.Status,group:"correspond_name",limit:0})},template_set_tag:function(e){var t=$(e).attr("data-category"),a=$(e).attr("data-title"),i=$("#hide_module_id").val(),d=$("#hide_module_code").val(),l=$("#hide_temp_id").val();n({datalist_url:TemplatePHP.getTagDataList,title:a,temp_id:l,module_code:d,module_id:i,category:t,id_field:"id",text_field:"name",text_field_lang:StrackLang.Tag,group:"type",limit:0})},template_set_sort:function(e){var t,a=$(e).attr("data-category"),i=$(e).attr("data-title"),d=$("#hide_module_id").val(),l=$("#hide_module_code").val(),o=$("#hide_temp_id").val();t={title:i,temp_id:o,module_code:l,module_id:d,category:a,id_field:"fields",text_field:"lang",text_field_lang:StrackLang.Column,group:"belong_table",limit:3},Strack.open_dialog("dialog",{title:t.title,width:420,height:320,content:Strack.dialog_dom({type:"adv_sort",hidden:[{case:101,id:"Mtemp_id",type:"hidden",name:"temp_id",valid:1,value:t.temp_id},{case:101,id:"Mid_field",type:"hidden",name:"id_field",valid:1,value:t.id_field},{case:101,id:"Mmodule_code",type:"hidden",name:"module_code",valid:1,value:t.module_code},{case:101,id:"Mcategory",type:"hidden",name:"category",valid:1,value:t.category}],footer:[{obj:"update_sort_config_set",type:1,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){Strack.combobox_widget("#sort_first,#sort_second,#sort_third",{url:TemplatePHP.getTemplateDataList,valueField:t.id_field,textField:t.text_field,width:160,height:25,groupField:t.group,queryParams:{category:t.category,module_id:t.module_id,project_id:0,template_id:t.temp_id}}),Strack.combobox_widget("#sort_first_func,#sort_second_func,#sort_third_func",{url:StrackPHP.getSortList,valueField:"id",textField:"name",width:110,height:25}),$.ajax({type:"POST",url:TemplatePHP.getTemplateConfig,dataType:"json",data:{template_id:t.temp_id,category:t.category,module_code:t.module_code},beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){e.forEach(function(e){$("#sort_"+e.index).combobox("setValue",e.field),$("#sort_"+e.index+"_func").combobox("setValue",e.order)}),$("#st-load_config").remove()}})}})},template_set_group:function(e){var t=$(e).attr("data-category"),a=$(e).attr("data-title"),i=$("#hide_module_id").val(),d=$("#hide_module_code").val(),l=$("#hide_temp_id").val();n({datalist_url:TemplatePHP.getModuleRelationColumns,title:a,temp_id:l,module_code:d,module_id:i,category:t,id_field:"fields",text_field:"lang",text_field_lang:StrackLang.Column,group:"belong_table",limit:1})},template_set_field:function(e){var t=$(e).attr("data-category"),a=$(e).attr("data-title"),i=$("#hide_module_id").val(),d=$("#hide_module_code").val(),l=$("#hide_temp_id").val(),o=0;"top_field"===t&&(o=3),n({datalist_url:TemplatePHP.getModuleBaseColumns,title:a,temp_id:l,module_code:d,module_id:i,category:t,id_field:"field_group_id",text_field:"lang",text_field_lang:StrackLang.Column,group:"belong_table",limit:o})},template_set_tab:function(e){var t=$(e).attr("data-category"),a=$(e).attr("data-title"),i=$("#hide_module_id").val(),d=$("#hide_module_code").val(),l=$("#hide_temp_id").val();n({datalist_url:TemplatePHP.getModuleTabList,title:a,temp_id:l,module_code:d,module_id:i,category:t,id_field:"tab_id",text_field:"name",text_field_lang:StrackLang.Tab,group:"group",limit:0})},template_set_link_onset:function(e){var t=$(e).attr("data-category"),a=$("#hide_module_id").val(),i=$("#hide_module_code").val(),d=$("#hide_temp_id").val();Strack.open_dialog("dialog",{title:StrackLang.Link_Onset_Switch,width:480,height:220,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mcategory",type:"hidden",name:"category",valid:1,value:t},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:a},{case:101,id:"Mmodule_code",type:"hidden",name:"module_code",valid:1,value:i},{case:101,id:"Mtemplate_id",type:"hidden",name:"template_id",valid:1,value:d}],items:[{case:2,id:"Mlink_onset_switch",lang:StrackLang.Switch,name:"link_onset",valid:""}],footer:[{obj:"modify_set_link_onset",type:1,title:StrackLang.Submit},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$.ajax({type:"POST",url:TemplatePHP.getTemplateConfig,dataType:"json",data:{template_id:d,module_code:i,category:t},beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){var t=e.switch?e.switch:0;Strack.init_open_switch({dom:"#Mlink_onset_switch",onText:StrackLang.Switch_ON,offText:StrackLang.Switch_OFF,value:t,width:100}),$("#st-load_config").remove()}})}})},modify_set_link_onset:function(){Strack.ajax_dialog_form("#st_dialog_form .dialog-widget-val","",TemplatePHP.modifyTemplateConfig,{back:function(e){200===parseInt(e.status)?(Strack.dialog_cancel(),Strack.top_message({bg:"g",msg:e.message})):layer.msg(e.message,{icon:7,time:1200,anim:6})}},{extra:function(e){return e.config={switch:e.link_onset},e}})},template_set_step:function(e){var t=$(e).attr("data-category"),a=$(e).attr("data-title"),i=$("#hide_module_id").val(),d=$("#hide_module_code").val(),l=$("#hide_temp_id").val();n({datalist_url:TemplatePHP.getTemplateStepList,title:a,temp_id:l,module_code:d,module_id:i,category:t,id_field:"id",text_field:"name",text_field_lang:StrackLang.Steps,group:"",limit:0})},template_entity_step_field:function(e){var t=$(e).attr("data-category"),a=$(e).attr("data-title"),i=($("#hide_module_id").val(),$("#hide_module_code").val()),d=$("#hide_temp_id").val();n({datalist_url:TemplatePHP.getModuleBaseColumns,title:a,temp_id:d,module_code:i,module_id:4,category:t,id_field:"field_group_id",text_field:"lang",text_field_lang:StrackLang.Column,group:"belong_table",limit:0})},template_set_relationship:function(e){var t,a=$(e).attr("data-category"),i=$(e).attr("data-title"),d=$("#hide_module_id").val(),l=$("#hide_module_code").val(),o=$("#hide_temp_id").val();t={datalist_url:TemplatePHP.getModuleRelationConfig,title:i,temp_id:o,module_code:l,module_id:d,category:a,id_field:"fields",text_field:"lang",text_field_lang:StrackLang.Column,group:"field_group"},Strack.open_dialog("dialog",{title:t.title,width:720,height:420,content:Strack.dialog_dom({type:"relationship_set",hidden:[{case:101,id:"Mtemp_id",type:"hidden",name:"temp_id",valid:1,value:t.temp_id},{case:101,id:"Mmodule_id",type:"hidden",name:"module_id",valid:1,value:t.module_id},{case:101,id:"Mid_field",type:"hidden",name:"id_field",valid:1,value:t.id_field},{case:101,id:"Mmodule_code",type:"hidden",name:"module_code",valid:1,value:t.module_code},{case:101,id:"Mcategory",type:"hidden",name:"category",valid:1,value:t.category}],footer:[{obj:"update_relation_config_set",type:1,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){$.ajax({type:"POST",url:t.datalist_url,dataType:"json",data:{template_id:t.temp_id,module_id:t.module_id,module_code:t.module_code,category:t.category},beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){var t="";e.exist.forEach(function(e){t+="<tr><td>"+e.from+"</td><td>"+e.to+"</td></tr>"}),$("#related_module_list").append(t),$("#st-load_config").remove()}})}})},update_config_set:function(){var e=$("#Mtemp_id").val(),t=$("#Mmodule_code").val(),a=$("#Mcategory").val(),i=$("#Mid_field").val(),d=$("#template-columns").datagrid("getRows"),l=[];d.forEach(function(e){switch(a){case"navigation":l.push(e);break;case"note_tag":l.push({id:e.id,name:e.name,type:e.type});break;case"column":l.push({fields:e[i],module:e.module,table:e.table});break;case"group":l.push({fields:e[i],field:e.fields,field_type:e.field_type,module:e.module,module_code:e.module_code,value_show:e.value_show,table:e.table,order:"asc"});break;case"tab":case"step":case"sort":case"top_field":case"step_fields":case"main_field":l.push(e);break;default:var t={};t[i]=e[i],l.push(t)}}),o(e,t,a,l)},update_sort_config_set:function(){var e=$("#Mtemp_id").val(),t=$("#hide_module_code").val(),a=$("#Mcategory").val(),i=($("#Mid_field").val(),[]);["first","second","third"].forEach(function(e){var t=$("#sort_"+e).combobox("getRowValue","id"),a=$("#sort_"+e+"_func").combobox("getValue");t&&(a=a||"asc",i.push({index:e,field:t.fields,fields:t.fields,field_type:t.field_type,module:t.module,module_code:t.module_code,value_show:t.value_show,table:t.table,order:a}))}),o(e,t,a,i)},update_relation_config_set:function(){var e=$("#Mtemp_id").val(),t=$("#Mcategory").val(),a=$("#Mmodule_code").val(),i=[];$(".st-dialog-input").each(function(){var e=$(this).attr("data-name"),t=$("#first_"+e).combobox("getValue"),a=$("#second_"+e).combobox("getValue");i.push({from:t,to:a})}),o(e,a,t,i)}};var d=Strack.generate_hidden_param(),t="";function e(e){$.ajax({url:TemplatePHP.getTemplateList,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({filter:e}),beforeSend:function(){$("#template_list").empty().append(Strack.loading_dom("null"))},success:function(e){var t="",a=$("#template_list"),i=$("#hide_temp_id").val();e.rows.forEach(function(e){t+=function(e){var t="";t+='<li id="temp_id_'+e.project_template_id+'" class="templates-items" ><div class="role-name text-ellipsis aign-left"><a href="javascript:;" class="list-item" onclick="obj.select_template(this);" data-pid="'+e.project_id+'"  data-tempid="'+e.project_template_id+'" data-tempname="'+e.name+'" data-tempcode="'+e.code+'">'+e.name+'</a></div><div class="role-bnt aign-right">',"yes"===d.rule_modify&&(t+='<a href="javascript:;" class="aign-left" onclick="obj.template_modify(this);" data-tempid="'+e.project_template_id+'" data-tempname="'+e.name+'" data-tempcode="'+e.code+'"><i class="icon-uniE684"></i></a>');"yes"===d.rule_reset&&(t+='<a href="javascript:;" class="aign-left" onclick="obj.template_to_default(this);" data-tempid="'+e.project_template_id+'" data-tempname="'+e.name+'"><i class="icon-uniF01E"></i></a>');"yes"===d.rule_delete&&(t+='<a href="javascript:;" class="aign-left" onclick="obj.template_delete(this);" data-tempid="'+e.project_template_id+'"><i class="icon-uniE6DB"></i></a>');return t+="</div></li>"}(e)}),t?($("#template_active_notice").remove(),a.append(t)):0===$("#template_active_notice").length&&a.before('<div id="template_active_notice" class="datagrid-empty-no">'+StrackLang.No_Project_Template_List+"</div>"),0<i&&obj.select_template($("#temp_id_"+i).find("a")),$("#st-load").remove()}})}function n(d){Strack.open_dialog("dialog",{title:d.title,width:800,height:520,content:Strack.dialog_dom({type:"normal",hidden:[{case:101,id:"Mtemp_id",type:"hidden",name:"temp_id",valid:1,value:d.temp_id},{case:101,id:"Mid_field",type:"hidden",name:"id_field",valid:1,value:d.id_field},{case:101,id:"Mmodule_code",type:"hidden",name:"module_code",valid:1,value:d.module_code},{case:101,id:"Mcategory",type:"hidden",name:"category",valid:1,value:d.category}],items:[{case:5,id:"",type:"text",lang:"",name:"",valid:"",value:0}],footer:[{obj:"update_config_set",type:1,title:StrackLang.Update},{obj:"dialog_cancel",type:8,title:StrackLang.Cancel}]}),inits:function(){var i;$("#template-field").datalist({url:d.datalist_url,width:320,height:380,idField:d.id_field,valueField:d.id_field,textField:d.text_field,groupField:d.group,checkbox:!0,singleSelect:!1,queryParams:{module_code:d.module_code,category:d.category,module_id:d.module_id,project_id:0,template_id:d.temp_id},onLoadSuccess:function(e){var a=$(this);$.ajax({type:"POST",url:TemplatePHP.getTemplateConfig,dataType:"json",data:{template_id:d.temp_id,module_code:d.module_code,category:d.category},beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){var t=[{field:d.id_field,checkbox:!0},{field:d.text_field,title:d.text_field_lang,align:"center",width:160}];d.group&&t.push({field:d.group,title:StrackLang.Group,align:"center",width:160}),$("#template-columns").datagrid({data:[],width:380,height:380,rownumbers:!0,fitColumns:!0,columns:[t],dragSelection:!0,onLoadSuccess:function(){(i=$(this)).datagrid("enableDnd")}}),e.forEach(function(e){console.log(e),console.log(d.id_field),a.datalist("selectRecord",e[d.id_field])}),$("#st-load_config").remove()}})},onSelect:function(e,t){var a=$("#template-columns");a.datagrid("appendRow",t),i.datagrid("enableDnd"),0<d.limit&&(a.datagrid("getRows").length>d.limit&&$(this).datagrid("unselectRow",e))},onUnselect:function(e,t){var a=$("#template-columns"),i=a.datagrid("getRowIndex",t);a.datagrid("deleteRow",i)}})}})}function o(e,t,a,i){var d={template_id:e,module_code:t,category:a,config:i};$.ajax({type:"POST",url:TemplatePHP.modifyTemplateConfig,data:JSON.stringify(d),dataType:"json",contentType:"application/json",beforeSend:function(){$("#dialog").prepend(Strack.loading_dom("white","","config"))},success:function(e){$("#st-load_config").remove(),Strack.top_message({bg:"g",msg:e.message}),Strack.dialog_cancel()}})}e(t),Strack.listen_keyboard_event(function(e,t){"enter"===t.code&&$("#search_val").is(":focus")&&(e.preventDefault(),obj.template_filter(Strack.get_obj_by_id("search_template_bnt")))})});